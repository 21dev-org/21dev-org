---
import ArticleLayout from './ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
import { getBipByNumber, statusVariants, type BIP } from '@/data/bips';

interface Props {
  number: number;
  prevBip?: number;
  nextBip?: number;
}

const { number, prevBip, nextBip } = Astro.props;

// Get BIP data from single source of truth
const bip = getBipByNumber(number);

if (!bip) {
  throw new Error(`BIP-${number} not found in bips.ts`);
}

// Helper to format BIP number with padding
function formatBipNumber(num: number): string {
  return String(num).padStart(4, '0');
}

// Get prev/next BIP data for navigation
const prevBipData = prevBip ? getBipByNumber(prevBip) : undefined;
const nextBipData = nextBip ? getBipByNumber(nextBip) : undefined;

// Construct navigation links
const prevPage = prevBipData
  ? {
      title: `BIP-${prevBip}: ${prevBipData.titleZh}`,
      href: `/bips/bip-${formatBipNumber(prevBip!)}`,
    }
  : undefined;

const nextPage = nextBipData
  ? {
      title: `BIP-${nextBip}: ${nextBipData.titleZh}`,
      href: `/bips/bip-${formatBipNumber(nextBip!)}`,
    }
  : undefined;

// Status variant for Tag component
const statusVariant = statusVariants[bip.status] || 'default';

// Get related BIPs data
const relatedBipsData = (bip.relatedBips || [])
  .map((num) => getBipByNumber(num))
  .filter((b): b is BIP => b !== undefined);
---

<ArticleLayout
  title={`BIP-${number}: ${bip.titleZh}`}
  description={bip.summary}
  breadcrumbs={[{ label: 'BIPs', href: '/bips/' }, { label: `BIP-${number}` }]}
  tags={[bip.type, bip.status]}
  author={bip.author}
  date={bip.created ? new Date(bip.created) : undefined}
  prevPage={prevPage}
  nextPage={nextPage}
>
  <!-- BIP Meta Info Card -->
  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">{number}</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">{bip.type}</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant={statusVariant} size="sm">{bip.status}</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">創建日期</span>
        <p class="font-semibold text-[var(--text-primary)]">{bip.created || '-'}</p>
      </div>
    </div>
  </div>

  <!-- Page Content -->
  <slot />

  <!-- Related BIPs Section -->
  {
    relatedBipsData.length > 0 && (
      <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-3">相關 BIP</h3>
        <div class="space-y-2">
          {relatedBipsData.map((relatedBip) => (
            <a
              href={`/bips/bip-${formatBipNumber(relatedBip.number)}`}
              class="flex items-center gap-3 p-2 -mx-2 rounded-lg hover:bg-[var(--surface-elevated)] transition-colors group"
            >
              <span class="flex-shrink-0 w-12 h-8 rounded bg-bitcoin-500/10 flex items-center justify-center text-sm font-bold text-bitcoin-700">
                {relatedBip.number}
              </span>
              <div class="min-w-0 flex-1">
                <p class="text-sm font-medium text-[var(--text-primary)] group-hover:text-bitcoin-500 transition-colors truncate">
                  {relatedBip.titleZh}
                </p>
                <p class="text-xs text-[var(--text-tertiary)] truncate">{relatedBip.title}</p>
              </div>
              <svg
                class="h-4 w-4 text-[var(--text-tertiary)] group-hover:text-bitcoin-500 flex-shrink-0 transition-colors"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ))}
        </div>
      </div>
    )
  }

  <!-- GitHub Link -->
  <div class="mt-8 p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
    <p class="text-sm text-bitcoin-700 dark:text-bitcoin-400">
      <strong>延伸閱讀：</strong> 查看
      <a
        href={`https://github.com/bitcoin/bips/blob/master/bip-${formatBipNumber(number)}.mediawiki`}
        target="_blank"
        rel="noopener noreferrer"
        class="underline hover:no-underline"
      >
        GitHub 上的完整 BIP-{number} 文件
      </a>
    </p>
  </div>
</ArticleLayout>
