---
import '@/styles/global.css';
import { siteConfig } from '@/data/site';
import { ViewTransitions } from 'astro:transitions';
import ReadingProgress from '@/components/ui/ReadingProgress.astro';
import BackToTop from '@/components/ui/BackToTop.astro';
import CodeCopy from '@/components/ui/CodeCopy.astro';

interface JsonLdArticle {
  headline: string;
  description: string;
  datePublished?: string;
  dateModified?: string;
  author?: string;
}

type JsonLdSchema = Record<string, unknown>;

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  noIndex?: boolean;
  article?: JsonLdArticle;
  schemas?: JsonLdSchema[];
}

const {
  title = siteConfig.title,
  description = siteConfig.description,
  ogImage: customOgImage,
  noIndex = false,
  article,
  schemas = [],
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, siteConfig.url);

// Determine OG image path - use custom if provided, otherwise try page-specific, fallback to default
function getOgImagePath() {
  if (customOgImage) return customOgImage;

  // Generate path for page-specific OG image
  const pathname = Astro.url.pathname;
  const cleanPath = pathname.replace(/^\/|\/$/g, ''); // Remove leading/trailing slashes

  if (cleanPath && cleanPath !== '') {
    // Check if page-specific OG exists (will be generated at build time)
    return `/og/${cleanPath}.png`;
  }

  return siteConfig.ogImage;
}

const ogImage = getOgImagePath();
const fullTitle = title === siteConfig.title ? title : `${title} | ${siteConfig.name}`;

// JSON-LD structured data
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: siteConfig.name,
  description: siteConfig.description,
  url: siteConfig.url,
  inLanguage: 'zh-Hant',
  publisher: {
    '@type': 'Organization',
    name: siteConfig.name,
    logo: {
      '@type': 'ImageObject',
      url: new URL('/favicon.svg', siteConfig.url).toString(),
    },
  },
};

const articleSchema = article
  ? {
      '@context': 'https://schema.org',
      '@type': 'Article',
      headline: article.headline,
      description: article.description,
      url: canonicalURL.toString(),
      inLanguage: 'zh-Hant',
      mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': canonicalURL.toString(),
      },
      publisher: {
        '@type': 'Organization',
        name: siteConfig.name,
        logo: {
          '@type': 'ImageObject',
          url: new URL('/favicon.svg', siteConfig.url).toString(),
        },
      },
      ...(article.datePublished && { datePublished: article.datePublished }),
      ...(article.dateModified && { dateModified: article.dateModified }),
      ...(article.author && {
        author: {
          '@type': 'Person',
          name: article.author,
        },
      }),
    }
  : null;
---

<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Performance: DNS Prefetch -->
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />

    <!-- Google Analytics (deferred for better performance) -->
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }

      // Defer GA loading until page is idle
      function loadGA() {
        var script = document.createElement('script');
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-9RXM7EXV1Q';
        script.async = true;
        document.head.appendChild(script);

        gtag('js', new Date());
        gtag('config', 'G-9RXM7EXV1Q');
      }

      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadGA, { timeout: 3000 });
      } else {
        setTimeout(loadGA, 2000);
      }

      // Track page views on View Transitions navigation
      document.addEventListener('astro:after-swap', function () {
        gtag('config', 'G-9RXM7EXV1Q', {
          page_path: window.location.pathname,
          page_title: document.title,
        });
      });

      // Track external link clicks
      document.addEventListener('click', function (e) {
        var link = e.target.closest('a');
        if (link && link.hostname !== window.location.hostname) {
          gtag('event', 'external_link_click', {
            link_url: link.href,
            link_text: link.textContent?.trim().substring(0, 50),
          });
        }
      });

      // Track CTA button clicks
      document.addEventListener('click', function (e) {
        var btn = e.target.closest('[data-cta]');
        if (btn) {
          gtag('event', 'cta_click', {
            cta_type: btn.dataset.cta,
            cta_text: btn.textContent?.trim().substring(0, 50),
          });
        }
      });
    </script>

    <!-- Icons & PWA -->
    <link rel="icon" href="/favicon.ico" sizes="48x48" />
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="canonical" href={canonicalURL} />

    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={description} />
    <meta name="author" content={siteConfig.author} />

    <!-- PWA Meta Tags -->
    <meta name="application-name" content={siteConfig.name} />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content={siteConfig.name} />
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- Language Alternates -->
    <link rel="alternate" hreflang="zh-Hant" href={canonicalURL} />
    <link rel="alternate" hreflang="zh" href={canonicalURL} />
    <link rel="alternate" hreflang="x-default" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="fb:app_id" content={siteConfig.fbAppId} />
    <meta property="og:type" content={article ? 'article' : 'website'} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, siteConfig.url)} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={`${title} - ${siteConfig.name}`} />
    <meta property="og:locale" content="zh_TW" />
    <meta property="og:site_name" content={siteConfig.name} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(ogImage, siteConfig.url)} />

    <!-- No Index (if specified) -->
    {noIndex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Theme Color -->
    <meta name="theme-color" content="#F7931A" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1C1917" media="(prefers-color-scheme: dark)" />

    <!-- Fonts: Use system fonts for Chinese (faster loading, better native experience) -->
    <!-- System fonts: PingFang SC (macOS/iOS), Microsoft YaHei (Windows), Noto Sans CJK (Android/Linux) -->
    <!-- Preload monospace font for code blocks -->
    <link
      rel="preload"
      href="/fonts/JetBrainsMono-Regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- JSON-LD Structured Data -->
    <script is:inline type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
    {
      articleSchema && (
        <script is:inline type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
      )
    }
    {
      schemas.map((schema) => (
        <script is:inline type="application/ld+json" set:html={JSON.stringify(schema)} />
      ))
    }

    <!-- AI/LLM Discovery -->
    <link rel="author" href="/llms.txt" />

    <!-- Theme initialization (prevent flash) -->
    <script is:inline>
      (function () {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>

    <!-- View Transitions -->
    <ViewTransitions />
  </head>
  <body class="min-h-screen bg-[var(--bg-primary)] text-[var(--text-primary)] antialiased">
    <!-- Accessibility: Skip to content link -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-bitcoin-500 focus:text-white focus:rounded-lg focus:outline-none"
    >
      跳至主要內容
    </a>

    <!-- UX: Reading progress bar -->
    <ReadingProgress />

    <slot />

    <!-- UX: Back to top button -->
    <BackToTop />

    <!-- UX: Code copy buttons -->
    <CodeCopy />

    <!-- Theme toggle script -->
    <script>
      function initTheme() {
        const themeToggle = document.getElementById('theme-toggle');
        if (!themeToggle) return;

        themeToggle.addEventListener('click', () => {
          const currentTheme = document.documentElement.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
        });
      }

      // Run on initial load
      initTheme();

      // Re-run on page navigation (for Astro view transitions)
      document.addEventListener('astro:after-swap', initTheme);
    </script>

    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch(() => {
            // Service worker registration failed silently
          });
        });
      }
    </script>
  </body>
</html>
