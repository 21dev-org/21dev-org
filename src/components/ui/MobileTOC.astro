---
/**
 * Mobile Table of Contents
 * A floating button that opens a bottom sheet with the table of contents on mobile devices.
 * Hidden on large screens where the sidebar TOC is visible.
 */
export interface Props {
  maxDepth?: number;
}

const { maxDepth = 3 } = Astro.props;
---

<!-- Floating TOC Button (visible only on mobile/tablet) -->
<button
  id="mobile-toc-button"
  type="button"
  class="lg:hidden fixed bottom-20 right-4 z-40 flex items-center gap-2 px-4 py-2.5 rounded-full bg-bitcoin-500 text-white shadow-lg hover:bg-bitcoin-600 active:scale-95 transition-all"
  aria-label="開啟目錄"
  aria-expanded="false"
  aria-controls="mobile-toc-panel"
  data-max-depth={maxDepth}
>
  <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
  </svg>
  <span class="text-sm font-medium">目錄</span>
</button>

<!-- Backdrop -->
<div
  id="mobile-toc-backdrop"
  class="lg:hidden fixed inset-0 z-40 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-300"
  aria-hidden="true"
>
</div>

<!-- Bottom Sheet Panel -->
<div
  id="mobile-toc-panel"
  class="lg:hidden fixed inset-x-0 bottom-0 z-50 transform translate-y-full transition-transform duration-300 ease-out"
  role="dialog"
  aria-modal="true"
  aria-labelledby="mobile-toc-title"
>
  <div class="bg-[var(--bg-primary)] rounded-t-2xl shadow-2xl max-h-[70vh] flex flex-col">
    <!-- Handle bar -->
    <div class="flex justify-center pt-3 pb-2">
      <div class="w-10 h-1 rounded-full bg-[var(--border-default)]"></div>
    </div>

    <!-- Header -->
    <div
      class="flex items-center justify-between px-5 pb-3 border-b border-[var(--border-default)]"
    >
      <h2 id="mobile-toc-title" class="text-lg font-semibold text-[var(--text-primary)]">目錄</h2>
      <button
        id="mobile-toc-close"
        type="button"
        class="p-2 -mr-2 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] transition-colors"
        aria-label="關閉目錄"
      >
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- TOC List -->
    <nav class="flex-1 overflow-y-auto overscroll-contain px-5 py-4" aria-label="目錄">
      <ul id="mobile-toc-list" class="space-y-1">
        <!-- Items will be populated by JavaScript -->
      </ul>
    </nav>
  </div>
</div>

<script>
  function initMobileTOC() {
    const button = document.getElementById('mobile-toc-button') as HTMLButtonElement | null;
    const backdrop = document.getElementById('mobile-toc-backdrop') as HTMLDivElement | null;
    const panel = document.getElementById('mobile-toc-panel') as HTMLDivElement | null;
    const closeBtn = document.getElementById('mobile-toc-close') as HTMLButtonElement | null;
    const tocList = document.getElementById('mobile-toc-list') as HTMLUListElement | null;

    if (!button || !backdrop || !panel || !closeBtn || !tocList) return;

    // Store references to avoid null checks in closures
    const btn = button;
    const bd = backdrop;
    const pn = panel;

    const maxDepth = parseInt(button.getAttribute('data-max-depth') || '3');
    const headingSelector = Array.from({ length: maxDepth }, (_, i) => `h${i + 2}`).join(',');

    // Find all headings in the main content
    const article = document.querySelector('article') || document.querySelector('main');
    if (!article) {
      button.style.display = 'none';
      return;
    }

    const headings = article.querySelectorAll(headingSelector);
    if (headings.length === 0) {
      button.style.display = 'none';
      return;
    }

    // Clear previous content
    tocList.innerHTML = '';

    // Generate IDs for headings that don't have them
    headings.forEach((heading, index) => {
      if (!heading.id) {
        heading.id = `heading-${index}`;
      }
    });

    // Build TOC
    headings.forEach((heading) => {
      const level = parseInt(heading.tagName.charAt(1));
      const li = document.createElement('li');

      const link = document.createElement('a');
      link.href = `#${heading.id}`;
      link.textContent = heading.textContent;
      link.className = `block py-2.5 px-3 rounded-lg text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] transition-colors`;
      link.style.paddingLeft = `${12 + (level - 2) * 16}px`;

      if (level > 2) {
        link.classList.add('text-sm');
      }

      li.appendChild(link);
      tocList.appendChild(li);
    });

    let isOpen = false;

    function openPanel() {
      isOpen = true;
      btn.setAttribute('aria-expanded', 'true');
      bd.classList.remove('opacity-0', 'pointer-events-none');
      bd.classList.add('opacity-100');
      pn.classList.remove('translate-y-full');
      pn.classList.add('translate-y-0');
      document.body.style.overflow = 'hidden';
    }

    function closePanel() {
      isOpen = false;
      btn.setAttribute('aria-expanded', 'false');
      bd.classList.add('opacity-0', 'pointer-events-none');
      bd.classList.remove('opacity-100');
      pn.classList.add('translate-y-full');
      pn.classList.remove('translate-y-0');
      document.body.style.overflow = '';
    }

    // Event listeners
    button.addEventListener('click', () => {
      if (isOpen) {
        closePanel();
      } else {
        openPanel();
      }
    });

    closeBtn.addEventListener('click', closePanel);
    backdrop.addEventListener('click', closePanel);

    // Close on link click and scroll to section
    tocList.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.tagName === 'A') {
        e.preventDefault();
        const href = target.getAttribute('href');
        if (href) {
          closePanel();
          // Small delay to allow panel to close before scrolling
          setTimeout(() => {
            const element = document.querySelector(href);
            if (element) {
              const offsetTop = element.getBoundingClientRect().top + window.scrollY - 80;
              window.scrollTo({
                top: offsetTop,
                behavior: 'smooth',
              });
              history.pushState(null, '', href);
            }
          }, 150);
        }
      }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closePanel();
      }
    });

    // Handle swipe down to close
    let startY = 0;
    let currentY = 0;

    pn.addEventListener(
      'touchstart',
      (e) => {
        startY = e.touches[0].clientY;
      },
      { passive: true }
    );

    pn.addEventListener(
      'touchmove',
      (e) => {
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;
        if (diff > 0) {
          pn.style.transform = `translateY(${diff}px)`;
        }
      },
      { passive: true }
    );

    pn.addEventListener('touchend', () => {
      const diff = currentY - startY;
      if (diff > 100) {
        closePanel();
      }
      pn.style.transform = '';
      startY = 0;
      currentY = 0;
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initMobileTOC);
  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initMobileTOC);
</script>
