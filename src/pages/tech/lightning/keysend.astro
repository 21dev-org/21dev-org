---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Keysend 自發支付"
  description="了解 Keysend 如何實現無需發票的閃電網路支付，讓發送方可以主動向任何節點發送資金。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Keysend' },
  ]}
  difficulty="intermediate"
  readingTime="10 分鐘"
  prevPage={{ title: 'Multi-Path Payments', href: '/tech/lightning/mpp' }}
  nextPage={{ title: 'Gossip Protocol', href: '/tech/lightning/gossip' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Keysend？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Keysend（也稱為 Spontaneous Payments 或 Sphinx Send）允許發送方向任何節點
    發送支付，而無需接收方提供發票。發送方自己生成 preimage 並通過加密的
    洋蔥包傳遞給接收方，接收方解密後即可結算支付。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>使用場景：</strong>
      Keysend 非常適合打賞、捐贈、串流支付（streaming payments）等場景，
      讓發送方可以主動付款而不需要接收方預先生成發票。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">傳統發票 vs Keysend</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Traditional Invoice Flow:

1. Bob generates preimage (32 bytes random)
2. Bob calculates payment_hash = SHA256(preimage)
3. Bob creates invoice containing payment_hash
4. Bob sends invoice to Alice
5. Alice pays invoice (HTLC locked to payment_hash)
6. Bob reveals preimage to settle

Problems:
• Requires bidirectional communication
• Bob must be online to generate invoice
• New invoice needed for each payment

--------------------------------------------

Keysend Flow:

1. Alice generates preimage (32 bytes random)
2. Alice calculates payment_hash = SHA256(preimage)
3. Alice encrypts preimage in onion packet
4. Alice sends HTLC (locked to payment_hash)
5. Bob decrypts onion packet, gets preimage
6. Bob uses preimage to settle

Advantages:
• Unidirectional communication
• No prior interaction needed
• Can proactively pay`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">技術實現</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Keysend Onion Payload:

Uses TLV (Type-Length-Value) extension:

Final hop payload:
  amt_to_forward (type 2): payment amount
  outgoing_cltv_value (type 4): CLTV timelock
  keysend_preimage (type 5482373484): preimage
    32 bytes: sender-generated preimage

TLV Type 5482373484 origin:
• Non-standard experimental type
• Odd type = optional (receiver can ignore if unknown)
• Has become de facto standard

Receiver processing:
1. Decrypt onion payload
2. Find keysend_preimage TLV
3. Verify SHA256(preimage) == payment_hash
4. If matches, use preimage to settle HTLC`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">自定義數據</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Keysend 還可以攜帶自定義數據，實現更豐富的功能：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Custom TLV Records:

Commonly used custom types:
  Type 34349334: text message
  Type 34349337: sender pubkey (for replies)
  Type 34349339: timestamp
  Type 34349343: content type
  Type 7629169: podcast info

Application example - Podcasting 2.0 value transfer:
{
  "keysend_preimage": "...",
  "7629169": {
    "podcast": "Bitcoin Audible",
    "episode": "Read 123",
    "ts": 1234,           // playback position (seconds)
    "action": "boost",
    "value_msat": 5000000,
    "sender_name": "Alice"
  }
}

This lets listeners tip creators directly while listening!`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">使用場景</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Podcasting 2.0</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        聽眾可以在收聽播客時進行即時打賞（streaming sats）或 boost，
        資金直接流向創作者。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">社交媒體打賞</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        用戶可以直接向內容創作者的節點發送打賞，無需創作者在線生成發票。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">遊戲內支付</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        遊戲中的即時交易，玩家之間可以快速轉帳而無需複雜的發票交換。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">節點間結算</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        服務提供商可以主動向合作夥伴節點發送結算款項。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">安全考量</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-orange-500/30 bg-orange-500/10">
      <h4 class="font-semibold text-orange-700 dark:text-orange-400 mb-2">付款證明問題</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        傳統發票由接收方生成 preimage，所以發送方獲得 preimage 就是付款證明。
        但 Keysend 的 preimage 是發送方自己生成的，無法證明接收方確實收到了款項。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-orange-500/30 bg-orange-500/10">
      <h4 class="font-semibold text-orange-700 dark:text-orange-400 mb-2">垃圾支付</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        任何人都可以向節點發送 Keysend 支付，可能被用於垃圾訊息。
        節點可以選擇設定最低金額或完全禁用 Keysend。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">緩解措施</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 設定最低接受金額</li>
        <li>• 使用 BOLT 12 Offers 代替純 Keysend</li>
        <li>• 結合發送方公鑰進行白名單</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Keysend + AMP</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`AMP Keysend (LND):

Combines advantages of AMP and Keysend:

Traditional Keysend:
• Single path
• Limited by single channel liquidity

AMP Keysend:
• Multi-path
• Can send large Keysend payments
• Better privacy (each shard has different hash)

Usage (lncli):
lncli sendpayment \\
  --dest <pubkey> \\
  --amt 100000 \\
  --amp \\
  --data 34349334=$(echo -n "Hello!" | xxd -p)

This will:
1. Generate AMP root key
2. Split into multiple shards
3. Each shard carries keysend TLV
4. Receiver settles after collecting all`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實現狀態</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >LND</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">完整支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        支持發送和接收 Keysend，包括 AMP Keysend。使用 --keysend 或 --amp 標誌。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Core Lightning</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">完整支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        通過 keysend 插件支持。需要配置 experimental-accept-extra-tlv-types。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Eclair</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">完整支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        Phoenix 錢包使用 Eclair，支持接收 Keysend 打賞。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT 12 作為替代</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BOLT 12 Offers 提供了更優雅的解決方案：
  </p>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Keysend</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 簡單直接</li>
        <li>• 無付款證明</li>
        <li>• 可能收到垃圾</li>
        <li>• 已廣泛部署</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">BOLT 12 Offers</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 有付款證明</li>
        <li>• 接收方控制</li>
        <li>• 支持 Route Blinding</li>
        <li>• 逐步部署中</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://docs.lightning.engineering/lightning-network-tools/lnd/send-messages-with-keysend"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">LND Keysend 文檔</a>
    </li>
    <li>
      • <a
        href="https://github.com/Podcastindex-org/podcast-namespace/blob/main/value/value.md"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Podcasting 2.0 Value Tag</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt12-offers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 12 Offers</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/gossip"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Gossip 協議</a
      >
      如何在閃電網路中傳播網路拓撲資訊。
    </p>
  </div>
</ArticleLayout>
