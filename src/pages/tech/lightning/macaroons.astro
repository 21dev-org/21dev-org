---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Macaroons LND 認證機制"
  description="了解 LND 的 Macaroon 認證系統，如何安全地管理節點 API 存取權限。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Macaroons' },
  ]}
  difficulty="intermediate"
  readingTime="10 分鐘"
  prevPage={{ title: 'Node Operation', href: '/tech/lightning/node-operation' }}
  nextPage={{ title: 'Channel Backup', href: '/tech/lightning/channel-backup' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Macaroons？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Macaroons 是 LND 使用的認證令牌系統。它們類似於 cookies，但提供更細粒度的
    權限控制和委託能力。每個 macaroon 定義了持有者可以執行的操作。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>安全核心：</strong>
      Macaroons 是保護 LND 節點的第一道防線。正確管理 macaroons
      對節點安全至關重要。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">內建 Macaroons</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`LND Default Macaroons:

Location: ~/.lnd/data/chain/bitcoin/mainnet/

admin.macaroon
  • Full permissions
  • Can execute all operations
  • Most sensitive, must be kept secure

readonly.macaroon
  • Read-only permissions
  • Can query balances, invoices, channel status
  • Cannot send payments or modify settings

invoice.macaroon
  • Invoice-related permissions
  • Create and query invoices
  • Cannot send payments

invoices.macaroon (plural)
  • Enhanced invoice permissions
  • Includes invoice subscriptions

chainnotifier.macaroon
  • On-chain notification permissions
  • Subscribe to blocks and transaction confirmations

signer.macaroon
  • Signing permissions
  • Used for remote signers

walletkit.macaroon
  • Wallet operation permissions
  • Address generation, PSBT, etc.

router.macaroon
  • Routing permissions
  • Send payments
  • Route queries`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Macaroon 結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Macaroon Internal Structure:

Components:

1. Identifier
   Unique identifier for tracking

2. Location (optional)
   Issuer location (e.g., "lnd")

3. Caveats (conditions/restrictions)
   • caveat 1: "entity=info"
   • caveat 2: "entity=invoices"
   • caveat 3: "action=read"
   • ...

4. Signature
   HMAC signature for integrity verification

Caveat Types:

First-party caveats:
  • Embedded directly in macaroon
  • Checked by verifier
  • Examples: time limits, IP restrictions

Third-party caveats:
  • Requires third-party verification
  • Enables multi-party authorization
  • LND primarily uses first-party`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">創建自定義 Macaroon</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Creating Custom Macaroons with lncli:

Basic Syntax:

lncli bakemacaroon <permissions...> [flags]

Permission Format: entity:action
  entities: info, offchain, onchain, address, message,
            peers, invoices, macaroon, signer
  actions:  read, write, generate

Examples:

# Read-only macaroon
lncli bakemacaroon info:read offchain:read onchain:read

# Invoice creation only
lncli bakemacaroon invoices:read invoices:write

# Can send payments, but cannot modify channels
lncli bakemacaroon offchain:read offchain:write \\
  --save_to=./payment.macaroon

# With time limit
lncli bakemacaroon info:read \\
  --timeout 3600 \\
  --save_to=./temp.macaroon

# With IP restriction
lncli bakemacaroon info:read \\
  --allow_external_permissions \\
  --custom_caveat "ipaddr 192.168.1.0/24"

Common Permission Combinations:

Monitoring (e.g., RTL, Thunderhub):
  info:read offchain:read onchain:read peers:read

Payments (e.g., BTCPay Server):
  invoices:read invoices:write offchain:read offchain:write

Full access (equivalent to admin):
  Not recommended, use admin.macaroon`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">衍生 Macaroon</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Deriving Restricted Macaroons:

Key Characteristics:

Macaroon's Unique Ability:
  • Can add caveats (restrictions)
  • Cannot remove existing caveats
  • No need to contact original issuer

This means:
  You can turn admin macaroon into restricted version
  But cannot turn readonly into admin

Adding Restrictions:

# Add time limit
lncli constrainmacaroon \\
  --macaroon_file=./admin.macaroon \\
  --timeout=3600 \\
  --output=./temp_admin.macaroon

# Add IP restriction
lncli constrainmacaroon \\
  --macaroon_file=./admin.macaroon \\
  --ip_address=192.168.1.100 \\
  --output=./restricted.macaroon

Now restricted.macaroon:
  • Retains all original permissions
  • But can only be used from 192.168.1.100
  • Other IPs will be rejected

Delegation Scenario:

Scenario: Give third-party service limited access

1. Create restricted version from admin.macaroon
2. Add time limit (1 day)
3. Add IP restriction (service's IP)
4. Grant only necessary permissions

lncli bakemacaroon invoices:read invoices:write \\
  --timeout 86400 \\
  --ip_address <service_ip> \\
  --save_to ./service.macaroon`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">安全最佳實踐</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Macaroon Security Guide:

Protecting admin.macaroon:

WARNING: admin.macaroon = Full node control

Should:
  • Store encrypted
  • Limit file permissions (chmod 600)
  • Never transmit or share
  • Consider using Hardware Security Module (HSM)

Should NOT:
  • Place in publicly accessible location
  • Transmit through insecure channels
  • Give to third-party services
  • Commit to version control

Principle of Least Privilege:

Create dedicated macaroon for each use case:

BTCPay Server:
  invoices:read invoices:write

Monitoring Dashboard:
  info:read peers:read offchain:read onchain:read

Auto-payment Script:
  offchain:write + amount limit

Development Testing:
  Short time limit + IP restriction

Regular Rotation:

1. Periodically generate new macaroons
2. Update services using old macaroon
3. Delete old macaroon (though cannot revoke)

Note: Macaroons cannot be "revoked"
The only way is to change LND's root key
This invalidates all existing macaroons`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">vs API Keys</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        傳統 API keys 是固定的。
        Macaroons 可以被衍生和限制。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">CLN: Runes</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Core Lightning 使用類似的 Runes 系統。
        概念相似但實現不同。
      </p>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>備份重要：</strong>
      雖然 macaroons 可以重新生成，但確保 root key（macaroons.db）
      和 wallet 一起備份。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://docs.lightning.engineering/lightning-network-tools/lnd/macaroons"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">LND Macaroons 文檔</a>
    </li>
    <li>
      • <a
        href="https://research.google/pubs/pub41892/"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Macaroons 論文</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/node-operation"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">節點運營</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/channel-backup"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">通道備份</a
      >
      確保資金安全。
    </p>
  </div>
</ArticleLayout>
