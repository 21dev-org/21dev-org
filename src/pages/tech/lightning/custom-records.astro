---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Custom Records 自定義 TLV 記錄"
  description="了解閃電網路的 Custom Records 機制，如何在支付中附加自定義資料。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Custom Records' },
  ]}
  difficulty="intermediate"
  readingTime="8 分鐘"
  prevPage={{ title: 'TLV Streams', href: '/tech/lightning/tlv-streams' }}
  nextPage={{ title: 'Keysend', href: '/tech/lightning/keysend' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Custom Records？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Custom Records 允許在閃電支付的洋蔥 payload 中附加任意資料。
    這些資料使用 TLV 格式，可以被接收節點讀取和處理。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>擴展協議：</strong>
      Custom Records 實現了支付的可編程性，支援訊息傳遞、
      身份驗證、應用層資料等多種用途。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">TLV 類型範圍</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`洋蔥 Payload TLV 類型分配：

類型範圍：
┌──────────────────────────────────────────────────────────────┐
│ 0 - 63,999：協議定義（BOLT 規範保留）                        │
│                                                              │
│ 常見協議類型：                                               │
│ ├── 2: amt_to_forward（轉發金額）                            │
│ ├── 4: outgoing_cltv_value（出站 CLTV）                      │
│ ├── 6: short_channel_id（下一跳通道）                        │
│ ├── 8: payment_data（payment_secret + total_msat）           │
│ ├── 10: encrypted_recipient_data（盲化路徑）                 │
│ └── 16: payment_metadata                                     │
│                                                              │
│ 64,000+：自定義記錄（應用程式使用）                          │
│ ├── 必須是奇數（odd type = optional）                        │
│ └── 接收者不認識可以安全忽略                                 │
└──────────────────────────────────────────────────────────────┘

奇偶規則（it's ok to be odd）：
┌──────────────────────────────────────────────────────────────┐
│ 偶數類型：必須理解，否則失敗                                 │
│ 奇數類型：可選的，不理解可以忽略                             │
│                                                              │
│ Custom Records 建議使用奇數類型：                            │
│ 65537, 65539, 65541, ...                                     │
│                                                              │
│ 這確保向後兼容性：                                           │
│ 老節點可以忽略它不認識的自定義記錄                           │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">常見應用</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Custom Records 應用場景：

1. Keysend（Spontaneous Payments）：
┌──────────────────────────────────────────────────────────────┐
│ Type 5482373484 (0x1466a3ac): keysend preimage               │
│                                                              │
│ 付款人生成 preimage，放在 custom record 中發送               │
│ 接收者提取 preimage 完成支付                                 │
│                                                              │
│ {                                                            │
│   5482373484: <32-byte preimage>                             │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘

2. 訊息傳遞：
┌──────────────────────────────────────────────────────────────┐
│ Whatsat / Sphinx Chat 風格：                                 │
│                                                              │
│ Type 34349334: 文字訊息                                      │
│ Type 34349337: 發送者資訊                                    │
│ Type 34349339: 時間戳                                        │
│                                                              │
│ {                                                            │
│   34349334: "Hello, Lightning!",                             │
│   34349337: <sender_pubkey>,                                 │
│   34349339: 1699999999                                       │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘

3. 應用識別：
┌──────────────────────────────────────────────────────────────┐
│ 識別支付來源應用：                                           │
│                                                              │
│ Type 65535: 應用識別符                                       │
│                                                              │
│ {                                                            │
│   65535: "my-app-v1.0"                                       │
│ }                                                            │
│                                                              │
│ 接收者可以根據此資訊進行特殊處理                             │
└──────────────────────────────────────────────────────────────┘

4. 訂單資訊：
┌──────────────────────────────────────────────────────────────┐
│ 電商場景：                                                   │
│                                                              │
│ {                                                            │
│   65537: "order_id:12345",                                   │
│   65539: "product:widget",                                   │
│   65541: "quantity:3"                                        │
│ }                                                            │
│                                                              │
│ 或使用 JSON：                                                │
│ {                                                            │
│   65537: '{"order":"12345","product":"widget","qty":3}'      │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">使用方式</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`發送和接收 Custom Records：

LND 發送（使用 lncli）：
┌──────────────────────────────────────────────────────────────┐
│ # Keysend with custom record                                 │
│ lncli sendpayment \\                                          │
│   --dest <pubkey> \\                                          │
│   --amt 1000 \\                                               │
│   --keysend \\                                                │
│   --data 65537=<hex_encoded_data>                            │
│                                                              │
│ # 多個 custom records                                        │
│ lncli sendpayment \\                                          │
│   --dest <pubkey> \\                                          │
│   --amt 1000 \\                                               │
│   --keysend \\                                                │
│   --data 65537=48656c6c6f \\                                  │
│   --data 65539=576f726c64                                    │
└──────────────────────────────────────────────────────────────┘

LND 接收（訂閱發票）：
┌──────────────────────────────────────────────────────────────┐
│ // gRPC 訂閱                                                 │
│ stream := client.SubscribeInvoices(ctx, &lnrpc.InvoiceSubscription{})
│                                                              │
│ for {                                                        │
│     invoice, _ := stream.Recv()                              │
│     for _, htlc := range invoice.Htlcs {                     │
│         // 讀取 custom records                               │
│         for typ, data := range htlc.CustomRecords {          │
│             fmt.Printf("Type %d: %x\n", typ, data)           │
│         }                                                    │
│     }                                                        │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘

Core Lightning：
┌──────────────────────────────────────────────────────────────┐
│ # 發送                                                       │
│ lightning-cli keysend <node_id> <amount> \\                   │
│   extratlvs='{"65537": "48656c6c6f"}'                        │
│                                                              │
│ # 接收（通過 hook 或 listinvoices）                          │
│ {                                                            │
│   "extra_tlvs": [                                            │
│     { "type": 65537, "value": "48656c6c6f" }                 │
│   ]                                                          │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">已知類型註冊</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`社區使用的 Custom Record 類型：

已知類型（非官方，社區共識）：
┌──────────────────────────────────────────────────────────────┐
│ 5482373484 (0x1466a3ac): Keysend preimage                    │
│   用於無發票的自發支付                                       │
│                                                              │
│ 34349334: Whatsat 文字訊息                                   │
│ 34349337: Whatsat 發送者                                     │
│ 34349339: Whatsat 時間戳                                     │
│ 34349343: Whatsat 簽名                                       │
│                                                              │
│ 7629169: Podcasting 2.0 boost                                │
│ 7629171: Podcasting 2.0 stream                               │
│                                                              │
│ 133773310: Zap (Nostr) sats                                  │
└──────────────────────────────────────────────────────────────┘

選擇新類型的建議：
┌──────────────────────────────────────────────────────────────┐
│ 1. 使用足夠大的隨機數（避免碰撞）                            │
│ 2. 使用奇數（確保可選性）                                    │
│ 3. 記錄你的類型使用                                          │
│ 4. 考慮向社區註冊                                            │
│                                                              │
│ 範例生成：                                                   │
│ import random                                                │
│ type_id = 65536 + random.randint(0, 2**32) | 1  # 確保奇數   │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">限制與考量</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Custom Records 限制：

大小限制：
┌──────────────────────────────────────────────────────────────┐
│ 洋蔥 payload 總大小有限：                                    │
│ ├── 每跳 payload 最大約 1300 bytes                           │
│ ├── 需要減去協議欄位的空間                                   │
│ └── Custom records 可用空間約 1000 bytes                     │
│                                                              │
│ 建議：                                                       │
│ ├── 保持資料簡潔                                             │
│ ├── 大資料使用哈希引用                                       │
│ └── 考慮壓縮                                                 │
└──────────────────────────────────────────────────────────────┘

隱私考量：
┌──────────────────────────────────────────────────────────────┐
│ Custom records 只對最終接收者可見：                          │
│ ├── 中間節點無法讀取（洋蔥加密）                             │
│ ├── 但接收者可以看到所有內容                                 │
│ └── 不要發送敏感資訊給不信任的接收者                         │
│                                                              │
│ 注意：                                                       │
│ ├── 資料未加密，只是洋蔥封裝                                 │
│ ├── 接收者可以儲存和分享                                     │
│ └── 考慮額外加密敏感資料                                     │
└──────────────────────────────────────────────────────────────┘

兼容性：
┌──────────────────────────────────────────────────────────────┐
│ 不是所有節點都支援自定義記錄：                               │
│ ├── 老版本可能忽略                                           │
│ ├── 某些實現可能有 bug                                       │
│ └── 測試目標接收者的支援情況                                 │
│                                                              │
│ LND: 完整支援                                                │
│ Core Lightning: 支援（可能需要配置）                         │
│ Eclair: 部分支援                                             │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">vs Onion Messages</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Onion messages 專門用於訊息傳遞，不需要支付。
        Custom records 附加在支付中。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">vs Invoice Description</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        發票描述對所有人可見。
        Custom records 只對接收者可見。
      </p>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>標準化進行中：</strong>
      Custom records 的使用正在標準化過程中。
      BOLT 12 的 payer_note 是正式化的一步。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/blob/master/04-onion-routing.md"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 4 Onion Routing</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/tlv-streams"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">TLV Streams</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/keysend"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Keysend</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/keysend"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Keysend</a
      >
      如何使用 custom records 實現無發票支付。
    </p>
  </div>
</ArticleLayout>
