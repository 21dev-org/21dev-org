---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Eltoo / LN-Symmetry"
  description="了解 Eltoo（也稱為 LN-Symmetry）如何通過對稱狀態更新簡化閃電網路通道機制，消除懲罰交易的需求。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Eltoo' },
  ]}
  difficulty="advanced"
  readingTime="15 分鐘"
  prevPage={{ title: 'Route Blinding', href: '/tech/lightning/route-blinding' }}
  nextPage={{ title: 'Multi-Path Payments', href: '/tech/lightning/mpp' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Eltoo？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Eltoo（發音類似 "L2"）是一種新的閃電網路通道更新機制，由 Christian Decker 等人於 2018
    年提出。它使用「對稱」的狀態更新取代了當前的「LN-Penalty」機制，
    大幅簡化了通道設計，並消除了對懲罰交易的需求。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>前置條件：</strong>
      Eltoo 需要 Bitcoin 添加 SIGHASH_ANYPREVOUT（APO）操作碼，這是一個尚未激活的軟分叉提案。 因此 Eltoo
      目前只是理論設計，無法在主網使用。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">當前機制的問題</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`LN-Penalty (Current Mechanism) Problems:

1. Asymmetric State
   Alice's commitment tx != Bob's commitment tx
   Each update produces two different transactions
   Increases complexity and potential errors

2. State Storage Burden
   Each channel update requires storing:
   • New commitment tx
   • Peer's revocation key
   • All HTLC timeout/success transactions

   10,000 updates ~ several GB of data!

3. Penalty Mechanism Risks
   • Must store all old states
   • Lost old states = cannot penalize cheater
   • Watchtower needs massive storage

4. Toxic State
   • Accidentally broadcasting old state may cause total loss
   • Hardware failure can cause disaster
   • Complex backup requirements`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Eltoo 設計</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Eltoo Core Concept:

Symmetric State:
Alice and Bob use the same update tx and settle tx

         Funding TX
         (2-of-2 multisig)
              |
              v
         Update TX (state n)
         Can be overwritten by state n+1
              |
              v
         Settlement TX
         Final balance distribution to Alice and Bob

Key Features:
• Anyone can "overwrite" old state with newer state
• No penalty mechanism needed
• Only need to store latest state`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">SIGHASH_ANYPREVOUT</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Eltoo 的關鍵是 SIGHASH_ANYPREVOUT（APO），一種新的簽名哈希標誌：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`SIGHASH_ANYPREVOUT Explained:

Traditional signature (SIGHASH_ALL):
  Signature commits to = Hash(
    all inputs (including txid and vout) +
    all outputs
  )
  -> Signature bound to specific input UTXO

ANYPREVOUT:
  Signature commits to = Hash(
    input's scriptPubKey (not txid/vout) +
    all outputs
  )
  -> Signature not bound to specific UTXO, can attach to any compatible output

This means:
  Update TX n+1 signature can spend:
  • Funding TX output
  • Or Update TX n output
  • Or any earlier Update TX output

  As long as output script is compatible!`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">狀態更新流程</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Eltoo State Transitions:

Initial state:
Funding TX --[state 0]--> Update TX 0 --> Settlement TX 0
                          Alice: 5 BTC
                          Bob:   5 BTC

Alice pays 1 BTC to Bob:
Funding TX --[state 1]--> Update TX 1 --> Settlement TX 1
                          Alice: 4 BTC
                          Bob:   6 BTC

Bob pays 2 BTC to Alice:
Funding TX --[state 2]--> Update TX 2 --> Settlement TX 2
                          Alice: 6 BTC
                          Bob:   4 BTC

Close channel (normal):
1. Both parties agree to use latest state
2. Broadcast Update TX 2
3. Wait for timelock
4. Broadcast Settlement TX 2

Close channel (someone cheats):
1. Alice broadcasts old Update TX 0
2. Bob notices, broadcasts Update TX 2
3. Update TX 2 "overwrites" Update TX 0
4. Settlement uses Settlement TX 2

No penalty! Just restores to correct state.`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">交易結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Eltoo Transaction Structure:

Funding TX:
  Output:
    2-of-2 MuSig (Alice + Bob)
    or Taproot output

Update TX (state n):
  Input:
    Signed with SIGHASH_ANYPREVOUT
    Can spend Funding TX or any earlier Update TX

  Output:
    <state_n+1 pubkey> CHECKSIG
    or after CSV timelock:
    <settlement pubkey> CHECKSIG

  nLockTime: state number (ensures ordering)

Settlement TX:
  Input:
    Spends Update TX output (after CSV)

  Outputs:
    Alice: X BTC
    Bob:   Y BTC
    (distributed according to latest state)`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Eltoo vs LN-Penalty</h2>

  <div class="overflow-x-auto mb-8">
    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 text-[var(--text-primary)]">特性</th>
          <th class="text-left py-3 px-4 text-[var(--text-primary)]">LN-Penalty（當前）</th>
          <th class="text-left py-3 px-4 text-[var(--text-primary)]">Eltoo</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">狀態對稱性</td>
          <td class="py-3 px-4 text-red-500">非對稱</td>
          <td class="py-3 px-4 text-green-500">對稱</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">存儲需求</td>
          <td class="py-3 px-4 text-red-500">O(n) - 所有舊狀態</td>
          <td class="py-3 px-4 text-green-500">O(1) - 只需最新</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">作惡懲罰</td>
          <td class="py-3 px-4">全額沒收</td>
          <td class="py-3 px-4">只是更正狀態</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">有毒備份</td>
          <td class="py-3 px-4 text-red-500">是（舊備份危險）</td>
          <td class="py-3 px-4 text-green-500">否（任何備份安全）</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">Watchtower 存儲</td>
          <td class="py-3 px-4 text-red-500">每次更新都要存</td>
          <td class="py-3 px-4 text-green-500">只存最新</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">多方通道</td>
          <td class="py-3 px-4 text-red-500">極其複雜</td>
          <td class="py-3 px-4 text-green-500">自然支持</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">Bitcoin 要求</td>
          <td class="py-3 px-4 text-green-500">當前已支援</td>
          <td class="py-3 px-4 text-yellow-500">需要 APO 軟分叉</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Channel Factories</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Eltoo 的一個重要應用是實現 Channel Factories（通道工廠）：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Channel Factory Concept:

Traditional mode: Each channel needs one on-chain tx
  Alice--Bob: 1 tx
  Alice--Carol: 1 tx
  Bob--Carol: 1 tx
  Total 3 on-chain transactions

Channel Factory:

      Factory Funding TX
      (N-of-N multisig)
      Alice + Bob + Carol + ...
              |
      +-------+-------+
      |               |
  Alice-Bob      Bob-Carol
   Channel        Channel

  Only 1 on-chain tx to open multiple channels!

Eltoo advantages:
• Multi-party coordination simpler (symmetric state)
• Anyone going offline doesn't cause penalty risk
• Can dynamically adjust channels within Factory`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">APO 軟分叉進展</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-blue-500/30 bg-blue-500/10">
      <h4 class="font-semibold text-blue-700 dark:text-blue-400 mb-2">
        BIP 118: SIGHASH_ANYPREVOUT
      </h4>
      <p class="text-sm text-[var(--text-secondary)]">
        原名 SIGHASH_NOINPUT，由 Christian Decker 提出。定義了新的簽名哈希模式。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-yellow-500/30 bg-yellow-500/10">
      <h4 class="font-semibold text-yellow-700 dark:text-yellow-400 mb-2">社群討論中</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        APO 提案已存在多年，但尚未進入激活流程。一些開發者擔心潛在的安全風險。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-purple-500/30 bg-purple-500/10">
      <h4 class="font-semibold text-purple-700 dark:text-purple-400 mb-2">替代方案</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        OP_CHECKTEMPLATEVERIFY (CTV) 和 OP_CAT 也可能實現類似功能，但設計不同。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://blockstream.com/eltoo.pdf"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Eltoo 論文</a
      >
    </li>
    <li>
      • <a
        href="https://github.com/bitcoin/bips/blob/master/bip-0118.mediawiki"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BIP 118: SIGHASH_ANYPREVOUT</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/commitment-tx"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">承諾交易（當前機制）</a
      >
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/mpp"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">多路徑支付</a
      >
      如何提高大額支付的成功率。
    </p>
  </div>
</ArticleLayout>
