---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Blinded Paths 盲化路徑"
  description="了解閃電網路的盲化路徑機制，如何保護收款人隱私並防止支付路徑暴露。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Blinded Paths' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'Route Blinding', href: '/tech/lightning/route-blinding' }}
  nextPage={{ title: 'BOLT12 Offers', href: '/tech/lightning/bolt12-offers' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是盲化路徑？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    盲化路徑（Blinded Paths）是一種隱私技術，允許收款人隱藏其節點身份和
    最後幾跳的路徑資訊。付款人只能看到路徑的起點（引入點），
    無法知道實際的收款人位置。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>收款人隱私：</strong>
      傳統發票暴露收款人節點 ID，盲化路徑則完全隱藏。
      即使付款人也無法確定誰是最終收款人。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">工作原理</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Blinded Path Mechanism

Traditional Routing vs Blinded Paths:

Traditional:
  Sender → A → B → C → Receiver
                       ↑
                   Exposed in invoice

Blinded:
  Sender → A → B → [Blinded Zone]
               ↑    ╔═══════════════════╗
         Introduction ║ C → Receiver    ║
            Point     ║ (encrypted)     ║
                      ╚═══════════════════╝

Blinding Process (by receiver):

1. Select introduction point
   • This is the last node visible to sender

2. Generate blinded data for each subsequent node:
   • blinded_node_id = node_id * blinding_factor
   • encrypted_data = encrypted routing info

3. Include blinded path in Offer/Invoice`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">密碼學基礎</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Blinding Cryptography

ECDH Key Derivation (for each node i in path):

1. Blinding factor derivation:
   e_i = SHA256(e_{i-1} || blinded_node_id_{i-1})

2. Blinded node ID:
   blinded_node_id_i = node_id_i * e_i

3. Shared secret (ECDH):
   ss_i = SHA256(e_i * node_id_i)
        = SHA256(e_i * k_i * G)
        = SHA256(k_i * blinded_node_id_i)  <- node can compute

Encrypted Data (encrypted_data_i via ChaCha20-Poly1305):

Contents:
• padding: optional padding
• short_channel_id: next hop channel
• payment_relay: fee and timelock info
• payment_constraints: payment restrictions
• next_blinding_override: optional blinding factor override

Key: HKDF(ss_i, "blinded_path")
Nonce: 0`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">路徑結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Blinded Path TLV Format

blinded_path:
┌─────────────────────────────────────────────────────────────┐
│ introduction_node_id: 33 bytes                              │
│   Real node ID of introduction point                        │
│                                                             │
│ blinding_point: 33 bytes                                    │
│   Initial blinding point (for ECDH)                         │
│                                                             │
│ blinded_hops: array                                         │
│   [0] blinded_node_id: 33 bytes                             │
│       encrypted_data: variable                              │
│   [1] blinded_node_id: 33 bytes                             │
│       encrypted_data: variable                              │
│   [n] last one is receiver                                  │
└─────────────────────────────────────────────────────────────┘

Sender's View:

Visible:
• introduction_node_id (can route to here)
• Number of blinded hops
• Total fee and timelock requirements

Hidden:
• Actual node IDs
• Channel IDs
• Receiver identity`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">中繼節點處理</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`How Nodes Process Blinded Payments

Receiving Blinded Onion:

Onion contains:
• current_blinding_point
• encrypted_data

Node Processing Steps:

1. Compute shared secret:
   ss = SHA256(private_key * current_blinding_point)

2. Decrypt encrypted_data:
   key = HKDF(ss, "blinded_path")
   data = ChaCha20-Poly1305_Decrypt(encrypted_data, key)

3. Extract from decrypted data:
   • Next hop channel ID
   • Fee and timelock
   • Next blinding point (if override exists)

4. Compute next blinding point (default):
   next_blinding = SHA256(ss || current_blinding) * current

5. Forward payment to specified channel`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT12 整合</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Blinded Paths in BOLT12

Blinded Paths in Offers:

offer_paths: one or more blinded paths

Buyer flow:
1. Receives Offer
2. Selects a blinded path
3. Sends invoice_request via that path

Seller flow:
1. Receives request via blinded path
2. Generates Invoice (may also contain blinded paths)
3. Replies via onion message

Multiple Blinded Paths - Benefits:
• Redundancy: if one path fails, use another
• Privacy: harder to correlate different requests
• Availability: distribute load

Example:
offer_paths:
  - path_1: A -> [blinded] -> Receiver
  - path_2: B -> [blinded] -> Receiver
  - path_3: C -> [blinded] -> Receiver`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">隱私保護</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">付款人隱私</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        收款人只看到引入點，不知道付款人的真實位置或路徑。
        洋蔥路由保護付款人身份。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">收款人隱私</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        盲化路徑隱藏收款人節點和最後幾跳。
        付款人無法知道誰是最終收款人。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">中繼節點隱私</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        盲化區域的節點 ID 被隱藏，中繼節點無法識別彼此。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">抗關聯性</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        每次使用不同盲化因子，相同路徑看起來不同，
        防止跨支付關聯。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實現狀態</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Implementation Support Status

Core Lightning:
  [x] Full blinded path support
  [x] BOLT12 Offers integration
  [x] Onion message support

  # Create Offer with blinded path
  lightning-cli offer any "my offer"

LND:
  [~] Partial support (in development)
  [~] Route blinding as forwarding node
  [ ] BOLT12 not fully supported yet

Eclair:
  [x] Blinded path support
  [x] BOLT12 partial support
  [x] Used in Phoenix wallet

LDK:
  [x] Blinded path construction
  [x] Blinded path parsing
  [x] BOLT12 support`}</pre>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>路徑長度：</strong>
      盲化路徑增加 payload 大小。建議限制盲化跳數在 2-3 跳，
      平衡隱私和效率。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/blob/master/04-onion-routing.md#route-blinding"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 4 Route Blinding</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/route-blinding"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">路徑盲化概覽</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt12-offers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT12 Offers</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/bolt12-offers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT12 Offers</a
      >
      如何使用盲化路徑提供隱私支付請求。
    </p>
  </div>
</ArticleLayout>
