---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="HTLC Intercept HTLC 攔截"
  description="了解 HTLC 攔截功能，如何實現即時通道、自定義路由邏輯和進階支付處理。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'HTLC Intercept' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'JIT Channels', href: '/tech/lightning/jit-channels' }}
  nextPage={{ title: 'Hold Invoices', href: '/tech/lightning/hold-invoices' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 HTLC Intercept？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    HTLC Intercept 是一個強大的節點功能，允許外部程式在 HTLC 被自動處理前
    介入決策過程。這實現了 JIT 通道、自定義路由邏輯等進階功能。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>LSP 核心功能：</strong>
      HTLC Intercept 是 Lightning Service Providers 實現即時通道開設
      和流動性管理的關鍵技術。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">工作原理</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`HTLC Intercept 流程：

正常 HTLC 轉發（無攔截）：
┌──────────────────────────────────────────────────────────────┐
│ Incoming HTLC                                                │
│      │                                                       │
│      ▼                                                       │
│ ┌─────────────┐                                              │
│ │   節點      │───────> Outgoing HTLC（自動轉發）            │
│ └─────────────┘                                              │
└──────────────────────────────────────────────────────────────┘

使用 HTLC Intercept：
┌──────────────────────────────────────────────────────────────┐
│ Incoming HTLC                                                │
│      │                                                       │
│      ▼                                                       │
│ ┌─────────────┐     ┌─────────────────────┐                  │
│ │   節點      │────>│   Interceptor       │                  │
│ └─────────────┘     │   (外部程式)         │                  │
│      ▲              └─────────────────────┘                  │
│      │                       │                               │
│      │                       ▼                               │
│      │              ┌─────────────────────┐                  │
│      │              │   決策邏輯          │                  │
│      │              │   - 轉發？          │                  │
│      │              │   - 拒絕？          │                  │
│      │              │   - 結算？          │                  │
│      │              │   - 修改？          │                  │
│      │              └─────────────────────┘                  │
│      │                       │                               │
│      └───────────────────────┘                               │
│         InterceptResponse                                    │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">LND 實現</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`LND HTLC Interceptor API：

啟用攔截：
┌──────────────────────────────────────────────────────────────┐
│ # gRPC 流式 API                                              │
│ rpc HtlcInterceptor(stream ForwardHtlcInterceptResponse)     │
│     returns (stream ForwardHtlcInterceptRequest);            │
│                                                              │
│ 當建立連接後，所有轉發 HTLC 都會被攔截                       │
└──────────────────────────────────────────────────────────────┘

InterceptRequest 結構：
┌──────────────────────────────────────────────────────────────┐
│ message ForwardHtlcInterceptRequest {                        │
│     // 唯一標識符                                            │
│     bytes incoming_circuit_key = 1;                          │
│                                                              │
│     // 入站通道 ID                                           │
│     uint64 incoming_chan_id = 2;                             │
│                                                              │
│     // HTLC ID                                               │
│     uint64 incoming_htlc_id = 3;                             │
│                                                              │
│     // 出站通道（如果已知）                                  │
│     uint64 outgoing_requested_chan_id = 4;                   │
│                                                              │
│     // 支付金額                                              │
│     uint64 incoming_amount_msat = 5;                         │
│     uint64 outgoing_amount_msat = 6;                         │
│                                                              │
│     // 時間鎖                                                │
│     uint32 incoming_expiry = 7;                              │
│     uint32 outgoing_expiry = 8;                              │
│                                                              │
│     // 支付哈希                                              │
│     bytes payment_hash = 9;                                  │
│                                                              │
│     // 洋蔥數據（TLV 格式）                                  │
│     bytes onion_blob = 10;                                   │
│                                                              │
│     // 自定義記錄                                            │
│     map<uint64, bytes> custom_records = 11;                  │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘

InterceptResponse 選項：
┌──────────────────────────────────────────────────────────────┐
│ message ForwardHtlcInterceptResponse {                       │
│     bytes incoming_circuit_key = 1;                          │
│                                                              │
│     ResolveHoldForwardAction action = 2;                     │
│     // RESUME: 繼續正常轉發                                  │
│     // FAIL: 拒絕並返回錯誤                                  │
│     // SETTLE: 直接結算（提供 preimage）                     │
│                                                              │
│     bytes preimage = 3;  // 用於 SETTLE                      │
│                                                              │
│     // 失敗原因                                              │
│     FailureCode failure_code = 4;                            │
│     bytes failure_message = 5;                               │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">使用場景</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`HTLC Intercept 應用場景：

1. JIT (Just-In-Time) 通道：
┌──────────────────────────────────────────────────────────────┐
│ 場景：用戶沒有足夠的入站容量接收支付                         │
│                                                              │
│ 流程：                                                       │
│ 1. 付款人 → LSP（HTLC 被攔截）                               │
│ 2. Interceptor 檢測：目標用戶沒有通道                        │
│ 3. LSP 開設新通道給用戶（扣除費用）                          │
│ 4. 通道確認後，RESUME 轉發 HTLC                              │
│ 5. 用戶收到支付                                              │
│                                                              │
│ 結果：用戶獲得新通道 + 支付（無需預先開設通道）              │
└──────────────────────────────────────────────────────────────┘

2. 動態費率調整：
┌──────────────────────────────────────────────────────────────┐
│ 場景：根據當前網絡狀況動態調整路由費用                       │
│                                                              │
│ 實現：                                                       │
│ incoming_fee = incoming_amount - outgoing_amount             │
│                                                              │
│ if network_congestion > threshold:                           │
│     if incoming_fee < dynamic_fee:                           │
│         FAIL(FEE_INSUFFICIENT)                               │
│     else:                                                    │
│         RESUME                                               │
└──────────────────────────────────────────────────────────────┘

3. 支付驗證/過濾：
┌──────────────────────────────────────────────────────────────┐
│ 場景：只接受符合特定條件的支付                               │
│                                                              │
│ 檢查項目：                                                   │
│ ├── payment_hash 是否在白名單                                │
│ ├── 金額是否在允許範圍                                       │
│ ├── 來源通道是否可信                                         │
│ └── custom_records 是否包含必要資訊                          │
│                                                              │
│ if not validate(htlc):                                       │
│     FAIL(INCORRECT_OR_UNKNOWN_PAYMENT_DETAILS)               │
└──────────────────────────────────────────────────────────────┘

4. 虛擬通道路由：
┌──────────────────────────────────────────────────────────────┐
│ 場景：路由到沒有直接通道的目標                               │
│                                                              │
│ 實現：                                                       │
│ 1. 攔截 HTLC                                                 │
│ 2. 識別真實目標（from custom_records）                       │
│ 3. 通過其他路徑轉發                                          │
│ 4. 收到 preimage 後 SETTLE                                   │
│                                                              │
│ 這實現了「虛擬 SCID」和靈活的路由策略                        │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Core Lightning 實現</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`CLN 的 HTLC Hook：

htlc_accepted hook：
┌──────────────────────────────────────────────────────────────┐
│ {                                                            │
│   "onion": {                                                 │
│     "payload": "<hex>",                                      │
│     "type": "tlv",                                           │
│     "forward_amount": "1000msat",                            │
│     "outgoing_cltv_value": 800100,                           │
│     "next_channel": "123x456x0",                             │
│     "custom_records": { ... }                                │
│   },                                                         │
│   "htlc": {                                                  │
│     "amount": "1010msat",                                    │
│     "cltv_expiry": 800140,                                   │
│     "cltv_expiry_relative": 40,                              │
│     "payment_hash": "<hex>"                                  │
│   },                                                         │
│   "forward_to": "<node_id>"                                  │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘

Hook 回應選項：
┌──────────────────────────────────────────────────────────────┐
│ 繼續處理：                                                   │
│ { "result": "continue" }                                     │
│                                                              │
│ 拒絕：                                                       │
│ {                                                            │
│   "result": "fail",                                          │
│   "failure_message": "<onion_failure_message>"               │
│ }                                                            │
│                                                              │
│ 結算：                                                       │
│ {                                                            │
│   "result": "resolve",                                       │
│   "payment_key": "<preimage_hex>"                            │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">安全考量</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`HTLC Intercept 安全要點：

超時風險：
┌──────────────────────────────────────────────────────────────┐
│ ⚠ HTLC 有過期時間！                                          │
│                                                              │
│ 如果 Interceptor：                                           │
│ ├── 處理太慢                                                 │
│ ├── 掛掉沒有回應                                             │
│ └── 決策時間過長                                             │
│                                                              │
│ 後果：                                                       │
│ ├── HTLC 過期，上游節點強制關閉通道                          │
│ ├── 資金可能損失                                             │
│ └── 節點聲譽受損                                             │
│                                                              │
│ 對策：                                                       │
│ ├── 設定 Interceptor 超時                                    │
│ ├── 超時後自動 RESUME 或 FAIL                                │
│ └── 監控 HTLC 剩餘時間                                       │
└──────────────────────────────────────────────────────────────┘

連接中斷處理：
┌──────────────────────────────────────────────────────────────┐
│ 如果 Interceptor 連接斷開：                                  │
│                                                              │
│ LND 行為（可配置）：                                         │
│ ├── 自動 FAIL 所有待處理 HTLC                                │
│ └── 或自動 RESUME 所有待處理 HTLC                            │
│                                                              │
│ 建議：                                                       │
│ ├── 使用高可用架構                                           │
│ ├── 快速重連機制                                             │
│ └── 監控 Interceptor 健康狀態                                │
└──────────────────────────────────────────────────────────────┘

惡意 Interceptor 防護：
┌──────────────────────────────────────────────────────────────┐
│ Interceptor 有完整控制權，可能：                             │
│ ├── 延遲支付（griefing）                                     │
│ ├── 選擇性拒絕                                               │
│ └── 分析支付模式（隱私風險）                                 │
│                                                              │
│ 只應運行自己信任的 Interceptor 程式                          │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">vs Invoice Hooks</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Invoice hooks 在發票創建時觸發。
        HTLC intercept 在支付路由時觸發。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">vs Hold Invoices</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Hold invoices 延遲結算最終節點的 HTLC。
        Intercept 可以處理轉發的 HTLC。
      </p>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>效能影響：</strong>
      每個轉發 HTLC 都會經過 Interceptor，確保處理邏輯高效。
      避免阻塞操作和外部 API 調用。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://docs.lightning.engineering/lightning-network-tools/lnd/htlc-interceptor"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">LND HTLC Interceptor 文檔</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/jit-channels"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">JIT Channels</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/hold-invoices"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Hold Invoices</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/hold-invoices"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Hold Invoices</a
      >
      如何延遲支付結算。
    </p>
  </div>
</ArticleLayout>
