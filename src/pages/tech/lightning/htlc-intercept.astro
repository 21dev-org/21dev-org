---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="HTLC Intercept HTLC 攔截"
  description="了解 HTLC 攔截功能，如何實現即時通道、自定義路由邏輯和進階支付處理。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'HTLC Intercept' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'JIT Channels', href: '/tech/lightning/jit-channels' }}
  nextPage={{ title: 'Hold Invoices', href: '/tech/lightning/hold-invoices' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 HTLC Intercept？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    HTLC Intercept 是一個強大的節點功能，允許外部程式在 HTLC 被自動處理前 介入決策過程。這實現了 JIT
    通道、自定義路由邏輯等進階功能。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>LSP 核心功能：</strong>
      HTLC Intercept 是 Lightning Service Providers 實現即時通道開設 和流動性管理的關鍵技術。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">工作原理</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`HTLC Intercept Flow:

Normal HTLC Forwarding (no intercept):

  Incoming HTLC
       |
       v
  +----------+
  |   Node   |-------> Outgoing HTLC (auto forward)
  +----------+

With HTLC Intercept:

  Incoming HTLC
       |
       v
  +----------+      +------------------+
  |   Node   |----->|   Interceptor    |
  +----------+      | (external app)   |
       ^            +------------------+
       |                    |
       |                    v
       |            +------------------+
       |            | Decision Logic   |
       |            |  - Forward?      |
       |            |  - Reject?       |
       |            |  - Settle?       |
       |            |  - Modify?       |
       |            +------------------+
       |                    |
       +--------------------+
          InterceptResponse`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">LND 實現</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`LND HTLC Interceptor API:

Enabling Intercept:

# gRPC streaming API
rpc HtlcInterceptor(stream ForwardHtlcInterceptResponse)
    returns (stream ForwardHtlcInterceptRequest);

Once connected, all forwarding HTLCs will be intercepted

InterceptRequest Structure:

message ForwardHtlcInterceptRequest {
    bytes incoming_circuit_key = 1;   // Unique identifier
    uint64 incoming_chan_id = 2;      // Inbound channel ID
    uint64 incoming_htlc_id = 3;      // HTLC ID
    uint64 outgoing_requested_chan_id = 4;  // Outbound channel (if known)
    uint64 incoming_amount_msat = 5;  // Payment amount
    uint64 outgoing_amount_msat = 6;
    uint32 incoming_expiry = 7;       // Timelock
    uint32 outgoing_expiry = 8;
    bytes payment_hash = 9;           // Payment hash
    bytes onion_blob = 10;            // Onion data (TLV format)
    map<uint64, bytes> custom_records = 11;  // Custom records
}

InterceptResponse Options:

message ForwardHtlcInterceptResponse {
    bytes incoming_circuit_key = 1;

    ResolveHoldForwardAction action = 2;
    // RESUME: Continue normal forwarding
    // FAIL: Reject and return error
    // SETTLE: Settle directly (provide preimage)

    bytes preimage = 3;  // For SETTLE

    // Failure reason
    FailureCode failure_code = 4;
    bytes failure_message = 5;
}`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">使用場景</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`HTLC Intercept Use Cases:

1. JIT (Just-In-Time) Channels:

Scenario: User lacks sufficient inbound capacity to receive payment

Flow:
  1. Payer -> LSP (HTLC intercepted)
  2. Interceptor detects: Target user has no channel
  3. LSP opens new channel to user (deducting fee)
  4. After channel confirms, RESUME to forward HTLC
  5. User receives payment

Result: User gets new channel + payment (no pre-opened channel needed)

2. Dynamic Fee Adjustment:

Scenario: Dynamically adjust routing fees based on network conditions

Implementation:
  incoming_fee = incoming_amount - outgoing_amount

  if network_congestion > threshold:
      if incoming_fee < dynamic_fee:
          FAIL(FEE_INSUFFICIENT)
      else:
          RESUME

3. Payment Validation/Filtering:

Scenario: Only accept payments meeting specific criteria

Checks:
  • payment_hash in whitelist?
  • Amount within allowed range?
  • Source channel trusted?
  • custom_records contain required info?

  if not validate(htlc):
      FAIL(INCORRECT_OR_UNKNOWN_PAYMENT_DETAILS)

4. Virtual Channel Routing:

Scenario: Route to target without direct channel

Implementation:
  1. Intercept HTLC
  2. Identify real target (from custom_records)
  3. Forward via other path
  4. SETTLE after receiving preimage

This enables "virtual SCID" and flexible routing strategies`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Core Lightning 實現</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`CLN HTLC Hook:

htlc_accepted hook:

{
  "onion": {
    "payload": "<hex>",
    "type": "tlv",
    "forward_amount": "1000msat",
    "outgoing_cltv_value": 800100,
    "next_channel": "123x456x0",
    "custom_records": { ... }
  },
  "htlc": {
    "amount": "1010msat",
    "cltv_expiry": 800140,
    "cltv_expiry_relative": 40,
    "payment_hash": "<hex>"
  },
  "forward_to": "<node_id>"
}

Hook Response Options:

Continue processing:
  { "result": "continue" }

Reject:
  {
    "result": "fail",
    "failure_message": "<onion_failure_message>"
  }

Settle:
  {
    "result": "resolve",
    "payment_key": "<preimage_hex>"
  }`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">安全考量</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`HTLC Intercept Security Considerations:

Timeout Risk:

WARNING: HTLCs have expiration times!

If Interceptor:
  • Processes too slowly
  • Crashes without responding
  • Takes too long to decide

Consequences:
  • HTLC expires, upstream node force-closes channel
  • Funds may be lost
  • Node reputation damaged

Countermeasures:
  • Set Interceptor timeout
  • Auto RESUME or FAIL on timeout
  • Monitor HTLC remaining time

Disconnection Handling:

If Interceptor connection drops:

LND behavior (configurable):
  • Auto FAIL all pending HTLCs
  • Or auto RESUME all pending HTLCs

Recommendations:
  • Use high-availability architecture
  • Fast reconnection mechanism
  • Monitor Interceptor health

Malicious Interceptor Protection:

Interceptor has full control, could:
  • Delay payments (griefing)
  • Selectively reject
  • Analyze payment patterns (privacy risk)

Only run Interceptor programs you trust`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">vs Invoice Hooks</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Invoice hooks 在發票創建時觸發。 HTLC intercept 在支付路由時觸發。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">vs Hold Invoices</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Hold invoices 延遲結算最終節點的 HTLC。 Intercept 可以處理轉發的 HTLC。
      </p>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>效能影響：</strong>
      每個轉發 HTLC 都會經過 Interceptor，確保處理邏輯高效。 避免阻塞操作和外部 API 調用。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://docs.lightning.engineering/lightning-network-tools/lnd/htlc-interceptor"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">LND HTLC Interceptor 文檔</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/jit-channels"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">JIT Channels</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/hold-invoices"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Hold Invoices</a
      >
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/hold-invoices"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Hold Invoices</a
      >
      如何延遲支付結算。
    </p>
  </div>
</ArticleLayout>
