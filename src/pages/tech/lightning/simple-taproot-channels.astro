---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Simple Taproot Channels 簡單 Taproot 通道"
  description="深入了解 Simple Taproot Channels 的技術實現，包括 MuSig2 簽名、Taproot 輸出結構和向後兼容性。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Simple Taproot Channels' },
  ]}
  difficulty="advanced"
  readingTime="15 分鐘"
  prevPage={{ title: 'Taproot Channels', href: '/tech/lightning/taproot-channels' }}
  nextPage={{ title: 'MuSig2', href: '/tech/lightning/musig2' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">
    什麼是 Simple Taproot Channels？
  </h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Simple Taproot Channels (STC) 是閃電網路向 Taproot 過渡的第一階段。 它保持現有通道結構，同時引入
    MuSig2 和 Taproot 的優勢。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>LND 0.17+：</strong>
      Simple Taproot Channels 已在 LND 0.17 中實驗性支援。 這是邁向完整 Taproot 閃電網路的重要一步。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">與傳統通道的比較</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Traditional Channels vs Simple Taproot Channels:

Traditional P2WSH Channel:

Funding Output:
  OP_2 <pubkeyA> <pubkeyB> OP_2 OP_CHECKMULTISIG

Characteristics:
  • 2-of-2 multisig clearly visible
  • Script exposed on-chain
  • Obviously a Lightning channel

Simple Taproot Channel:

Funding Output:
  OP_1 <aggregated_pubkey>

Internal Structure:
  • Internal Key: MuSig2(pubkeyA, pubkeyB)
  • Taproot Tree: (empty for keypath spend)

Characteristics:
  • Looks like ordinary single-sig output
  • No script exposure on cooperative close
  • Significantly improved on-chain privacy`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Funding 輸出結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Simple Taproot Funding Output:

Key Aggregation:

1. Both parties exchange public keys
   Alice: pubkey_a
   Bob: pubkey_b

2. MuSig2 key aggregation
   aggregate_key = MuSig2_KeyAgg(pubkey_a, pubkey_b)

3. Build Taproot output
   internal_key = aggregate_key
   merkle_root = (empty)
   output_key = internal_key + H(internal_key || merkle_root)*G

4. Funding output
   scriptPubKey: OP_1 <output_key>
   This is a standard P2TR output

Why Use Empty Taproot Tree?

Simple Taproot = keypath spend only

Advantages:
  • Cooperative close looks completely ordinary
  • No script exposure
  • Minimal on-chain footprint

Disadvantages:
  • Non-cooperative case still reveals commitment tx structure
  • Less flexible than full Taproot channels`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">承諾交易結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Simple Taproot Commitment Transaction:

Input Signing Method:

Traditional: Two separate ECDSA signatures

Simple Taproot:
  • MuSig2 aggregated signature
  • Single Schnorr signature
  • 64 bytes (vs traditional ~144 bytes)

Commitment Transaction Outputs (similar structure):

to_local Output (using P2TR):
  Internal Key: revocation_pubkey

  Script Path (leaf):
    <local_delayedpubkey>
    OP_CHECKSIG
    <to_self_delay>
    OP_CHECKSEQUENCEVERIFY
    OP_DROP

to_remote Output (using P2TR):
  Simple P2TR output
  Counterparty can spend directly via keypath

HTLC Output (using P2TR):

Offered HTLC:
  Internal Key: revocation_pubkey

  Script Leaves:
  [0] Success path: <remote_htlcpubkey> CHECKSIG
      (with preimage in annex)

  [1] Timeout path: <local_htlcpubkey> CHECKSIG
      <cltv_expiry> CHECKLOCKTIMEVERIFY

Received HTLC: Similar but paths reversed`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">MuSig2 簽名流程</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Commitment Transaction MuSig2 Signing:

Two-Round Protocol:

  Alice                                    Bob
    |                                        |
    |  [Round 1: Nonce Exchange]             |
    |                                        |
    |---- nonce_a -------------------------->|
    |<--- nonce_b ---------------------------|
    |                                        |
    |  [Compute aggregate nonce]             |
    |  R = R_a + R_b                         |
    |                                        |
    |  [Round 2: Partial Signature]          |
    |                                        |
    |---- partial_sig_a -------------------->|
    |<--- partial_sig_b ---------------------|
    |                                        |
    |  [Combine signatures]                  |
    |  sig = partial_sig_a + partial_sig_b   |

Difference from Traditional Signing:

Traditional 2-of-2:
  • Alice signs -> sig_a
  • Bob signs -> sig_b
  • Witness: <sig_a> <sig_b> <script>

MuSig2:
  • Alice partial_sig -> s_a
  • Bob partial_sig -> s_b
  • Aggregate -> sig = (R, s_a + s_b)
  • Witness: <sig> (single signature)

Savings: ~80 bytes per commitment tx`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">通道生命週期</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Simple Taproot Channel Lifecycle:

Opening:

1. open_channel2 message
   • channel_type = option_taproot
   • funding_pubkey (for MuSig2)

2. accept_channel2 message
   • funding_pubkey

3. MuSig2 key aggregation
   • Compute aggregate public key

4. tx_add_input / tx_add_output
   • Dual-funded (if used)

5. commitment_signed (using MuSig2 nonces)
   • Exchange nonces
   • Exchange partial signatures

6. tx_signatures
   • Funding transaction signatures

Operation:

Updating commitment transaction:

1. update_add_htlc / update_fulfill_htlc / ...

2. commitment_signed
   • Contains MuSig2 nonce
   • Contains partial signature

3. revoke_and_ack
   • Reveal previous state's revocation key
   • Send new nonce (for next round)

Note: Requires additional nonce state management

Closing:

Cooperative close (ideal case):
  • shutdown message
  • closing_signed (using MuSig2)
  • On-chain shows only P2TR -> P2TR/P2WPKH
    Looks like ordinary single-sig transaction!

Non-cooperative close:
  • Broadcast commitment transaction
  • Reveals Taproot script path
  • Still smaller than traditional channels`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Gossip 與隱私</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Taproot Channel Gossip:

channel_announcement Changes:

Traditional:
  • bitcoin_key_1, bitcoin_key_2
  • Signature proves ownership of funding output

Taproot:
  • Need to prove ownership of aggregate key
  • Uses MuSig2 signature
  • New message format (pending standardization)

Chain Analysis Resistance:

On cooperative close:
  • Input: P2TR (looks like single-sig)
  • Output: P2TR/P2WPKH
  • Cannot determine from chain that it's a Lightning channel

Even for public channels:
  • Gossip participation is optional
  • Private channels completely hidden
  • Channel capacity no longer easily trackable`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">優點</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        隱私提升、費用降低、向後兼容。 是 Taproot 閃電的第一步。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">限制</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        非合作關閉仍揭露腳本。 完整 PTLCs 需要更多工作。
      </p>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>實驗性功能：</strong>
      Simple Taproot Channels 仍在開發中。 生產環境使用前請確認節點版本和對等節點支援。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/pull/995"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Simple Taproot Channels PR</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/musig2"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">MuSig2 簽名</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/taproot-channels"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Taproot Channels 概述</a
      >
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/musig2"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">MuSig2</a
      >
      如何實現安全的多方簽名。
    </p>
  </div>
</ArticleLayout>
