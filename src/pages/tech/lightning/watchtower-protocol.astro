---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Watchtower Protocol 瞭望塔協議"
  description="深入了解閃電網路瞭望塔的技術實現，包括協議細節、資料結構和隱私考量。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Watchtower Protocol' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'Watchtowers', href: '/tech/lightning/watchtowers' }}
  nextPage={{ title: 'Channel Jamming', href: '/tech/lightning/channel-jamming' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">瞭望塔協議概述</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    瞭望塔協議定義了客戶端和瞭望塔服務器之間的通訊方式。
    協議設計需要平衡安全性、隱私和效率。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>BOLT 13 草案：</strong>
      瞭望塔協議尚未完全標準化。不同實現可能有不同的協議細節，
      但核心概念相似。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">核心資料結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`瞭望塔資料結構：

Justice Transaction Blob：
┌──────────────────────────────────────────────────────────────┐
│ 客戶端發送給瞭望塔的加密資料：                               │
│                                                              │
│ 明文內容：                                                   │
│ ├── sweep_address: 懲罰資金發送目的地                        │
│ ├── revocation_key: 撤銷私鑰                                 │
│ ├── to_local_delay_key: 延遲支付私鑰                         │
│ └── to_remote_key: 遠端支付私鑰（可選）                      │
│                                                              │
│ 或者直接包含：                                               │
│ └── 預簽名的 Justice Transaction                             │
└──────────────────────────────────────────────────────────────┘

Locator（定位器）：
┌──────────────────────────────────────────────────────────────┐
│ 用於匹配區塊鏈上的作弊交易：                                 │
│                                                              │
│ locator = txid[:16]（前 16 bytes）                           │
│                                                              │
│ 設計考量：                                                   │
│ ├── 足夠長以避免碰撞                                         │
│ ├── 足夠短以節省儲存                                         │
│ └── 不揭露完整 txid（隱私）                                  │
└──────────────────────────────────────────────────────────────┘

Encryption Key：
┌──────────────────────────────────────────────────────────────┐
│ blob 使用 txid 加密：                                        │
│                                                              │
│ encryption_key = SHA256(breach_txid)                         │
│                                                              │
│ 加密方案：                                                   │
│ ├── ChaCha20-Poly1305                                        │
│ └── AES-GCM（替代方案）                                      │
│                                                              │
│ 結果：                                                       │
│ ├── 瞭望塔無法讀取 blob 內容                                 │
│ ├── 只有當作弊交易出現，才能解密                             │
│ └── 作弊交易 txid 就是解密金鑰                               │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">協議訊息</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`客戶端-瞭望塔通訊：

會話建立：
┌──────────────────────────────────────────────────────────────┐
│ 客戶端                                瞭望塔                 │
│     │                                    │                   │
│     │──── CreateSession ────────────────>│                   │
│     │     {                              │                   │
│     │       blob_type,                   │                   │
│     │       max_updates,                 │                   │
│     │       reward_address (optional)    │                   │
│     │     }                              │                   │
│     │                                    │                   │
│     │<─── CreateSessionReply ────────────│                   │
│     │     {                              │                   │
│     │       session_id,                  │                   │
│     │       accepted / rejected,         │                   │
│     │       fee_rate                     │                   │
│     │     }                              │                   │
└──────────────────────────────────────────────────────────────┘

狀態更新：
┌──────────────────────────────────────────────────────────────┐
│ 客戶端                                瞭望塔                 │
│     │                                    │                   │
│     │──── StateUpdate ──────────────────>│                   │
│     │     {                              │                   │
│     │       session_id,                  │                   │
│     │       seq_num,                     │                   │
│     │       locator,                     │                   │
│     │       encrypted_blob               │                   │
│     │     }                              │                   │
│     │                                    │                   │
│     │<─── StateUpdateReply ──────────────│                   │
│     │     {                              │                   │
│     │       code: ACCEPTED / REJECTED,   │                   │
│     │       last_applied                 │                   │
│     │     }                              │                   │
└──────────────────────────────────────────────────────────────┘

刪除會話：
┌──────────────────────────────────────────────────────────────┐
│ DeleteSession {                                              │
│   session_id                                                 │
│ }                                                            │
│                                                              │
│ 用於通道關閉後清理資源                                       │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">瞭望塔處理流程</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`瞭望塔監控和回應：

監控階段：
┌──────────────────────────────────────────────────────────────┐
│ 每個新區塊：                                                 │
│                                                              │
│ for each tx in block:                                        │
│   locator = tx.txid[:16]                                     │
│   if locator in database:                                    │
│     # 可能的作弊！                                           │
│     blob = database.get(locator)                             │
│     key = SHA256(tx.txid)                                    │
│     try:                                                     │
│       justice_data = decrypt(blob, key)                      │
│       broadcast_justice_tx(justice_data, tx)                 │
│     except DecryptionError:                                  │
│       # 誤報（locator 碰撞）                                 │
│       continue                                               │
└──────────────────────────────────────────────────────────────┘

構建 Justice Transaction：
┌──────────────────────────────────────────────────────────────┐
│ 使用解密的資料：                                             │
│                                                              │
│ 1. 識別作弊承諾交易的輸出                                    │
│    ├── to_local 輸出（延遲）                                 │
│    ├── to_remote 輸出                                        │
│    └── HTLC 輸出                                             │
│                                                              │
│ 2. 構建花費交易                                              │
│    ├── 使用撤銷私鑰簽名                                      │
│    ├── 設定適當費率                                          │
│    └── 發送到 sweep_address                                  │
│                                                              │
│ 3. 廣播 Justice Transaction                                  │
│    ├── 使用最高費率                                          │
│    └── 監控確認                                              │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">隱私保護</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`隱私設計：

瞭望塔不知道什麼：
┌──────────────────────────────────────────────────────────────┐
│ ✗ 客戶端身份（可以使用 Tor）                                 │
│ ✗ 通道對手方                                                 │
│ ✗ 通道容量                                                   │
│ ✗ 正常的交易活動                                             │
│ ✗ 資金金額（直到作弊發生）                                   │
│ ✗ blob 內容（直到作弊發生）                                  │
└──────────────────────────────────────────────────────────────┘

瞭望塔知道什麼：
┌──────────────────────────────────────────────────────────────┐
│ ✓ 客戶端有閃電通道                                           │
│ ✓ 通道狀態更新的頻率                                         │
│ ✓ 大約的通道數量（按會話數）                                 │
│ ✓ 作弊發生時的完整交易                                       │
└──────────────────────────────────────────────────────────────┘

進一步隱私增強：
┌──────────────────────────────────────────────────────────────┐
│ 1. 使用多個瞭望塔                                            │
│    └── 分散信任，無單點知識                                  │
│                                                              │
│ 2. 添加假更新                                                │
│    └── 混淆真實活動模式                                      │
│                                                              │
│ 3. 延遲更新                                                  │
│    └── 批量發送，隱藏即時活動                                │
│                                                              │
│ 4. Tor 連接                                                  │
│    └── 隱藏 IP 地址                                          │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">獎勵機制</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Altruistic 模式</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        瞭望塔免費提供服務。所有懲罰資金歸客戶端。
        適合個人運行的瞭望塔。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Reward 模式</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        瞭望塔從懲罰資金中獲得部分獎勵。
        激勵第三方提供可靠服務。
      </p>
    </div>
  </div>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`獎勵交易結構：

Justice Transaction with Reward：
┌──────────────────────────────────────────────────────────────┐
│ 輸入：                                                       │
│ └── 作弊承諾交易的輸出                                       │
│                                                              │
│ 輸出：                                                       │
│ ├── [0] 瞭望塔獎勵：X sats                                   │
│ │       to: reward_address（瞭望塔提供）                     │
│ └── [1] 客戶端餘額：剩餘 - 費用                              │
│         to: sweep_address（客戶端提供）                      │
│                                                              │
│ 獎勵比例協商：                                               │
│ ├── 固定金額                                                 │
│ ├── 百分比                                                   │
│ └── 複合模式                                                 │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>可靠性考量：</strong>
      選擇瞭望塔時考慮其在線率、響應時間和聲譽。
      使用多個瞭望塔增加可靠性。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightningnetwork/lnd/blob/master/watchtower/wtclient/client.go"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">LND Watchtower Client</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/watchtowers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">瞭望塔概述</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/penalty-tx"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">懲罰交易</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/channel-jamming"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">通道堵塞</a
      >
      問題及其防禦。
    </p>
  </div>
</ArticleLayout>
