---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Async Payments 非同步支付"
  description="了解非同步支付如何讓離線用戶也能接收閃電網路支付，解決移動設備的在線要求問題。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Async Payments' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'Channel Jamming', href: '/tech/lightning/channel-jamming' }}
  nextPage={{ title: 'LNURL', href: '/tech/lightning/lnurl' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">在線要求問題</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    閃電網路的設計假設雙方在支付時都在線。接收方需要在線來生成發票、揭示 preimage、
    更新通道狀態。這對服務器節點沒問題，但對移動設備用戶是個挑戰——
    你不能要求用戶的手機 24/7 在線才能收款。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>核心問題：</strong>
      傳統閃電網路需要接收方在線來完成支付。非同步支付的目標是讓離線用戶也能「收款」，
      然後在上線時完成結算。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">當前解決方案的局限</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Existing Solutions and Their Problems:

1. Custodial Wallets
   + Simple, can receive anytime
   - Funds controlled by third party
   - Privacy risk
   - Counterparty risk

2. LSP Proxy Receiving
   + Funds eventually reach user
   + Better user experience
   - LSP needs to temporarily hold funds
   - Still requires trust
   - LSP may censor payments

3. HODL Invoices
   + Payment can wait
   - Occupies sender's liquidity
   - Increases jamming risk
   - Has time limit

Ideal Solution:
• Receiver can "commit" to receive while offline
• Settle trustlessly when online
• Don't occupy others' liquidity`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Async Payments 概念</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Async Payment Design Goals:

Flow:
  Sender (Alice)
       |
       | Initiates payment
       v
  LSP / Intermediate Node
       |
       | Holds payment intent, waits for receiver
       | (doesn't hold actual funds)
       v
  Receiver comes online
       |
       v
  Receiver (Bob) - Completes settlement

Key Features:
• No liquidity occupied while receiver offline
• Complete actual HTLC exchange when online
• No need to trust intermediate node with funds`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">技術方案</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">1. Trampoline + Async</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Trampoline Routing + Async Payments:

Concept:
• Sender delegates payment to Trampoline node
• Trampoline node finds the receiver
• If receiver offline, Trampoline can wait

Flow:
1. Alice creates payment, specifies Bob's static ID
2. Alice sends to Trampoline node T
3. T discovers Bob is offline
4. T saves "payment intent" (not actual funds)
5. Bob comes online, connects to T
6. T routes payment to Bob
7. Bob reveals preimage
8. Payment complete

Advantages:
• No on-chain transaction needed
• Alice's funds not locked when Bob offline
• Based on existing Trampoline proposal

Limitations:
• Requires Trampoline node support
• Still some trust requirement (T might not forward)`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">2. PTLCs + Async</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`PTLC-based Async Payments:

Advantages of adaptor signatures:

Traditional HTLC:
• Receiver must be online to generate preimage
• Cannot create "reusable" payment method in advance

PTLC:
• Receiver can publish public point P = p*G in advance
• Sender uses P to create payment
• Receiver unlocks with p when online

Flow:
1. Bob publishes static payment point P (like static address)
2. Alice creates PTLC locked to P
3. Alice sends payment to Bob's LSP
4. LSP holds payment (in PTLC form)
5. Bob comes online, unlocks PTLC with p
6. Payment complete

Challenges:
• Requires widespread PTLC deployment
• Depends on Taproot channels`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">3. 靜態發票 (Static Invoices)</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`BOLT 12 Offers for Static Invoices:

Traditional BOLT 11:
• Need to generate new invoice each time
• Invoice has expiry time
• Receiver must be online

BOLT 12 Offers:
  Offer: lno1...
  • Static payment "offer"
  • Reusable
  • No need to be online for each invoice

Flow:
1. Bob creates and publishes Offer
2. Alice uses Offer to request invoice
3. Invoice request via onion routing
4. Bob's node/LSP returns invoice
5. Alice pays

Async scenario:
• When Bob offline, LSP can proxy
• Use Bob's pre-authorized keys
• Or wait for Bob to come online`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">LSP 輔助非同步</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    目前最實用的方案依賴 LSP 的輔助：
  </p>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">Phoenix 的方案</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• ACINQ 節點代理接收</li>
        <li>• 支付暫存在 LSP</li>
        <li>• 用戶上線後自動完成</li>
        <li>• 使用加密的支付數據</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-blue-500/30 bg-blue-500/10">
      <h4 class="font-semibold text-blue-700 dark:text-blue-400 mb-2">Breez 的方案</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• LSP 持有 HODL invoices</li>
        <li>• 推送通知喚醒 App</li>
        <li>• 在線時即時結算</li>
        <li>• 有超時限制</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">挑戰與權衡</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">信任最小化</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        如何確保中間方不能偷取資金或審查支付？理想方案應該是「持有意圖」而非「持有資金」。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">超時處理</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        如果接收方長時間不上線怎麼辦？需要有明確的超時和退款機制。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">通道堵塞</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        如果使用 HODL invoices，長時間等待會佔用流動性。需要與堵塞防護措施配合。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">隱私保護</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        LSP 會知道誰在接收支付。需要設計機制保護接收方隱私。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">未來展望</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Async Payments Roadmap:

Near-term (implemented):
• LSP proxy receiving
• HODL invoices
• Push notification wakeup

Mid-term (in development):
• BOLT 12 Offers
• Trampoline routing
• Better LSP standards

Long-term (research):
• PTLC-based async
• Fully trustless solution
• Cross-LSP interoperability

Ideal Goals:
• Receiver can be fully offline
• Don't occupy network liquidity
• Minimize trust requirements
• Protect privacy`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實現狀態</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Phoenix</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">部分實現</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        支援離線接收，使用 ACINQ 節點作為代理，支付會在 App 啟動時完成。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Breez</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">部分實現</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        使用 HODL invoices 和推送通知實現離線接收。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-yellow-500/30 bg-yellow-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-yellow-500/20 text-yellow-600 dark:text-yellow-400"
          >BOLT 12</span
        >
        <span class="text-sm font-semibold text-yellow-700 dark:text-yellow-400">開發中</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        靜態 Offers 可以改善非同步支付體驗，CLN 已支援，其他實現正在跟進。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2021-October/003307.html"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Async Payments 郵件列表討論</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt12-offers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT12 Offers</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/ptlcs"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">PTLCs</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/lnurl"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">LNURL</a
      >
      協議如何簡化閃電網路的用戶體驗。
    </p>
  </div>
</ArticleLayout>
