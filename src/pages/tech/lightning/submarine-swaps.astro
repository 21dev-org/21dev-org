---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Submarine Swaps"
  description="深入理解 Submarine Swaps，實現閃電網路與鏈上比特幣之間的原子交換。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Submarine Swaps' },
  ]}
  difficulty="advanced"
  readingTime="15 分鐘"
  prevPage={{ title: '流動性管理', href: '/tech/lightning/liquidity' }}
  nextPage={{ title: 'Splicing', href: '/tech/lightning/splicing' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Submarine Swap？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Submarine Swap 是一種原子交換技術，允許用戶在閃電網路（鏈下）和比特幣主鏈（鏈上）之間
    無需信任地交換資金。這解決了閃電網路的一個關鍵問題：如何在不關閉通道的情況下
    將通道資金轉移到鏈上，或將鏈上資金注入通道。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>核心價值：</strong>
      Submarine Swaps 讓閃電網路和鏈上比特幣變得「可互換」，大幅提升了資金的流動性和可用性。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">兩種交換方向</h2>

  <div class="grid md:grid-cols-2 gap-6 mb-8">
    <div class="p-6 rounded-xl border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-[var(--text-primary)]">Loop In</h3>
      </div>
      <p class="text-sm text-[var(--text-secondary)] mb-3">
        將鏈上比特幣轉換為閃電網路入站容量
      </p>
      <ul class="space-y-2 text-sm text-[var(--text-secondary)]">
        <li class="flex items-start gap-2">
          <span class="text-green-500">•</span>
          <span>增加接收能力</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-green-500">•</span>
          <span>適合商家收款</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-green-500">•</span>
          <span>鏈上 → 閃電</span>
        </li>
      </ul>
    </div>

    <div class="p-6 rounded-xl border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-[var(--text-primary)]">Loop Out</h3>
      </div>
      <p class="text-sm text-[var(--text-secondary)] mb-3">
        將閃電網路資金轉換為鏈上比特幣
      </p>
      <ul class="space-y-2 text-sm text-[var(--text-secondary)]">
        <li class="flex items-start gap-2">
          <span class="text-blue-500">•</span>
          <span>增加發送能力</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-blue-500">•</span>
          <span>適合路由節點</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-blue-500">•</span>
          <span>閃電 → 鏈上</span>
        </li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Loop Out 運作流程</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Loop Out 將閃電網路資金轉移到鏈上，以下是詳細步驟：
  </p>

  <div class="not-prose mb-8 space-y-3">
    {
      [
        { step: '1', title: '請求交換', desc: 'Alice 向 Loop 服務請求 Loop Out，指定金額和鏈上地址' },
        { step: '2', title: '生成哈希鎖', desc: 'Loop 服務生成 preimage，計算 hash = SHA256(preimage)' },
        { step: '3', title: '鏈上 HTLC', desc: 'Loop 創建鏈上 HTLC，鎖定資金到 Alice 的地址（需要 preimage 解鎖）' },
        { step: '4', title: '閃電支付', desc: 'Alice 通過閃電網路向 Loop 支付（附帶相同的 hash）' },
        { step: '5', title: '揭示原像', desc: 'Loop 揭示 preimage 領取閃電支付，Alice 用同一個 preimage 領取鏈上資金' },
      ].map((item) => (
        <div class="flex items-start gap-4 p-4 rounded-lg bg-[var(--surface-elevated)] border border-[var(--border-default)]">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-yellow-500 text-white flex items-center justify-center font-bold text-sm">
            {item.step}
          </div>
          <div>
            <h4 class="font-semibold text-[var(--text-primary)]">{item.title}</h4>
            <p class="text-sm text-[var(--text-secondary)]">{item.desc}</p>
          </div>
        </div>
      ))
    }
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">HTLC 腳本示例</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>OP_HASH256 &lt;hash&gt; OP_EQUAL
OP_IF
    &lt;alice_pubkey&gt;                    # Alice 用 preimage 領取
OP_ELSE
    &lt;timeout&gt; OP_CHECKLOCKTIMEVERIFY OP_DROP
    &lt;loop_pubkey&gt;                     # 超時後 Loop 取回
OP_ENDIF
OP_CHECKSIG</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">原子性保證</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Submarine Swap 的安全性來自於 HTLC 的原子性：
  </p>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">成功情況</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Loop 揭示 preimage → Alice 可以同時用這個 preimage 領取鏈上資金。
        雙方都獲得應得的資金。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">失敗情況</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Loop 不揭示 preimage → 閃電支付超時退回給 Alice，
        鏈上 HTLC 超時後 Loop 取回資金。雙方回到原狀。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">應用場景</h2>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">場景</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">類型</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">說明</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">商家收款</td>
          <td class="py-3 px-4">Loop In</td>
          <td class="py-3 px-4">增加入站容量以接收更多支付</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">路由節點平衡</td>
          <td class="py-3 px-4">Loop Out</td>
          <td class="py-3 px-4">恢復通道的發送能力</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">交易所提款</td>
          <td class="py-3 px-4">Loop Out</td>
          <td class="py-3 px-4">用閃電支付換取鏈上 UTXO</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">即時入金</td>
          <td class="py-3 px-4">Loop In</td>
          <td class="py-3 px-4">快速將鏈上資金轉入閃電錢包</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">服務提供商</h2>

  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
    {
      [
        { name: 'Lightning Loop', provider: 'Lightning Labs', url: 'https://lightning.engineering/loop/' },
        { name: 'Boltz', provider: 'Boltz Exchange', url: 'https://boltz.exchange/' },
        { name: 'Peerswap', provider: 'ElementsProject', url: 'https://peerswap.dev/' },
      ].map((service) => (
        <a
          href={service.url}
          target="_blank"
          rel="noopener noreferrer"
          class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)] hover:border-yellow-500/50 transition-colors"
        >
          <h4 class="font-semibold text-[var(--text-primary)] mb-1">{service.name}</h4>
          <p class="text-sm text-[var(--text-secondary)]">{service.provider}</p>
        </a>
      ))
    }
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">費用結構</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Submarine Swap 涉及多種費用：
  </p>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-yellow-500 font-bold">•</span>
      <span><strong class="text-[var(--text-primary)]">服務費</strong>：交換服務商收取的手續費（通常 0.1-1%）</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-yellow-500 font-bold">•</span>
      <span><strong class="text-[var(--text-primary)]">鏈上手續費</strong>：HTLC 創建和解鎖的礦工費</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-yellow-500 font-bold">•</span>
      <span><strong class="text-[var(--text-primary)]">閃電路由費</strong>：閃電網路支付的路由費用</span>
    </li>
  </ul>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>成本優化提示：</strong>
      在鏈上手續費低時執行 Loop 操作可以顯著降低成本。
      許多服務提供商支持批量處理以進一步節省費用。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">與 Splicing 的比較</h2>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">特性</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">Submarine Swap</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">Splicing</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">需要第三方</td>
          <td class="py-3 px-4">是（交換服務）</td>
          <td class="py-3 px-4">否</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">通道中斷</td>
          <td class="py-3 px-4">否</td>
          <td class="py-3 px-4">否</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">即時性</td>
          <td class="py-3 px-4">閃電部分即時</td>
          <td class="py-3 px-4">需等待確認</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">費用</td>
          <td class="py-3 px-4">較高（含服務費）</td>
          <td class="py-3 px-4">僅鏈上費用</td>
        </tr>
      </tbody>
    </table>
  </div>
</ArticleLayout>
