---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="發票格式"
  description="深入理解閃電網路 BOLT 11 發票格式，以及新一代 BOLT 12 Offers 協議。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: '發票格式' },
  ]}
  difficulty="intermediate"
  readingTime="15 分鐘"
  prevPage={{ title: '洋蔥路由', href: '/tech/lightning/bolt-onion' }}
  nextPage={{ title: '路由與尋路', href: '/tech/lightning/routing' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT 11 發票</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BOLT 11 定義了閃電網路支付請求的標準格式。發票包含支付所需的所有資訊， 使用 Bech32
    編碼，易於複製分享和 QR 碼掃描。
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`BOLT 11 Invoice Example:

lnbc1pvjluezpp5qqqsyqcyq5rqwzqfqqqsyqcyq5rqwzqfqqqsyqcyq5rqwzqfqypqdpl
2pkx2ctnv5sxxmmwwd5kgetjypeh2ursdae8g6twvus8g6rfwvs8qun0dfjkxaq8rkx3yf5
tcsyz3d73gafnh3cax9rn449d9p5uxz9ezhhypd0elx87sjle52x86fux2ypatgddc6k63n
7erqz25le42c4u4ecky03ylcqca784w

Structure:
lnbc    - prefix (mainnet)
1       - amount (optional)
p...    - tagged data
8rkx... - signature`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">發票結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`BOLT 11 Invoice Structure:

Prefix:
  ln + network:
  • lnbc  - Bitcoin mainnet
  • lntb  - testnet
  • lnbcrt - regtest
  • lnsb  - signet

Amount (optional):
  number + multiplier:
  • m = milli (0.001)
  • u = micro (0.000001)
  • n = nano (0.000000001)
  • p = pico (0.000000000001)
  Example: 2500u = 2500 micro = 250000 sats

Timestamp:
  Invoice creation time (UNIX seconds)

Tagged Fields:
  Various payment info...

Signature:
  Receiver node signature`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">標籤化欄位</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Tagged Field Format:
type (5 bits) + data_length (10 bits) + data

Common Tags:

p (1): payment_hash (52 chars, 256 bits)
       SHA256 payment hash, required

s (16): payment_secret (52 chars, 256 bits)
        prevents probing attacks

d (13): description (variable)
        UTF-8 description text

h (23): description_hash (52 chars)
        hash of long description

x (6): expiry (variable)
       expiry seconds, default 3600 (1 hour)

c (24): min_final_cltv_expiry (variable)
        minimum CLTV delta, default 18

n (19): payee node_id (53 chars)
        receiver pubkey (recoverable from sig)

r (3): routing hint
       private channel routing info

f (9): fallback address
       on-chain fallback address

9 (5): feature bits
       supported features`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">路由提示</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    當接收方只有私有通道時，需要提供路由提示：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Routing Hint Structure (r tag):

Each hint contains one channel:
├── pubkey (33 bytes): entry node pubkey
├── short_channel_id (8 bytes)
├── fee_base_msat (4 bytes)
├── fee_proportional_millionths (4 bytes)
└── cltv_expiry_delta (2 bytes)

Example scenario:
Carol only has private channel to Bob

Invoice includes hint:
r = [
  {
    pubkey: Bob's pubkey,
    short_channel_id: Bob-Carol channel,
    fee: ...,
    cltv: ...
  }
]

Sender routing:
Alice -> ... -> Bob -> Carol (private channel)`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">解析發票</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Decode Example (using lncli):

$ lncli decodepayreq lnbc...

{
  "destination": "03...公鑰",
  "payment_hash": "0001020304...",
  "num_satoshis": "100000",
  "timestamp": "1609459200",
  "expiry": "3600",
  "description": "Coffee payment",
  "cltv_expiry": "18",
  "features": {
    "9": { "name": "tlv-onion" },
    "14": { "name": "payment-addr" },
    "17": { "name": "multi-path-payments" }
  },
  "payment_addr": "abcd..."
}`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT 11 限制</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">一次性使用</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        每次支付需要生成新發票，不適合訂閱或捐款場景。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">需要交互</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        發送方必須先從接收方獲取發票，無法離線支付。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">會過期</h4>
      <p class="text-sm text-[var(--text-secondary)]">發票有過期時間，過期後無法支付。</p>
    </div>
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">無退款機制</h4>
      <p class="text-sm text-[var(--text-secondary)]">沒有標準的退款或部分退款協議。</p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT 12 Offers</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BOLT 12 (Offers) 是新一代支付協議，解決了 BOLT 11 的諸多限制：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`BOLT 12 Core Concepts:

Offer:
• Reusable payment request template
• Like a "donation link"
• No payment_hash (generated per request)

lno1qcp4256ypq...

Flow:
1. Merchant publishes Offer
2. Payer sends invoice_request (via onion message)
3. Merchant responds with invoice (with payment_hash)
4. Payer pays

Advantages:
• Reusable (subscriptions, donations)
• Supports refunds (refund message)
• Enhanced privacy (receiver can use blinded paths)
• No centralized server needed`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Offer 結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Offer TLV Fields:

offer_chains (2): supported blockchains
offer_metadata (4): merchant custom data
offer_currency (6): currency code (e.g. USD)
offer_amount (8): amount (for fiat pricing)
offer_description (10): description
offer_features (12): feature bits
offer_absolute_expiry (14): absolute expiry time
offer_paths (16): blinded paths
offer_issuer (18): issuer name
offer_quantity_max (20): max quantity
offer_node_id (22): node ID

invoice_request Additional Fields:
invreq_metadata (0): requester data
invreq_chain (80): selected chain
invreq_amount (82): payment amount
invreq_features (84): features
invreq_quantity (86): quantity
invreq_payer_id (88): payer ephemeral pubkey
invreq_payer_note (89): payer note`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT 12 退款</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Refund Flow:

1. Original Payment
   Payer -> Merchant (pay invoice)

2. Refund Request
   Merchant creates refund (like reverse offer)
   Sends to original payer

3. Refund Invoice
   Payer sends invoice_request
   Merchant responds with invoice

4. Refund Payment
   Merchant pays invoice

Refund TLV:
refund_for: original payment_hash
refund_amount: refund amount`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">隱私增強</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`BOLT 12 Privacy Features:

1. Blinded Paths
   • Offer can include blinded paths
   • Payer cannot identify receiver's real node
   • Suitable for anonymous donations

2. Onion Messages
   • invoice_request sent via onion network
   • No direct connection to receiver needed

3. Payer Ephemeral Identity
   • Each request uses new payer_id
   • Does not reveal payer's real node ID

4. No payment_hash Correlation
   • Each payment uses new hash
   • Cannot correlate multiple payments to same offer`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">比較</h2>

  <div class="not-prose mb-8 overflow-x-auto">
    <table
      class="w-full text-sm border border-[var(--border-default)] rounded-lg overflow-hidden"
      aria-label="BOLT 11 與 BOLT 12 發票格式比較"
    >
      <thead class="bg-[var(--bg-secondary)]">
        <tr>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">特性</th>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">BOLT 11</th>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">BOLT 12</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">重複使用</td>
          <td class="px-4 py-3 text-red-500">X 一次性</td>
          <td class="px-4 py-3 text-green-500">O 可重複</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">退款</td>
          <td class="px-4 py-3 text-red-500">X 無標準</td>
          <td class="px-4 py-3 text-green-500">O 原生支持</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">接收方隱私</td>
          <td class="px-4 py-3 text-yellow-500">- 有限</td>
          <td class="px-4 py-3 text-green-500">O 盲化路徑</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">離線接收</td>
          <td class="px-4 py-3 text-red-500">X 需在線</td>
          <td class="px-4 py-3 text-yellow-500">- 需處理請求</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">採用狀態</td>
          <td class="px-4 py-3 text-green-500">O 廣泛</td>
          <td class="px-4 py-3 text-yellow-500">- 逐步採用中</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/routing"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">路由與尋路</a
      >
      如何找到支付路徑。
    </p>
  </div>
</ArticleLayout>
