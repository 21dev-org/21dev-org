---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Gossip Protocol 八卦協議"
  description="了解閃電網路的 Gossip 協議如何讓節點發現彼此、廣播通道資訊，並構建用於路由的網路圖譜。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Gossip Protocol' },
  ]}
  difficulty="intermediate"
  readingTime="12 分鐘"
  prevPage={{ title: 'Keysend', href: '/tech/lightning/keysend' }}
  nextPage={{ title: 'Channel Backup', href: '/tech/lightning/channel-backup' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Gossip 協議？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Gossip 協議（BOLT #7）定義了閃電網路節點如何發現彼此、如何廣播通道資訊，
    以及如何維護用於支付路由的網路圖譜。這個「八卦」機制讓每個節點都能了解
    整個網路的拓撲結構。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>核心功能：</strong>
      Gossip 讓節點能夠發現不直接連接的遠程節點和通道，這是源路由（source routing）
      的基礎——發送方需要知道整個路徑才能構建洋蔥封包。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Gossip 訊息類型</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-blue-500/20 text-blue-600 dark:text-blue-400"
          >256</span
        >
        <h4 class="font-semibold text-[var(--text-primary)]">channel_announcement</h4>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        宣告一個新的公開通道。包含通道的兩個節點公鑰和 funding 交易資訊。
      </p>
    </div>

    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >258</span
        >
        <h4 class="font-semibold text-[var(--text-primary)]">channel_update</h4>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        更新通道的路由參數，如費率、時間鎖、啟用/禁用狀態等。每個方向獨立更新。
      </p>
    </div>

    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-purple-500/20 text-purple-600 dark:text-purple-400"
          >257</span
        >
        <h4 class="font-semibold text-[var(--text-primary)]">node_announcement</h4>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        宣告節點的元數據，如別名、顏色、網路地址、支持的功能等。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Channel Announcement</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`channel_announcement 結構：

┌─────────────────────────────────────────────────────────┐
│ node_signature_1: 節點 1 的簽名                         │
│ node_signature_2: 節點 2 的簽名                         │
│ bitcoin_signature_1: 節點 1 的 Bitcoin 密鑰簽名         │
│ bitcoin_signature_2: 節點 2 的 Bitcoin 密鑰簽名         │
│ features: 通道功能位                                    │
│ chain_hash: 區塊鏈標識（mainnet/testnet）               │
│ short_channel_id: 8 字節通道標識                        │
│   ├── block height (3 bytes)                           │
│   ├── tx index (3 bytes)                               │
│   └── output index (2 bytes)                           │
│ node_id_1: 節點 1 公鑰（字典序較小）                    │
│ node_id_2: 節點 2 公鑰（字典序較大）                    │
│ bitcoin_key_1: 節點 1 的 Bitcoin 公鑰                   │
│ bitcoin_key_2: 節點 2 的 Bitcoin 公鑰                   │
└─────────────────────────────────────────────────────────┘

驗證步驟：
1. 檢查 short_channel_id 對應的 UTXO 存在
2. UTXO 是 P2WSH，鎖定到 2-of-2 multisig
3. 驗證 4 個簽名
4. 確認 chain_hash 匹配`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Channel Update</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`channel_update 結構：

┌─────────────────────────────────────────────────────────┐
│ signature: 發布者的簽名                                 │
│ chain_hash: 區塊鏈標識                                  │
│ short_channel_id: 通道標識                              │
│ timestamp: Unix 時間戳（更新時間）                      │
│ message_flags:                                          │
│   └── bit 0: must_be_one                               │
│ channel_flags:                                          │
│   ├── bit 0: direction (0=node1→node2, 1=node2→node1)  │
│   └── bit 1: disabled (通道是否禁用)                    │
│ cltv_expiry_delta: HTLC 時間鎖增量                      │
│ htlc_minimum_msat: 最小 HTLC 金額                       │
│ fee_base_msat: 基礎路由費                               │
│ fee_proportional_millionths: 比例路由費                 │
│ htlc_maximum_msat: 最大 HTLC 金額（可選）               │
└─────────────────────────────────────────────────────────┘

費用計算：
fee = fee_base_msat + (amount * fee_proportional_millionths / 1000000)

更新規則：
- timestamp 必須比之前的大
- 每個方向獨立更新
- 可以禁用/啟用通道`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Node Announcement</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`node_announcement 結構：

┌─────────────────────────────────────────────────────────┐
│ signature: 節點簽名                                     │
│ features: 節點功能位                                    │
│ timestamp: 更新時間                                     │
│ node_id: 節點公鑰                                       │
│ rgb_color: 節點顏色（3 bytes）                          │
│ alias: 節點別名（最多 32 bytes UTF-8）                  │
│ addresses: 網路地址列表                                 │
│   ├── type 1: IPv4 (6 bytes)                           │
│   ├── type 2: IPv6 (18 bytes)                          │
│   ├── type 3: Tor v2 (12 bytes) [已棄用]               │
│   ├── type 4: Tor v3 (37 bytes)                        │
│   ├── type 5: DNS hostname                             │
│   └── type 6: WebSocket                                │
└─────────────────────────────────────────────────────────┘

前提條件：
- 節點必須至少有一個公開通道
- 否則 node_announcement 會被忽略
- 防止垃圾節點信息`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Gossip 同步</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Gossip 查詢機制：

初始同步：
┌─────────────┐                      ┌─────────────┐
│   新節點    │                      │   老節點    │
└──────┬──────┘                      └──────┬──────┘
       │                                    │
       │──── query_channel_range ──────────>│
       │     (請求某區塊範圍的通道)          │
       │                                    │
       │<─── reply_channel_range ──────────│
       │     (返回該範圍的 short_channel_ids)│
       │                                    │
       │──── query_short_channel_ids ──────>│
       │     (請求特定通道的完整資訊)        │
       │                                    │
       │<─── channel_announcement ─────────│
       │<─── channel_update ───────────────│
       │<─── node_announcement ────────────│
       │                                    │
       ▼                                    ▼

增量同步：
- gossip_timestamp_filter: 只接收特定時間後的更新
- 減少重複訊息傳輸`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Gossip 驗證</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">有效性檢查</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 驗證所有簽名</li>
        <li>• 確認 UTXO 存在且未花費</li>
        <li>• 檢查 timestamp 遞增</li>
        <li>• 驗證 chain_hash 匹配</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">防止垃圾</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 通道必須有鏈上 UTXO</li>
        <li>• 節點必須有公開通道</li>
        <li>• 限制更新頻率</li>
        <li>• 限制訊息大小</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">私有通道</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`私有通道（Unannounced Channels）：

私有通道：
- 不廣播 channel_announcement
- 不在公開圖譜中
- 只有通道雙方知道

用途：
- 移動錢包連接 LSP（隱私）
- 商家不公開收款通道
- 減少網路圖譜大小

發票中的路由提示（Route Hints）：
┌─────────────────────────────────────────┐
│ Invoice:                                │
│   route_hints:                          │
│     - pubkey: 02abc...                  │
│       short_channel_id: 123x456x0       │
│       fee_base_msat: 1000               │
│       fee_proportional: 100             │
│       cltv_expiry_delta: 40             │
└─────────────────────────────────────────┘

這讓發送方可以路由到有私有通道的接收方，
同時不公開通道給整個網路。`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">圖譜維護</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">通道過期</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        如果通道超過 2 週沒有 channel_update，節點可能會認為它不可用並從圖譜中移除。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">UTXO 監控</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        節點應該監控區塊鏈，當 funding UTXO 被花費時，從圖譜中移除對應通道。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">存儲需求</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        完整的網路圖譜可能需要 50-100 MB 存儲空間，這對移動設備是個挑戰。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Gossip v1.5 / v2</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    社群正在研究改進 Gossip 協議以減少頻寬和存儲需求：
  </p>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Minisketch</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        使用集合對帳技術，只同步差異而非完整數據，大幅減少頻寬。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Taproot Gossip</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Taproot 通道的 gossip 格式會更緊湊，使用 MuSig2 簽名減少數據量。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/blob/master/07-routing-gossip.md"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 7: P2P Node and Channel Discovery</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/routing"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">路由與尋路</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt-messages"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">訊息協議</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/channel-backup"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">通道備份</a
      >
      如何保護你的閃電網路資金安全。
    </p>
  </div>
</ArticleLayout>
