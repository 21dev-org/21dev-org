---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Channel Factories 通道工廠"
  description="了解 Channel Factories 如何讓多個參與者共享一筆鏈上交易來開設多個閃電通道，大幅降低成本。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Channel Factories' },
  ]}
  difficulty="advanced"
  readingTime="15 分鐘"
  prevPage={{ title: 'Dual-Funded Channels', href: '/tech/lightning/dual-funded' }}
  nextPage={{ title: 'Eltoo', href: '/tech/lightning/eltoo' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Channel Factory？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Channel Factory（通道工廠）是一種讓多個參與者共享一筆鏈上交易來創建多個閃電通道的技術。
    傳統上，每個通道需要單獨的鏈上交易。通道工廠可以讓 N 個參與者用一筆交易創建
    最多 N×(N-1)/2 個通道，大幅降低鏈上成本。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>研究階段：</strong>
      Channel Factories 目前仍是研究提案，尚未在主網實現。
      需要 SIGHASH_ANYPREVOUT 或類似的軟分叉來實現最佳版本。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">擴展性問題</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`傳統通道開設的問題：

假設 10 個人想要互相開通道：
┌─────────────────────────────────────────────────────────┐
│ 需要的通道數：10 × 9 / 2 = 45 個通道                    │
│ 需要的鏈上交易：45 筆                                   │
│ 假設每筆交易費：10,000 sats                             │
│ 總成本：450,000 sats                                    │
└─────────────────────────────────────────────────────────┘

隨著參與者增加：
├── 20 人：190 個通道 → 1,900,000 sats
├── 100 人：4,950 個通道 → 49,500,000 sats
└── 擴展性非常差！

Channel Factory 解決方案：
┌─────────────────────────────────────────────────────────┐
│ 10 個人共享一個 Factory                                 │
│ 需要的鏈上交易：1 筆（開設）+ 1 筆（關閉）             │
│ 總成本：~20,000 sats（大幅節省！）                      │
│                                                         │
│ Factory 內部可以創建任意通道配置                        │
│ 不需要額外的鏈上交易                                    │
└─────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">基本結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Channel Factory 層次結構：

層次 1：資金交易（Funding Transaction）
┌─────────────────────────────────────────────────────────┐
│ 輸入：每個參與者的 UTXO                                 │
│ 輸出：N-of-N 多簽地址                                   │
│                                                         │
│ Alice: 1 BTC ─┐                                         │
│ Bob: 1 BTC ───┼──> [3-of-3 多簽] = 3 BTC               │
│ Carol: 1 BTC ─┘                                         │
└─────────────────────────────────────────────────────────┘

層次 2：分配交易（Allocation Transaction）
┌─────────────────────────────────────────────────────────┐
│ 花費層次 1 的多簽輸出                                   │
│ 創建多個通道輸出                                        │
│                                                         │
│ 3 BTC ──> Alice-Bob 通道: 1 BTC                        │
│       ──> Bob-Carol 通道: 1 BTC                        │
│       ──> Alice-Carol 通道: 1 BTC                      │
│                                                         │
│ 這些通道是「虛擬」的，不上鏈！                         │
└─────────────────────────────────────────────────────────┘

層次 3：承諾交易（Commitment Transactions）
┌─────────────────────────────────────────────────────────┐
│ 每個通道有自己的承諾交易                                │
│ 正常的閃電網路通道機制                                  │
└─────────────────────────────────────────────────────────┘

關鍵點：
├── 只有層次 1 的交易上鏈
├── 層次 2、3 都是鏈下狀態
├── 必要時可以強制上鏈任何層次
└── 狀態更新需要所有參與者簽名`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">狀態更新</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Factory 狀態更新：

場景：Alice 想和 Dave 開新通道

當前狀態：
┌─────────────────────────────────────────────────────────┐
│ Factory：Alice, Bob, Carol, Dave                        │
│ 通道：Alice-Bob, Bob-Carol, Carol-Dave                  │
│ 餘額分配各 1 BTC                                        │
└─────────────────────────────────────────────────────────┘

更新流程：
1. Alice 提議新的分配狀態
2. 所有 4 人簽名新的分配交易
3. 舊狀態被撤銷
4. 新狀態生效

新狀態：
┌─────────────────────────────────────────────────────────┐
│ 通道：Alice-Bob, Bob-Carol, Carol-Dave, Alice-Dave      │
│ 每個通道分配 0.8 BTC（總額不變）                        │
└─────────────────────────────────────────────────────────┘

挑戰：
├── 需要所有參與者在線並同意
├── 任何人拒絕 → 無法更新
├── 隨參與者增多，協調成本增加
└── 這是 Factory 的主要限制`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Eltoo 的重要性</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">沒有 Eltoo 的問題</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        使用 LN-Penalty 機制時，每個狀態更新需要存儲撤銷密鑰。
        多方參與時，撤銷密鑰數量爆炸性增長，實際不可行。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">有 Eltoo 的優勢</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        <a href="/tech/lightning/eltoo" class="underline">Eltoo</a> 使用狀態編號機制，
        新狀態可以直接覆蓋舊狀態。無需存儲撤銷信息，完美適合多方協議。
      </p>
    </div>
  </div>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Eltoo + Channel Factory：

使用 SIGHASH_ANYPREVOUT：

Update TX #1 ─┐
Update TX #2 ─┼─> 任一個都可以花費 Funding TX
Update TX #3 ─┘
   ...
Update TX #N ───> 最新狀態

Settlement TX ───> 最終結算

流程：
1. 任何人廣播任何舊的 Update TX
2. 其他人可以廣播更新的 Update TX
3. 最終只有最新狀態生效
4. Settlement TX 完成結算

優點：
├── 無需存儲撤銷密鑰
├── 狀態可以無限更新
├── 離線參與者不會被懲罰
└── 完美支持多方協議`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">使用場景</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">企業內部網路</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        公司內部的多個部門或子公司可以共享一個 Factory，
        在內部進行頻繁的資金流轉而幾乎無需鏈上交易。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">交易所聯盟</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        多個交易所可以創建 Factory 進行清結算，大幅減少鏈上交易需求。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">LSP 聯盟</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        多個 LSP 可以共享 Factory，為用戶提供更好的連通性和更低的成本。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">社群/DAO</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        去中心化組織的成員可以使用 Factory 進行內部資金流轉，
        治理決策可以調整通道配置。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">挑戰與限制</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Channel Factory 的挑戰：

1. 協調問題
   ├── 所有參與者必須在線才能更新
   ├── 一人離線 → 全體卡住
   ├── 惡意參與者可以阻撓更新
   └── 需要激勵機制確保配合

2. 退出成本
   ├── 單人退出需要關閉整個 Factory
   ├── 或者進行昂貴的鏈上分割
   └── 可能需要「虛擬」退出機制

3. 資本效率
   ├── 資金鎖定在 Factory 中
   ├── 不能用於 Factory 外的通道
   └── 需要權衡內外部流動性

4. 軟分叉依賴
   ├── 最佳實現需要 SIGHASH_ANYPREVOUT
   ├── 或類似的 covenant 支持
   └── 目前 Bitcoin 尚未激活

5. 複雜性
   ├── 多層次交易結構
   ├── 狀態管理複雜
   └── 實現和審計難度高

可能的緩解措施：
├── 小規模 Factory（5-10 人）
├── 信任假設（如企業內部）
├── 激勵機制（押金/聲譽）
└── 備用退出路徑`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關概念</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Ark</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Ark 是另一種多方協議設計，使用不同的方法解決擴展性問題。
        它允許用戶無需與其他參與者協調就能發送支付。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Statechains</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Statechains 允許 UTXO 所有權的鏈下轉移，是另一種 Layer 2 擴展方案。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Virtual Channels</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        虛擬通道是在現有通道之上創建的「虛擬」通道，不需要額外的鏈上交易。
        Channel Factory 可以看作是虛擬通道概念的擴展。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實現狀態</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-yellow-500/30 bg-yellow-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-yellow-500/20 text-yellow-600 dark:text-yellow-400"
          >研究階段</span
        >
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        Channel Factories 目前處於研究和提案階段。需要等待
        SIGHASH_ANYPREVOUT 軟分叉激活後才能實現最佳版本。
        部分簡化版本可以在現有 Bitcoin 上實現，但有更多限制。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://tik-old.ee.ethz.ch/file/a20a865ce40d40c8f942cf206a7cba96/Scalable_Funding_Of_Blockchain_Micropayment_Networks.pdf"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Channel Factories 原始論文</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/eltoo"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Eltoo / LN-Symmetry</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/dual-funded"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Dual-Funded Channels</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/eltoo"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Eltoo</a
      >
      如何簡化狀態更新並啟用 Channel Factories。
    </p>
  </div>
</ArticleLayout>
