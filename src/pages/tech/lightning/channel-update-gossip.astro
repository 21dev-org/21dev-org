---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Channel Update Gossip 通道更新廣播"
  description="深入了解閃電網路的 channel_update 訊息，如何傳播通道費用和策略變更。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Channel Update Gossip' },
  ]}
  difficulty="intermediate"
  readingTime="10 分鐘"
  prevPage={{ title: 'Gossip', href: '/tech/lightning/gossip' }}
  nextPage={{ title: 'Channel Announcements', href: '/tech/lightning/channel-announcements' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Channel Update？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Channel Update 是閃電網路節點用來廣播通道策略變更的訊息。 它包含費用設定、HTLC
    限制和通道狀態，是路由決策的關鍵資訊。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>BOLT 7 定義：</strong>
      channel_update 訊息在 BOLT 7 中規範。每個通道方向 可以獨立設定策略，因此一個通道可能有兩個不同的
      update。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">訊息結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`channel_update Message Format:

Field Definitions:

signature: 64 bytes
  Schnorr/ECDSA signature of entire message

chain_hash: 32 bytes
  Blockchain identifier (Bitcoin mainnet/testnet)

short_channel_id: 8 bytes
  Channel identifier (block_height:tx_index:output_index)

timestamp: 4 bytes
  Unix timestamp for ordering updates

message_flags: 1 byte
  • bit 0: must_be_one (compatibility)
  • Other bits reserved

channel_flags: 1 byte
  • bit 0: direction (0=node1->node2, 1=node2->node1)
  • bit 1: disable (1=channel temporarily disabled)

cltv_expiry_delta: 2 bytes
  CLTV delta required for forwarding HTLCs

htlc_minimum_msat: 8 bytes
  Minimum accepted HTLC amount

fee_base_msat: 4 bytes
  Base fee (millisatoshis)

fee_proportional_millionths: 4 bytes
  Proportional fee (per million)

htlc_maximum_msat: 8 bytes (optional, if message_flags bit 0)
  Maximum accepted HTLC amount`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">費用計算</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Routing Fee Formula:

fee = fee_base_msat + (amount_msat * fee_proportional_millionths / 1,000,000)

Example:

Channel Policy:
  • fee_base_msat: 1000 (1 sat)
  • fee_proportional_millionths: 100 (0.01%)

Forwarding 1,000,000 msat (1000 sats):
  fee = 1000 + (1,000,000 * 100 / 1,000,000)
      = 1000 + 100
      = 1100 msat (1.1 sats)

Forwarding 10,000,000 msat (10,000 sats):
  fee = 1000 + (10,000,000 * 100 / 1,000,000)
      = 1000 + 1000
      = 2000 msat (2 sats)

Common Fee Settings:

1. Zero-fee Channel:
   • base: 0, ppm: 0
   • Used for connections between own nodes

2. Low-fee Node:
   • base: 0-10, ppm: 1-10
   • Prioritizes routing volume

3. Standard Node:
   • base: 1000, ppm: 100-500
   • Balances revenue and routing volume

4. High-fee Node:
   • base: 1000+, ppm: 1000+
   • Popular routes or scarce liquidity`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">方向性</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Channel Update Directions:

One channel, two directions, two updates:

  Node A (pubkey: 02aa...)       Node B (pubkey: 03bb...)
        |                                |
        |     short_channel_id: 700000x1x0
        |                                |
        |---- channel_update (dir=0) ----|
        |     A's policy for A->B        |
        |     fee_base: 1000             |
        |     fee_ppm: 100               |
        |                                |
        |---- channel_update (dir=1) ----|
        |     B's policy for B->A        |
        |     fee_base: 500              |
        |     fee_ppm: 50                |

Direction Determination (channel_flags bit 0):

direction = 0:
  Publisher is node1 (smaller pubkey)
  Defines policy from node1 to node2

direction = 1:
  Publisher is node2 (larger pubkey)
  Defines policy from node2 to node1

Determining node1/node2:
  if pubkey_a < pubkey_b:
      node1 = A, node2 = B
  else:
      node1 = B, node2 = A`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Gossip 傳播</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Channel Update Propagation:

Broadcast Flow:

1. Node updates channel policy
   lncli updatechanpolicy --base_fee_msat 1000 ...

2. Node creates and signs channel_update
   timestamp = current_time

3. Sends to all connected peers
   peer.send(channel_update)

4. Peers validate
   • Signature correct?
   • Timestamp newer than known?
   • Channel exists?

5. After validation, forward to other peers
   -> Gradually propagates across network

Rate Limiting:

Preventing gossip flood attacks:
  • timestamp must be increasing
  • Too frequent updates may be ignored
  • Nodes can set minimum update interval
  • Recommended interval: at least 1 hour

LND Implementation:
  • By default rejects too frequent updates
  • gossip.channel-update-interval config

Gossip Queries (Sync):

When new node joins network:

  query_channel_range:
    Request all channels in specified block range

  reply_channel_range:
    Reply with channel list

  query_short_channel_ids:
    Request details for specific channels

  reply_short_channel_ids_end:
    Reply with channel_announcement and channel_update`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">禁用通道</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Channel Disable Flag:

channel_flags bit 1 (disable):

  disable = 0: Channel normally available
  disable = 1: Channel temporarily disabled

Disable Reasons:
  • Peer offline
  • Channel liquidity exhausted
  • Under maintenance
  • Manual disable

Auto-disable Behavior (LND):

When peer disconnects:
  1. Wait for period (gossip.inactive-channel-ticker)
  2. Send channel_update with disable=1
  3. Other nodes stop routing to this channel

When peer reconnects:
  1. Send channel_update with disable=0
  2. Channel available for routing again

Config:
  [gossip]
  inactive-channel-ticker = 20m (default)`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">私有通道</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        私有通道不廣播 channel_update。 只有直接參與者知道通道存在。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Gossip 壓縮</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        可以使用 gossip_timestamp_filter 只接收特定時間後的更新。
      </p>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>陳舊資訊：</strong>
      Gossip 有傳播延遲。路由時可能使用過時的費用資訊， 導致路由失敗。現代節點使用探測來獲取即時資訊。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/blob/master/07-routing-gossip.md"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 7 Gossip</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/gossip"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Gossip 協議</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/channel-announcements"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Channel Announcements</a
      >
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/channel-announcements"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Channel Announcements</a
      >
      如何公告新通道。
    </p>
  </div>
</ArticleLayout>
