---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Channel Update Gossip 通道更新廣播"
  description="深入了解閃電網路的 channel_update 訊息，如何傳播通道費用和策略變更。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Channel Update Gossip' },
  ]}
  difficulty="intermediate"
  readingTime="10 分鐘"
  prevPage={{ title: 'Gossip', href: '/tech/lightning/gossip' }}
  nextPage={{ title: 'Channel Announcements', href: '/tech/lightning/channel-announcements' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Channel Update？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Channel Update 是閃電網路節點用來廣播通道策略變更的訊息。
    它包含費用設定、HTLC 限制和通道狀態，是路由決策的關鍵資訊。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>BOLT 7 定義：</strong>
      channel_update 訊息在 BOLT 7 中規範。每個通道方向
      可以獨立設定策略，因此一個通道可能有兩個不同的 update。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">訊息結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`channel_update 訊息格式：

欄位定義：
┌──────────────────────────────────────────────────────────────┐
│ signature: 64 bytes                                          │
│   對整個訊息的 Schnorr/ECDSA 簽名                            │
│                                                              │
│ chain_hash: 32 bytes                                         │
│   區塊鏈識別（Bitcoin mainnet/testnet）                      │
│                                                              │
│ short_channel_id: 8 bytes                                    │
│   通道識別符（區塊高度:交易索引:輸出索引）                   │
│                                                              │
│ timestamp: 4 bytes                                           │
│   Unix 時間戳，用於判斷更新先後                              │
│                                                              │
│ message_flags: 1 byte                                        │
│   ├── bit 0: must_be_one（兼容性）                           │
│   └── 其他位保留                                             │
│                                                              │
│ channel_flags: 1 byte                                        │
│   ├── bit 0: direction（0=node1→node2, 1=node2→node1）       │
│   └── bit 1: disable（1=通道暫時禁用）                       │
│                                                              │
│ cltv_expiry_delta: 2 bytes                                   │
│   轉發 HTLC 需要的 CLTV 差值                                 │
│                                                              │
│ htlc_minimum_msat: 8 bytes                                   │
│   接受的最小 HTLC 金額                                       │
│                                                              │
│ fee_base_msat: 4 bytes                                       │
│   基礎費用（毫聰）                                           │
│                                                              │
│ fee_proportional_millionths: 4 bytes                         │
│   比例費用（每百萬分之一）                                   │
│                                                              │
│ htlc_maximum_msat: 8 bytes (optional, if message_flags bit 0)│
│   接受的最大 HTLC 金額                                       │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">費用計算</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`路由費用計算公式：

fee = fee_base_msat + (amount_msat × fee_proportional_millionths / 1,000,000)

範例：
┌──────────────────────────────────────────────────────────────┐
│ 通道策略：                                                   │
│ ├── fee_base_msat: 1000 (1 sat)                              │
│ └── fee_proportional_millionths: 100 (0.01%)                 │
│                                                              │
│ 轉發 1,000,000 msat (1000 sats) 的費用：                     │
│ fee = 1000 + (1,000,000 × 100 / 1,000,000)                   │
│     = 1000 + 100                                             │
│     = 1100 msat (1.1 sats)                                   │
│                                                              │
│ 轉發 10,000,000 msat (10,000 sats) 的費用：                  │
│ fee = 1000 + (10,000,000 × 100 / 1,000,000)                  │
│     = 1000 + 1000                                            │
│     = 2000 msat (2 sats)                                     │
└──────────────────────────────────────────────────────────────┘

常見費用設定：
┌──────────────────────────────────────────────────────────────┐
│ 零費用通道：                                                 │
│ ├── base: 0, ppm: 0                                          │
│ └── 用於自己的節點間連接                                     │
│                                                              │
│ 低費用節點：                                                 │
│ ├── base: 0-10, ppm: 1-10                                    │
│ └── 追求路由量                                               │
│                                                              │
│ 標準節點：                                                   │
│ ├── base: 1000, ppm: 100-500                                 │
│ └── 平衡收益和路由量                                         │
│                                                              │
│ 高費用節點：                                                 │
│ ├── base: 1000+, ppm: 1000+                                  │
│ └── 熱門路由或稀缺流動性                                     │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">方向性</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`通道更新的方向：

一個通道，兩個方向，兩個 update：
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│   Node A (pubkey: 02aa...)     Node B (pubkey: 03bb...)      │
│         │                              │                     │
│         │   short_channel_id: 700000x1x0                     │
│         │                              │                     │
│         │──── channel_update (dir=0) ──│                     │
│         │     A 設定的從 A→B 策略      │                     │
│         │     fee_base: 1000           │                     │
│         │     fee_ppm: 100             │                     │
│         │                              │                     │
│         │──── channel_update (dir=1) ──│                     │
│         │     B 設定的從 B→A 策略      │                     │
│         │     fee_base: 500            │                     │
│         │     fee_ppm: 50              │                     │
│         │                              │                     │
└──────────────────────────────────────────────────────────────┘

方向判定（channel_flags bit 0）：
┌──────────────────────────────────────────────────────────────┐
│ direction = 0:                                               │
│   發布者是 node1（pubkey 較小者）                            │
│   定義從 node1 到 node2 的策略                               │
│                                                              │
│ direction = 1:                                               │
│   發布者是 node2（pubkey 較大者）                            │
│   定義從 node2 到 node1 的策略                               │
│                                                              │
│ 判斷誰是 node1/node2：                                       │
│ if pubkey_a < pubkey_b:                                      │
│     node1 = A, node2 = B                                     │
│ else:                                                        │
│     node1 = B, node2 = A                                     │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Gossip 傳播</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Channel Update 傳播機制：

廣播流程：
┌──────────────────────────────────────────────────────────────┐
│ 1. 節點更新通道策略                                          │
│    lncli updatechanpolicy --base_fee_msat 1000 ...           │
│                                                              │
│ 2. 節點創建並簽名 channel_update                             │
│    timestamp = current_time                                  │
│                                                              │
│ 3. 發送給所有連接的對等節點                                  │
│    peer.send(channel_update)                                 │
│                                                              │
│ 4. 對等節點驗證                                              │
│    ├── 簽名正確？                                            │
│    ├── 時間戳比已知的新？                                    │
│    └── 通道存在？                                            │
│                                                              │
│ 5. 驗證通過後轉發給其他對等節點                              │
│    └── 逐漸傳遍整個網路                                      │
└──────────────────────────────────────────────────────────────┘

速率限制：
┌──────────────────────────────────────────────────────────────┐
│ 防止 gossip 洪水攻擊：                                       │
│                                                              │
│ ├── timestamp 必須遞增                                       │
│ ├── 過於頻繁的更新可能被忽略                                 │
│ ├── 節點可以設定最小更新間隔                                 │
│ └── 建議間隔：至少 1 小時                                    │
│                                                              │
│ LND 實現：                                                   │
│ ├── 默認不接受太頻繁的更新                                   │
│ └── gossip.channel-update-interval 配置                      │
└──────────────────────────────────────────────────────────────┘

Gossip 查詢（同步）：
┌──────────────────────────────────────────────────────────────┐
│ 新節點加入網路時：                                           │
│                                                              │
│ query_channel_range：                                        │
│   請求指定區塊範圍內的所有通道                               │
│                                                              │
│ reply_channel_range：                                        │
│   回覆通道列表                                               │
│                                                              │
│ query_short_channel_ids：                                    │
│   請求特定通道的詳細資訊                                     │
│                                                              │
│ reply_short_channel_ids_end：                                │
│   回覆 channel_announcement 和 channel_update                │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">禁用通道</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`通道禁用標記：

channel_flags bit 1（disable）：
┌──────────────────────────────────────────────────────────────┐
│ disable = 0：通道正常可用                                    │
│ disable = 1：通道暫時禁用                                    │
│                                                              │
│ 禁用原因：                                                   │
│ ├── 對等節點離線                                             │
│ ├── 通道流動性耗盡                                           │
│ ├── 維護中                                                   │
│ └── 手動禁用                                                 │
└──────────────────────────────────────────────────────────────┘

自動禁用行為（LND）：
┌──────────────────────────────────────────────────────────────┐
│ 對等節點斷開連接時：                                         │
│ 1. 等待一段時間（gossip.inactive-channel-ticker）            │
│ 2. 發送 disable=1 的 channel_update                          │
│ 3. 其他節點不再路由到此通道                                  │
│                                                              │
│ 對等節點重新連接時：                                         │
│ 1. 發送 disable=0 的 channel_update                          │
│ 2. 通道重新可用於路由                                        │
│                                                              │
│ 配置：                                                       │
│ [gossip]                                                     │
│ inactive-channel-ticker = 20m（默認）                        │
└──────────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">私有通道</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        私有通道不廣播 channel_update。
        只有直接參與者知道通道存在。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Gossip 壓縮</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        可以使用 gossip_timestamp_filter
        只接收特定時間後的更新。
      </p>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>陳舊資訊：</strong>
      Gossip 有傳播延遲。路由時可能使用過時的費用資訊，
      導致路由失敗。現代節點使用探測來獲取即時資訊。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/blob/master/07-routing-gossip.md"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 7 Gossip</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/gossip"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Gossip 協議</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/channel-announcements"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Channel Announcements</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/channel-announcements"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Channel Announcements</a
      >
      如何公告新通道。
    </p>
  </div>
</ArticleLayout>
