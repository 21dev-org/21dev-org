---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Route Blinding 路徑盲化"
  description="了解路徑盲化如何隱藏閃電網路支付的接收方身份，保護接收方的節點位置和通道資訊。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Route Blinding' },
  ]}
  difficulty="advanced"
  readingTime="15 分鐘"
  prevPage={{ title: 'Trampoline Routing', href: '/tech/lightning/trampoline' }}
  nextPage={{ title: 'Eltoo', href: '/tech/lightning/eltoo' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Route Blinding？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Route Blinding（路徑盲化，也稱為 Blinded Paths）是一種隱私保護技術，
    允許接收方隱藏自己在網路中的位置。發送方可以將支付路由到接收方，
    但無法知道接收方的真實節點 ID 或其直接連接的通道。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>為什麼重要：</strong>
      傳統的閃電網路發票會暴露接收方的節點公鑰。這讓任何人都可以追蹤誰在收款，
      監控節點活動，甚至進行針對性攻擊。Route Blinding 解決了這個隱私問題。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">隱私問題</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Traditional Invoice Privacy Leakage:

BOLT 11 invoice contents:
lnbc100u1p...
  amount: 100,000 sats
  destination: 03abc123...def (receiver pubkey)
  expiry: 3600 seconds
  route hints:
    pubkey: 02xyz...
    scid: 123x456x0
    fee: 1 sat
    cltv: 40

Problems:
1. Destination pubkey exposes receiver identity
2. Route hints expose receiver's direct connections
3. Can track specific node's payment activity
4. Can analyze receiver's channel structure

Attack scenarios:
• Competitors monitoring merchant payments
• Tracking user spending habits
• Targeted attacks on high-value nodes`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Blinded Path 原理</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Blinded Path Structure:

Receiver Bob creates blinded path:

Real path:
  Node E --> Node F --> Node G --> Bob
  (entry)                          (receiver)

After blinding:

Blinded Path:
  introduction_node: E (public entry point)
  blinding_point: B = b*G
  blinded_hops:
    blinded_node_id: E' = HMAC(E, B)
      encrypted_data: [to F, encrypted]
    blinded_node_id: F' = HMAC(F, B')
      encrypted_data: [to G, encrypted]
    blinded_node_id: G' = HMAC(G, B'')
      encrypted_data: [to Bob, encrypted]
    blinded_node_id: Bob' = HMAC(Bob, B''')
      encrypted_data: [final payload]

Sender only knows:
• Entry node E's real ID
• A series of meaningless blinded_node_ids
• Cannot deduce identities of F, G, Bob`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">密碼學機制</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Blinding Cryptography:

1. Receiver chooses random blinding secret: b
   Calculates blinding point: B = b*G

2. For each node N_i, calculate:

   Shared secret:
   ss_i = SHA256(b * N_i)  // ECDH with node pubkey

   Blinded node ID:
   N_i' = N_i + SHA256("blinded_node_id", ss_i)*G

   Encryption key:
   key_i = SHA256("encrypted_data", ss_i)

   Next hop blinding point:
   B_{i+1} = SHA256("blinding", ss_i) * B

3. When each node receives payment:
   • Use own private key and B to calculate ss
   • Decrypt encrypted_data
   • Calculate next hop's B'
   • Forward to next blinded_node_id

Key points:
• Each node can only decrypt its own data
• Cannot deduce other nodes' identities
• Sender knows nothing about path details`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">支付流程</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Payment Using Blinded Path:

1. Bob creates Offer/Invoice with blinded path
   Offer:
     amount: 100,000 sats
     paths:
       - introduction_node: 02abc...
         blinding_point: 03xyz...
         blinded_hops: [...]

2. Alice calculates route
   Alice -> ... -> entry node E -> [blinded path] -> Bob

   Alice builds onion:
   • Normal hops: path from Alice to E
   • Blinded hops: use blinded_hops directly

3. E receives payment
   • Recognizes this is blinded path
   • Decrypts using blinding_point
   • Finds next hop is F (from encrypted_data)
   • Calculates new blinding_point
   • Forwards

4. F, G process similarly

5. Bob receives payment
   • Decrypts final payload
   • Verifies and accepts payment`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT 12 整合</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Route Blinding 是 BOLT 12 Offers 的核心組件：
  </p>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">BOLT 11（傳統）</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 公開接收方節點 ID</li>
        <li>• 路由提示暴露通道</li>
        <li>• 單次使用發票</li>
        <li>• 接收方必須在線生成</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">BOLT 12 + Blinding</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 隱藏接收方身份</li>
        <li>• 通道資訊加密</li>
        <li>• 可重複使用 Offers</li>
        <li>• 支援回覆路徑</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Reply Path（回覆路徑）</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Reply Path Use Cases:

BOLT 12 Offers flow:
1. Bob publishes Offer (with blinded reply path)
2. Alice requests invoice using Onion Message
3. Bob returns invoice through reply path
4. Alice pays invoice

Reply Path structure:

alice_offer_request:
  offer_id: ...
  amount: 100000
  reply_path:
    introduction_node: node near Alice
    blinding_point: ...
    blinded_hops: [... -> Alice]

Benefits:
• Alice can protect her privacy when sending requests
• Bob can reply without knowing who Alice is
• Bidirectional privacy protection`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">安全考量</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-orange-500/30 bg-orange-500/10">
      <h4 class="font-semibold text-orange-700 dark:text-orange-400 mb-2">入口節點洩露</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        入口節點的身份是公開的。攻擊者可能推斷接收方與入口節點有關係。
        解決方案：使用多個不同的入口節點。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-orange-500/30 bg-orange-500/10">
      <h4 class="font-semibold text-orange-700 dark:text-orange-400 mb-2">路徑長度分析</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Blinded path 的跳數可能洩露資訊。解決方案：添加虛擬跳來混淆路徑長度。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-orange-500/30 bg-orange-500/10">
      <h4 class="font-semibold text-orange-700 dark:text-orange-400 mb-2">時序攻擊</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        如果攻擊者控制入口節點，可能通過時序分析推斷接收方。
        解決方案：使用不可信的中間節點。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Onion Messages</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Route Blinding 依賴 Onion Messages（BOLT 提案）來傳遞無支付的訊息：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Onion Messages vs HTLC:

HTLC (traditional):
• Used for payments
• Requires locking funds
• Has time limits
• Requires channel

Onion Messages:
• Used for communication
• No funds locked
• No time limits
• No direct channel needed

Use cases:
• BOLT 12 invoice requests
• BOLT 12 invoice replies
• Future: payment proofs, chat, etc.

Message type: 513 (onion_message)
Feature bits: 38/39 (option_onion_messages)`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實現狀態</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Core Lightning</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">已支援</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        CLN 完整支援 Route Blinding 和 BOLT 12，是該功能的主要推動者。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >LDK</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">已支援</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        Lightning Dev Kit 支援 Route Blinding 和 Onion Messages。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-yellow-500/30 bg-yellow-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-yellow-500/20 text-yellow-600 dark:text-yellow-400"
          >LND</span
        >
        <span class="text-sm font-semibold text-yellow-700 dark:text-yellow-400">開發中</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        LND 正在開發 BOLT 12 和 Route Blinding 支援。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Eclair</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">已支援</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        Eclair 支援 Route Blinding，用於 Phoenix 錢包的隱私功能。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/pull/765"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Route Blinding BOLT 提案</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt12-offers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 12 Offers</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt-onion"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">洋蔥路由</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/eltoo"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Eltoo</a
      >
      如何改進通道狀態更新機制。
    </p>
  </div>
</ArticleLayout>
