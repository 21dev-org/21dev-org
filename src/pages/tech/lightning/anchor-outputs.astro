---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Anchor Outputs 錨定輸出"
  description="了解 Anchor Outputs 如何讓閃電網路通道在強制關閉時動態調整手續費，解決費率預估難題。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Anchor Outputs' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'Onion Messages', href: '/tech/lightning/onion-messages' }}
  nextPage={{ title: 'Channel Reserve', href: '/tech/lightning/channel-reserve' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Anchor Outputs？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Anchor Outputs（錨定輸出）是閃電網路承諾交易的一項重要改進。它在承諾交易中
    添加兩個小額「錨定」輸出，讓任一方都可以通過 CPFP（Child-Pays-For-Parent）
    在廣播時動態增加交易手續費，解決了預估未來費率的難題。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>核心問題：</strong>
      傳統承諾交易的手續費在簽名時就固定了。如果之後網路擁堵導致費率飆升， 你的通道關閉交易可能卡住無法確認，HTLC
      可能超時，資金面臨風險。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">費率問題</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Traditional Commitment TX Fee Rate Dilemma:

Time T0: Open channel
• Current fee rate: 10 sat/vB
• Commitment tx signed at 20 sat/vB (buffer)
• Looks fine

Time T0 + 6 months: Need to close channel
• Current fee rate: 200 sat/vB (network congestion)
• Your commitment tx only has 20 sat/vB
• Transaction stuck in mempool!
• HTLC may timeout, funds at risk!

Or the opposite:

Time T0: Open channel
• Anticipating future congestion
• Set high fee rate: 100 sat/vB
• Sacrificing channel capacity for fees

Time T0 + 6 months: Close channel
• Current fee rate: 5 sat/vB
• Overpaid by 95 sat/vB!
• Money wasted

Neither approach works!`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Anchor Outputs 解決方案</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Anchor Outputs Commitment Transaction Structure:

Commitment Transaction
+---------------------------------------------------+
| Inputs:                                           |
|   Funding TX output                               |
+---------------------------------------------------+
| Outputs:                                          |
|   to_local (Alice's balance)                      |
|   to_remote (Bob's balance)                       |
|   HTLC outputs (if any)                           |
|   anchor_alice (330 sats)  <- anchor output       |
|   anchor_bob (330 sats)    <- anchor output       |
+---------------------------------------------------+
| Fee: minimum rate (e.g., 1 sat/vB)                |
+---------------------------------------------------+

Using CPFP to accelerate:

+--------------------+
| Commitment TX      |------> low fee rate
| (parent)           |
+--------+-----------+
         |
         | spend anchor_alice
         v
+--------------------+
| CPFP TX            |------> high fee rate
| (child)            |        covers total fee
+--------------------+

Miners will include parent and child together!`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Anchor 腳本</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Anchor Output Script:

<anchor_pubkey> CHECKSIG
IFDUP
NOTIF
  16 CHECKSEQUENCEVERIFY
ENDIF

Explanation:
1. Owner can immediately spend with anchor_pubkey
2. If signature fails (someone else tries to spend)
   -> Must wait 16 blocks
3. This allows anyone to clean up unused anchors after 16 blocks

Why 330 sats?
• This is the dust limit
• Smaller outputs would be rejected by nodes
• Small enough to not waste channel capacity
• Large enough to be recognized as valid output

Feature bits:
• option_anchor_outputs (bit 20/21) - original
• option_anchors_zero_fee_htlc_tx (bit 22/23) - improved`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Zero-Fee HTLC Anchors</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    改進版的 Anchor Outputs 還解決了 HTLC 交易的費率問題：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Zero-Fee HTLC Transactions:

Problem: HTLC-Success and HTLC-Timeout txs also need fees

Traditional approach:
  Commitment TX --> HTLC Output
                         |
                         v
                    HTLC-Success TX (fixed fee rate)
                    or HTLC-Timeout TX (fixed fee rate)

  These second-stage tx fee rates are also pre-signed!

Zero-Fee HTLC approach:
  Commitment TX --> HTLC Output
                         |
                         v
                    HTLC TX (0 fee rate)
                         |
                         | add extra input to pay fee
                         v
                    Complete tx with CPFP

Benefits:
• HTLC txs can also dynamically adjust fee rate
• More flexibility in HTLC timeout races
• Can use wallet UTXOs to pay fees`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">UTXO 需求</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-orange-500/30 bg-orange-500/10">
      <h4 class="font-semibold text-orange-700 dark:text-orange-400 mb-2">新的運營需求</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        使用 Anchor Outputs 的節點需要維護額外的鏈上 UTXO 用於 CPFP。 如果沒有可用
        UTXO，可能無法及時加速交易。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">UTXO 管理</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• LND 有專用的「anchor 錢包」</li>
        <li>• 自動維護最低餘額</li>
        <li>• 監控 UTXO 可用性</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">與 Watchtower 的關係</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Watchtower + Anchor Outputs:

Traditional Watchtower:
• Stores pre-signed penalty transactions
• Fee rate fixed at signing time
• If fee rate too low, penalty may fail!

Anchor-aware Watchtower:
• Stores penalty tx + has CPFP capability
• Needs its own UTXO pool
• Can dynamically adjust fee rate
• Increases Watchtower costs

Challenges for Watchtower:
1. Maintain UTXO pool
2. Monitor fee rate market
3. Ready to pay CPFP fees
4. May need to charge users to cover costs`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">版本演進</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">原版 (option_anchor_outputs)</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        第一版 Anchor Outputs，承諾交易有 anchors，但 HTLC 交易仍使用預簽費率。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">
        改進版 (option_anchors_zero_fee_htlc_tx)
      </h4>
      <p class="text-sm text-[var(--text-secondary)]">
        當前推薦版本。HTLC 交易使用零費率，也可以通過 CPFP 加速。
        <code class="text-xs bg-[var(--bg-secondary)] px-1 rounded">static_remotekey</code> 是必需的。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-blue-500/30 bg-blue-500/10">
      <h4 class="font-semibold text-blue-700 dark:text-blue-400 mb-2">
        Simple Taproot Channels（未來）
      </h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Taproot 通道會使用不同的 anchor 設計，可能只需要單個共享 anchor。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實現狀態</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >LND</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">默認啟用</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        LND 0.12+ 默認使用 anchor channels，自動管理 anchor 錢包。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Core Lightning</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">CLN 支持 anchor channels，可通過配置啟用。</p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Eclair</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">Eclair 和 Phoenix 支持 anchor channels。</p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/pull/688"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Anchor Outputs BOLT 提案</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/commitment-tx"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">承諾交易</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/watchtowers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Watchtowers</a
      >
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/channel-reserve"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">通道儲備金</a
      >
      如何保護雙方免受欺詐。
    </p>
  </div>
</ArticleLayout>
