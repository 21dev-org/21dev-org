---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Splicing"
  description="深入理解通道拼接技術，無需關閉通道即可調整容量。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Splicing' },
  ]}
  difficulty="advanced"
  readingTime="18 分鐘"
  prevPage={{ title: 'Submarine Swaps', href: '/tech/lightning/submarine-swaps' }}
  nextPage={{ title: 'BOLT12 Offers', href: '/tech/lightning/bolt12-offers' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Splicing？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Splicing（通道拼接）是一種允許用戶在不關閉閃電網路通道的情況下，
    動態增加或減少通道容量的技術。這意味著你可以向通道添加資金（splice-in）
    或從通道中提取資金到鏈上（splice-out），同時保持通道運作。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>核心優勢：</strong>
      傳統上，調整通道容量需要關閉舊通道再開新通道，產生兩筆鏈上交易。 Splicing 只需要一筆交易，節省手續費並保持通道連續可用。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">兩種 Splice 操作</h2>

  <div class="grid md:grid-cols-2 gap-6 mb-8">
    <div class="p-6 rounded-xl border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-4">
        <div
          class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-green-700 dark:text-green-400">Splice-In</h3>
      </div>
      <p class="text-sm text-[var(--text-secondary)] mb-3">向現有通道添加資金，增加通道容量</p>
      <ul class="space-y-2 text-sm text-[var(--text-secondary)]">
        <li>• 從鏈上 UTXO 添加資金</li>
        <li>• 增加本地餘額</li>
        <li>• 通道繼續運作</li>
      </ul>
    </div>

    <div class="p-6 rounded-xl border border-blue-500/30 bg-blue-500/10">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center">
          <svg
            class="w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-blue-700 dark:text-blue-400">Splice-Out</h3>
      </div>
      <p class="text-sm text-[var(--text-secondary)] mb-3">從通道提取資金到鏈上地址</p>
      <ul class="space-y-2 text-sm text-[var(--text-secondary)]">
        <li>• 將通道資金發送到鏈上</li>
        <li>• 減少通道容量</li>
        <li>• 無需關閉通道</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">運作原理</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Splicing 的核心是創建一個新的 funding transaction，同時維護通道的連續性：
  </p>

  <div class="not-prose mb-8 space-y-3">
    {
      [
        { step: '1', title: '協商 Splice', desc: '雙方同意進行 splice 操作，協商新的通道容量' },
        {
          step: '2',
          title: '構建交易',
          desc: '創建新的 funding tx，花費原 funding output + 新資金（splice-in）或產生鏈上輸出（splice-out）',
        },
        { step: '3', title: '並行狀態', desc: '在新 funding tx 確認前，同時維護舊和新的承諾交易' },
        { step: '4', title: '簽名交換', desc: '雙方交換新 funding tx 和對應承諾交易的簽名' },
        { step: '5', title: '廣播確認', desc: '廣播新 funding tx，等待確認後切換到新狀態' },
      ].map((item) => (
        <div class="flex items-start gap-4 p-4 rounded-lg bg-[var(--surface-elevated)] border border-[var(--border-default)]">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-yellow-500 text-white flex items-center justify-center font-bold text-sm">
            {item.step}
          </div>
          <div>
            <h4 class="font-semibold text-[var(--text-primary)]">{item.title}</h4>
            <p class="text-sm text-[var(--text-secondary)]">{item.desc}</p>
          </div>
        </div>
      ))
    }
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Splice 交易結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]"><code># Splice-In 交易
Inputs:
  - 原 funding output (2-of-2 multisig)
  - 新增 UTXO（Alice 的鏈上資金）

Outputs:
  - 新 funding output (2-of-2 multisig, 容量增加)

# Splice-Out 交易
Inputs:
  - 原 funding output (2-of-2 multisig)

Outputs:
  - 新 funding output (2-of-2 multisig, 容量減少)
  - 鏈上輸出（Alice 的提款地址）</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">關鍵技術：並行承諾</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    在 splice 交易確認期間，通道需要同時支持兩種狀態：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-purple-500/10 border border-purple-500/30">
    <h4 class="font-semibold text-purple-700 dark:text-purple-400 mb-3">並行狀態管理</h4>
    <ul class="space-y-2 text-sm text-[var(--text-secondary)]">
      <li class="flex items-start gap-2">
        <span class="text-purple-500">1.</span>
        <span><strong>舊承諾交易</strong>：基於原 funding output，在新 tx 確認前仍有效</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-purple-500">2.</span>
        <span><strong>新承諾交易</strong>：基於新 funding output，新 tx 確認後生效</span>
      </li>
      <li class="flex items-start gap-2">
        <span class="text-purple-500">3.</span>
        <span><strong>狀態同步</strong>：每次通道更新都要同時更新兩套承諾交易</span>
      </li>
    </ul>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">與傳統操作比較</h2>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col"
            >操作</th
          >
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col"
            >傳統方式</th
          >
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col"
            >Splicing</th
          >
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">鏈上交易數</td>
          <td class="py-3 px-4">2 筆（關閉 + 開啟）</td>
          <td class="py-3 px-4">1 筆</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">通道停機時間</td>
          <td class="py-3 px-4">等待兩次確認</td>
          <td class="py-3 px-4">無</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">路由中斷</td>
          <td class="py-3 px-4">是</td>
          <td class="py-3 px-4">否</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">通道 ID</td>
          <td class="py-3 px-4">改變</td>
          <td class="py-3 px-4">改變</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">手續費成本</td>
          <td class="py-3 px-4">較高</td>
          <td class="py-3 px-4">較低</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">應用場景</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    {
      [
        {
          title: '動態容量調整',
          desc: '根據業務需求隨時增減通道容量，無需中斷服務',
          icon: '📊',
        },
        {
          title: '整合鏈上支付',
          desc: '直接從閃電通道支付鏈上地址，無需先關閉通道',
          icon: '🔗',
        },
        {
          title: '通道合併',
          desc: '將多個小通道合併為一個大通道，簡化管理',
          icon: '🔄',
        },
        {
          title: 'UTXO 整合',
          desc: '在 splice 時順便整合鏈上 UTXO，節省未來手續費',
          icon: '📦',
        },
      ].map((item) => (
        <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
          <div class="text-2xl mb-2">{item.icon}</div>
          <h4 class="font-semibold text-[var(--text-primary)] mb-1">{item.title}</h4>
          <p class="text-sm text-[var(--text-secondary)]">{item.desc}</p>
        </div>
      ))
    }
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實現狀態</h2>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col"
            >實現</th
          >
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col"
            >狀態</th
          >
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col"
            >備註</th
          >
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">CLN (Core Lightning)</td>
          <td class="py-3 px-4"><span class="text-green-500">✓ 已支持</span></td>
          <td class="py-3 px-4">v23.08 開始</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">Phoenix</td>
          <td class="py-3 px-4"><span class="text-green-500">✓ 已支持</span></td>
          <td class="py-3 px-4">移動端錢包</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">LND</td>
          <td class="py-3 px-4"><span class="text-yellow-500">⏳ 開發中</span></td>
          <td class="py-3 px-4">預計 2024</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">Eclair</td>
          <td class="py-3 px-4"><span class="text-green-500">✓ 已支持</span></td>
          <td class="py-3 px-4">ACINQ 實現</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">
    未來展望：Splicing + Taproot
  </h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    結合 Taproot 通道後，Splicing 將獲得額外優勢：
  </p>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-yellow-500 font-bold">•</span>
      <span><strong class="text-[var(--text-primary)]">更小的交易</strong>：Schnorr 簽名更緊湊</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-yellow-500 font-bold">•</span>
      <span
        ><strong class="text-[var(--text-primary)]">更好的隱私</strong>：無法區分 splice 和普通交易</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-yellow-500 font-bold">•</span>
      <span
        ><strong class="text-[var(--text-primary)]">批量操作</strong>：可以將多個 splice
        合併為單筆交易</span
      >
    </li>
  </ul>
</ArticleLayout>
