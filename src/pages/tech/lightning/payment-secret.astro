---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Payment Secret 支付密鑰"
  description="了解閃電網路的 payment_secret 機制，如何防止探測攻擊並支援多路徑支付。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Payment Secret' },
  ]}
  difficulty="intermediate"
  readingTime="8 分鐘"
  prevPage={{ title: 'Payment Hash', href: '/tech/lightning/payment-hash' }}
  nextPage={{ title: 'MPP', href: '/tech/lightning/mpp' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Payment Secret？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Payment Secret（支付密鑰）是發票中包含的 32 字節隨機值，付款人必須在支付時
    提供正確的 payment_secret 才能成功完成支付。這提供了額外的安全層。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>必要功能：</strong>
      自 2019 年起，payment_secret 成為閃電網路的標準要求。
      所有現代錢包和節點都支援此功能。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">為什麼需要 Payment Secret</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Payment Secret 解決的問題：

問題 1：前向劫持攻擊

沒有 payment_secret 的情況：

  Alice --> Bob --> Carol --> 收款人

攻擊：Carol 是惡意中繼節點
1. Carol 看到 payment_hash
2. Carol 向收款人發起另一筆同 hash 的支付
3. Carol 獲得 preimage
4. Carol 使用 preimage 領取 Alice 的支付
5. Carol 不轉發 Alice 的原始支付

結果：Carol 獲得免費的服務/商品

有 payment_secret 的保護：

  Alice --> Bob --> Carol --> 收款人

1. 收款人生成發票，包含：
   • payment_hash
   • payment_secret（只有 Alice 知道）

2. Alice 在最終 HTLC payload 中包含 payment_secret

3. Carol 無法看到 payment_secret（洋蔥加密）

4. 即使 Carol 知道 payment_hash，
   也無法創建有效的支付請求

5. 收款人驗證 payment_secret 才會揭露 preimage`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">問題 2：探測攻擊</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`探測攻擊：

沒有 payment_secret 時：

攻擊者可以：
1. 生成隨機 payment_hash
2. 向目標節點發送探測支付
3. 觀察錯誤訊息：
   • "unknown payment hash" -> 路由可達
   • "channel exhausted" -> 通道餘額不足

這允許攻擊者：
• 發現私有通道
• 估計通道餘額
• 追蹤支付模式

有 payment_secret 的保護：

節點行為改變：

沒有正確 payment_secret 的支付：
-> 直接拒絕，返回 "incorrect_or_unknown_payment_details"

這使得探測更困難：
• 無法區分「hash 錯誤」和「secret 錯誤」
• 無法確認路由可達性
• 大大降低探測效率`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">MPP 中的作用</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`多路徑支付（MPP）與 payment_secret：

payment_secret 的關鍵作用：

MPP 將大額支付拆分成多個 HTLC：

發票：100,000 sats

拆分：
• HTLC 1: 40,000 sats（路徑 A）
• HTLC 2: 35,000 sats（路徑 B）
• HTLC 3: 25,000 sats（路徑 C）

所有 HTLC 共享：
• 相同的 payment_hash
• 相同的 payment_secret

收款人處理：

收到第一個 HTLC 時：
1. 驗證 payment_secret
2. 記錄 payment_hash + secret 組合
3. 累加金額
4. 等待更多 HTLC...

收到後續 HTLC 時：
1. 驗證 payment_secret 匹配
2. 驗證 payment_hash 匹配
3. 累加金額
4. 檢查是否達到 total_msat

達到總金額時：
1. 揭露 preimage 給所有 HTLC
2. 原子完成所有部分支付

安全保證：
• 沒有正確 secret，無法「搭便車」到 MPP 支付
• 每個部分都必須是同一個付款人
• 防止部分支付被劫持`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">技術細節</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Payment Secret 規範：

發票中的 payment_secret（BOLT 11）：

Tagged field 's'（type 16）：
• 長度：52 data 字符（32 bytes）
• 值：隨機生成的 256-bit 值

範例發票字段：
s = 0x1234567890abcdef...（32 bytes）

洋蔥 payload 中的 payment_data（TLV type 8）：

只在最終節點的 payload 中：

payment_data:
• payment_secret: 32 bytes
• total_msat: 8 bytes（TU64）

total_msat 用於 MPP：
• 表示整個支付的總金額
• 不是當前 HTLC 的金額
• 收款人用來判斷是否收齊所有部分

功能位：

var_onion_optin (8/9)：
  支援 TLV 洋蔥 payload
  payment_secret 需要此功能

payment_secret (14/15)：
  明確表示支援 payment_secret
  現在是強制要求

basic_mpp (16/17)：
  支援基本 MPP
  需要 payment_secret`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">生成方式</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Payment secret 應該是密碼學安全的隨機數。
        每個發票必須使用不同的 secret。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">儲存需求</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        收款節點必須記住發出的 payment_secret，
        直到發票過期或支付完成。
      </p>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>不要混淆：</strong>
      payment_secret 和 payment_preimage 是不同的東西。
      Secret 在發票中公開（給付款人），preimage 在支付完成後揭露。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/blob/master/04-onion-routing.md"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 4 Onion Routing</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/payment-hash"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Payment Hash</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/mpp"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">多路徑支付</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/mpp"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">多路徑支付</a
      >
      如何利用 payment_secret 安全拆分支付。
    </p>
  </div>
</ArticleLayout>
