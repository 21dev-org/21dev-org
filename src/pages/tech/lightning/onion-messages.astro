---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Onion Messages 洋蔥訊息"
  description="了解洋蔥訊息如何在閃電網路中實現無需支付、無需通道的端到端加密通訊，是 BOLT 12 的基礎設施。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Onion Messages' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'Hold Invoices', href: '/tech/lightning/hold-invoices' }}
  nextPage={{ title: 'Anchor Outputs', href: '/tech/lightning/anchor-outputs' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Onion Messages？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Onion Messages（洋蔥訊息）是閃電網路的一種新型通訊機制，允許節點之間
    發送端到端加密的訊息，而不需要建立通道或進行支付。它使用與支付相同的
    洋蔥路由技術來保護隱私，是 BOLT 12 Offers 的核心基礎設施。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>核心價值：</strong>
      Onion Messages 讓閃電網路從純支付網路擴展為通用的隱私通訊層，
      支持發票請求、報價查詢、未來甚至可能支持聊天應用。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">與 HTLC 的區別</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`HTLC vs Onion Messages:

HTLC (Payments):
• Transfers value (sats)
• Requires channels and liquidity
• Funds locked until settlement
• Has time limits (CLTV)
• Failures roll back
• Cannot send pure messages

Onion Messages:
• Only transfers data (no value transfer)
• No channel needed (just need node pubkey)
• No funds locked
• No time limits
• Fire and forget
• Cannot transfer sats

Both use onion routing for privacy!`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">訊息結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Onion Message Structure:

Message type: 513 (onion_message)

onion_message:
  blinding_point: 33 bytes (for route blinding)
  onion_routing_packet:
    version: 0
    public_key: 33 bytes
    hop_payloads: 1300 bytes (encrypted routing info)
    hmac: 32 bytes

Per-hop Payload (TLV):
  encrypted_recipient_data (type 4): encrypted routing data
  next_node_id (type 6): next hop node ID
  path_id (type 8): for reply path identification
  message (type 64): final message content
  invoice_request (type 66): BOLT 12 invoice request
  invoice (type 68): BOLT 12 invoice`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">路由與轉發</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Onion Message Routing:

Routing without channels:
  Alice --> Bob --> Carol --> Dave
     |         |        |
     |    Can forward without channels!
     |
     +-- Only need to know network topology

Send flow:
1. Alice knows Dave's public key
2. Alice finds a path from gossip network
3. Alice builds onion packet
4. Each node decrypts its layer, forwards to next hop
5. Dave receives final message

Connectionless forwarding:

Bob receives onion_message:
1. Uses blinding_point to decrypt his payload
2. Finds next_node_id
3. Calculates new blinding_point
4. Forwards to next hop

Bob doesn't need channels with Alice or Dave!`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Reply Path（回覆路徑）</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Reply Path Mechanism:

Problem: How to reply to an anonymous sender?

Solution: Sender includes blinded reply path

Alice's request message:
  destination: Dave (or blinded path to Dave)
  reply_path:
    introduction_node: Bob
    blinding_point: ...
    blinded_hops: [..., ..., Alice]
  message: "Please send me an invoice"

Dave replies:
1. Dave decrypts message
2. Dave uses reply_path to send reply
3. Reply reaches Alice through blinded path
4. Dave doesn't know who Alice is!

Bidirectional privacy:
• Alice doesn't know Dave's real location (if using blinded path)
• Dave doesn't know Alice's real location (through reply path)`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT 12 整合</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Onion Messages 是 BOLT 12 Offers 的傳輸層：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`BOLT 12 Flow Using Onion Messages:

1. Bob publishes Offer
   lno1... (contains blinded path to Bob)

2. Alice sends invoice_request (Onion Message)
   onion_message:
     destination: Bob's blinded path
     payload:
       invoice_request:
         offer_id: ...
         amount: 100000
         payer_key: Alice's key
       reply_path: [... -> Alice]

3. Bob replies with invoice (Onion Message)
   onion_message:
     destination: Alice's reply_path
     payload:
       invoice:
         amount: 100000
         payment_hash: ...
         paths: [blinded paths to Bob]

4. Alice pays using blinded paths from invoice`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">DoS 保護</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">潛在風險</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 免費轉發可能被濫用</li>
        <li>• 可能用於垃圾訊息攻擊</li>
        <li>• 節點資源可能被耗盡</li>
        <li>• 無法追蹤發送者</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">保護措施</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 速率限制（每秒/每對等）</li>
        <li>• 訊息大小限制</li>
        <li>• 可選擇不轉發</li>
        <li>• 未來可能加入付費轉發</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">未來應用</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">隱私聊天</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        基於 Onion Messages 構建端到端加密的去中心化聊天應用。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">支付證明傳遞</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        支付完成後，通過 Onion Message 發送收據或額外數據。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">訂閱通知</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        商家可以向訂閱者發送更新通知，用戶保持匿名。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實現狀態</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Core Lightning</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">完整支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        CLN 是 Onion Messages 的主要推動者，完整支持發送、接收和轉發。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >LDK</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">完整支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        Lightning Dev Kit 支持 Onion Messages 和 BOLT 12。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-yellow-500/30 bg-yellow-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-yellow-500/20 text-yellow-600 dark:text-yellow-400"
          >LND</span
        >
        <span class="text-sm font-semibold text-yellow-700 dark:text-yellow-400">開發中</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        LND 正在開發 BOLT 12 和 Onion Messages 支持。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Eclair</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">已支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        Eclair 支持 Onion Messages，用於 Phoenix 的 BOLT 12 功能。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/pull/759"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Onion Messages BOLT 提案</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt12-offers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 12 Offers</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/route-blinding"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Route Blinding</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/anchor-outputs"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Anchor Outputs</a
      >
      如何解決閃電網路的手續費問題。
    </p>
  </div>
</ArticleLayout>
