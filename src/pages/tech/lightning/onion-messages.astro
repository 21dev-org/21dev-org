---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Onion Messages 洋蔥訊息"
  description="了解洋蔥訊息如何在閃電網路中實現無需支付、無需通道的端到端加密通訊，是 BOLT 12 的基礎設施。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Onion Messages' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'Hold Invoices', href: '/tech/lightning/hold-invoices' }}
  nextPage={{ title: 'Anchor Outputs', href: '/tech/lightning/anchor-outputs' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Onion Messages？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Onion Messages（洋蔥訊息）是閃電網路的一種新型通訊機制，允許節點之間
    發送端到端加密的訊息，而不需要建立通道或進行支付。它使用與支付相同的
    洋蔥路由技術來保護隱私，是 BOLT 12 Offers 的核心基礎設施。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>核心價值：</strong>
      Onion Messages 讓閃電網路從純支付網路擴展為通用的隱私通訊層，
      支持發票請求、報價查詢、未來甚至可能支持聊天應用。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">與 HTLC 的區別</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`HTLC vs Onion Messages：

HTLC（支付）：
┌─────────────────────────────────────────────────────────┐
│ ✓ 傳遞價值（sats）                                      │
│ ✓ 需要通道和流動性                                      │
│ ✓ 資金會被鎖定直到結算                                  │
│ ✓ 有時間限制（CLTV）                                    │
│ ✓ 失敗會回滾                                            │
│ ✗ 無法發送純訊息                                        │
└─────────────────────────────────────────────────────────┘

Onion Messages：
┌─────────────────────────────────────────────────────────┐
│ ✓ 只傳遞數據（無價值轉移）                               │
│ ✓ 不需要通道（只需知道節點公鑰）                         │
│ ✓ 不鎖定任何資金                                        │
│ ✓ 沒有時間限制                                          │
│ ✓ 即發即忘（fire and forget）                           │
│ ✗ 無法傳遞 sats                                         │
└─────────────────────────────────────────────────────────┘

兩者都使用洋蔥路由保護隱私！`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">訊息結構</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Onion Message 結構：

訊息類型：513 (onion_message)

┌─────────────────────────────────────────────────────────┐
│ onion_message:                                          │
│   blinding_point: 33 bytes (用於 route blinding)        │
│   onion_routing_packet:                                 │
│     ├── version: 0                                     │
│     ├── public_key: 33 bytes                           │
│     ├── hop_payloads: 1300 bytes (加密的路由信息)       │
│     └── hmac: 32 bytes                                 │
└─────────────────────────────────────────────────────────┘

每跳的 Payload：
┌─────────────────────────────────────────────────────────┐
│ hop_payload (TLV):                                      │
│   encrypted_recipient_data (type 4): 加密的路由數據     │
│   next_node_id (type 6): 下一跳的節點 ID               │
│   path_id (type 8): 用於回覆路徑識別                    │
│   message (type 64): 最終訊息內容                       │
│   invoice_request (type 66): BOLT 12 發票請求           │
│   invoice (type 68): BOLT 12 發票                       │
└─────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">路由與轉發</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Onion Message 路由：

不需要通道的路由：
  Alice ──> Bob ──> Carol ──> Dave
     │         │        │
     │    沒有通道也能轉發！
     │
     └── 只需知道網路拓撲

發送流程：
1. Alice 知道 Dave 的公鑰
2. Alice 從 gossip 網路找到一條路徑
3. Alice 構建洋蔥包
4. 每個節點解密自己的層，轉發給下一跳
5. Dave 收到最終訊息

無連接轉發：
┌─────────────────────────────────────────────────────────┐
│ Bob 收到 onion_message：                                │
│ 1. 使用 blinding_point 解密自己的 payload               │
│ 2. 找到 next_node_id                                   │
│ 3. 計算新的 blinding_point                              │
│ 4. 轉發給下一跳                                         │
│                                                         │
│ Bob 不需要和 Alice 或 Dave 有通道！                      │
└─────────────────────────────────────────────────────────┘`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Reply Path（回覆路徑）</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Reply Path 機制：

問題：如何回覆匿名的發送方？

解決方案：發送方包含 blinded reply path

┌─────────────────────────────────────────────────────────┐
│ Alice 的請求訊息：                                       │
│   destination: Dave (或 blinded path 到 Dave)           │
│   reply_path:                                           │
│     introduction_node: Bob                              │
│     blinding_point: ...                                 │
│     blinded_hops: [..., ..., Alice]                    │
│   message: "請給我發票"                                  │
└─────────────────────────────────────────────────────────┘

Dave 回覆：
1. Dave 解密訊息
2. Dave 使用 reply_path 發送回覆
3. 回覆通過盲化路徑到達 Alice
4. Dave 不知道 Alice 是誰！

雙向隱私：
- Alice 不知道 Dave 的真實位置（如果用 blinded path）
- Dave 不知道 Alice 的真實位置（通過 reply path）`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT 12 整合</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Onion Messages 是 BOLT 12 Offers 的傳輸層：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`BOLT 12 流程使用 Onion Messages：

1. Bob 發布 Offer
   lno1...（包含 blinded path 到 Bob）

2. Alice 發送 invoice_request（Onion Message）
   ┌──────────────────────────────────────────┐
   │ onion_message:                           │
   │   destination: Bob's blinded path        │
   │   payload:                               │
   │     invoice_request:                     │
   │       offer_id: ...                      │
   │       amount: 100000                     │
   │       payer_key: Alice's key             │
   │     reply_path: [... → Alice]            │
   └──────────────────────────────────────────┘

3. Bob 回覆 invoice（Onion Message）
   ┌──────────────────────────────────────────┐
   │ onion_message:                           │
   │   destination: Alice's reply_path        │
   │   payload:                               │
   │     invoice:                             │
   │       amount: 100000                     │
   │       payment_hash: ...                  │
   │       paths: [blinded paths to Bob]      │
   └──────────────────────────────────────────┘

4. Alice 使用發票中的 blinded paths 支付`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">DoS 保護</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">潛在風險</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 免費轉發可能被濫用</li>
        <li>• 可能用於垃圾訊息攻擊</li>
        <li>• 節點資源可能被耗盡</li>
        <li>• 無法追蹤發送者</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">保護措施</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 速率限制（每秒/每對等）</li>
        <li>• 訊息大小限制</li>
        <li>• 可選擇不轉發</li>
        <li>• 未來可能加入付費轉發</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">未來應用</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">隱私聊天</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        基於 Onion Messages 構建端到端加密的去中心化聊天應用。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">支付證明傳遞</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        支付完成後，通過 Onion Message 發送收據或額外數據。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">訂閱通知</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        商家可以向訂閱者發送更新通知，用戶保持匿名。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實現狀態</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Core Lightning</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">完整支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        CLN 是 Onion Messages 的主要推動者，完整支持發送、接收和轉發。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >LDK</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">完整支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        Lightning Dev Kit 支持 Onion Messages 和 BOLT 12。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-yellow-500/30 bg-yellow-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-yellow-500/20 text-yellow-600 dark:text-yellow-400"
          >LND</span
        >
        <span class="text-sm font-semibold text-yellow-700 dark:text-yellow-400">開發中</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        LND 正在開發 BOLT 12 和 Onion Messages 支持。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <div class="flex items-center gap-3 mb-2">
        <span
          class="px-2 py-1 text-xs font-mono rounded bg-green-500/20 text-green-600 dark:text-green-400"
          >Eclair</span
        >
        <span class="text-sm font-semibold text-green-700 dark:text-green-400">已支持</span>
      </div>
      <p class="text-sm text-[var(--text-secondary)]">
        Eclair 支持 Onion Messages，用於 Phoenix 的 BOLT 12 功能。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/pull/759"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Onion Messages BOLT 提案</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt12-offers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 12 Offers</a>
    </li>
    <li>
      • <a
        href="/tech/lightning/route-blinding"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Route Blinding</a>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/anchor-outputs"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">Anchor Outputs</a
      >
      如何解決閃電網路的手續費問題。
    </p>
  </div>
</ArticleLayout>
