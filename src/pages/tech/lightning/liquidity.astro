---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="流動性管理"
  description="了解閃電網路流動性的概念，以及如何有效管理通道餘額以確保支付順利。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: '流動性管理' },
  ]}
  difficulty="intermediate"
  readingTime="15 分鐘"
  prevPage={{ title: '路由與尋路', href: '/tech/lightning/routing' }}
  nextPage={{ title: '通道管理', href: '/tech/lightning/channel-management' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是流動性？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    在閃電網路中，「流動性」指的是你在通道中可用於支付的資金。
    由於支付通道是雙向的，你的流動性決定了你能發送和接收多少資金。
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <p class="text-[var(--text-secondary)] mb-2">流動性類型：</p>
    <p class="text-[var(--text-secondary)] mb-3">通道容量: 1,000,000 sats</p>
    <table class="mb-4">
      <thead>
        <tr>
          <th colspan="2" class="text-center">通道總容量</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="text-center">
            <strong>本地餘額</strong><br />
            <span class="text-sm">600,000 sats</span>
          </td>
          <td class="text-center">
            <strong>遠端餘額</strong><br />
            <span class="text-sm">400,000 sats</span>
          </td>
        </tr>
        <tr>
          <td class="text-center">
            <strong>出站流動性</strong><br />
            <span class="text-xs">(可發送)</span>
          </td>
          <td class="text-center">
            <strong>入站流動性</strong><br />
            <span class="text-xs">(可接收)</span>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="text-[var(--text-secondary)] text-sm">
      出站流動性 (Outbound) = 本地餘額<br />入站流動性 (Inbound) = 遠端餘額
    </p>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>關鍵洞見：</strong>
      開啟通道時你提供的資金是「出站流動性」。 要獲得「入站流動性」，需要別人向你開通道，或者你先花掉一些資金。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">流動性問題</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">缺乏入站流動性</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        剛開通道的節點只有出站流動性，無法接收大額支付。商家經常遇到這個問題。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">通道不平衡</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        經常收款或付款會導致通道餘額偏向一側，影響雙向支付能力。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">流動性碎片化</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        資金分散在多個小通道，單個通道無法處理大額支付。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">路由節點耗盡</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        高流量的路由節點某一側流動性被耗盡，無法繼續轉發。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">獲取入站流動性</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">1. 請求入站通道</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Method: Ask others to open channel to you

Free methods:
• Join Lightning Network community
• Provide valuable node (good connectivity)
• Participate in liquidity swap groups

Paid methods:
• Liquidity markets (Magma, Pool, Amboss)
• LSP (Lightning Service Provider)
• Channel rental services`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">2. 使用 LSP</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`LSP (Lightning Service Provider):

Services:
• Auto-open inbound channels
• On-demand liquidity (JIT channels)
• Liquidity management

Common LSPs:
• ACINQ (Phoenix)
• Breez
• Voltage
• Zero Fee Routing

JIT (Just-In-Time) Channels:
1. Receive payment request
2. LSP opens channel instantly
3. Channel fee deducted from payment
4. User doesn't wait for confirmation`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">3. 流動性市場</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Liquidity Market Platforms:

Lightning Pool (Lightning Labs):
• Auction model
• Buy/rent channels
• APY billing

Magma (Amboss):
• P2P liquidity market
• Fixed price or auction
• Reputation system

Pricing Factors:
• Channel size
• Rental period
• Peer node quality
• Market supply/demand`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">通道再平衡</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    當通道不平衡時，可以通過「再平衡」來調整餘額分布：
  </p>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">循環再平衡</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Circular Rebalance Principle:

Goal: Move funds from channel A to channel B

Your Node --- ChannelA --- Node1
    |                        |
    |                        |
ChannelB                     |
    |                        |
    +---- Node2 -------------+

Steps:
1. Send to yourself via channel B
2. Route through Node2 -> Node1
3. Return from channel A to yourself

Result:
• Channel A local balance decreases
• Channel B local balance increases
• Pay routing fees

Tools:
• lncli: bos rebalance
• Core Lightning: rebalance plugin
• RTL, ThunderHub and other GUIs`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">潛水艇交換</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Submarine Swap:

Loop Out (increase inbound):
Lightning -> On-chain
1. Send Lightning payment to swap service
2. Service sends on-chain BTC to you
3. Your outbound liquidity becomes inbound

Loop In (increase outbound):
On-chain -> Lightning
1. Send on-chain BTC to swap service
2. Service sends Lightning payment to you
3. You get more outbound liquidity

Service Providers:
• Loop (Lightning Labs)
• Boltz
• Deezy`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Splicing</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Splicing 允許在不關閉通道的情況下調整容量：
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Splice-In (increase capacity):
1. Add more funds to existing channel
2. Create new funding tx
3. Channel continues operating, no interruption

Original: 1 BTC -> New: 2 BTC

Splice-Out (decrease capacity):
1. Extract partial funds from channel
2. Funds sent to on-chain address
3. Channel capacity reduced but continues

Original: 2 BTC -> New: 1.5 BTC + 0.5 BTC on-chain

Advantages:
• No need to close/reopen channel
• Save on-chain fees
• Maintain payment routing continuity

Status: Core Lightning supported, LND in development`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">路由節點策略</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Routing Node Liquidity Strategy:

1. Dynamic Fees
   • Raise fees for low liquidity direction
   • Lower fees for high liquidity direction
   • Auto-guide traffic balance

2. Channel Selection
   • Choose high-traffic peers
   • Avoid dead-end nodes
   • Establish triangular connections

3. Rebalance Timing
   • Set thresholds (e.g. 20%-80%)
   • Auto-rebalance below threshold
   • Consider fee cost-effectiveness

4. Monitoring Tools
   • Track traffic per channel
   • Identify bottleneck channels
   • Analyze profit margins`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">流動性成本</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Liquidity Cost Calculation:

Channel Opening Costs:
• On-chain fee (opening)
• Capital lock-up cost (opportunity cost)
• On-chain fee (closing)

Maintenance Costs:
• Rebalancing fees
• Monitoring and management time

Revenue:
• Routing fees
• Liquidity rental income

ROI Calculation:
Yield = (Routing Income - Costs) / Capital Invested

Typical Routing Node:
• APY 1-5% (market dependent)
• Requires active management`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">最佳實踐</h2>

  <div class="space-y-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">多樣化連接</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        與不同類型的節點建立通道：大型路由節點、商家、交易所等。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">適當的通道大小</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        通道太小無法處理正常支付，太大則資金效率低。根據需求選擇。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">定期監控</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        使用工具監控通道餘額，在失衡嚴重前採取行動。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">成本意識</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        再平衡有成本，只在必要時進行。考慮使用動態手續費替代。
      </p>
    </div>
  </div>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/channel-management"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">通道管理</a
      >
      的具體操作和工具。
    </p>
  </div>
</ArticleLayout>
