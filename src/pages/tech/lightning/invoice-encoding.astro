---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Invoice Encoding 發票編碼"
  description="深入了解 BOLT 11 發票的編碼格式，包括 Bech32 編碼、欄位結構和簽名驗證。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Lightning Network', href: '/tech/lightning/' },
    { label: 'Invoice Encoding' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'BOLT Invoice', href: '/tech/lightning/bolt-invoice' }}
  nextPage={{ title: 'LNURL', href: '/tech/lightning/lnurl' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BOLT 11 發票結構</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BOLT 11 定義了閃電網路發票的標準編碼格式。發票使用 Bech32 編碼，
    包含支付所需的所有資訊：金額、目的地、支付哈希、過期時間等。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>人類可讀：</strong>
      BOLT 11 發票以 "ln" 開頭，後接網路標識符（bc=主網、tb=測試網）， 使其易於識別為閃電發票。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">發票格式解析</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`BOLT 11 Invoice Structure

Example Invoice:
lnbc10u1pj9...omitted...cqzzsxqyz5vq

Breakdown:
• ln        : prefix (Lightning Network)
• bc        : network (bc=mainnet, tb=testnet, bcrt=regtest)
• 10u       : amount (10 micro-bitcoin = 1000 sats)
• 1         : separator
• pj9...    : timestamp + data fields (Bech32 encoded)
• cqzzsxqyz5vq : signature + recovery flag

Amount Units:
┌────────┬─────────────┬─────────────────────────────┐
│ Letter │ Multiplier  │ Conversion                  │
├────────┼─────────────┼─────────────────────────────┤
│ m      │ 0.001       │ milli-bitcoin (100,000 sats)│
│ u      │ 0.000001    │ micro-bitcoin (100 sats)    │
│ n      │ 0.000000001 │ nano-bitcoin (0.1 sats)     │
│ p      │ 1e-12       │ pico-bitcoin (0.0001 sats)  │
└────────┴─────────────┴─────────────────────────────┘

Examples:
• lnbc1m    = 0.001 BTC = 100,000 sats
• lnbc100u  = 0.0001 BTC = 10,000 sats
• lnbc1000n = 0.000001 BTC = 100 sats
• lnbc (no amount) = amount decided by payer`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">資料欄位（Tagged Fields）</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`BOLT 11 Tagged Fields

Field Structure:
┌──────────────────────────────────────────────────────────────┐
│ [type: 5 bits] [data_length: 10 bits] [data: variable]      │
└──────────────────────────────────────────────────────────────┘

Required Field:
• p (1) : payment_hash - 256-bit SHA256 hash, used for HTLC

Common Fields:
• d (13) : description - short text (UTF-8)
• h (23) : description_hash - SHA256 of long description
           (mutually exclusive with d)
• x (6)  : expiry - expiration time in seconds (default 3600)
• n (19) : payee_pubkey - receiver public key (33 bytes)
           can be recovered from signature
• c (24) : min_final_cltv_expiry_delta - minimum CLTV delta
           (default 18)

Routing Hints:
• r (3) : routing_info - hints for private channels
  Per hop (51 bytes):
  - pubkey: 33 bytes
  - short_channel_id: 8 bytes
  - fee_base_msat: 4 bytes
  - fee_proportional_millionths: 4 bytes
  - cltv_expiry_delta: 2 bytes

Feature Bits:
• 9 (5) : feature_bits - supported features
  e.g., payment_secret, basic_mpp

Payment Secret:
• s (16) : payment_secret - 256-bit random value
  Prevents probing and forward-hijacking
  Required for MPP`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Bech32 編碼</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Bech32 Encoding Details

Character Set (32 characters):
qpzry9x8gf2tvdw0s3jn54khce6mua7l

• Excludes confusing chars: 1, b, i, o
• All lowercase to reduce errors

Encoding Process:
1. Raw data (8-bit bytes)
   ↓
2. Convert to 5-bit groups
   ↓
3. Map to Bech32 characters
   ↓
4. Add checksum (6 characters)

Checksum Properties:
• Uses BCH code (Bose-Chaudhuri-Hocquenghem)
• Detects up to 4 character errors
• Guarantees detection of 2 substitution errors within 89 chars
• Provides error position hints

Example Conversion:
Timestamp 1496314658
= 0x5932DC22 (32-bit)
= Split into 7 x 5-bit groups
= [0b01011, 0b00100, ...]
= Bech32 characters`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">簽名與驗證</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Invoice Signature

Signed Message:
SHA256(SHA256(
  hrp (as UTF-8 bytes) ||
  data (as 5-bit values, excluding signature)
))
hrp = "lnbc" or "lntb" etc.

Signature Format (65 bytes):
┌──────────────────────────────────────────────────────────────┐
│ r: 32 bytes        - ECDSA signature r value                 │
│ s: 32 bytes        - ECDSA signature s value                 │
│ recovery: 1 byte   - public key recovery flag (0-3)          │
└──────────────────────────────────────────────────────────────┘

Public Key Recovery:
If invoice has no n (payee_pubkey) field:
1. Compute hash of signed message
2. Use recovery ID to recover pubkey from signature
3. Recovered pubkey is the receiver's node ID
• Benefit: saves 33 bytes

Verification Flow:
1. Decode Bech32
2. Verify checksum
3. Parse fields
4. Verify signature (or recover pubkey)
5. Check expiration time
6. Validate amount format`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">解碼範例</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`Invoice Decoding Example

Raw Invoice:
lnbc20m1pvjluezpp5qqqsyqcyq5rqwzqfqqqsyqcyq5rqwzqfqqqsyqcyq5rq
wzqfqypqhp58yjmdan79s6qqdhdzgynm4zwqd5d7xmw5fk98klysy043l2ahr
sqsrzjqwryaup9lh50kkranzgcdnn2fgvx390wgj5jd07rwr3vxeje0glclldc
wwnqqqqqqqqqqqqqqqsqfq2zs8t3c

Decoded Result:
• Network: mainnet (bc)
• Amount: 20 mBTC = 2,000,000 sats
• Timestamp: 1496314658 (2017-06-01 12:57:38 UTC)
• payment_hash:
  0001020304050607080900010203040506070809000102030405060708
• description_hash:
  3925b6f67e2c340036ed12093dd44e0368df1b6ea26c53dbe4811f58fd5db8c1
• Expiry: 3600 seconds (default)
• Signature: valid
• Payee pubkey: (recovered from signature)

CLI Decoding:

# LND
lncli decodepayreq <invoice>

# Core Lightning
lightning-cli decode <invoice>

# Online Tool
https://lightningdecoder.com/`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">程式碼範例</h2>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`JavaScript 解碼範例：

// 使用 bolt11 庫
import * as bolt11 from 'bolt11';

const invoice = 'lnbc10u1p...';

// 解碼
const decoded = bolt11.decode(invoice);

console.log({
  network: decoded.network,           // 'bc' | 'tb'
  satoshis: decoded.satoshis,         // 金額
  timestamp: decoded.timestamp,       // Unix 時間戳
  timeExpireDate: decoded.timeExpireDate,
  paymentHash: decoded.tags.find(t => t.tagName === 'payment_hash')?.data,
  description: decoded.tags.find(t => t.tagName === 'description')?.data,
  payeeNodeKey: decoded.payeeNodeKey, // 收款人公鑰
});

// 創建發票（需要私鑰）
const encoded = bolt11.encode({
  satoshis: 1000,
  description: 'Test payment',
  timestamp: Math.floor(Date.now() / 1000),
  tags: [
    { tagName: 'payment_hash', data: paymentHash },
    { tagName: 'expire_time', data: 3600 },
  ],
});

const signedInvoice = bolt11.sign(encoded, privateKey);`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">發票大小限制</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        沒有硬性限制，但 QR 碼有實際限制。 建議保持在約 1023 字元以下以確保 QR 可讀。
      </p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">大小寫</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        Bech32 使用小寫，但解碼器應接受大寫或小寫。 混合大小寫是無效的。
      </p>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>BOLT 12 演進：</strong>
      BOLT 12 Offers 使用 TLV 編碼取代 Bech32， 支援可重複使用的支付請求和更好的隱私。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      • <a
        href="https://github.com/lightning/bolts/blob/master/11-payment-encoding.md"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT 11 規範</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt-invoice"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">發票格式概覽</a
      >
    </li>
    <li>
      • <a
        href="/tech/lightning/bolt12-offers"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">BOLT12 Offers</a
      >
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">下一步：</strong>
      了解 <a
        href="/tech/lightning/lnurl"
        class="text-yellow-600 dark:text-yellow-400 hover:underline">LNURL</a
      >
      如何簡化支付流程。
    </p>
  </div>
</ArticleLayout>
