---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Block-Relay-Only Connections"
  description="深入了解 Bitcoin Core 的 block-relay-only 連接，增強隱私和抵抗攻擊的特殊連接類型。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Bitcoin Core', href: '/tech/bitcoin-core/' },
    { label: 'Block-Relay-Only' },
  ]}
  difficulty="advanced"
  readingTime="10 分鐘"
  prevPage={{ title: 'AddrMan', href: '/tech/bitcoin-core/addrman' }}
  nextPage={{ title: 'LevelDB', href: '/tech/bitcoin-core/leveldb' }}
>
  <section class="space-y-6">
    <h2 id="introduction" class="text-2xl font-bold text-[var(--text-primary)]">什麼是 Block-Relay-Only 連接？</h2>
    <p class="text-[var(--text-secondary)]">
      Block-relay-only 連接是 Bitcoin Core 0.19 引入的特殊連接類型。
      這些連接只中繼區塊，不中繼交易或地址，提供額外的隱私保護和 Eclipse 攻擊抵抗。
    </p>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-4">連接類型比較</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-[var(--border-default)]">
              <th class="text-left py-2 text-[var(--text-secondary)]">功能</th>
              <th class="text-left py-2 text-[var(--text-secondary)]">Full Relay</th>
              <th class="text-left py-2 text-[var(--text-secondary)]">Block-Relay-Only</th>
            </tr>
          </thead>
          <tbody class="text-[var(--text-secondary)]">
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">區塊中繼</td>
              <td class="py-2 text-green-400">✓</td>
              <td class="py-2 text-green-400">✓</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">交易中繼</td>
              <td class="py-2 text-green-400">✓</td>
              <td class="py-2 text-red-400">✗</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">地址中繼</td>
              <td class="py-2 text-green-400">✓</td>
              <td class="py-2 text-red-400">✗</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">預設數量</td>
              <td class="py-2">8 出站</td>
              <td class="py-2">2 出站</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="benefits" class="text-2xl font-bold text-[var(--text-primary)]">優勢</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-green-500/10 p-4 rounded-lg border border-green-500/30">
        <h4 class="font-semibold text-green-400 mb-2">隱私增強</h4>
        <ul class="text-sm text-[var(--text-secondary)] space-y-1">
          <li>• 不洩露交易來源</li>
          <li>• 對等節點無法識別這些連接</li>
          <li>• 攻擊者更難追蹤交易傳播</li>
        </ul>
      </div>
      <div class="bg-green-500/10 p-4 rounded-lg border border-green-500/30">
        <h4 class="font-semibold text-green-400 mb-2">Eclipse 抵抗</h4>
        <ul class="text-sm text-[var(--text-secondary)] space-y-1">
          <li>• 額外的隱藏連接</li>
          <li>• 攻擊者難以識別所有連接</li>
          <li>• 作為錨定連接重啟時使用</li>
        </ul>
      </div>
    </div>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-text" is:raw>連接結構示意：

你的節點
    │
    ├── Full Relay 連接 (8 個出站)
    │   ├── 節點 A ←→ 區塊、交易、地址
    │   ├── 節點 B ←→ 區塊、交易、地址
    │   └── ...
    │
    └── Block-Relay-Only 連接 (2 個出站)
        ├── 節點 X ←→ 只有區塊
        └── 節點 Y ←→ 只有區塊

攻擊者看到：
- 與 A、B 等節點的交易往來
- 無法看到 X、Y 的存在（因為沒有交易特徵）</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="implementation" class="text-2xl font-bold text-[var(--text-primary)]">實現細節</h2>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-typescript" is:raw>enum ConnectionType {
  INBOUND,
  OUTBOUND_FULL_RELAY,
  BLOCK_RELAY,           // Block-relay-only
  MANUAL,
  FEELER,
  ADDR_FETCH,
}

class P2PConnection {
  type: ConnectionType;

  // 版本消息中設定 relay = false
  sendVersion(): VersionMessage {
    return {
      version: 70016,
      services: this.getServices(),
      relay: this.type !== ConnectionType.BLOCK_RELAY,
    };
  }

  // 過濾消息
  shouldRelay(msgType: string): boolean {
    if (this.type === ConnectionType.BLOCK_RELAY) {
      // 只允許區塊相關消息
      const allowed = [
        'version', 'verack', 'ping', 'pong',
        'inv', 'getdata', 'getheaders', 'headers',
        'block', 'cmpctblock', 'blocktxn', 'getblocktxn',
        'sendcmpct', 'sendheaders',
      ];
      return allowed.includes(msgType);
    }
    return true;
  }

  onInv(inv: Inventory[]): void {
    if (this.type === ConnectionType.BLOCK_RELAY) {
      // 只處理區塊 inv，忽略交易
      inv = inv.filter(i => i.type === INV_TYPE.BLOCK);
    }
    this.processInv(inv);
  }
}</code></pre>
    </div>

    <h3 id="anchor" class="text-xl font-semibold text-[var(--text-primary)]">錨定連接</h3>
    <p class="text-[var(--text-secondary)]">
      Block-relay-only 連接在節點關閉時會被保存為錨定連接，重啟時優先重連：
    </p>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 錨定連接儲存位置
~/.bitcoin/anchors.dat

# 節點關閉時
# 1. 選擇 2 個 block-relay-only 連接
# 2. 保存到 anchors.dat

# 節點啟動時
# 1. 讀取 anchors.dat
# 2. 優先連接這些節點
# 3. 刪除 anchors.dat（一次性使用）</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="configuration" class="text-2xl font-bold text-[var(--text-primary)]">配置選項</h2>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 預設配置（無需修改）
# 自動建立 2 個 block-relay-only 出站連接

# 查看連接類型
bitcoin-cli getpeerinfo | jq '.[] | {addr, connection_type}'

# 輸出示例
{
  "addr": "192.168.1.100:8333",
  "connection_type": "block-relay-only"
}

# 手動添加 block-relay-only 連接
bitcoin-cli addconnection "192.168.1.200:8333" "block-relay-only"</code></pre>
    </div>

    <div class="bg-yellow-500/10 p-4 rounded-lg border border-yellow-500/30">
      <p class="text-sm text-[var(--text-secondary)]">
        <strong class="text-yellow-400">注意：</strong>
        Block-relay-only 連接是自動管理的，通常不需要手動配置。
        手動干預可能會影響節點的隱私和安全特性。
      </p>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="summary" class="text-2xl font-bold text-[var(--text-primary)]">總結</h2>

    <div class="bg-gradient-to-r from-bitcoin-500/10 to-transparent p-6 rounded-lg border border-bitcoin-500/30">
      <ul class="space-y-3 text-[var(--text-secondary)]">
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">只傳區塊：</strong>不中繼交易和地址</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">隱私增強：</strong>對等節點難以識別這些連接</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">Eclipse 抵抗：</strong>額外的隱藏連接增加攻擊難度</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">錨定連接：</strong>重啟時優先重連以防止攻擊</span>
        </li>
      </ul>
    </div>
  </section>
</ArticleLayout>
