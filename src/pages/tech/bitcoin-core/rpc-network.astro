---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="網路 RPC"
  description="Bitcoin Core 網路和 Mempool 相關 RPC 命令，包括節點管理和手續費估算。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Bitcoin Core', href: '/tech/bitcoin-core/' },
    { label: '網路 RPC' },
  ]}
  difficulty="intermediate"
  readingTime="12 分鐘"
  prevPage={{ title: '區塊鏈 RPC', href: '/tech/bitcoin-core/rpc-blockchain' }}
  nextPage={{ title: 'P2P 協議', href: '/tech/bitcoin-core/p2p-protocol' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">網路狀態</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">getnetworkinfo</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`bitcoin-cli getnetworkinfo

# 返回範例
{
  "version": 260000,
  "subversion": "/Satoshi:26.0.0/",
  "protocolversion": 70016,
  "localservices": "0000000000000c09",
  "localservicesnames": ["NETWORK", "WITNESS", "NETWORK_LIMITED", "P2P_V2"],
  "localrelay": true,
  "timeoffset": 0,
  "networkactive": true,
  "connections": 125,
  "connections_in": 115,
  "connections_out": 10,
  "networks": [...],
  "relayfee": 0.00001000,
  "incrementalfee": 0.00001000,
  "localaddresses": [...],
  "warnings": ""
}`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">連線計數</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`# 獲取連線數量
bitcoin-cli getconnectioncount

# 檢查網路是否啟用
bitcoin-cli getnetworkinfo | jq '.networkactive'`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">節點管理</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">getpeerinfo</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`# 列出所有連接的節點
bitcoin-cli getpeerinfo

# 每個節點的資訊包括
{
  "id": 1,
  "addr": "192.168.1.100:8333",
  "addrbind": "192.168.1.1:45678",
  "network": "ipv4",
  "services": "0000000000000c09",
  "servicesnames": ["NETWORK", "WITNESS", ...],
  "relaytxes": true,
  "lastsend": 1704067200,
  "lastrecv": 1704067199,
  "bytessent": 123456789,
  "bytesrecv": 987654321,
  "conntime": 1704000000,
  "pingtime": 0.05,
  "version": 70016,
  "subver": "/Satoshi:26.0.0/",
  "inbound": false,
  "connection_type": "outbound-full-relay",
  "transport_protocol_type": "v2",
  "startingheight": 825000,
  "synced_headers": 825100,
  "synced_blocks": 825100
}`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">節點連線控制</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`# 手動添加節點
bitcoin-cli addnode "192.168.1.100:8333" "add"
bitcoin-cli addnode "192.168.1.100:8333" "remove"
bitcoin-cli addnode "192.168.1.100:8333" "onetry"

# 列出手動添加的節點
bitcoin-cli getaddednodeinfo

# 斷開特定節點
bitcoin-cli disconnectnode "192.168.1.100:8333"

# 禁止節點
bitcoin-cli setban "192.168.1.100" "add" 86400  # 禁止 24 小時
bitcoin-cli listbanned
bitcoin-cli clearbanned`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">網路開關</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`# 停用/啟用網路
bitcoin-cli setnetworkactive false
bitcoin-cli setnetworkactive true`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Mempool 管理</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">getmempoolinfo</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`bitcoin-cli getmempoolinfo

# 返回範例
{
  "loaded": true,
  "size": 5000,                    # 交易數量
  "bytes": 2500000,                # 總大小
  "usage": 15000000,               # 記憶體使用
  "total_fee": 0.12345678,         # 總手續費
  "maxmempool": 300000000,         # 最大容量
  "mempoolminfee": 0.00001000,     # 最低進入費率
  "minrelaytxfee": 0.00001000,     # 最低中繼費率
  "incrementalrelayfee": 0.00001000,
  "unbroadcastcount": 0,
  "fullrbf": true
}`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">查詢 Mempool</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`# 列出所有 mempool 交易 ID
bitcoin-cli getrawmempool

# 包含詳細資訊
bitcoin-cli getrawmempool true

# 按祖先/後代排序
bitcoin-cli getrawmempool false "sequence"

# 查詢特定交易
bitcoin-cli getmempoolentry "<txid>"

# 查詢交易的祖先
bitcoin-cli getmempoolancestors "<txid>"

# 查詢交易的後代
bitcoin-cli getmempooldescendants "<txid>"`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">廣播與驗證</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`# 廣播原始交易
bitcoin-cli sendrawtransaction "<hex>"

# 測試交易是否會被接受（不廣播）
bitcoin-cli testmempoolaccept '["<hex>"]'

# 返回範例
[{
  "txid": "...",
  "wtxid": "...",
  "allowed": true,
  "vsize": 141,
  "fees": {
    "base": 0.00001410
  }
}]`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">手續費估算</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">estimatesmartfee</h3>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`# 估算 N 區塊內確認的費率
bitcoin-cli estimatesmartfee 1   # 下一區塊
bitcoin-cli estimatesmartfee 6   # 約 1 小時
bitcoin-cli estimatesmartfee 144 # 約 1 天

# 返回範例
{
  "feerate": 0.00012345,          # BTC/kvB
  "blocks": 6
}

# 指定估算模式
bitcoin-cli estimatesmartfee 6 "economical"
bitcoin-cli estimatesmartfee 6 "conservative"`}</pre>
  </div>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">economical 模式</h4>
      <p class="text-sm text-[var(--text-secondary)]">較低的費率估算，適合不急著確認的交易。</p>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">conservative 模式</h4>
      <p class="text-sm text-[var(--text-secondary)]">較高的費率估算，確保快速確認。</p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">常用命令速查</h2>

  <div class="not-prose mb-8 overflow-x-auto">
    <table
      class="w-full text-sm border border-[var(--border-default)] rounded-lg overflow-hidden"
      aria-label="Bitcoin Core 網路 RPC 常用命令"
    >
      <thead class="bg-[var(--bg-secondary)]">
        <tr>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">命令</th>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">說明</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 font-mono text-xs text-bitcoin-500">getnetworkinfo</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">網路狀態概覽</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 font-mono text-xs text-bitcoin-500">getpeerinfo</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">連接的節點列表</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 font-mono text-xs text-bitcoin-500">getmempoolinfo</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">Mempool 狀態</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 font-mono text-xs text-bitcoin-500">getrawmempool</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">Mempool 交易列表</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 font-mono text-xs text-bitcoin-500">estimatesmartfee</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">手續費估算</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 font-mono text-xs text-bitcoin-500">sendrawtransaction</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">廣播交易</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">相關文檔：</strong>
      了解底層的 <a
        href="/tech/bitcoin-core/p2p-protocol"
        class="text-bitcoin-700 underline decoration-bitcoin-700/50 hover:decoration-bitcoin-700"
        >P2P 協議</a
      >
      可以幫助更好地理解網路行為。
    </p>
  </div>
</ArticleLayout>
