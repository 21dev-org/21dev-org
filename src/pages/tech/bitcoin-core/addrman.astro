---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="AddrMan"
  description="深入了解 Bitcoin Core 的地址管理器，如何發現、儲存和選擇對等節點地址。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Bitcoin Core', href: '/tech/bitcoin-core/' },
    { label: 'AddrMan' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'Checkpoints', href: '/tech/bitcoin-core/checkpoints' }}
  nextPage={{ title: 'Block-Relay-Only', href: '/tech/bitcoin-core/block-relay-only' }}
>
  <section class="space-y-6">
    <h2 id="introduction" class="text-2xl font-bold text-[var(--text-primary)]">
      什麼是 AddrMan？
    </h2>
    <p class="text-[var(--text-secondary)]">
      AddrMan（Address Manager）是 Bitcoin Core 的地址管理系統，負責發現、儲存和選擇對等節點地址。
      它使用精心設計的數據結構來抵抗 Eclipse 攻擊，確保節點能夠連接到真實的比特幣網路。
    </p>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-4">AddrMan 的職責</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="p-4 bg-[var(--bg-primary)] rounded-lg">
          <h4 class="font-semibold text-[var(--text-primary)] mb-2">地址收集</h4>
          <ul class="text-sm text-[var(--text-secondary)] space-y-1">
            <li>• 從 DNS seeds 獲取初始地址</li>
            <li>• 接收對等節點廣播的地址</li>
            <li>• 記錄成功連接的節點</li>
          </ul>
        </div>
        <div class="p-4 bg-[var(--bg-primary)] rounded-lg">
          <h4 class="font-semibold text-[var(--text-primary)] mb-2">連接選擇</h4>
          <ul class="text-sm text-[var(--text-secondary)] space-y-1">
            <li>• 選擇要連接的節點</li>
            <li>• 平衡新舊地址</li>
            <li>• 防止連接偏向</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="data-structure" class="text-2xl font-bold text-[var(--text-primary)]">雙表架構</h2>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre
        class="text-sm overflow-x-auto"><code class="language-text" is:raw>AddrMan 結構：

┌──────────────────────────────────────────────────────┐
│  New Table (1024 buckets × 64 entries)               │
│  ├── 儲存從未成功連接過的地址                          │
│  ├── 按來源 IP 分組（防止單一來源控制）                 │
│  └── 最多 65,536 個地址                              │
├──────────────────────────────────────────────────────┤
│  Tried Table (256 buckets × 64 entries)              │
│  ├── 儲存成功連接過的地址                             │
│  ├── 按目標 IP 分組                                  │
│  └── 最多 16,384 個地址                              │
└──────────────────────────────────────────────────────┘</code></pre>
    </div>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre
        class="text-sm overflow-x-auto"><code class="language-typescript" is:raw>interface AddrInfo {
  addr: NetAddress;      // IP:Port
  source: NetAddress;    // 誰告訴我們這個地址
  lastTry: number;       // 最後嘗試連接時間
  lastSuccess: number;   // 最後成功連接時間
  nAttempts: number;     // 連接嘗試次數
}

class AddrMan {
  private newTable: AddrInfo[/* 1024 */][/* 64 */];
  private triedTable: AddrInfo[/* 256 */][/* 64 */];
  private nKey: Buffer;  // 隨機密鑰，防止預測

  // New 表的 bucket 選擇（基於來源 IP）
  getNewBucket(addr: NetAddress, source: NetAddress): number {
    const sourceGroup = this.getGroup(source);  // /16 網段
    const hash = this.hash(this.nKey, sourceGroup, addr);
    return hash % 1024;
  }

  // Tried 表的 bucket 選擇（基於目標 IP）
  getTriedBucket(addr: NetAddress): number {
    const addrGroup = this.getGroup(addr);
    const hash = this.hash(this.nKey, addrGroup);
    return hash % 256;
  }

  // 標記連接成功，移到 Tried 表
  good(addr: NetAddress): void {
    const info = this.findInNew(addr);
    if (!info) return;

    this.removeFromNew(addr);
    const bucket = this.getTriedBucket(addr);
    info.lastSuccess = Date.now();
    this.triedTable[bucket][position] = info;
  }
}</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="eclipse-prevention" class="text-2xl font-bold text-[var(--text-primary)]">
      Eclipse 攻擊防護
    </h2>

    <div class="bg-red-500/10 p-6 rounded-lg border border-red-500/30">
      <h4 class="font-semibold text-red-400 mb-3">什麼是 Eclipse 攻擊？</h4>
      <p class="text-sm text-[var(--text-secondary)] mb-3">
        攻擊者控制受害節點的所有連接，將其與真實網路隔離。
      </p>
      <ul class="space-y-1 text-sm text-[var(--text-secondary)]">
        <li>• 雙花攻擊 - 讓商家看到假的確認</li>
        <li>• 自私挖礦 - 延遲受害者看到新區塊</li>
        <li>• N-confirmation 攻擊 - 製造假的確認深度</li>
      </ul>
    </div>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <h4 class="text-lg font-semibold text-[var(--text-primary)] mb-3">防禦機制</h4>
      <ul class="space-y-3 text-[var(--text-secondary)]">
        <li class="flex items-start gap-3">
          <span
            class="w-6 h-6 rounded-full bg-bitcoin-500 text-white flex items-center justify-center text-sm flex-shrink-0"
            >1</span
          >
          <div>
            <strong class="text-[var(--text-primary)]">基於來源的 Bucket 分配</strong>
            <p class="text-sm">單一來源無法填滿所有 bucket</p>
          </div>
        </li>
        <li class="flex items-start gap-3">
          <span
            class="w-6 h-6 rounded-full bg-bitcoin-500 text-white flex items-center justify-center text-sm flex-shrink-0"
            >2</span
          >
          <div>
            <strong class="text-[var(--text-primary)]">隨機密鑰 (nKey)</strong>
            <p class="text-sm">每個節點不同，攻擊者無法預測 bucket</p>
          </div>
        </li>
        <li class="flex items-start gap-3">
          <span
            class="w-6 h-6 rounded-full bg-bitcoin-500 text-white flex items-center justify-center text-sm flex-shrink-0"
            >3</span
          >
          <div>
            <strong class="text-[var(--text-primary)]">網段多樣性</strong>
            <p class="text-sm">出站連接確保來自不同的 /16 網段</p>
          </div>
        </li>
        <li class="flex items-start gap-3">
          <span
            class="w-6 h-6 rounded-full bg-bitcoin-500 text-white flex items-center justify-center text-sm flex-shrink-0"
            >4</span
          >
          <div>
            <strong class="text-[var(--text-primary)]">錨定連接</strong>
            <p class="text-sm">重啟時優先連接最後成功的節點</p>
          </div>
        </li>
      </ul>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="persistence" class="text-2xl font-bold text-[var(--text-primary)]">持久化</h2>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre
        class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 地址數據庫
~/.bitcoin/peers.dat

# 錨定檔案（重啟時優先連接）
~/.bitcoin/anchors.dat

# 查看已知地址
bitcoin-cli getnodeaddresses 10

# 手動添加節點
bitcoin-cli addnode "192.168.1.100:8333" "add"

# 查看連接的節點
bitcoin-cli getpeerinfo | jq '.[].addr'</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="configuration" class="text-2xl font-bold text-[var(--text-primary)]">配置選項</h2>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre
        class="text-sm overflow-x-auto"><code class="language-ini" is:raw># bitcoin.conf

# 手動指定節點
addnode=192.168.1.100:8333

# 只連接到指定節點
connect=192.168.1.100:8333

# DNS seeds（預設開啟）
dnsseed=1

# 固定 seeds
fixedseeds=1

# 最大連接數
maxconnections=125</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="summary" class="text-2xl font-bold text-[var(--text-primary)]">總結</h2>

    <div
      class="bg-gradient-to-r from-bitcoin-500/10 to-transparent p-6 rounded-lg border border-bitcoin-500/30"
    >
      <ul class="space-y-3 text-[var(--text-secondary)]">
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span
            ><strong class="text-[var(--text-primary)]">雙表架構：</strong>New 表存新地址，Tried
            表存驗證過的地址</span
          >
        </li>
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span
            ><strong class="text-[var(--text-primary)]">Eclipse 防護：</strong
            >基於來源分組、隨機密鑰、網段多樣性</span
          >
        </li>
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span
            ><strong class="text-[var(--text-primary)]">錨定連接：</strong
            >重啟時優先連接已知可信節點</span
          >
        </li>
      </ul>
    </div>
  </section>
</ArticleLayout>
