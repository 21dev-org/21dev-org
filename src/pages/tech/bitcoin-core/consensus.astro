---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="共識機制"
  description="深入理解比特幣的工作量證明共識機制、難度調整算法和分叉處理。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Bitcoin Core', href: '/tech/bitcoin-core/' },
    { label: '共識機制' },
  ]}
  difficulty="intermediate"
  readingTime="20 分鐘"
  nextPage={{ title: '區塊結構', href: '/tech/bitcoin-core/block-structure' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是共識？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    在分散式系統中，共識是指所有參與者對某個狀態達成一致的過程。
    比特幣網路沒有中央權威，卻能讓全球數萬個節點對「誰擁有多少比特幣」達成一致。
    這是通過工作量證明（Proof of Work, PoW）機制實現的。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
    <p class="text-sm text-bitcoin-700 dark:text-bitcoin-400">
      <strong>核心問題：</strong> 在沒有中央機構的情況下，如何防止同一筆比特幣被花費兩次（雙重支付）？
      答案是：讓所有人同意一個統一的交易順序。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">工作量證明 (PoW)</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    工作量證明是一種讓礦工證明他們付出了計算資源的機制。
    礦工需要找到一個特殊的數字（nonce），使得區塊頭的雜湊值小於目標值。
  </p>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">挖礦過程</h3>
  <div class="not-prose mb-6 space-y-3">
    {
      [
        { step: '1', title: '收集交易', desc: '從 mempool 選擇交易，構建候選區塊' },
        { step: '2', title: '構建區塊頭', desc: '包含前區塊雜湊、Merkle 根、時間戳等' },
        { step: '3', title: '嘗試 nonce', desc: '不斷改變 nonce 值，計算區塊頭雜湊' },
        { step: '4', title: '檢查結果', desc: '如果雜湊 < 目標值，找到有效區塊；否則繼續' },
        { step: '5', title: '廣播區塊', desc: '找到有效區塊後，立即廣播到網路' },
      ].map((item) => (
        <div class="flex items-start gap-4 p-4 rounded-lg bg-[var(--surface-elevated)] border border-[var(--border-default)]">
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-bitcoin-500 text-white flex items-center justify-center font-bold text-sm">
            {item.step}
          </div>
          <div>
            <h4 class="font-semibold text-[var(--text-primary)]">{item.title}</h4>
            <p class="text-sm text-[var(--text-secondary)]">{item.desc}</p>
          </div>
        </div>
      ))
    }
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">雜湊函數特性</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    比特幣使用 SHA-256 雜湊函數。它有以下關鍵特性：
  </p>
  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500 font-bold">•</span>
      <span><strong class="text-[var(--text-primary)]">單向性</strong>：從輸出無法反推輸入</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500 font-bold">•</span>
      <span
        ><strong class="text-[var(--text-primary)]">雪崩效應</strong
        >：輸入微小變化導致輸出完全不同</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500 font-bold">•</span>
      <span
        ><strong class="text-[var(--text-primary)]">確定性</strong>：相同輸入永遠產生相同輸出</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500 font-bold">•</span>
      <span
        ><strong class="text-[var(--text-primary)]">抗碰撞</strong
        >：找到兩個相同雜湊的輸入極其困難</span
      >
    </li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">難度調整</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    比特幣設計為平均每 10 分鐘產生一個區塊。為了維持這個節奏， 網路每 2016
    個區塊（約兩週）自動調整一次難度。
  </p>

  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <pre
      class="text-[var(--text-secondary)]">{`# 難度調整公式
新難度 = 舊難度 × (實際時間 / 目標時間)

# 目標時間
目標時間 = 2016 區塊 × 10 分鐘 = 20160 分鐘 ≈ 2 週

# 調整限制：最多 4 倍，最少 1/4 倍
if 調整係數 > 4: 調整係數 = 4
if 調整係數 < 0.25: 調整係數 = 0.25`}</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">為什麼是 10 分鐘？</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    10 分鐘是安全性和使用便利性之間的平衡：
  </p>
  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>• 足夠長，讓新區塊有時間傳播到全網</li>
    <li>• 減少「孤塊」（orphan blocks）的產生</li>
    <li>• 防止礦池過度中心化</li>
    <li>• 同時不會讓用戶等待太久</li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">最長鏈規則</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    當網路中出現多個有效區塊時，節點遵循「最長鏈規則」（實際上是累計工作量最大的鏈）：
  </p>

  <div class="not-prose mb-8 overflow-x-auto">
    <table
      class="w-full text-sm border border-[var(--border-default)] rounded-lg overflow-hidden"
      aria-label="比特幣最長鏈規則處理方式"
    >
      <thead class="bg-[var(--bg-secondary)]">
        <tr>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">情況</th>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">處理方式</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">收到更長的鏈</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">切換到新鏈（重組）</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">收到相同長度的鏈</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">保留先收到的，等待下一個區塊</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">收到較短的鏈</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">忽略</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">分叉類型</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">臨時分叉</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    當兩個礦工幾乎同時找到有效區塊時，網路會暫時分裂。 這是正常現象，通常在 1-2 個區塊後自動解決。
  </p>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">軟分叉 (Soft Fork)</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    軟分叉是向後相容的升級。舊節點仍能驗證新規則產生的區塊，
    但可能無法使用新功能。例如：SegWit、Taproot。
  </p>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">硬分叉 (Hard Fork)</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    硬分叉是不向後相容的變更。未升級的節點會拒絕新規則的區塊，
    可能導致永久性網路分裂。比特幣社群通常避免硬分叉。
  </p>

  <div class="not-prose mb-8 overflow-x-auto">
    <table
      class="w-full text-sm border border-[var(--border-default)] rounded-lg overflow-hidden"
      aria-label="比特幣軟分叉與硬分叉比較"
    >
      <thead class="bg-[var(--bg-secondary)]">
        <tr>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">特性</th>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">軟分叉</th>
          <th scope="col" class="px-4 py-3 text-left text-[var(--text-primary)]">硬分叉</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">向後相容</td>
          <td class="px-4 py-3 text-green-600 dark:text-green-400">是</td>
          <td class="px-4 py-3 text-red-600 dark:text-red-400">否</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">升級強制性</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">可選</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">必須</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">分裂風險</td>
          <td class="px-4 py-3 text-green-600 dark:text-green-400">低</td>
          <td class="px-4 py-3 text-red-600 dark:text-red-400">高</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-secondary)]">範例</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">SegWit, Taproot</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">BCH 分裂</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">共識規則類型</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">Bitcoin Core 實現了多層共識規則：</p>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h3 class="font-semibold text-[var(--text-primary)] mb-2">區塊級規則</h3>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 區塊大小 ≤ 4MB (weight)</li>
        <li>• 時間戳在合理範圍內</li>
        <li>• 難度值正確</li>
        <li>• Merkle 根正確</li>
        <li>• Coinbase 獎勵正確</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h3 class="font-semibold text-[var(--text-primary)] mb-2">交易級規則</h3>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 輸入 UTXO 存在且未花費</li>
        <li>• 簽名有效</li>
        <li>• 輸出 ≤ 輸入</li>
        <li>• 不是雙重支付</li>
        <li>• 腳本執行成功</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關 BIP</h2>
  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>
      <a href="/bips/bip-0009" class="text-bitcoin-700 underline decoration-bitcoin-700/50 hover:decoration-bitcoin-700">BIP-9</a>： Version bits
      軟分叉激活機制
    </li>
    <li>
      <a href="/bips/bip-0008" class="text-bitcoin-700 underline decoration-bitcoin-700/50 hover:decoration-bitcoin-700">BIP-8</a>：
      帶強制激活的軟分叉部署
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">延伸閱讀：</strong>
      <a href="/books/mastering-bitcoin" class="text-bitcoin-700 underline decoration-bitcoin-700/50 hover:decoration-bitcoin-700">《精通比特幣》</a>
      第 10 章深入講解了挖礦和共識機制。
    </p>
  </div>
</ArticleLayout>
