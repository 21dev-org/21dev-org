---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Transaction Index (txindex)"
  description="深入了解 Bitcoin Core 的交易索引功能，如何快速查詢任意歷史交易。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Bitcoin Core', href: '/tech/bitcoin-core/' },
    { label: 'TxIndex' },
  ]}
  difficulty="beginner"
  readingTime="8 分鐘"
  prevPage={{ title: 'CPFP', href: '/tech/bitcoin-core/cpfp' }}
  nextPage={{ title: 'SigOps', href: '/tech/bitcoin-core/sigops' }}
>
  <section class="space-y-6">
    <h2 id="introduction" class="text-2xl font-bold text-[var(--text-primary)]">什麼是 TxIndex？</h2>
    <p class="text-[var(--text-secondary)]">
      Transaction Index（txindex）是 Bitcoin Core 的可選功能，建立一個從交易 ID (txid)
      到區塊位置的索引。啟用後，你可以透過 txid 快速查詢區塊鏈中的任何歷史交易。
    </p>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-4">有無 TxIndex 的差異</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="p-4 bg-red-500/10 rounded-lg border border-red-500/30">
          <h4 class="font-semibold text-red-400 mb-2">無 TxIndex（預設）</h4>
          <ul class="text-sm text-[var(--text-secondary)] space-y-1">
            <li>• 只能查詢 UTXO 相關交易</li>
            <li>• 只能查詢錢包交易</li>
            <li>• 只能查詢 mempool 交易</li>
            <li>• getrawtransaction 受限</li>
          </ul>
        </div>
        <div class="p-4 bg-green-500/10 rounded-lg border border-green-500/30">
          <h4 class="font-semibold text-green-400 mb-2">有 TxIndex</h4>
          <ul class="text-sm text-[var(--text-secondary)] space-y-1">
            <li>• 可查詢任何歷史交易</li>
            <li>• 支援區塊瀏覽器功能</li>
            <li>• 完整的 getrawtransaction</li>
            <li>• 需要額外磁碟空間</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="configuration" class="text-2xl font-bold text-[var(--text-primary)]">配置方式</h2>

    <h3 id="enable-txindex" class="text-xl font-semibold text-[var(--text-primary)]">啟用 TxIndex</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 方法 1: 命令行參數
bitcoind -txindex=1

# 方法 2: 配置文件 (~/.bitcoin/bitcoin.conf)
echo "txindex=1" >> ~/.bitcoin/bitcoin.conf

# 重新啟動節點
bitcoin-cli stop
bitcoind

# 檢查索引狀態
bitcoin-cli getindexinfo
# {
#   "txindex": {
#     "synced": true,
#     "best_block_height": 820000
#   }
# }</code></pre>
    </div>

    <div class="bg-yellow-500/10 p-4 rounded-lg border border-yellow-500/30">
      <p class="text-sm text-[var(--text-secondary)]">
        <strong class="text-yellow-400">注意：</strong>
        如果在已同步的節點上啟用 txindex，需要重新索引整個區塊鏈。
        這可能需要幾個小時到一天，取決於硬體。
      </p>
    </div>

    <h3 id="reindex" class="text-xl font-semibold text-[var(--text-primary)]">重新索引</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 如果已有區塊數據，需要重新索引
bitcoind -txindex=1 -reindex

# 或者只重建索引（不重新驗證區塊）
bitcoind -txindex=1 -reindex-chainstate

# 查看進度
bitcoin-cli getblockchaininfo | jq '{blocks, headers, verificationprogress}'</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="usage" class="text-2xl font-bold text-[var(--text-primary)]">使用方式</h2>

    <h3 id="getrawtransaction" class="text-xl font-semibold text-[var(--text-primary)]">getrawtransaction</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 查詢任意交易（需要 txindex）
bitcoin-cli getrawtransaction <txid>

# 解碼交易
bitcoin-cli getrawtransaction <txid> true

# 包含區塊資訊
bitcoin-cli getrawtransaction <txid> true <blockhash>

# 示例輸出
{
  "txid": "abc123...",
  "hash": "abc123...",
  "version": 2,
  "size": 225,
  "vsize": 144,
  "weight": 573,
  "locktime": 0,
  "vin": [...],
  "vout": [...],
  "blockhash": "000000000...",
  "confirmations": 12345,
  "time": 1234567890,
  "blocktime": 1234567890
}</code></pre>
    </div>

    <h3 id="gettxout" class="text-xl font-semibold text-[var(--text-primary)]">gettxout（不需要 txindex）</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 查詢未花費輸出（不需要 txindex）
bitcoin-cli gettxout <txid> <vout>

# 包含 mempool
bitcoin-cli gettxout <txid> <vout> true

# 示例輸出
{
  "bestblock": "000000000...",
  "confirmations": 100,
  "value": 0.01000000,
  "scriptPubKey": {
    "asm": "0 abc123...",
    "hex": "0014abc123...",
    "type": "witness_v0_keyhash",
    "address": "bc1q..."
  },
  "coinbase": false
}</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="storage" class="text-2xl font-bold text-[var(--text-primary)]">存儲需求</h2>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-4">磁碟空間估算</h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-[var(--border-default)]">
              <th class="text-left py-2 text-[var(--text-secondary)]">組件</th>
              <th class="text-left py-2 text-[var(--text-secondary)]">大小</th>
              <th class="text-left py-2 text-[var(--text-secondary)]">說明</th>
            </tr>
          </thead>
          <tbody class="text-[var(--text-secondary)]">
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">區塊數據</td>
              <td class="py-2">~600 GB</td>
              <td class="py-2">完整區塊鏈</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">UTXO 集合</td>
              <td class="py-2">~8 GB</td>
              <td class="py-2">chainstate</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2 font-semibold text-bitcoin-500">TxIndex</td>
              <td class="py-2 font-semibold text-bitcoin-500">~35 GB</td>
              <td class="py-2">交易索引</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2 font-bold">總計</td>
              <td class="py-2 font-bold">~643 GB</td>
              <td class="py-2">完整節點 + txindex</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <h3 id="index-location" class="text-xl font-semibold text-[var(--text-primary)]">索引位置</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-text" is:raw>~/.bitcoin/
├── blocks/           # 區塊數據
│   ├── blk00000.dat
│   └── ...
├── chainstate/       # UTXO 集合
├── indexes/          # 索引目錄
│   └── txindex/      # 交易索引 (LevelDB)
│       ├── 000001.log
│       ├── CURRENT
│       ├── LOCK
│       └── ...
└── ...</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="implementation" class="text-2xl font-bold text-[var(--text-primary)]">實現細節</h2>

    <h3 id="index-structure" class="text-xl font-semibold text-[var(--text-primary)]">索引結構</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-typescript" is:raw>// TxIndex 條目結構
interface TxIndexEntry {
  txid: Buffer;        // 32 bytes - 交易 ID
  blockHash: Buffer;   // 32 bytes - 區塊雜湊
  blockHeight: number; // 4 bytes - 區塊高度
  txOffset: number;    // 4 bytes - 交易在區塊文件中的偏移
}

// LevelDB Key-Value
// Key: 't' + txid (33 bytes)
// Value: blockHash + blockHeight + txOffset

// 查詢流程
async function getTransaction(txid: string): Promise<Transaction | null> {
  // 1. 查詢索引
  const entry = await txindex.get(txid);
  if (!entry) {
    return null;
  }

  // 2. 從區塊文件讀取交易
  const blockFile = getBlockFile(entry.blockHash);
  const rawTx = await blockFile.read(entry.txOffset);

  // 3. 解碼交易
  return Transaction.decode(rawTx);
}

// 索引建立
async function indexBlock(block: Block): Promise<void> {
  const batch = txindex.batch();

  for (let i = 0; i < block.transactions.length; i++) {
    const tx = block.transactions[i];
    batch.put(tx.txid, {
      blockHash: block.hash,
      blockHeight: block.height,
      txOffset: calculateOffset(block, i),
    });
  }

  await batch.commit();
}</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="use-cases" class="text-2xl font-bold text-[var(--text-primary)]">使用場景</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-[var(--bg-secondary)] p-4 rounded-lg border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">區塊瀏覽器</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          建立區塊瀏覽器需要 txindex 來快速查詢任意交易。
        </p>
      </div>
      <div class="bg-[var(--bg-secondary)] p-4 rounded-lg border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">分析工具</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          鏈上分析需要追蹤交易歷史，txindex 提供快速查詢。
        </p>
      </div>
      <div class="bg-[var(--bg-secondary)] p-4 rounded-lg border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">開發調試</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          開發者需要查詢交易細節來調試應用程式。
        </p>
      </div>
      <div class="bg-[var(--bg-secondary)] p-4 rounded-lg border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">支付驗證</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          驗證歷史付款需要查詢交易詳情。
        </p>
      </div>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="alternatives" class="text-2xl font-bold text-[var(--text-primary)]">替代方案</h2>

    <h3 id="without-txindex" class="text-xl font-semibold text-[var(--text-primary)]">不使用 TxIndex</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 如果知道區塊雜湊，可以不用 txindex
bitcoin-cli getrawtransaction <txid> true <blockhash>

# 查詢錢包交易（不需要 txindex）
bitcoin-cli gettransaction <txid>

# 查詢 mempool 交易（不需要 txindex）
bitcoin-cli getmempoolentry <txid></code></pre>
    </div>

    <h3 id="other-indexes" class="text-xl font-semibold text-[var(--text-primary)]">其他索引</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 區塊過濾器索引（用於輕客戶端）
blockfilterindex=1

# Coinstats 索引（用於 UTXO 統計）
coinstatsindex=1

# 查看所有索引狀態
bitcoin-cli getindexinfo</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="compatibility" class="text-2xl font-bold text-[var(--text-primary)]">兼容性</h2>

    <div class="bg-red-500/10 p-6 rounded-lg border border-red-500/30">
      <h3 class="text-lg font-semibold text-red-400 mb-3">TxIndex 與 Pruning 不兼容</h3>
      <p class="text-[var(--text-secondary)] mb-4">
        修剪節點會刪除舊區塊數據，而 txindex 需要完整的區塊數據來定位交易。
        因此，txindex 和 pruning 不能同時使用。
      </p>
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 這會報錯
bitcoind -txindex=1 -prune=550
# Error: -txindex is incompatible with -prune mode</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="best-practices" class="text-2xl font-bold text-[var(--text-primary)]">最佳實踐</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-green-500/10 p-4 rounded-lg border border-green-500/30">
        <h4 class="font-semibold text-green-400 mb-2">✓ 推薦使用 TxIndex</h4>
        <ul class="text-sm text-[var(--text-secondary)] space-y-2">
          <li>• 運行區塊瀏覽器</li>
          <li>• 進行鏈上分析</li>
          <li>• 開發和調試應用</li>
          <li>• 需要查詢歷史交易</li>
        </ul>
      </div>
      <div class="bg-yellow-500/10 p-4 rounded-lg border border-yellow-500/30">
        <h4 class="font-semibold text-yellow-400 mb-2">⚠ 可以不用 TxIndex</h4>
        <ul class="text-sm text-[var(--text-secondary)] space-y-2">
          <li>• 只運行個人錢包</li>
          <li>• 只驗證區塊鏈</li>
          <li>• 磁碟空間有限</li>
          <li>• 使用修剪模式</li>
        </ul>
      </div>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="summary" class="text-2xl font-bold text-[var(--text-primary)]">總結</h2>

    <div class="bg-gradient-to-r from-bitcoin-500/10 to-transparent p-6 rounded-lg border border-bitcoin-500/30">
      <ul class="space-y-3 text-[var(--text-secondary)]">
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">快速查詢：</strong>TxIndex 允許透過 txid 快速查詢任何歷史交易</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">可選功能：</strong>預設禁用，需要手動啟用並重建索引</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-yellow-500">⚠</span>
          <span><strong class="text-[var(--text-primary)]">額外空間：</strong>需要約 35 GB 額外磁碟空間</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-red-500">✗</span>
          <span><strong class="text-[var(--text-primary)]">不兼容修剪：</strong>TxIndex 不能與 pruning 模式同時使用</span>
        </li>
      </ul>
    </div>
  </section>
</ArticleLayout>
