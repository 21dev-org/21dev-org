---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="Signature Operations (SigOps)"
  description="深入了解比特幣的簽名操作限制，如何防止 DoS 攻擊並確保區塊驗證效率。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Bitcoin Core', href: '/tech/bitcoin-core/' },
    { label: 'SigOps' },
  ]}
  difficulty="advanced"
  readingTime="10 分鐘"
  prevPage={{ title: 'TxIndex', href: '/tech/bitcoin-core/txindex' }}
  nextPage={{ title: 'Wallet Encryption', href: '/tech/bitcoin-core/wallet-encryption' }}
>
  <section class="space-y-6">
    <h2 id="introduction" class="text-2xl font-bold text-[var(--text-primary)]">什麼是 SigOps？</h2>
    <p class="text-[var(--text-secondary)]">
      Signature Operations（SigOps，簽名操作）是衡量交易驗證成本的指標。
      比特幣對每個區塊的 SigOps 總數有限制，以防止攻擊者創建需要大量 CPU 時間驗證的區塊。
    </p>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-4">為什麼需要 SigOps 限制？</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="p-4 bg-red-500/10 rounded-lg border border-red-500/30">
          <h4 class="font-semibold text-red-400 mb-2">無限制的風險</h4>
          <ul class="text-sm text-[var(--text-secondary)] space-y-1">
            <li>• 區塊驗證時間過長</li>
            <li>• DoS 攻擊可能</li>
            <li>• 節點資源耗盡</li>
            <li>• 網路同步延遲</li>
          </ul>
        </div>
        <div class="p-4 bg-green-500/10 rounded-lg border border-green-500/30">
          <h4 class="font-semibold text-green-400 mb-2">SigOps 限制的保護</h4>
          <ul class="text-sm text-[var(--text-secondary)] space-y-1">
            <li>• 可預測的驗證時間</li>
            <li>• 防止資源耗盡攻擊</li>
            <li>• 確保網路健康</li>
            <li>• 保護較弱的節點</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="limits" class="text-2xl font-bold text-[var(--text-primary)]">SigOps 限制</h2>

    <h3 id="block-limits" class="text-xl font-semibold text-[var(--text-primary)]">區塊限制</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-[var(--border-default)]">
              <th class="text-left py-2 text-[var(--text-secondary)]">時期</th>
              <th class="text-left py-2 text-[var(--text-secondary)]">限制</th>
              <th class="text-left py-2 text-[var(--text-secondary)]">計算方式</th>
            </tr>
          </thead>
          <tbody class="text-[var(--text-secondary)]">
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">Pre-SegWit</td>
              <td class="py-2">20,000 SigOps</td>
              <td class="py-2">傳統計數</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2 font-semibold text-bitcoin-500">Post-SegWit</td>
              <td class="py-2 font-semibold text-bitcoin-500">80,000 SigOps</td>
              <td class="py-2">Weight-based（最大 4 MWU）</td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="text-sm text-[var(--text-tertiary)] mt-3">
        SegWit 的 SigOps 限制與區塊重量成比例：每 50 weight units 最多 1 個 SigOp
      </p>
    </div>

    <h3 id="counting-rules" class="text-xl font-semibold text-[var(--text-primary)]">計數規則</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-text" is:raw>傳統 SigOps 計數（Legacy）：
┌────────────────────────────────┬──────────┐
│ 操作                           │ SigOps   │
├────────────────────────────────┼──────────┤
│ OP_CHECKSIG                    │ 1        │
│ OP_CHECKSIGVERIFY              │ 1        │
│ OP_CHECKMULTISIG (最多 20 keys)│ 20       │
│ OP_CHECKMULTISIGVERIFY         │ 20       │
└────────────────────────────────┴──────────┘

SegWit SigOps 計數（更精確）：
┌────────────────────────────────┬──────────┐
│ 操作                           │ SigOps   │
├────────────────────────────────┼──────────┤
│ OP_CHECKSIG (native SegWit)    │ 1        │
│ OP_CHECKMULTISIG (n-of-m)      │ n        │
│ (實際公鑰數量，不是最大值 20)   │          │
└────────────────────────────────┴──────────┘

Taproot（BIP-342）：
- 每個 OP_CHECKSIG 或 OP_CHECKSIGADD 計 1 個 SigOp
- 沒有 CHECKMULTISIG（使用 CHECKSIGADD）</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="implementation" class="text-2xl font-bold text-[var(--text-primary)]">實現細節</h2>

    <h3 id="counting-code" class="text-xl font-semibold text-[var(--text-primary)]">SigOps 計數</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-typescript" is:raw>enum Opcode {
  OP_CHECKSIG = 0xac,
  OP_CHECKSIGVERIFY = 0xad,
  OP_CHECKMULTISIG = 0xae,
  OP_CHECKMULTISIGVERIFY = 0xaf,
  OP_CHECKSIGADD = 0xba,  // Taproot
}

interface SigOpCount {
  legacy: number;
  segwit: number;
}

// 傳統 SigOps 計數（保守估計）
function countLegacySigOps(script: Buffer): number {
  let count = 0;
  let i = 0;

  while (i < script.length) {
    const opcode = script[i];

    switch (opcode) {
      case Opcode.OP_CHECKSIG:
      case Opcode.OP_CHECKSIGVERIFY:
        count += 1;
        break;

      case Opcode.OP_CHECKMULTISIG:
      case Opcode.OP_CHECKMULTISIGVERIFY:
        // 傳統計數：假設最大 20 個公鑰
        count += 20;
        break;
    }

    i++;
  }

  return count;
}

// SegWit SigOps 計數（精確計數）
function countSegWitSigOps(
  script: Buffer,
  witness: Buffer[]
): number {
  let count = 0;

  // 對於 P2WPKH，計 1 個 SigOp
  if (isP2WPKH(script)) {
    return 1;
  }

  // 對於 P2WSH，分析見證腳本
  if (isP2WSH(script)) {
    const witnessScript = witness[witness.length - 1];
    return countWitnessSigOps(witnessScript, witness);
  }

  return count;
}

function countWitnessSigOps(
  witnessScript: Buffer,
  witness: Buffer[]
): number {
  let count = 0;
  let i = 0;

  while (i < witnessScript.length) {
    const opcode = witnessScript[i];

    switch (opcode) {
      case Opcode.OP_CHECKSIG:
      case Opcode.OP_CHECKSIGVERIFY:
        count += 1;
        break;

      case Opcode.OP_CHECKMULTISIG:
      case Opcode.OP_CHECKMULTISIGVERIFY:
        // SegWit: 使用實際的公鑰數量
        const nKeys = getMultisigKeyCount(witnessScript, i);
        count += nKeys;
        break;
    }

    i++;
  }

  return count;
}

// 計算區塊的總 SigOps
function calculateBlockSigOps(block: Block): number {
  let totalSigOps = 0;

  for (const tx of block.transactions) {
    // Legacy SigOps（輸出腳本 + P2SH 贖回腳本）
    for (const output of tx.outputs) {
      totalSigOps += countLegacySigOps(output.scriptPubKey) * 4;
    }

    // SegWit SigOps
    for (let i = 0; i < tx.inputs.length; i++) {
      if (tx.witness && tx.witness[i]) {
        totalSigOps += countSegWitSigOps(
          tx.inputs[i].prevout.scriptPubKey,
          tx.witness[i]
        );
      }
    }
  }

  return totalSigOps;
}</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="attack-vectors" class="text-2xl font-bold text-[var(--text-primary)]">攻擊向量</h2>

    <h3 id="historical-attack" class="text-xl font-semibold text-[var(--text-primary)]">歷史攻擊</h3>

    <div class="bg-red-500/10 p-6 rounded-lg border border-red-500/30">
      <h4 class="font-semibold text-red-400 mb-3">2015 年的 SigOps 攻擊</h4>
      <p class="text-[var(--text-secondary)] mb-4">
        攻擊者創建了包含大量簽名操作的區塊，導致驗證時間長達 25 秒。
        這暴露了早期 SigOps 計數規則的問題。
      </p>
      <ul class="text-sm text-[var(--text-secondary)] space-y-2">
        <li class="flex items-start gap-3">
          <span class="text-red-500">•</span>
          <span>攻擊者使用 OP_CHECKMULTISIG 的最壞情況</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-red-500">•</span>
          <span>舊規則按輸出腳本計數，不考慮實際簽名</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-red-500">•</span>
          <span>P2SH 贖回腳本可以包含大量 CHECKMULTISIG</span>
        </li>
      </ul>
    </div>

    <h3 id="segwit-fixes" class="text-xl font-semibold text-[var(--text-primary)]">SegWit 修復</h3>

    <div class="bg-green-500/10 p-6 rounded-lg border border-green-500/30">
      <h4 class="font-semibold text-green-400 mb-3">SegWit 的改進</h4>
      <ul class="space-y-3 text-[var(--text-secondary)]">
        <li class="flex items-start gap-3">
          <span class="text-green-500">✓</span>
          <div>
            <strong class="text-[var(--text-primary)]">精確計數：</strong>
            CHECKMULTISIG 按實際公鑰數量計數，不再假設最大值
          </div>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-green-500">✓</span>
          <div>
            <strong class="text-[var(--text-primary)]">Weight-based 限制：</strong>
            SigOps 限制與區塊重量成比例
          </div>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-green-500">✓</span>
          <div>
            <strong class="text-[var(--text-primary)]">見證數據折扣：</strong>
            見證腳本的 SigOps 成本更準確
          </div>
        </li>
      </ul>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="taproot" class="text-2xl font-bold text-[var(--text-primary)]">Taproot 中的 SigOps</h2>

    <h3 id="taproot-changes" class="text-xl font-semibold text-[var(--text-primary)]">Taproot 的變化</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-text" is:raw>Taproot (BIP-342) SigOps 規則：

1. Key-path spend:
   - 只需要 1 個簽名
   - 計 0 個 SigOps（包含在基礎成本中）

2. Script-path spend:
   - 使用 OP_CHECKSIG 和 OP_CHECKSIGADD
   - 沒有 OP_CHECKMULTISIG
   - 每個 CHECKSIG/CHECKSIGADD 計 1 個 SigOp

3. 預算系統：
   - 每個輸入有 SigOps 預算
   - 預算 = 50 + (見證大小)
   - 超過預算的交易無效</code></pre>
    </div>

    <h3 id="checksigadd" class="text-xl font-semibold text-[var(--text-primary)]">OP_CHECKSIGADD</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-text" is:raw>OP_CHECKSIGADD 取代 OP_CHECKMULTISIG

傳統多簽（2-of-3）：
OP_2 &lt;pk1&gt; &lt;pk2&gt; &lt;pk3&gt; OP_3 OP_CHECKMULTISIG
→ 計 3 個 SigOps（舊規則計 20 個）

Taproot 多簽（2-of-3）：
&lt;pk1&gt; OP_CHECKSIG
&lt;pk2&gt; OP_CHECKSIGADD
&lt;pk3&gt; OP_CHECKSIGADD
OP_2 OP_NUMEQUAL
→ 計 3 個 SigOps（準確反映實際工作量）</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="rpc-commands" class="text-2xl font-bold text-[var(--text-primary)]">相關 RPC 命令</h2>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <pre class="text-sm overflow-x-auto"><code class="language-bash" is:raw># 查看區塊的 SigOps
bitcoin-cli getblockstats <height> '["sigops"]'
# { "sigops": 12345 }

# 查看區塊模板的 SigOps
bitcoin-cli getblocktemplate '{"rules": ["segwit"]}' | jq '.sigopcost'

# 解碼交易查看腳本
bitcoin-cli decoderawtransaction <hex> | jq '.vout[].scriptPubKey'

# 測試 mempool 接受
bitcoin-cli testmempoolaccept '["<hex>"]'</code></pre>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="practical-impact" class="text-2xl font-bold text-[var(--text-primary)]">實際影響</h2>

    <h3 id="transaction-design" class="text-xl font-semibold text-[var(--text-primary)]">交易設計考量</h3>

    <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-default)]">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-[var(--border-default)]">
              <th class="text-left py-2 text-[var(--text-secondary)]">腳本類型</th>
              <th class="text-left py-2 text-[var(--text-secondary)]">SigOps</th>
              <th class="text-left py-2 text-[var(--text-secondary)]">說明</th>
            </tr>
          </thead>
          <tbody class="text-[var(--text-secondary)]">
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">P2PKH</td>
              <td class="py-2">1</td>
              <td class="py-2">單簽名</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">P2WPKH</td>
              <td class="py-2">1</td>
              <td class="py-2">SegWit 單簽名</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">P2TR (key-path)</td>
              <td class="py-2">0</td>
              <td class="py-2">包含在基礎成本</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">2-of-3 多簽 (Legacy)</td>
              <td class="py-2">20</td>
              <td class="py-2">保守計數</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">2-of-3 多簽 (SegWit)</td>
              <td class="py-2">3</td>
              <td class="py-2">精確計數</td>
            </tr>
            <tr class="border-b border-[var(--border-default)]">
              <td class="py-2">2-of-3 多簽 (Taproot)</td>
              <td class="py-2">3</td>
              <td class="py-2">CHECKSIGADD</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="best-practices" class="text-2xl font-bold text-[var(--text-primary)]">最佳實踐</h2>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-green-500/10 p-4 rounded-lg border border-green-500/30">
        <h4 class="font-semibold text-green-400 mb-2">✓ 推薦做法</h4>
        <ul class="text-sm text-[var(--text-secondary)] space-y-2">
          <li>• 使用 SegWit/Taproot 減少 SigOps</li>
          <li>• 避免不必要的複雜腳本</li>
          <li>• 考慮 MuSig2 替代多簽</li>
          <li>• 測試交易在 SigOps 限制內</li>
        </ul>
      </div>
      <div class="bg-yellow-500/10 p-4 rounded-lg border border-yellow-500/30">
        <h4 class="font-semibold text-yellow-400 mb-2">⚠ 注意事項</h4>
        <ul class="text-sm text-[var(--text-secondary)] space-y-2">
          <li>• Legacy 多簽 SigOps 成本高</li>
          <li>• 大型多簽可能接近限制</li>
          <li>• 某些礦池有更嚴格的限制</li>
          <li>• SigOps 影響打包優先級</li>
        </ul>
      </div>
    </div>
  </section>

  <section class="space-y-6">
    <h2 id="summary" class="text-2xl font-bold text-[var(--text-primary)]">總結</h2>

    <div class="bg-gradient-to-r from-bitcoin-500/10 to-transparent p-6 rounded-lg border border-bitcoin-500/30">
      <ul class="space-y-3 text-[var(--text-secondary)]">
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">DoS 保護：</strong>SigOps 限制防止區塊驗證時間過長</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">區塊限制：</strong>SegWit 後最多 80,000 SigOps 每區塊</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">精確計數：</strong>SegWit/Taproot 按實際簽名數量計數</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="text-bitcoin-500">✓</span>
          <span><strong class="text-[var(--text-primary)]">使用現代腳本：</strong>Taproot key-path 沒有額外 SigOps 成本</span>
        </li>
      </ul>
    </div>
  </section>
</ArticleLayout>
