---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-30 è‡ªè¨‚è¡¨æƒ…"
  description="Nostr è‡ªè¨‚è¡¨æƒ…ç¬¦è™Ÿæ¨™æº–ï¼Œè®“ç”¨æˆ¶å¯ä»¥åœ¨è²¼æ–‡å’Œåæ‡‰ä¸­ä½¿ç”¨è‡ªè¨‚åœ–ç‰‡è¡¨æƒ…ã€‚"
  breadcrumbs={[
    { label: 'æŠ€è¡“', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-30 è‡ªè¨‚è¡¨æƒ…' },
  ]}
  difficulty="beginner"
  readingTime="8 åˆ†é˜"
  prevPage={{
    href: '/tech/nostr/nip-25/',
    title: 'NIP-25 åæ‡‰',
  }}
  nextPage={{
    href: '/tech/nostr/nip-36/',
    title: 'NIP-36 æ•æ„Ÿå…§å®¹',
  }}
>
  <h2 id="overview">æ¦‚è¿°</h2>
  <p>
    NIP-30 å®šç¾©äº† Nostr çš„è‡ªè¨‚è¡¨æƒ…ç¬¦è™Ÿæ¨™æº–ï¼Œè®“ç”¨æˆ¶å¯ä»¥ä½¿ç”¨åœ–ç‰‡ä½œç‚ºè¡¨æƒ…ç¬¦è™Ÿã€‚ èˆ‡ Discord æˆ– Slack
    çš„è‡ªè¨‚è¡¨æƒ…é¡ä¼¼ï¼Œç”¨æˆ¶å¯ä»¥åœ¨å…§å®¹ä¸­ä½¿ç”¨ <code>:shortcode:</code>
    æ ¼å¼å¼•ç”¨è‡ªè¨‚è¡¨æƒ…ï¼Œå®¢æˆ¶ç«¯æœƒå°‡å…¶æ¸²æŸ“ç‚ºå°æ‡‰çš„åœ–ç‰‡ã€‚
  </p>

  <div class="p-4 bg-purple-500/10 border border-purple-500/30 rounded-lg my-6">
    <p class="text-purple-700 dark:text-purple-300 font-medium mb-2">ä½¿ç”¨å ´æ™¯</p>
    <p class="text-[var(--text-secondary)] text-sm">
      è‡ªè¨‚è¡¨æƒ…å¯ç”¨æ–¼å€‹äººè³‡æ–™ã€è²¼æ–‡å…§å®¹å’Œåæ‡‰ã€‚ç¤¾ç¾¤å¯ä»¥å»ºç«‹å°ˆå±¬çš„è¡¨æƒ…åŒ…ï¼Œ å¢åŠ äº’å‹•çš„è¶£å‘³æ€§å’Œå€‹æ€§åŒ–ã€‚
    </p>
  </div>

  <h2 id="supported-events">æ”¯æ´çš„äº‹ä»¶é¡å‹</h2>
  <div class="overflow-x-auto my-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-[var(--bg-secondary)]">
          <th class="border border-[var(--border-default)] p-3 text-left">Kind</th>
          <th class="border border-[var(--border-default)] p-3 text-left">é¡å‹</th>
          <th class="border border-[var(--border-default)] p-3 text-left">è¡¨æƒ…ä½ç½®</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="border border-[var(--border-default)] p-3 font-mono">0</td>
          <td class="border border-[var(--border-default)] p-3">å€‹äººè³‡æ–™</td>
          <td class="border border-[var(--border-default)] p-3"
            ><code>name</code> å’Œ <code>about</code> æ¬„ä½</td
          >
        </tr>
        <tr>
          <td class="border border-[var(--border-default)] p-3 font-mono">1</td>
          <td class="border border-[var(--border-default)] p-3">æ–‡å­—è²¼æ–‡</td>
          <td class="border border-[var(--border-default)] p-3"><code>content</code> æ¬„ä½</td>
        </tr>
        <tr>
          <td class="border border-[var(--border-default)] p-3 font-mono">7</td>
          <td class="border border-[var(--border-default)] p-3">åæ‡‰</td>
          <td class="border border-[var(--border-default)] p-3"><code>content</code> æ¬„ä½</td>
        </tr>
        <tr>
          <td class="border border-[var(--border-default)] p-3 font-mono">30315</td>
          <td class="border border-[var(--border-default)] p-3">ç”¨æˆ¶ç‹€æ…‹</td>
          <td class="border border-[var(--border-default)] p-3"><code>content</code> æ¬„ä½</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 id="emoji-tag">è¡¨æƒ…æ¨™ç±¤æ ¼å¼</h2>
  <p>
    è‡ªè¨‚è¡¨æƒ…ä½¿ç”¨ <code>emoji</code> æ¨™ç±¤å®šç¾©ï¼š
  </p>

  <pre><code class="language-json" is:raw>{`["emoji", "<shortcode>", "<image-url>"]`}</code></pre>

  <ul>
    <li><code>shortcode</code> - è¡¨æƒ…ä»£ç¢¼ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•¸å­—å’Œåº•ç·š</li>
    <li><code>image-url</code> - è¡¨æƒ…åœ–ç‰‡çš„ URL</li>
  </ul>

  <h3>å‘½åè¦å‰‡</h3>
  <ul>
    <li>åªèƒ½ä½¿ç”¨ <strong>a-zã€A-Zã€0-9ã€_</strong></li>
    <li>ä¸èƒ½åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦</li>
    <li>å»ºè­°ä½¿ç”¨å°å¯«ä»¥ä¿æŒä¸€è‡´æ€§</li>
  </ul>

  <pre><code class="language-json" is:raw>{`// âœ“ æ­£ç¢º
["emoji", "pepe_happy", "https://example.com/pepe_happy.gif"]
["emoji", "bitcoin", "https://example.com/btc.png"]
["emoji", "nostr_logo", "https://example.com/nostr.svg"]

// âœ— éŒ¯èª¤
["emoji", "pepe-happy", "..."]   // åŒ…å«é€£å­—è™Ÿ
["emoji", "pepe happy", "..."]   // åŒ…å«ç©ºæ ¼
["emoji", "ğŸš€", "..."]           // ä½¿ç”¨ Unicode è¡¨æƒ…`}</code></pre>

  <h2 id="usage">ä½¿ç”¨æ–¹å¼</h2>
  <p>
    åœ¨å…§å®¹ä¸­ä½¿ç”¨ <code>:shortcode:</code> æ ¼å¼å¼•ç”¨è¡¨æƒ…ï¼š
  </p>

  <pre><code class="language-json" is:raw>{`{
  "kind": 1,
  "content": "ä»Šå¤©å¿ƒæƒ…è¶…å¥½ :pepe_happy: ä¾†é»æ¯”ç‰¹å¹£ :bitcoin:",
  "tags": [
    ["emoji", "pepe_happy", "https://example.com/pepe_happy.gif"],
    ["emoji", "bitcoin", "https://example.com/btc.png"]
  ],
  ...
}`}</code></pre>

  <h2 id="examples">äº‹ä»¶ç¯„ä¾‹</h2>

  <h3>å€‹äººè³‡æ–™ (Kind 0)</h3>
  <pre><code class="language-json" is:raw>{`{
  "kind": 0,
  "content": "{\"name\":\"Alice :nostr:\",\"about\":\"Nostr æ„›å¥½è€… :bitcoin: :lightning:\"}",
  "tags": [
    ["emoji", "nostr", "https://example.com/nostr.png"],
    ["emoji", "bitcoin", "https://example.com/btc.png"],
    ["emoji", "lightning", "https://example.com/ln.png"]
  ],
  ...
}`}</code></pre>

  <h3>è²¼æ–‡ (Kind 1)</h3>
  <pre><code class="language-json" is:raw>{`{
  "kind": 1,
  "content": "å‰›å‰›å®Œæˆäº†æ–°åŠŸèƒ½ï¼:ship_it: :party_parrot:",
  "tags": [
    ["emoji", "ship_it", "https://example.com/ship.gif"],
    ["emoji", "party_parrot", "https://example.com/parrot.gif"]
  ],
  ...
}`}</code></pre>

  <h3>è‡ªè¨‚è¡¨æƒ…åæ‡‰ (Kind 7)</h3>
  <pre><code class="language-json" is:raw>{`{
  "kind": 7,
  "content": ":pepe_love:",
  "tags": [
    ["e", "<event-id>", "<relay>"],
    ["p", "<author-pubkey>"],
    ["emoji", "pepe_love", "https://example.com/pepe_love.png"]
  ],
  ...
}`}</code></pre>

  <h2 id="implementation">å¯¦ä½œ</h2>

  <h3>å»ºç«‹å¸¶è¡¨æƒ…çš„äº‹ä»¶</h3>
  <pre><code class="language-typescript" is:raw>{`import { finalizeEvent } from 'nostr-tools';

interface CustomEmoji {
  shortcode: string;
  url: string;
}

// é©—è­‰ shortcode æ ¼å¼
function isValidShortcode(shortcode: string): boolean {
  return /^[a-zA-Z0-9_]+$/.test(shortcode);
}

// å»ºç«‹å¸¶è‡ªè¨‚è¡¨æƒ…çš„è²¼æ–‡
function createPostWithEmojis(
  privateKey: Uint8Array,
  content: string,
  emojis: CustomEmoji[]
) {
  // é©—è­‰æ‰€æœ‰ shortcode
  for (const emoji of emojis) {
    if (!isValidShortcode(emoji.shortcode)) {
      throw new Error(\`Invalid shortcode: \${emoji.shortcode}\`);
    }
  }

  const emojiTags = emojis.map(e => ['emoji', e.shortcode, e.url]);

  return finalizeEvent({
    kind: 1,
    created_at: Math.floor(Date.now() / 1000),
    tags: emojiTags,
    content,
  }, privateKey);
}

// ä½¿ç”¨ç¯„ä¾‹
const post = createPostWithEmojis(
  privateKey,
  'æ–°å¹´å¿«æ¨‚ï¼:fireworks: :party:',
  [
    { shortcode: 'fireworks', url: 'https://example.com/fireworks.gif' },
    { shortcode: 'party', url: 'https://example.com/party.png' },
  ]
);`}</code></pre>

  <h3>å»ºç«‹è‡ªè¨‚è¡¨æƒ…åæ‡‰</h3>
  <pre><code class="language-typescript" is:raw>{`// ä½¿ç”¨è‡ªè¨‚è¡¨æƒ…åæ‡‰
function createCustomEmojiReaction(
  privateKey: Uint8Array,
  targetEventId: string,
  targetAuthorPubkey: string,
  emoji: CustomEmoji,
  relay?: string
) {
  if (!isValidShortcode(emoji.shortcode)) {
    throw new Error(\`Invalid shortcode: \${emoji.shortcode}\`);
  }

  const tags: string[][] = [
    ['e', targetEventId, relay || ''],
    ['p', targetAuthorPubkey],
    ['emoji', emoji.shortcode, emoji.url],
  ];

  return finalizeEvent({
    kind: 7,
    created_at: Math.floor(Date.now() / 1000),
    tags,
    content: \`:\${emoji.shortcode}:\`,
  }, privateKey);
}

// ä½¿ç”¨ç¯„ä¾‹
const reaction = createCustomEmojiReaction(
  privateKey,
  'abc123...',
  'def456...',
  { shortcode: 'pepe_thumbs_up', url: 'https://example.com/pepe_up.gif' }
);`}</code></pre>

  <h3>è§£æä¸¦æ¸²æŸ“è¡¨æƒ…</h3>
  <pre><code class="language-typescript" is:raw>{`interface EmojiMap {
  [shortcode: string]: string;
}

// å¾äº‹ä»¶æ¨™ç±¤æå–è¡¨æƒ…æ˜ å°„
function extractEmojis(tags: string[][]): EmojiMap {
  const emojiMap: EmojiMap = {};

  for (const tag of tags) {
    if (tag[0] === 'emoji' && tag[1] && tag[2]) {
      emojiMap[tag[1]] = tag[2];
    }
  }

  return emojiMap;
}

// å°‡å…§å®¹ä¸­çš„ :shortcode: æ›¿æ›ç‚ºåœ–ç‰‡
function renderEmojis(content: string, emojiMap: EmojiMap): string {
  return content.replace(/:([a-zA-Z0-9_]+):/g, (match, shortcode) => {
    const url = emojiMap[shortcode];
    if (url) {
      return \`<img src="\${url}" alt=":\${shortcode}:" class="custom-emoji" />\`;
    }
    return match; // æ²’æœ‰å°æ‡‰çš„è¡¨æƒ…ï¼Œä¿æŒåŸæ¨£
  });
}

// ä½¿ç”¨ç¯„ä¾‹
const event = {
  content: 'å¤ªæ£’äº† :party: :fire:',
  tags: [
    ['emoji', 'party', 'https://example.com/party.gif'],
    ['emoji', 'fire', 'https://example.com/fire.gif'],
  ],
};

const emojiMap = extractEmojis(event.tags);
const rendered = renderEmojis(event.content, emojiMap);
// å¤ªæ£’äº† <img src="https://example.com/party.gif" ... /> <img src="https://example.com/fire.gif" ... />`}</code></pre>

  <h2 id="react-component">React çµ„ä»¶ç¯„ä¾‹</h2>
  <pre><code class="language-tsx" is:raw>{`interface CustomEmojiProps {
  shortcode: string;
  url: string;
}

function CustomEmoji({ shortcode, url }: CustomEmojiProps) {
  return (
    <img
      src={url}
      alt={\`:\${shortcode}:\`}
      title={\`:\${shortcode}:\`}
      className="inline-block h-5 w-5 align-text-bottom"
      loading="lazy"
    />
  );
}

interface EmojifiedTextProps {
  content: string;
  emojis: EmojiMap;
}

function EmojifiedText({ content, emojis }: EmojifiedTextProps) {
  const parts: (string | JSX.Element)[] = [];
  let lastIndex = 0;
  const regex = /:([a-zA-Z0-9_]+):/g;
  let match;

  while ((match = regex.exec(content)) !== null) {
    // æ·»åŠ è¡¨æƒ…å‰çš„æ–‡å­—
    if (match.index > lastIndex) {
      parts.push(content.slice(lastIndex, match.index));
    }

    const shortcode = match[1];
    const url = emojis[shortcode];

    if (url) {
      parts.push(
        <CustomEmoji
          key={\`\${shortcode}-\${match.index}\`}
          shortcode={shortcode}
          url={url}
        />
      );
    } else {
      // æ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„è¡¨æƒ…
      parts.push(match[0]);
    }

    lastIndex = regex.lastIndex;
  }

  // æ·»åŠ å‰©é¤˜çš„æ–‡å­—
  if (lastIndex < content.length) {
    parts.push(content.slice(lastIndex));
  }

  return <>{parts}</>;
}

// ä½¿ç”¨ç¯„ä¾‹
<EmojifiedText
  content="æ­å–œ :party: å¤ªå²å®³äº† :fire:"
  emojis={{
    party: 'https://example.com/party.gif',
    fire: 'https://example.com/fire.gif',
  }}
/>`}</code></pre>

  <h2 id="emoji-packs">è¡¨æƒ…åŒ…</h2>
  <p>
    ç¤¾ç¾¤å¯ä»¥å»ºç«‹ä¸¦åˆ†äº«è¡¨æƒ…åŒ…ã€‚å¸¸è¦‹çš„åšæ³•æ˜¯å°‡è¡¨æƒ…åœ–ç‰‡è¨—ç®¡åœ¨ç©©å®šçš„ä¼ºæœå™¨ä¸Šï¼Œ ä¸¦æä¾› shortcode
    åˆ—è¡¨ä¾›ç”¨æˆ¶ä½¿ç”¨ã€‚
  </p>

  <pre><code class="language-typescript" is:raw>{`// è¡¨æƒ…åŒ…å®šç¾©
interface EmojiPack {
  name: string;
  author: string;
  emojis: CustomEmoji[];
}

const pepePack: EmojiPack = {
  name: 'Pepe Pack',
  author: 'npub1...',
  emojis: [
    { shortcode: 'pepe_happy', url: 'https://cdn.example.com/pepe/happy.gif' },
    { shortcode: 'pepe_sad', url: 'https://cdn.example.com/pepe/sad.gif' },
    { shortcode: 'pepe_angry', url: 'https://cdn.example.com/pepe/angry.gif' },
    { shortcode: 'pepe_love', url: 'https://cdn.example.com/pepe/love.gif' },
    { shortcode: 'pepe_think', url: 'https://cdn.example.com/pepe/think.gif' },
  ],
};

// ä½¿ç”¨è¡¨æƒ…åŒ…å»ºç«‹è²¼æ–‡
function createPostWithPack(
  privateKey: Uint8Array,
  content: string,
  pack: EmojiPack
) {
  // åªåŒ…å«å…§å®¹ä¸­å¯¦éš›ä½¿ç”¨çš„è¡¨æƒ…
  const usedEmojis = pack.emojis.filter(emoji =>
    content.includes(\`:\${emoji.shortcode}:\`)
  );

  return createPostWithEmojis(privateKey, content, usedEmojis);
}`}</code></pre>

  <h2 id="best-practices">æœ€ä½³å¯¦è¸</h2>
  <ul>
    <li><strong>åœ–ç‰‡å¤§å°</strong>ï¼šå»ºè­° 64x64 æˆ– 128x128 åƒç´ </li>
    <li><strong>æª”æ¡ˆæ ¼å¼</strong>ï¼šæ”¯æ´ PNGã€GIFã€WebPã€SVG</li>
    <li><strong>å‹•æ…‹è¡¨æƒ…</strong>ï¼šGIF å’Œ WebP æ”¯æ´å‹•ç•«</li>
    <li><strong>ç©©å®šè¨—ç®¡</strong>ï¼šä½¿ç”¨å¯é çš„ CDN è¨—ç®¡è¡¨æƒ…åœ–ç‰‡</li>
    <li><strong>åªåŒ…å«ä½¿ç”¨çš„</strong>ï¼šä¸è¦åœ¨æ¨™ç±¤ä¸­åŒ…å«æœªä½¿ç”¨çš„è¡¨æƒ…</li>
    <li><strong>CSS æ¨£å¼</strong>ï¼šç¢ºä¿è¡¨æƒ…åœ¨è¡Œå…§æ­£ç¢ºé¡¯ç¤º</li>
  </ul>

  <h3>CSS æ¨£å¼å»ºè­°</h3>
  <pre><code class="language-css" is:raw>{`.custom-emoji {
  display: inline-block;
  height: 1.2em;
  width: 1.2em;
  vertical-align: text-bottom;
  object-fit: contain;
}

/* è¼ƒå¤§çš„è¡¨æƒ… */
.custom-emoji-lg {
  height: 2em;
  width: 2em;
}

/* åæ‡‰ä¸­çš„è¡¨æƒ… */
.reaction-emoji {
  height: 1.5em;
  width: 1.5em;
}`}</code></pre>

  <h2 id="considerations">æ³¨æ„äº‹é …</h2>
  <ul>
    <li><strong>åœ–ç‰‡è¼‰å…¥</strong>ï¼šä½¿ç”¨ lazy loading é¿å…å½±éŸ¿æ•ˆèƒ½</li>
    <li><strong>fallback</strong>ï¼šç„¡æ³•è¼‰å…¥åœ–ç‰‡æ™‚é¡¯ç¤º :shortcode:</li>
    <li><strong>ç„¡éšœç¤™</strong>ï¼šä½¿ç”¨ alt å±¬æ€§æä¾›æ–‡å­—æè¿°</li>
    <li><strong>XSS é˜²è­·</strong>ï¼šç¢ºä¿ URL ç¶“éé©—è­‰å’Œæ¸…ç†</li>
  </ul>

  <div class="p-4 bg-amber-500/10 border border-amber-500/30 rounded-lg my-6">
    <p class="text-amber-700 dark:text-amber-300 font-medium mb-2">å®‰å…¨æé†’</p>
    <p class="text-[var(--text-secondary)] text-sm">
      è¡¨æƒ…åœ–ç‰‡ URL ç”±ç”¨æˆ¶æä¾›ï¼Œå¯èƒ½æŒ‡å‘æƒ¡æ„å…§å®¹ã€‚ å®¢æˆ¶ç«¯æ‡‰è©²é©—è­‰ URL
      æ ¼å¼ï¼Œä¸¦è€ƒæ…®ä½¿ç”¨å…§å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰ã€‚
    </p>
  </div>

  <h2 id="related">ç›¸é—œ NIP</h2>
  <ul>
    <li><a href="/tech/nostr/nip-01/">NIP-01</a> - åŸºæœ¬å”è­°èˆ‡äº‹ä»¶çµæ§‹</li>
    <li><a href="/tech/nostr/nip-25/">NIP-25</a> - åæ‡‰ï¼ˆè‡ªè¨‚è¡¨æƒ…åæ‡‰ï¼‰</li>
    <li><a href="/tech/nostr/nip-94/">NIP-94</a> - æª”æ¡ˆä¸­ç¹¼è³‡æ–™</li>
  </ul>

  <h2 id="resources">åƒè€ƒè³‡æº</h2>
  <ul>
    <li>
      <a
        href="https://github.com/nostr-protocol/nips/blob/master/30.md"
        target="_blank"
        rel="noopener">NIP-30 è¦ç¯„åŸæ–‡</a
      >
    </li>
    <li>
      <a href="https://github.com/nbd-wtf/nostr-tools" target="_blank" rel="noopener"
        >nostr-tools å‡½å¼åº«</a
      >
    </li>
  </ul>
</ArticleLayout>
