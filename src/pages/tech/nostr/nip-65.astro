---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-65 ä¸­ç¹¼å™¨åˆ—è¡¨"
  description="æ·±å…¥äº†è§£ Nostr çš„ä¸­ç¹¼å™¨åˆ—è¡¨å…ƒæ•¸æ“šï¼Œç”¨æ–¼ç™¼ç¾ç”¨æˆ¶ä½¿ç”¨çš„ä¸­ç¹¼å™¨ã€‚"
  breadcrumbs={[
    { label: 'æŠ€è¡“', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-65 ä¸­ç¹¼å™¨åˆ—è¡¨' },
  ]}
  difficulty="intermediate"
  readingTime="10 åˆ†é˜"
  prevPage={{ title: 'NIP-57 Zaps', href: '/tech/nostr/nip-57' }}
  nextPage={{ title: 'ä¸­ç¹¼å™¨é‹ä½œ', href: '/tech/nostr/relays' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">ä»€éº¼æ˜¯ NIP-65ï¼Ÿ</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    NIP-65 å®šç¾©äº†ç”¨æˆ¶çš„ä¸­ç¹¼å™¨åˆ—è¡¨å…ƒæ•¸æ“šï¼ˆRelay List Metadataï¼‰ï¼Œè®“å…¶ä»–ç”¨æˆ¶å’Œå®¢æˆ¶ç«¯
    çŸ¥é“æ‡‰è©²å¾å“ªäº›ä¸­ç¹¼å™¨è®€å–è©²ç”¨æˆ¶çš„äº‹ä»¶ï¼Œä»¥åŠå‘å“ªäº›ä¸­ç¹¼å™¨ç™¼é€çµ¦è©²ç”¨æˆ¶çš„äº‹ä»¶ã€‚
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-purple-500/10 border border-purple-500/30">
    <p class="text-sm text-purple-700 dark:text-purple-400">
      <strong>æ ¸å¿ƒæ¦‚å¿µï¼š</strong>
      Kind 10002 äº‹ä»¶åŒ…å«ç”¨æˆ¶çš„ä¸­ç¹¼å™¨åå¥½ï¼Œå€åˆ†ã€Œè®€å–ã€å’Œã€Œå¯«å…¥ã€ä¸­ç¹¼å™¨ï¼Œ
      è®“ Nostr ç¶²è·¯æ›´æœ‰æ•ˆç‡åœ°è·¯ç”±è¨Šæ¯ã€‚
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">äº‹ä»¶çµæ§‹</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`{
  "kind": 10002,
  "pubkey": "<user-pubkey>",
  "content": "",
  "tags": [
    ["r", "wss://relay1.com"],              // è®€+å¯«
    ["r", "wss://relay2.com", "read"],      // åªè®€
    ["r", "wss://relay3.com", "write"]      // åªå¯«
  ],
  "created_at": 1234567890,
  "id": "...",
  "sig": "..."
}`}</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">ä¸­ç¹¼å™¨é¡å‹</h2>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">æ¨™è¨˜</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">è®€å–</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">å¯«å…¥</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">ç”¨é€”</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono">ï¼ˆç„¡æ¨™è¨˜ï¼‰</td>
          <td class="py-3 px-4 text-green-500">âœ“</td>
          <td class="py-3 px-4 text-green-500">âœ“</td>
          <td class="py-3 px-4">ä¸»è¦ä¸­ç¹¼å™¨ï¼Œç”¨æ–¼è®€å¯«</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono text-blue-500">"read"</td>
          <td class="py-3 px-4 text-green-500">âœ“</td>
          <td class="py-3 px-4 text-red-500">âœ—</td>
          <td class="py-3 px-4">å¾æ­¤ä¸­ç¹¼å™¨è®€å–ä»–äººäº‹ä»¶</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono text-purple-500">"write"</td>
          <td class="py-3 px-4 text-red-500">âœ—</td>
          <td class="py-3 px-4 text-green-500">âœ“</td>
          <td class="py-3 px-4">ç™¼å¸ƒè‡ªå·±çš„äº‹ä»¶åˆ°æ­¤ä¸­ç¹¼å™¨</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">ä½¿ç”¨å ´æ™¯</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    {
      [
        {
          title: 'æ‰¾åˆ°ç”¨æˆ¶çš„è²¼æ–‡',
          desc: 'æŸ¥çœ‹ç”¨æˆ¶çš„ write ä¸­ç¹¼å™¨ï¼Œå¾é‚£è£¡ç²å–ä»–å€‘çš„äº‹ä»¶',
          icon: 'ğŸ“–',
        },
        {
          title: 'ç™¼é€ç§è¨Š',
          desc: 'ç™¼é€åˆ°ç”¨æˆ¶çš„ read ä¸­ç¹¼å™¨ï¼Œç¢ºä¿ä»–å€‘èƒ½æ”¶åˆ°',
          icon: 'âœ‰ï¸',
        },
        {
          title: 'å›è¦†è²¼æ–‡',
          desc: 'ç™¼é€åˆ°åŸä½œè€…çš„ read ä¸­ç¹¼å™¨',
          icon: 'ğŸ’¬',
        },
        {
          title: 'å»£æ’­é€šçŸ¥',
          desc: 'ä½¿ç”¨ write ä¸­ç¹¼å™¨ç™¼å¸ƒï¼Œè®“é—œæ³¨è€…èƒ½æ‰¾åˆ°',
          icon: 'ğŸ“¢',
        },
      ].map((item) => (
        <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
          <div class="text-2xl mb-2">{item.icon}</div>
          <h4 class="font-semibold text-[var(--text-primary)] mb-1">{item.title}</h4>
          <p class="text-sm text-[var(--text-secondary)]">{item.desc}</p>
        </div>
      ))
    }
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">ç¨‹å¼ç¢¼ç¯„ä¾‹</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">ç™¼å¸ƒä¸­ç¹¼å™¨åˆ—è¡¨</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`async function publishRelayList(relays) {
  const event = {
    kind: 10002,
    created_at: Math.floor(Date.now() / 1000),
    content: '',
    tags: relays.map(r => {
      if (r.type === 'read') return ['r', r.url, 'read']
      if (r.type === 'write') return ['r', r.url, 'write']
      return ['r', r.url]  // è®€+å¯«
    })
  }

  const signed = await window.nostr.signEvent(event)
  // ç™¼é€åˆ°å¤šå€‹ä¸­ç¹¼å™¨
  for (const relay of connectedRelays) {
    relay.send(JSON.stringify(['EVENT', signed]))
  }

  return signed
}

// ä½¿ç”¨
await publishRelayList([
  { url: 'wss://relay.damus.io' },           // è®€+å¯«
  { url: 'wss://nos.lol' },                  // è®€+å¯«
  { url: 'wss://relay.snort.social', type: 'read' },
  { url: 'wss://nostr.wine', type: 'write' }
])`}</code></pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">æŸ¥è©¢ç”¨æˆ¶çš„ä¸­ç¹¼å™¨åˆ—è¡¨</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`async function getUserRelays(pubkey) {
  return new Promise((resolve) => {
    const sub = relay.subscribe([{
      kinds: [10002],
      authors: [pubkey],
      limit: 1
    }])

    let relayList = null

    sub.on('event', (event) => {
      relayList = parseRelayList(event)
    })

    sub.on('eose', () => {
      sub.close()
      resolve(relayList)
    })
  })
}

function parseRelayList(event) {
  const relays = { read: [], write: [] }

  for (const tag of event.tags) {
    if (tag[0] !== 'r') continue

    const url = tag[1]
    const type = tag[2]

    if (!type || type === 'write') {
      relays.write.push(url)
    }
    if (!type || type === 'read') {
      relays.read.push(url)
    }
  }

  return relays
}

// ä½¿ç”¨
const relays = await getUserRelays('npub1...')
console.log('è®€å–ä¸­ç¹¼å™¨:', relays.read)
console.log('å¯«å…¥ä¸­ç¹¼å™¨:', relays.write)`}</code></pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">ç™¼é€äº‹ä»¶åˆ°ç”¨æˆ¶çš„ä¸­ç¹¼å™¨</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`async function sendToUser(event, targetPubkey) {
  // 1. ç²å–ç›®æ¨™ç”¨æˆ¶çš„ä¸­ç¹¼å™¨åˆ—è¡¨
  const userRelays = await getUserRelays(targetPubkey)

  if (!userRelays || userRelays.read.length === 0) {
    console.log('æ‰¾ä¸åˆ°ç”¨æˆ¶çš„ä¸­ç¹¼å™¨ï¼Œä½¿ç”¨é è¨­')
    userRelays = { read: DEFAULT_RELAYS }
  }

  // 2. é€£æ¥åˆ°ç”¨æˆ¶çš„ read ä¸­ç¹¼å™¨
  const connections = await Promise.all(
    userRelays.read.map(url => connectToRelay(url))
  )

  // 3. ç™¼é€äº‹ä»¶
  for (const relay of connections) {
    relay.send(JSON.stringify(['EVENT', event]))
  }
}

// ç™¼é€ç§è¨Šåˆ°ç”¨æˆ¶çš„ä¸­ç¹¼å™¨
await sendToUser(encryptedDM, recipientPubkey)`}</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Outbox æ¨¡å‹</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    NIP-65 å¯¦ç¾äº†ã€ŒOutbox æ¨¡å‹ã€ï¼Œè®“è¨Šæ¯è·¯ç”±æ›´æœ‰æ•ˆç‡ï¼š
  </p>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`# Outbox æ¨¡å‹åŸç†

Alice çš„è¨­å®šï¼š
  write: [relay1, relay2]  // Alice ç™¼å¸ƒåˆ°é€™è£¡
  read:  [relay3, relay4]  // Alice å¾é€™è£¡è®€å–

Bob æƒ³çœ‹ Alice çš„è²¼æ–‡ï¼š
  â†’ æŸ¥è©¢ Alice çš„ kind 10002
  â†’ é€£æ¥åˆ° Alice çš„ write ä¸­ç¹¼å™¨ (relay1, relay2)
  â†’ å¾é‚£è£¡ç²å– Alice çš„äº‹ä»¶

Bob æƒ³ç™¼ç§è¨Šçµ¦ Aliceï¼š
  â†’ æŸ¥è©¢ Alice çš„ kind 10002
  â†’ é€£æ¥åˆ° Alice çš„ read ä¸­ç¹¼å™¨ (relay3, relay4)
  â†’ ç™¼é€åˆ°é‚£è£¡ï¼ŒAlice æ‰èƒ½æ”¶åˆ°`}</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">èˆ‡ kind 3 çš„å€åˆ¥</h2>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">ç‰¹æ€§</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">Kind 3ï¼ˆé—œæ³¨åˆ—è¡¨ï¼‰</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">Kind 10002ï¼ˆä¸­ç¹¼å™¨åˆ—è¡¨ï¼‰</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">ä¸»è¦ç”¨é€”</td>
          <td class="py-3 px-4">å„²å­˜é—œæ³¨çš„ç”¨æˆ¶</td>
          <td class="py-3 px-4">å®£å‘Šä¸­ç¹¼å™¨åå¥½</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">ä¸­ç¹¼å™¨è³‡è¨Š</td>
          <td class="py-3 px-4">é™„å¸¶åœ¨ contentï¼ˆå·²éæ™‚ï¼‰</td>
          <td class="py-3 px-4">ä¸»è¦åŠŸèƒ½ï¼Œä½¿ç”¨æ¨™ç±¤</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">è®€/å¯«å€åˆ†</td>
          <td class="py-3 px-4">ä¸æ”¯æ´</td>
          <td class="py-3 px-4">æ”¯æ´</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">æ¨è–¦ä½¿ç”¨</td>
          <td class="py-3 px-4">åªç”¨æ–¼é—œæ³¨åˆ—è¡¨</td>
          <td class="py-3 px-4">ç”¨æ–¼ä¸­ç¹¼å™¨è¨­å®š</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">æœ€ä½³å¯¦è¸</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">æ¨è–¦åšæ³•</h4>
      <ul class="space-y-1 text-sm text-[var(--text-secondary)]">
        <li>â€¢ ä¿æŒ 3-5 å€‹ä¸­ç¹¼å™¨</li>
        <li>â€¢ è‡³å°‘æœ‰ä¸€å€‹è®€+å¯«ä¸­ç¹¼å™¨</li>
        <li>â€¢ ä½¿ç”¨ç©©å®šå¯é çš„ä¸­ç¹¼å™¨</li>
        <li>â€¢ å®šæœŸæ›´æ–°åˆ—è¡¨</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-yellow-500/30 bg-yellow-500/10">
      <h4 class="font-semibold text-yellow-700 dark:text-yellow-400 mb-2">æ³¨æ„äº‹é …</h4>
      <ul class="space-y-1 text-sm text-[var(--text-secondary)]">
        <li>â€¢ ä¸è¦åˆ—å‡ºå¤ªå¤šä¸­ç¹¼å™¨</li>
        <li>â€¢ ç¢ºä¿ä¸­ç¹¼å™¨å¯è¨ªå•</li>
        <li>â€¢ è€ƒæ…®åœ°ç†ä½ç½®åˆ†æ•£</li>
        <li>â€¢ æ¸¬è©¦ read/write è¨­å®š</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">æŸ¥è©¢ç¤ºä¾‹</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`// æŸ¥è©¢å–®å€‹ç”¨æˆ¶çš„ä¸­ç¹¼å™¨åˆ—è¡¨
["REQ", "relay-list", {
  "kinds": [10002],
  "authors": ["<pubkey>"],
  "limit": 1
}]

// æ‰¹é‡æŸ¥è©¢å¤šå€‹ç”¨æˆ¶çš„ä¸­ç¹¼å™¨åˆ—è¡¨
["REQ", "relay-lists", {
  "kinds": [10002],
  "authors": ["<pubkey1>", "<pubkey2>", "<pubkey3>"]
}]

// æ³¨æ„ï¼škind 10002 æ˜¯å¯æ›¿æ›äº‹ä»¶
// åªéœ€è¦æœ€æ–°çš„ä¸€å€‹ç‰ˆæœ¬`}</code></pre>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>å®¢æˆ¶ç«¯å»ºè­°ï¼š</strong>
      å¯¦ä½œ NIP-65 å¯ä»¥å¤§å¹…æå‡è¨Šæ¯é€é”ç‡ã€‚ç•¶ç”¨æˆ¶é—œæ³¨æŸäººæ™‚ï¼Œ
      æŸ¥è©¢ä»–å€‘çš„ä¸­ç¹¼å™¨åˆ—è¡¨ï¼Œä¸¦å„ªå…ˆé€£æ¥åˆ°é€™äº›ä¸­ç¹¼å™¨ã€‚
    </p>
  </div>
</ArticleLayout>
