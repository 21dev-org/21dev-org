---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-45: Counting Results"
  description="ä½¿ç”¨ COUNT è«‹æ±‚é«˜æ•ˆç²å–äº‹ä»¶æ•¸é‡çµ±è¨ˆ"
  pubDate={new Date()}
>
  <h2 id="overview">æ¦‚è¿°</h2>
  <p>
    NIP-45 å®šç¾©äº† <code>COUNT</code> è«‹æ±‚é¡å‹ï¼Œå…è¨±å®¢æˆ¶ç«¯å‘ä¸­ç¹¼å™¨æŸ¥è©¢ç¬¦åˆæ¢ä»¶çš„äº‹ä»¶æ•¸é‡ï¼Œ
    è€Œç„¡éœ€ä¸‹è¼‰æ‰€æœ‰äº‹ä»¶ã€‚é€™å°æ–¼é¡¯ç¤ºè¿½è¹¤è€…æ•¸é‡ã€æŒ‰è®šæ•¸ã€å›è¦†æ•¸ç­‰çµ±è¨ˆè³‡è¨Šéå¸¸æœ‰ç”¨ã€‚
  </p>

  <h2 id="count-request">COUNT è«‹æ±‚</h2>
  <p>
    COUNT è«‹æ±‚çš„æ ¼å¼èˆ‡ REQ é¡ä¼¼ï¼Œä½†ä½¿ç”¨ <code>COUNT</code> å‹•è©ï¼š
  </p>

  <pre><code class="language-json">["COUNT", "&lt;subscription_id&gt;", &lt;filter&gt;, ...]</code></pre>

  <h3>éæ¿¾å™¨</h3>
  <p>
    éæ¿¾å™¨æ ¼å¼èˆ‡ NIP-01 çš„ REQ è«‹æ±‚ç›¸åŒï¼š
  </p>

  <pre><code class="language-json">{
  "kinds": [1],
  "authors": ["pubkey1", "pubkey2"],
  "#e": ["event_id"],
  "#p": ["pubkey"],
  "since": 1700000000,
  "until": 1700100000
}</code></pre>

  <h2 id="count-response">COUNT å›æ‡‰</h2>
  <p>
    ä¸­ç¹¼å™¨å›æ‡‰åŒ…å«è¨ˆæ•¸çµæœï¼š
  </p>

  <pre><code class="language-json">["COUNT", "&lt;subscription_id&gt;", {"count": 238}]</code></pre>

  <h3>å¯é¸çš„è¿‘ä¼¼å€¼æ¨™è¨˜</h3>
  <p>
    ç•¶è¨ˆæ•¸å¯èƒ½ä¸ç²¾ç¢ºæ™‚ï¼Œä¸­ç¹¼å™¨å¯ä»¥æ¨™è¨˜ç‚ºè¿‘ä¼¼å€¼ï¼š
  </p>

  <pre><code class="language-json">["COUNT", "&lt;subscription_id&gt;", {"count": 238, "approximate": true}]</code></pre>

  <h2 id="examples">ä½¿ç”¨ç¯„ä¾‹</h2>

  <h3>çµ±è¨ˆè¿½è¹¤è€…æ•¸é‡</h3>
  <pre><code class="language-json">// è«‹æ±‚
["COUNT", "followers", {"kinds": [3], "#p": ["ç›®æ¨™ç”¨æˆ¶å…¬é‘°"]}]

// å›æ‡‰
["COUNT", "followers", {"count": 1523}]</code></pre>

  <h3>çµ±è¨ˆè²¼æ–‡æŒ‰è®šæ•¸</h3>
  <pre><code class="language-json">// è«‹æ±‚
["COUNT", "likes", {"kinds": [7], "#e": ["è²¼æ–‡äº‹ä»¶ID"]}]

// å›æ‡‰
["COUNT", "likes", {"count": 42}]</code></pre>

  <h3>çµ±è¨ˆå›è¦†æ•¸</h3>
  <pre><code class="language-json">// è«‹æ±‚
["COUNT", "replies", {"kinds": [1], "#e": ["åŸå§‹è²¼æ–‡ID"]}]

// å›æ‡‰
["COUNT", "replies", {"count": 15}]</code></pre>

  <h3>çµ±è¨ˆç”¨æˆ¶è²¼æ–‡æ•¸</h3>
  <pre><code class="language-json">// è«‹æ±‚
["COUNT", "posts", {"kinds": [1], "authors": ["ç”¨æˆ¶å…¬é‘°"]}]

// å›æ‡‰
["COUNT", "posts", {"count": 892}]</code></pre>

  <h2 id="implementation">TypeScript å¯¦ä½œ</h2>

  <h3>åŸºç¤è¨ˆæ•¸å‡½æ•¸</h3>
  <pre><code class="language-typescript">interface CountResult {
  count: number;
  approximate?: boolean;
}

async function countEvents(
  relay: WebSocket,
  filter: object
): Promise&lt;CountResult&gt; {
  return new Promise((resolve, reject) => {
    const subId = Math.random().toString(36).substring(7);
    const timeout = setTimeout(() => {
      reject(new Error('Count request timeout'));
    }, 10000);

    const handler = (event: MessageEvent) => {
      const data = JSON.parse(event.data);

      if (data[0] === 'COUNT' && data[1] === subId) {
        clearTimeout(timeout);
        relay.removeEventListener('message', handler);
        resolve(data[2]);
      }
    };

    relay.addEventListener('message', handler);
    relay.send(JSON.stringify(['COUNT', subId, filter]));
  });
}

// ä½¿ç”¨ç¯„ä¾‹
const result = await countEvents(relay, {
  kinds: [7],
  '#e': ['event_id'],
});
console.log(`æŒ‰è®šæ•¸: ${result.count}`);</code></pre>

  <h3>å¤šä¸­ç¹¼å™¨è¨ˆæ•¸</h3>
  <pre><code class="language-typescript">interface MultiRelayCountResult {
  total: number;
  byRelay: Map&lt;string, number&gt;;
  hasApproximate: boolean;
}

async function countFromMultipleRelays(
  relayUrls: string[],
  filter: object
): Promise&lt;MultiRelayCountResult&gt; {
  const results = await Promise.allSettled(
    relayUrls.map(async (url) => {
      const ws = new WebSocket(url);
      await new Promise((resolve) => (ws.onopen = resolve));

      try {
        const result = await countEvents(ws, filter);
        return { url, ...result };
      } finally {
        ws.close();
      }
    })
  );

  const byRelay = new Map&lt;string, number&gt;();
  let hasApproximate = false;
  let maxCount = 0;

  for (const result of results) {
    if (result.status === 'fulfilled') {
      byRelay.set(result.value.url, result.value.count);
      maxCount = Math.max(maxCount, result.value.count);
      if (result.value.approximate) {
        hasApproximate = true;
      }
    }
  }

  return {
    total: maxCount, // å–æœ€å¤§å€¼ä½œç‚ºç¸½æ•¸
    byRelay,
    hasApproximate,
  };
}</code></pre>

  <h3>ç¤¾äº¤çµ±è¨ˆé¡åˆ¥</h3>
  <pre><code class="language-typescript">class NostrStats {
  private relays: string[];

  constructor(relays: string[]) {
    this.relays = relays;
  }

  // ç²å–è¿½è¹¤è€…æ•¸é‡
  async getFollowerCount(pubkey: string): Promise&lt;number&gt; {
    const result = await countFromMultipleRelays(this.relays, {
      kinds: [3],
      '#p': [pubkey],
    });
    return result.total;
  }

  // ç²å–é—œæ³¨æ•¸é‡
  async getFollowingCount(pubkey: string): Promise&lt;number&gt; {
    // éœ€è¦ç²å– kind 3 äº‹ä»¶ä¸¦è¨ˆç®— p æ¨™ç±¤æ•¸é‡
    // COUNT ç„¡æ³•ç›´æ¥è¨ˆç®—é€™å€‹
    return 0;
  }

  // ç²å–è²¼æ–‡æŒ‰è®šæ•¸
  async getReactionCount(eventId: string): Promise&lt;number&gt; {
    const result = await countFromMultipleRelays(this.relays, {
      kinds: [7],
      '#e': [eventId],
    });
    return result.total;
  }

  // ç²å–è²¼æ–‡å›è¦†æ•¸
  async getReplyCount(eventId: string): Promise&lt;number&gt; {
    const result = await countFromMultipleRelays(this.relays, {
      kinds: [1],
      '#e': [eventId],
    });
    return result.total;
  }

  // ç²å–è²¼æ–‡è½‰ç™¼æ•¸
  async getRepostCount(eventId: string): Promise&lt;number&gt; {
    const result = await countFromMultipleRelays(this.relays, {
      kinds: [6],
      '#e': [eventId],
    });
    return result.total;
  }

  // ç²å–è²¼æ–‡ Zap æ•¸é‡
  async getZapCount(eventId: string): Promise&lt;number&gt; {
    const result = await countFromMultipleRelays(this.relays, {
      kinds: [9735],
      '#e': [eventId],
    });
    return result.total;
  }

  // ç²å–ç”¨æˆ¶è²¼æ–‡æ•¸é‡
  async getPostCount(pubkey: string): Promise&lt;number&gt; {
    const result = await countFromMultipleRelays(this.relays, {
      kinds: [1],
      authors: [pubkey],
    });
    return result.total;
  }
}

// ä½¿ç”¨ç¯„ä¾‹
const stats = new NostrStats([
  'wss://relay.damus.io',
  'wss://relay.nostr.band',
  'wss://nos.lol',
]);

const pubkey = 'ç”¨æˆ¶å…¬é‘°';
const followers = await stats.getFollowerCount(pubkey);
const posts = await stats.getPostCount(pubkey);

console.log(`è¿½è¹¤è€…: ${followers}, è²¼æ–‡: ${posts}`);</code></pre>

  <h3>React Hook</h3>
  <pre><code class="language-typescript">import { useState, useEffect } from 'react';

interface EventStats {
  reactions: number;
  replies: number;
  reposts: number;
  zaps: number;
  loading: boolean;
}

function useEventStats(eventId: string, relays: string[]): EventStats {
  const [stats, setStats] = useState&lt;EventStats&gt;({
    reactions: 0,
    replies: 0,
    reposts: 0,
    zaps: 0,
    loading: true,
  });

  useEffect(() => {
    const nostrStats = new NostrStats(relays);

    Promise.all([
      nostrStats.getReactionCount(eventId),
      nostrStats.getReplyCount(eventId),
      nostrStats.getRepostCount(eventId),
      nostrStats.getZapCount(eventId),
    ]).then(([reactions, replies, reposts, zaps]) => {
      setStats({
        reactions,
        replies,
        reposts,
        zaps,
        loading: false,
      });
    });
  }, [eventId, relays]);

  return stats;
}

// ä½¿ç”¨ç¯„ä¾‹
function PostStats({ eventId }: { eventId: string }) {
  const stats = useEventStats(eventId, RELAYS);

  if (stats.loading) {
    return &lt;div&gt;è¼‰å…¥ä¸­...&lt;/div&gt;;
  }

  return (
    &lt;div className="stats"&gt;
      &lt;span&gt;â¤ï¸ {stats.reactions}&lt;/span&gt;
      &lt;span&gt;ğŸ’¬ {stats.replies}&lt;/span&gt;
      &lt;span&gt;ğŸ” {stats.reposts}&lt;/span&gt;
      &lt;span&gt;âš¡ {stats.zaps}&lt;/span&gt;
    &lt;/div&gt;
  );
}</code></pre>

  <h2 id="relay-support">ä¸­ç¹¼å™¨æ”¯æ´æª¢æ¸¬</h2>
  <pre><code class="language-typescript">async function supportsCount(relayUrl: string): Promise&lt;boolean&gt; {
  try {
    const response = await fetch(
      relayUrl.replace('wss://', 'https://').replace('ws://', 'http://'),
      { headers: { Accept: 'application/nostr+json' } }
    );
    const info = await response.json();
    return info.supported_nips?.includes(45) ?? false;
  } catch {
    return false;
  }
}

// éæ¿¾æ”¯æ´ COUNT çš„ä¸­ç¹¼å™¨
async function getCountSupportedRelays(relays: string[]): Promise&lt;string[]&gt; {
  const results = await Promise.all(
    relays.map(async (relay) => ({
      relay,
      supported: await supportsCount(relay),
    }))
  );
  return results.filter((r) => r.supported).map((r) => r.relay);
}</code></pre>

  <h2 id="limitations">é™åˆ¶èˆ‡æ³¨æ„äº‹é …</h2>
  <ul>
    <li><strong>ä¸­ç¹¼å™¨æ”¯æ´</strong>ï¼šä¸¦éæ‰€æœ‰ä¸­ç¹¼å™¨éƒ½æ”¯æ´ COUNT</li>
    <li><strong>æº–ç¢ºæ€§</strong>ï¼šä¸åŒä¸­ç¹¼å™¨å¯èƒ½è¿”å›ä¸åŒæ•¸å€¼</li>
    <li><strong>è¿‘ä¼¼å€¼</strong>ï¼šå¤§é‡è³‡æ–™æ™‚å¯èƒ½è¿”å›è¿‘ä¼¼å€¼</li>
    <li><strong>æ•ˆèƒ½é™åˆ¶</strong>ï¼šæŸäº›ä¸­ç¹¼å™¨å¯èƒ½é™åˆ¶ COUNT è«‹æ±‚é »ç‡</li>
    <li><strong>ç„¡æ³•èšåˆ</strong>ï¼šç„¡æ³•ç›´æ¥é€²è¡Œ SUMã€AVG ç­‰èšåˆé‹ç®—</li>
  </ul>

  <h2 id="best-practices">æœ€ä½³å¯¦è¸</h2>
  <ul>
    <li><strong>å¿«å–çµæœ</strong>ï¼šçµ±è¨ˆæ•¸æ“šè®ŠåŒ–ä¸é »ç¹ï¼Œå¯ä»¥å¿«å–</li>
    <li><strong>é™ç´šè™•ç†</strong>ï¼šä¸æ”¯æ´æ™‚æ”¹ç”¨ REQ è¨ˆæ•¸</li>
    <li><strong>å¤šä¸­ç¹¼å™¨æŸ¥è©¢</strong>ï¼šå–æœ€å¤§å€¼ç²å¾—æ›´æº–ç¢ºçš„çµ±è¨ˆ</li>
    <li><strong>é¡¯ç¤ºè¿‘ä¼¼</strong>ï¼šç•¶ approximate ç‚º true æ™‚é¡¯ç¤º â‰ˆ ç¬¦è™Ÿ</li>
  </ul>

  <h2 id="related-nips">ç›¸é—œ NIPs</h2>
  <ul>
    <li><a href="/tech/nostr/nip-01">NIP-01</a>ï¼šåŸºæœ¬å”è­° - REQ è«‹æ±‚</li>
    <li><a href="/tech/nostr/nip-11">NIP-11</a>ï¼šä¸­ç¹¼å™¨è³‡è¨Š - åŠŸèƒ½ç™¼ç¾</li>
    <li><a href="/tech/nostr/nip-25">NIP-25</a>ï¼šåæ‡‰ - æŒ‰è®šäº‹ä»¶</li>
    <li><a href="/tech/nostr/nip-57">NIP-57</a>ï¼šZaps - æ‰“è³äº‹ä»¶</li>
  </ul>

  <h2 id="references">åƒè€ƒè³‡æº</h2>
  <ul>
    <li><a href="https://github.com/nostr-protocol/nips/blob/master/45.md" target="_blank" rel="noopener noreferrer">NIP-45 è¦ç¯„</a></li>
    <li><a href="https://github.com/nbd-wtf/nostr-tools" target="_blank" rel="noopener noreferrer">nostr-tools</a></li>
  </ul>
</ArticleLayout>
