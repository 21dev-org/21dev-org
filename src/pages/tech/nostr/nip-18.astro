---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-18 è½‰ç™¼"
  description="Nostr è½‰ç™¼æ©Ÿåˆ¶ï¼Œç”¨æ–¼åˆ†äº«å’Œæ”¾å¤§å…¶ä»–ç”¨æˆ¶çš„å…§å®¹ã€‚"
  breadcrumbs={[
    { label: 'æŠ€è¡“', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-18 è½‰ç™¼' },
  ]}
  difficulty="beginner"
  readingTime="6 åˆ†é˜"
  prevPage={{
    href: '/tech/nostr/nip-13/',
    title: 'NIP-13 å·¥ä½œé‡è­‰æ˜',
  }}
  nextPage={{
    href: '/tech/nostr/nip-19/',
    title: 'NIP-19 bech32 ç·¨ç¢¼',
  }}
>
  <h2 id="overview">æ¦‚è¿°</h2>
  <p>
    NIP-18 å®šç¾©äº† Nostr çš„è½‰ç™¼ï¼ˆRepostï¼‰æ©Ÿåˆ¶ï¼Œé¡ä¼¼æ–¼ Twitter çš„è½‰æ¨åŠŸèƒ½ã€‚
    è½‰ç™¼è®“ç”¨æˆ¶å¯ä»¥åˆ†äº«å…¶ä»–äººçš„å…§å®¹çµ¦è‡ªå·±çš„è¿½è¹¤è€…ï¼Œå¹«åŠ©å„ªè³ªå…§å®¹ç²å¾—æ›´å»£æ³›çš„å‚³æ’­ã€‚
  </p>

  <h2 id="event-kinds">äº‹ä»¶é¡å‹</h2>
  <p>NIP-18 å®šç¾©äº†å…©ç¨®è½‰ç™¼äº‹ä»¶ï¼š</p>

  <div class="overflow-x-auto my-6">
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-[var(--bg-secondary)]">
          <th class="border border-[var(--border-default)] p-3 text-left">Kind</th>
          <th class="border border-[var(--border-default)] p-3 text-left">åç¨±</th>
          <th class="border border-[var(--border-default)] p-3 text-left">ç”¨é€”</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="border border-[var(--border-default)] p-3 font-mono">6</td>
          <td class="border border-[var(--border-default)] p-3">Repost</td>
          <td class="border border-[var(--border-default)] p-3">è½‰ç™¼ kind 1 çŸ­æ–‡ï¼ˆç­†è¨˜ï¼‰</td>
        </tr>
        <tr>
          <td class="border border-[var(--border-default)] p-3 font-mono">16</td>
          <td class="border border-[var(--border-default)] p-3">Generic Repost</td>
          <td class="border border-[var(--border-default)] p-3">è½‰ç™¼ä»»æ„é¡å‹çš„äº‹ä»¶</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 id="repost-structure">è½‰ç™¼çµæ§‹ (Kind 6)</h2>
  <p>Kind 6 ç”¨æ–¼è½‰ç™¼ kind 1 çš„çŸ­æ–‡ç­†è¨˜ï¼š</p>

  <pre><code class="language-json" is:raw>{`{
  "kind": 6,
  "tags": [
    ["e", "<åŸå§‹äº‹ä»¶ ID>", "<ä¸­ç¹¼å™¨ URL>"],
    ["p", "<åŸå§‹ä½œè€…å…¬é‘°>"]
  ],
  "content": "",
  "pubkey": "<è½‰ç™¼è€…å…¬é‘°>",
  ...
}`}</code></pre>

  <h3>åŒ…å«åŸå§‹äº‹ä»¶</h3>
  <p>
    ç‚ºäº†è®“å®¢æˆ¶ç«¯å¯ä»¥ç«‹å³é¡¯ç¤ºå…§å®¹è€Œä¸éœ€é¡å¤–æŸ¥è©¢ï¼Œå¯ä»¥åœ¨ <code>content</code>
    ä¸­åŒ…å«åŸå§‹äº‹ä»¶çš„ JSON å­—ä¸²ï¼š
  </p>

  <pre><code class="language-json" is:raw>{`{
  "kind": 6,
  "tags": [
    ["e", "abc123...", "wss://relay.damus.io"],
    ["p", "def456..."]
  ],
  "content": "{\"id\":\"abc123...\",\"pubkey\":\"def456...\",\"kind\":1,\"content\":\"åŸå§‹å…§å®¹\",\"tags\":[],\"created_at\":1234567890,\"sig\":\"...\"}",
  ...
}`}</code></pre>

  <h2 id="generic-repost">é€šç”¨è½‰ç™¼ (Kind 16)</h2>
  <p>
    Kind 16 å¯ä»¥è½‰ç™¼ä»»æ„é¡å‹çš„äº‹ä»¶ï¼Œéœ€è¦é¡å¤–çš„ <code>k</code> æ¨™ç±¤æŒ‡å®šåŸå§‹äº‹ä»¶é¡å‹ï¼š
  </p>

  <pre><code class="language-json" is:raw>{`{
  "kind": 16,
  "tags": [
    ["e", "<åŸå§‹äº‹ä»¶ ID>", "<ä¸­ç¹¼å™¨ URL>"],
    ["p", "<åŸå§‹ä½œè€…å…¬é‘°>"],
    ["k", "<åŸå§‹äº‹ä»¶ kind>"]
  ],
  "content": "",
  ...
}`}</code></pre>

  <h3>è½‰ç™¼é•·æ–‡ç¯„ä¾‹</h3>
  <pre><code class="language-json" is:raw>{`{
  "kind": 16,
  "tags": [
    ["e", "article123...", "wss://relay.example.com"],
    ["p", "author456..."],
    ["k", "30023"]
  ],
  "content": "",
  ...
}`}</code></pre>

  <h2 id="implementation">å¯¦ä½œ</h2>

  <h3>å»ºç«‹è½‰ç™¼</h3>
  <pre><code class="language-typescript" is:raw>{`import { finalizeEvent, getPublicKey } from 'nostr-tools';

interface Event {
  id: string;
  pubkey: string;
  kind: number;
  content: string;
  tags: string[][];
  created_at: number;
  sig: string;
}

// è½‰ç™¼ kind 1 ç­†è¨˜
function createRepost(
  privateKey: Uint8Array,
  originalEvent: Event,
  relay: string,
  includeContent: boolean = true
) {
  const tags: string[][] = [
    ['e', originalEvent.id, relay],
    ['p', originalEvent.pubkey],
  ];

  const event = {
    kind: 6,
    created_at: Math.floor(Date.now() / 1000),
    tags,
    content: includeContent ? JSON.stringify(originalEvent) : '',
  };

  return finalizeEvent(event, privateKey);
}

// é€šç”¨è½‰ç™¼ï¼ˆä»»æ„ kindï¼‰
function createGenericRepost(
  privateKey: Uint8Array,
  originalEvent: Event,
  relay: string,
  includeContent: boolean = true
) {
  const tags: string[][] = [
    ['e', originalEvent.id, relay],
    ['p', originalEvent.pubkey],
    ['k', originalEvent.kind.toString()],
  ];

  const event = {
    kind: 16,
    created_at: Math.floor(Date.now() / 1000),
    tags,
    content: includeContent ? JSON.stringify(originalEvent) : '',
  };

  return finalizeEvent(event, privateKey);
}

// ä½¿ç”¨ç¯„ä¾‹
const repost = createRepost(privateKey, originalNote, 'wss://relay.damus.io');
const articleRepost = createGenericRepost(privateKey, articleEvent, 'wss://nos.lol');`}</code></pre>

  <h3>è§£æè½‰ç™¼</h3>
  <pre><code class="language-typescript" is:raw>{`// è§£æè½‰ç™¼äº‹ä»¶
function parseRepost(repostEvent: Event): {
  originalEventId: string;
  originalAuthor: string;
  originalKind: number;
  embeddedEvent: Event | null;
  relay: string | null;
} {
  const eTag = repostEvent.tags.find(t => t[0] === 'e');
  const pTag = repostEvent.tags.find(t => t[0] === 'p');
  const kTag = repostEvent.tags.find(t => t[0] === 'k');

  // å˜—è©¦è§£æåµŒå…¥çš„åŸå§‹äº‹ä»¶
  let embeddedEvent: Event | null = null;
  if (repostEvent.content) {
    try {
      embeddedEvent = JSON.parse(repostEvent.content);
    } catch {
      // content ä¸æ˜¯æœ‰æ•ˆçš„ JSON
    }
  }

  // åˆ¤æ–·åŸå§‹äº‹ä»¶é¡å‹
  let originalKind = 1; // é è¨­ kind 6 è½‰ç™¼çš„æ˜¯ kind 1
  if (repostEvent.kind === 16 && kTag) {
    originalKind = parseInt(kTag[1], 10);
  } else if (embeddedEvent) {
    originalKind = embeddedEvent.kind;
  }

  return {
    originalEventId: eTag?.[1] || '',
    originalAuthor: pTag?.[1] || '',
    originalKind,
    embeddedEvent,
    relay: eTag?.[2] || null,
  };
}`}</code></pre>

  <h3>æŸ¥è©¢è½‰ç™¼</h3>
  <pre><code class="language-typescript" is:raw>{`import { SimplePool } from 'nostr-tools';

const pool = new SimplePool();
const relays = ['wss://relay.damus.io', 'wss://nos.lol'];

// æŸ¥è©¢ç”¨æˆ¶çš„æ‰€æœ‰è½‰ç™¼
async function getUserReposts(pubkey: string) {
  return await pool.querySync(relays, {
    kinds: [6, 16],
    authors: [pubkey],
    limit: 50,
  });
}

// æŸ¥è©¢ç‰¹å®šäº‹ä»¶çš„è½‰ç™¼æ•¸é‡
async function getRepostCount(eventId: string): Promise<number> {
  const reposts = await pool.querySync(relays, {
    kinds: [6, 16],
    '#e': [eventId],
  });

  return reposts.length;
}

// æŸ¥è©¢ç‰¹å®šäº‹ä»¶çš„æ‰€æœ‰è½‰ç™¼è€…
async function getReposters(eventId: string): Promise<string[]> {
  const reposts = await pool.querySync(relays, {
    kinds: [6, 16],
    '#e': [eventId],
  });

  return [...new Set(reposts.map(r => r.pubkey))];
}

// æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²è½‰ç™¼
async function hasUserReposted(
  userPubkey: string,
  eventId: string
): Promise<boolean> {
  const reposts = await pool.querySync(relays, {
    kinds: [6, 16],
    authors: [userPubkey],
    '#e': [eventId],
    limit: 1,
  });

  return reposts.length > 0;
}`}</code></pre>

  <h2 id="fetching-original">å–å¾—åŸå§‹äº‹ä»¶</h2>
  <pre><code class="language-typescript" is:raw>{`// å–å¾—è½‰ç™¼çš„åŸå§‹äº‹ä»¶
async function getOriginalEvent(repostEvent: Event): Promise<Event | null> {
  const parsed = parseRepost(repostEvent);

  // å„ªå…ˆä½¿ç”¨åµŒå…¥çš„äº‹ä»¶
  if (parsed.embeddedEvent) {
    // é©—è­‰åµŒå…¥äº‹ä»¶çš„ ID æ˜¯å¦æ­£ç¢º
    if (parsed.embeddedEvent.id === parsed.originalEventId) {
      return parsed.embeddedEvent;
    }
  }

  // å¾ä¸­ç¹¼å™¨æŸ¥è©¢
  const searchRelays = parsed.relay
    ? [parsed.relay, ...relays]
    : relays;

  const events = await pool.querySync(searchRelays, {
    ids: [parsed.originalEventId],
    limit: 1,
  });

  return events[0] || null;
}`}</code></pre>

  <h2 id="display">é¡¯ç¤ºå»ºè­°</h2>
  <p>å®¢æˆ¶ç«¯é¡¯ç¤ºè½‰ç™¼æ™‚çš„å»ºè­°åšæ³•ï¼š</p>

  <ul>
    <li>é¡¯ç¤ºã€Œè½‰ç™¼ã€æ¨™è¨˜å’Œè½‰ç™¼è€…è³‡è¨Š</li>
    <li>é¡¯ç¤ºåŸå§‹å…§å®¹å’ŒåŸä½œè€…</li>
    <li>é»æ“Šå¯è·³è½‰åˆ°åŸå§‹äº‹ä»¶</li>
    <li>è½‰ç™¼æ™‚é–“å’ŒåŸå§‹ç™¼å¸ƒæ™‚é–“éƒ½æ‡‰é¡¯ç¤º</li>
  </ul>

  <pre><code class="language-typescript" is:raw>{`// React çµ„ä»¶ç¯„ä¾‹
function RepostNote({ repostEvent }: { repostEvent: Event }) {
  const [originalEvent, setOriginalEvent] = useState<Event | null>(null);
  const [reposter, setReposter] = useState<Profile | null>(null);

  useEffect(() => {
    // è¼‰å…¥è½‰ç™¼è€…è³‡è¨Š
    loadProfile(repostEvent.pubkey).then(setReposter);

    // è¼‰å…¥åŸå§‹äº‹ä»¶
    getOriginalEvent(repostEvent).then(setOriginalEvent);
  }, [repostEvent]);

  if (!originalEvent) {
    return <div>è¼‰å…¥ä¸­...</div>;
  }

  return (
    <div className="repost">
      <div className="repost-header">
        ğŸ” {reposter?.name || shortenPubkey(repostEvent.pubkey)} è½‰ç™¼äº†
        <span className="time">
          {formatTime(repostEvent.created_at)}
        </span>
      </div>
      <Note event={originalEvent} />
    </div>
  );
}`}</code></pre>

  <h2 id="quote-repost">å¼•ç”¨è½‰ç™¼</h2>
  <p>NIP-18 å°ˆæ³¨æ–¼ç´”è½‰ç™¼ã€‚å¦‚æœè¦æ·»åŠ è©•è«–ï¼ˆå¼•ç”¨è½‰ç™¼ï¼‰ï¼Œæ‡‰ä½¿ç”¨ kind 1 ç­†è¨˜ ä¸¦å¼•ç”¨åŸå§‹äº‹ä»¶ï¼š</p>

  <pre><code class="language-typescript" is:raw>{`// å¼•ç”¨è½‰ç™¼ï¼ˆå¸¶è©•è«–ï¼‰
function createQuoteRepost(
  privateKey: Uint8Array,
  originalEvent: Event,
  comment: string,
  relay: string
) {
  // ä½¿ç”¨ NIP-19 çš„ nevent æ ¼å¼å¼•ç”¨
  const nevent = nip19.neventEncode({
    id: originalEvent.id,
    relays: [relay],
    author: originalEvent.pubkey,
  });

  const event = {
    kind: 1,
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['e', originalEvent.id, relay, 'mention'],
      ['p', originalEvent.pubkey],
      ['q', originalEvent.id],  // å¼•ç”¨æ¨™ç±¤
    ],
    content: \`\${comment}\\n\\nnostr:\${nevent}\`,
  };

  return finalizeEvent(event, privateKey);
}`}</code></pre>

  <h2 id="considerations">æ³¨æ„äº‹é …</h2>
  <ul>
    <li><strong>é©—è­‰åµŒå…¥å…§å®¹</strong>ï¼šå¦‚æœä½¿ç”¨åµŒå…¥çš„äº‹ä»¶ï¼Œæ‡‰é©—è­‰å…¶ç°½å</li>
    <li>
      <strong>ä¸­ç¹¼å™¨æç¤º</strong>ï¼š<code>e</code> æ¨™ç±¤çš„ç¬¬ä¸‰å€‹å€¼æ˜¯ä¸­ç¹¼å™¨æç¤ºï¼Œå¹«åŠ©æŸ¥è©¢åŸå§‹äº‹ä»¶
    </li>
    <li><strong>å–æ¶ˆè½‰ç™¼</strong>ï¼šä½¿ç”¨ NIP-09 åˆªé™¤è½‰ç™¼äº‹ä»¶</li>
    <li><strong>é‡è¤‡è½‰ç™¼</strong>ï¼šå®¢æˆ¶ç«¯æ‡‰é˜²æ­¢ç”¨æˆ¶é‡è¤‡è½‰ç™¼åŒä¸€äº‹ä»¶</li>
  </ul>

  <h2 id="related">ç›¸é—œ NIP</h2>
  <ul>
    <li><a href="/tech/nostr/nip-01/">NIP-01</a> - åŸºæœ¬å”è­°èˆ‡äº‹ä»¶çµæ§‹</li>
    <li><a href="/tech/nostr/nip-09/">NIP-09</a> - äº‹ä»¶åˆªé™¤ï¼ˆå–æ¶ˆè½‰ç™¼ï¼‰</li>
    <li><a href="/tech/nostr/nip-10/">NIP-10</a> - å›è¦†èˆ‡æ¨™è¨˜</li>
    <li><a href="/tech/nostr/nip-25/">NIP-25</a> - åæ‡‰ï¼ˆå¦ä¸€ç¨®äº’å‹•æ–¹å¼ï¼‰</li>
  </ul>

  <h2 id="resources">åƒè€ƒè³‡æº</h2>
  <ul>
    <li>
      <a
        href="https://github.com/nostr-protocol/nips/blob/master/18.md"
        target="_blank"
        rel="noopener">NIP-18 è¦ç¯„åŸæ–‡</a>
    </li>
    <li>
      <a href="https://github.com/nbd-wtf/nostr-tools" target="_blank" rel="noopener"
        >nostr-tools å‡½å¼åº«</a>
    </li>
  </ul>
</ArticleLayout>
