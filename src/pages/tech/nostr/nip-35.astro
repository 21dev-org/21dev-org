---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-35: Torrents"
  description="åœ¨ Nostr ä¸Šåˆ†äº«å’Œç™¼ç¾ BitTorrent ç¨®å­"
  breadcrumbs={[
    { label: 'æŠ€è¡“', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-35' },
  ]}
>
  <h2 id="overview">æ¦‚è¿°</h2>
  <p>
    NIP-35 å®šç¾©äº†åœ¨ Nostr ä¸Šåˆ†äº« BitTorrent ç¨®å­ï¼ˆTorrentsï¼‰çš„æ¨™æº–æ ¼å¼ã€‚
    ä½¿ç”¨è€…å¯ä»¥ç™¼å¸ƒç¨®å­è³‡è¨Šï¼Œå…¶ä»–äººå¯ä»¥æœå°‹ã€è¨‚é–±å’Œä¸‹è¼‰ï¼Œ å¯¦ç¾å»ä¸­å¿ƒåŒ–çš„ç¨®å­åˆ†äº«å’Œç™¼ç¾ã€‚
  </p>

  <h2 id="event-kind">äº‹ä»¶é¡å‹</h2>

  <table>
    <thead>
      <tr>
        <th>Kind</th>
        <th>èªªæ˜</th>
        <th>é¡å‹</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>2003</code></td>
        <td>ç¨®å­ (Torrent)</td>
        <td>ä¸€èˆ¬</td>
      </tr>
    </tbody>
  </table>

  <h2 id="event-structure">äº‹ä»¶çµæ§‹</h2>

  <h3>Content</h3>
  <p>
    äº‹ä»¶çš„ <code>content</code> æ¬„ä½åŒ…å«ç¨®å­çš„æè¿°æ–‡å­—ï¼Œå¯ä»¥ä½¿ç”¨ Markdown æ ¼å¼ã€‚
  </p>

  <h3>å¿…è¦æ¨™ç±¤</h3>
  <table>
    <thead>
      <tr>
        <th>æ¨™ç±¤</th>
        <th>èªªæ˜</th>
        <th>ç¯„ä¾‹</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>title</code></td>
        <td>ç¨®å­æ¨™é¡Œ</td>
        <td><code>["title", "Ubuntu 24.04 LTS"]</code></td>
      </tr>
      <tr>
        <td><code>x</code></td>
        <td>Info Hash (v1)</td>
        <td><code>["x", "abc123..."]</code></td>
      </tr>
    </tbody>
  </table>

  <h3>å¯é¸æ¨™ç±¤</h3>
  <table>
    <thead>
      <tr>
        <th>æ¨™ç±¤</th>
        <th>èªªæ˜</th>
        <th>ç¯„ä¾‹</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>file</code></td>
        <td>æª”æ¡ˆè³‡è¨Šï¼ˆåç¨±ã€å¤§å°ï¼‰</td>
        <td><code>["file", "ubuntu.iso", "4700000000"]</code></td>
      </tr>
      <tr>
        <td><code>tracker</code></td>
        <td>Tracker URL</td>
        <td><code>["tracker", "udp://tracker.example.com:6969"]</code></td>
      </tr>
      <tr>
        <td><code>i</code></td>
        <td>Info Hash (v2)</td>
        <td><code>["i", "btih:abc123..."]</code></td>
      </tr>
      <tr>
        <td><code>t</code></td>
        <td>ä¸»é¡Œæ¨™ç±¤</td>
        <td><code>["t", "linux"]</code></td>
      </tr>
      <tr>
        <td><code>image</code></td>
        <td>é è¦½åœ–ç‰‡</td>
        <td><code>["image", "https://..."]</code></td>
      </tr>
    </tbody>
  </table>

  <h2 id="magnet-link">Magnet é€£çµ</h2>

  <p>å¯ä»¥å¾äº‹ä»¶çš„æ¨™ç±¤ä¸­çµ„åˆæˆ Magnet URIï¼š</p>

  <pre><code class="language-text" is:raw>magnet:?xt=urn:btih:&lt;info-hash&gt;&amp;dn=&lt;title&gt;&amp;tr=&lt;tracker&gt;</code></pre>

  <h2 id="examples">ç¯„ä¾‹</h2>

  <h3>é–‹æºè»Ÿé«”ç¨®å­</h3>
  <pre><code class="language-json" is:raw>{
  "kind": 2003,
  "content": "Ubuntu 24.04 LTS (Noble Numbat) å®˜æ–¹ ISO æ˜ åƒæª”ã€‚\n\n## ç‰¹é»\n- é•·æœŸæ”¯æ´ç‰ˆæœ¬ï¼ˆ5å¹´æ”¯æ´ï¼‰\n- GNOME 46 æ¡Œé¢ç’°å¢ƒ\n- Linux å…§æ ¸ 6.8\n\nè«‹å¾å®˜æ–¹ä¾†æºé©—è­‰ SHA256 æ ¡é©—ç¢¼ã€‚",
  "tags": [
    ["title", "Ubuntu 24.04 LTS Desktop (64-bit)"],
    ["x", "abc123def456789..."],
    ["file", "ubuntu-24.04-desktop-amd64.iso", "5748072448"],
    ["tracker", "udp://tracker.ubuntu.com:6969"],
    ["tracker", "udp://tracker.opentrackr.org:1337"],
    ["t", "linux"],
    ["t", "ubuntu"],
    ["t", "é–‹æº"],
    ["t", "ä½œæ¥­ç³»çµ±"],
    ["image", "https://ubuntu.com/wp-content/uploads/ubuntu-logo.png"]
  ]
}</code></pre>

  <h3>å¤šæª”æ¡ˆç¨®å­</h3>
  <pre><code class="language-json" is:raw>{
  "kind": 2003,
  "content": "Bitcoin æ ¸å¿ƒå®¢æˆ¶ç«¯ v27.0 æ‰€æœ‰å¹³å°ç‰ˆæœ¬ã€‚\n\nåŒ…å« Windowsã€macOSã€Linux ç‰ˆæœ¬åŠç°½åæª”ã€‚",
  "tags": [
    ["title", "Bitcoin Core v27.0"],
    ["x", "xyz789..."],
    ["file", "bitcoin-27.0-win64.zip", "45000000"],
    ["file", "bitcoin-27.0-x86_64-linux-gnu.tar.gz", "42000000"],
    ["file", "bitcoin-27.0-osx64.tar.gz", "38000000"],
    ["file", "SHA256SUMS.asc", "5000"],
    ["tracker", "udp://tracker.opentrackr.org:1337"],
    ["t", "bitcoin"],
    ["t", "è»Ÿé«”"],
    ["t", "å€å¡Šéˆ"]
  ]
}</code></pre>

  <h2 id="implementation">TypeScript å¯¦ä½œ</h2>

  <h3>å®šç¾©é¡å‹</h3>
  <pre><code class="language-typescript" is:raw>interface TorrentFile {
  name: string;
  size: number;
}

interface Torrent {
  title: string;
  description: string;
  infoHash: string;
  infoHashV2?: string;
  files: TorrentFile[];
  trackers: string[];
  tags?: string[];
  image?: string;
}</code></pre>

  <h3>å»ºç«‹ç¨®å­äº‹ä»¶</h3>
  <pre><code class="language-typescript" is:raw>import { finalizeEvent } from 'nostr-tools';

function createTorrentEvent(
  torrent: Torrent,
  secretKey: Uint8Array
) {
  const tags: string[][] = [
    ['title', torrent.title],
    ['x', torrent.infoHash],
  ];

  if (torrent.infoHashV2) {
    tags.push(['i', `btih:${torrent.infoHashV2}`]);
  }

  torrent.files.forEach((file) => {
    tags.push(['file', file.name, file.size.toString()]);
  });

  torrent.trackers.forEach((tracker) => {
    tags.push(['tracker', tracker]);
  });

  torrent.tags?.forEach((tag) => {
    tags.push(['t', tag]);
  });

  if (torrent.image) {
    tags.push(['image', torrent.image]);
  }

  const event = {
    kind: 2003,
    content: torrent.description,
    tags,
    created_at: Math.floor(Date.now() / 1000),
  };

  return finalizeEvent(event, secretKey);
}

// ä½¿ç”¨ç¯„ä¾‹
const torrentEvent = createTorrentEvent(
  {
    title: 'Debian 12 Bookworm',
    description: 'Debian 12 å®˜æ–¹ ISOï¼Œç©©å®šç‰ˆæœ¬ã€‚',
    infoHash: 'abc123def456...',
    files: [
      { name: 'debian-12-amd64-netinst.iso', size: 600000000 },
    ],
    trackers: [
      'udp://tracker.debian.org:6969',
      'udp://tracker.opentrackr.org:1337',
    ],
    tags: ['linux', 'debian', 'é–‹æº'],
  },
  secretKey
);</code></pre>

  <h3>è§£æç¨®å­äº‹ä»¶</h3>
  <pre><code class="language-typescript" is:raw>interface ParsedTorrent {
  title: string;
  description: string;
  infoHash: string;
  infoHashV2?: string;
  files: TorrentFile[];
  trackers: string[];
  tags: string[];
  image?: string;
  magnetUri: string;
  totalSize: number;
}

function parseTorrentEvent(event: any): ParsedTorrent | null {
  if (event.kind !== 2003) return null;

  const getTag = (name: string) => {
    const tag = event.tags.find((t: string[]) => t[0] === name);
    return tag?.[1];
  };

  const getAllTags = (name: string) => {
    return event.tags
      .filter((t: string[]) => t[0] === name)
      .map((t: string[]) => t.slice(1));
  };

  const title = getTag('title');
  const infoHash = getTag('x');

  if (!title || !infoHash) return null;

  const files = getAllTags('file').map((f: string[]) => ({
    name: f[0],
    size: parseInt(f[1] || '0'),
  }));

  const trackers = getAllTags('tracker').map((t: string[]) => t[0]);
  const tags = getAllTags('t').map((t: string[]) => t[0]);

  const totalSize = files.reduce((sum, f) => sum + f.size, 0);

  // å»ºç«‹ Magnet URI
  let magnetUri = `magnet:?xt=urn:btih:${infoHash}`;
  magnetUri += `&dn=${encodeURIComponent(title)}`;
  trackers.forEach((tracker) => {
    magnetUri += `&tr=${encodeURIComponent(tracker)}`;
  });

  const iTag = event.tags.find((t: string[]) => t[0] === 'i');
  const infoHashV2 = iTag?.[1]?.replace('btih:', '');

  return {
    title,
    description: event.content,
    infoHash,
    infoHashV2,
    files,
    trackers,
    tags,
    image: getTag('image'),
    magnetUri,
    totalSize,
  };
}

// ä½¿ç”¨ç¯„ä¾‹
const torrent = parseTorrentEvent(event);
if (torrent) {
  console.log(`æ¨™é¡Œ: ${torrent.title}`);
  console.log(`å¤§å°: ${formatBytes(torrent.totalSize)}`);
  console.log(`Magnet: ${torrent.magnetUri}`);
}</code></pre>

  <h3>æœå°‹ç¨®å­</h3>
  <pre><code class="language-typescript" is:raw>import { SimplePool } from 'nostr-tools';

interface TorrentSearchOptions {
  tags?: string[];
  author?: string;
  limit?: number;
}

async function searchTorrents(
  pool: SimplePool,
  relays: string[],
  options: TorrentSearchOptions = {}
): Promise&lt;ParsedTorrent[]&gt; {
  const filter: any = {
    kinds: [2003],
    limit: options.limit || 50,
  };

  if (options.author) {
    filter.authors = [options.author];
  }

  if (options.tags && options.tags.length > 0) {
    filter['#t'] = options.tags;
  }

  const events = await pool.querySync(relays, filter);

  return events
    .map(parseTorrentEvent)
    .filter((t): t is ParsedTorrent => t !== null)
    .sort((a, b) => b.totalSize - a.totalSize);
}

// ä½¿ç”¨ç¯„ä¾‹
const torrents = await searchTorrents(pool, relays, {
  tags: ['linux', 'é–‹æº'],
  limit: 20,
});</code></pre>

  <h3>æ ¼å¼åŒ–å·¥å…·</h3>
  <pre><code class="language-typescript" is:raw>function formatBytes(bytes: number): string {
  if (bytes === 0) return '0 B';

  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  const k = 1024;
  const i = Math.floor(Math.log(bytes) / Math.log(k));

  return `${(bytes / Math.pow(k, i)).toFixed(2)} ${units[i]}`;
}

function copyMagnetLink(magnetUri: string): void {
  navigator.clipboard.writeText(magnetUri);
}</code></pre>

  <h3>React å…ƒä»¶</h3>
  <pre><code class="language-typescript" is:raw>interface TorrentCardProps {
  torrent: ParsedTorrent;
}

function TorrentCard({ torrent }: TorrentCardProps) {
  const handleCopyMagnet = () => {
    navigator.clipboard.writeText(torrent.magnetUri);
    // é¡¯ç¤ºæç¤º
  };

  return (
    &lt;div className="torrent-card"&gt;
      {torrent.image && (
        &lt;img src={torrent.image} alt={torrent.title} className="preview" /&gt;
      )}
      &lt;div className="info"&gt;
        &lt;h3&gt;{torrent.title}&lt;/h3&gt;
        &lt;p className="description"&gt;{torrent.description}&lt;/p&gt;
        &lt;div className="meta"&gt;
          &lt;span className="size"&gt;{formatBytes(torrent.totalSize)}&lt;/span&gt;
          &lt;span className="files"&gt;{torrent.files.length} å€‹æª”æ¡ˆ&lt;/span&gt;
        &lt;/div&gt;
        &lt;div className="tags"&gt;
          {torrent.tags.map((tag) => (
            &lt;span key={tag} className="tag"&gt;#{tag}&lt;/span&gt;
          ))}
        &lt;/div&gt;
        &lt;div className="actions"&gt;
          &lt;a href={torrent.magnetUri} className="magnet-btn"&gt;
            ğŸ§² é–‹å•Ÿ Magnet
          &lt;/a&gt;
          &lt;button onClick={handleCopyMagnet}&gt;è¤‡è£½é€£çµ&lt;/button&gt;
        &lt;/div&gt;
        &lt;div className="files-list"&gt;
          &lt;h4&gt;æª”æ¡ˆåˆ—è¡¨&lt;/h4&gt;
          {torrent.files.map((file, i) => (
            &lt;div key={i} className="file"&gt;
              &lt;span className="name"&gt;{file.name}&lt;/span&gt;
              &lt;span className="size"&gt;{formatBytes(file.size)}&lt;/span&gt;
            &lt;/div&gt;
          ))}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
}</code></pre>

  <h2 id="use-cases">ä½¿ç”¨å ´æ™¯</h2>

  <h3>é–‹æºè»Ÿé«”åˆ†ç™¼</h3>
  <ul>
    <li>Linux ç™¼è¡Œç‰ˆ ISO</li>
    <li>é–‹æºæ‡‰ç”¨ç¨‹å¼</li>
    <li>å€å¡Šéˆå®¢æˆ¶ç«¯</li>
  </ul>

  <h3>å…§å®¹å‰µä½œ</h3>
  <ul>
    <li>å‰µç”¨ CC æˆæ¬Šå…§å®¹</li>
    <li>å…¬å…±é ˜åŸŸä½œå“</li>
    <li>æ•™è‚²è³‡æº</li>
  </ul>

  <h3>æ•¸æ“šé›†åˆ†äº«</h3>
  <ul>
    <li>å…¬é–‹æ•¸æ“šé›†</li>
    <li>ç ”ç©¶è³‡æ–™</li>
    <li>æ­·å²å­˜æª”</li>
  </ul>

  <h2 id="best-practices">æœ€ä½³å¯¦è¸</h2>
  <ul>
    <li><strong>æä¾›å¤šå€‹ Tracker</strong>ï¼šå¢åŠ ä¸‹è¼‰å¯ç”¨æ€§</li>
    <li><strong>è©³ç´°æè¿°</strong>ï¼šèªªæ˜å…§å®¹å’Œä¾†æº</li>
    <li><strong>æ¨™ç±¤åˆ†é¡</strong>ï¼šå¹«åŠ©æœå°‹å’Œç™¼ç¾</li>
    <li><strong>æä¾›æ ¡é©—ç¢¼</strong>ï¼šåœ¨æè¿°ä¸­åŒ…å« SHA256</li>
    <li><strong>åˆæ³•å…§å®¹</strong>ï¼šåªåˆ†äº«åˆæ³•æˆæ¬Šçš„å…§å®¹</li>
  </ul>

  <h2 id="related-nips">ç›¸é—œ NIPs</h2>
  <ul>
    <li><a href="/tech/nostr/nip-01">NIP-01</a>ï¼šåŸºæœ¬å”è­° - äº‹ä»¶æ ¼å¼</li>
    <li><a href="/tech/nostr/nip-94">NIP-94</a>ï¼šæª”æ¡ˆä¸­ç¹¼è³‡æ–™ - æª”æ¡ˆè³‡è¨Š</li>
    <li><a href="/tech/nostr/nip-96">NIP-96</a>ï¼šæª”æ¡ˆå„²å­˜ - æª”æ¡ˆä¸Šå‚³</li>
  </ul>

  <h2 id="references">åƒè€ƒè³‡æº</h2>
  <ul>
    <li>
      <a
        href="https://github.com/nostr-protocol/nips/blob/master/35.md"
        target="_blank"
        rel="noopener noreferrer">NIP-35 è¦ç¯„</a>
    </li>
    <li>
      <a
        href="https://www.bittorrent.org/beps/bep_0003.html"
        target="_blank"
        rel="noopener noreferrer">BitTorrent å”è­°</a>
    </li>
    <li>
      <a href="https://github.com/nbd-wtf/nostr-tools" target="_blank" rel="noopener noreferrer"
        >nostr-tools</a>
    </li>
  </ul>
</ArticleLayout>
