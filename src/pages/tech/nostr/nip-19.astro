---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-19 bech32 編碼"
  description="深入了解 Nostr 的 bech32 編碼實體，npub、nsec、note 和其他標識符格式。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-19 bech32 編碼' },
  ]}
  difficulty="beginner"
  readingTime="12 分鐘"
  prevPage={{ title: 'NIP-04 加密私訊', href: '/tech/nostr/nip-04' }}
  nextPage={{ title: 'NIP-23 長文內容', href: '/tech/nostr/nip-23' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 NIP-19？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    NIP-19 定義了 Nostr 中使用的 bech32 編碼格式，用於人類可讀的標識符。
    這些格式讓用戶可以安全地分享公鑰、私鑰、事件 ID 等資訊，
    同時內建錯誤檢測機制。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-purple-500/10 border border-purple-500/30">
    <p class="text-sm text-purple-700 dark:text-purple-400">
      <strong>設計目的：</strong>
      bech32 編碼不區分大小寫、具有錯誤檢測、前綴明確區分類型，
      讓用戶一眼就能識別「npub」是公鑰、「nsec」是私鑰。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">基本格式</h2>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">前綴</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">含義</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">內容</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono text-purple-500">npub</td>
          <td class="py-3 px-4">公鑰</td>
          <td class="py-3 px-4">32 bytes 公鑰</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono text-red-500">nsec</td>
          <td class="py-3 px-4">私鑰</td>
          <td class="py-3 px-4">32 bytes 私鑰</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono text-blue-500">note</td>
          <td class="py-3 px-4">事件 ID</td>
          <td class="py-3 px-4">32 bytes 事件 ID</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">範例</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code># 公鑰（hex）
3bf0c63fcb93463407af97a5e5ee64fa883d107ef9e558472c4eb9aaaefa459d

# 公鑰（npub）
npub180cvv07tjdrrgpa0j7j7tmnyl2yr6yr7l8j4s3evf6u64th6gkwsyjh6w6

# 事件 ID（hex）
b9f7e1b5af2e5f0c6a8b5c9d3e2f1a0b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f

# 事件 ID（note）
note1h8lcrkd09enczag29ea5l97rgt3w4u0l4xl2k2wz3w8q7dvn8m8s8d0zyj</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">可分享格式（TLV 編碼）</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    NIP-19 還定義了包含額外資訊的可分享格式，使用 TLV（Type-Length-Value）編碼：
  </p>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">前綴</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">含義</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">包含資訊</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono text-purple-500">nprofile</td>
          <td class="py-3 px-4">個人檔案</td>
          <td class="py-3 px-4">公鑰 + 推薦中繼器</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono text-blue-500">nevent</td>
          <td class="py-3 px-4">事件</td>
          <td class="py-3 px-4">事件 ID + 中繼器 + 作者</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono text-green-500">naddr</td>
          <td class="py-3 px-4">可替換事件</td>
          <td class="py-3 px-4">kind + 公鑰 + d 標籤 + 中繼器</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4 font-mono text-yellow-500">nrelay</td>
          <td class="py-3 px-4">中繼器</td>
          <td class="py-3 px-4">中繼器 URL</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">TLV 結構</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code># TLV 類型定義
0: special (公鑰或事件 ID，取決於前綴)
1: relay (推薦的中繼器 URL)
2: author (事件作者公鑰，用於 nevent)
3: kind (事件類型，用於 naddr)

# nprofile 範例結構
TLV[
  (0, 32, &lt;pubkey&gt;),           # 公鑰
  (1, n, "wss://relay1.com"),   # 中繼器 1
  (1, n, "wss://relay2.com")    # 中繼器 2
]

# nevent 範例結構
TLV[
  (0, 32, &lt;event_id&gt;),         # 事件 ID
  (1, n, "wss://relay.com"),    # 發現此事件的中繼器
  (2, 32, &lt;author_pubkey&gt;)     # 作者公鑰
]</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">程式碼範例</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">編碼公鑰</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`import { bech32 } from '@scure/base'

function hexToNpub(hex) {
  const data = Buffer.from(hex, 'hex')
  const words = bech32.toWords(data)
  return bech32.encode('npub', words, 1000)
}

// 使用
const npub = hexToNpub('3bf0c63f...')
// => npub180cvv07tjdrrgpa0j7j7tmnyl2yr6yr7l8j4s3evf6u64th6gkwsyjh6w6`}</code></pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">解碼 npub</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`function npubToHex(npub) {
  const { prefix, words } = bech32.decode(npub, 1000)
  if (prefix !== 'npub') throw new Error('Invalid npub')
  const data = bech32.fromWords(words)
  return Buffer.from(data).toString('hex')
}

// 使用
const hex = npubToHex('npub180cvv07...')
// => 3bf0c63fcb93463407af97a5e5ee64fa883d107ef9e558472c4eb9aaaefa459d`}</code></pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">編碼 nprofile</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`function encodeNprofile(pubkey, relays) {
  // 構建 TLV
  let tlv = []

  // 類型 0: 公鑰
  tlv.push(0, 32, ...Buffer.from(pubkey, 'hex'))

  // 類型 1: 中繼器
  for (const relay of relays) {
    const relayBytes = Buffer.from(relay, 'utf8')
    tlv.push(1, relayBytes.length, ...relayBytes)
  }

  const words = bech32.toWords(Buffer.from(tlv))
  return bech32.encode('nprofile', words, 1500)
}

// 使用
const nprofile = encodeNprofile(
  '3bf0c63f...',
  ['wss://relay.damus.io', 'wss://nos.lol']
)`}</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">使用場景</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    {
      [
        {
          title: '分享個人檔案',
          desc: '使用 nprofile 分享包含推薦中繼器的個人檔案連結',
          format: 'nprofile1...',
        },
        {
          title: '分享貼文',
          desc: '使用 nevent 分享特定貼文，包含可找到它的中繼器',
          format: 'nevent1...',
        },
        {
          title: '引用長文',
          desc: '使用 naddr 引用可替換事件如長文、文章',
          format: 'naddr1...',
        },
        {
          title: '推薦中繼器',
          desc: '使用 nrelay 分享中繼器連結',
          format: 'nrelay1...',
        },
      ].map((item) => (
        <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
          <h4 class="font-semibold text-[var(--text-primary)] mb-1">{item.title}</h4>
          <p class="text-sm text-[var(--text-secondary)] mb-2">{item.desc}</p>
          <code class="text-xs bg-black/10 dark:bg-white/10 px-2 py-1 rounded">{item.format}</code>
        </div>
      ))
    }
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">bech32 vs bech32m</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    NIP-19 使用 bech32（非 bech32m），這是一個重要區別：
  </p>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">特性</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">bech32</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">bech32m</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">用於</td>
          <td class="py-3 px-4">Nostr、SegWit v0</td>
          <td class="py-3 px-4">Taproot (SegWit v1+)</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">常數</td>
          <td class="py-3 px-4">1</td>
          <td class="py-3 px-4">0x2bc830a3</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">BIP</td>
          <td class="py-3 px-4">BIP-173</td>
          <td class="py-3 px-4">BIP-350</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
    <p class="text-sm text-red-700 dark:text-red-400">
      <strong>安全警告：</strong>
      永遠不要分享你的 nsec 私鑰！nsec 開頭的字串包含你的私鑰，
      任何人獲得它都可以完全控制你的 Nostr 身份。
    </p>
  </div>
</ArticleLayout>
