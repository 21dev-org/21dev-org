---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="å®¢æˆ¶ç«¯é–‹ç™¼"
  description="å­¸ç¿’å¦‚ä½•é–‹ç™¼ Nostr å®¢æˆ¶ç«¯æ‡‰ç”¨ï¼ŒåŒ…æ‹¬é€£æ¥ä¸­ç¹¼å™¨ã€ç™¼é€äº‹ä»¶å’Œè™•ç†è¨‚é–±ã€‚"
  breadcrumbs={[
    { label: 'æŠ€è¡“', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'å®¢æˆ¶ç«¯é–‹ç™¼' },
  ]}
  difficulty="intermediate"
  readingTime="25 åˆ†é˜"
  prevPage={{ title: 'ä¸­ç¹¼å™¨æ¶è¨­', href: '/tech/nostr/relay-setup' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">é–‹ç™¼å·¥å…·</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    é–‹ç™¼ Nostr å®¢æˆ¶ç«¯å¯ä»¥ä½¿ç”¨å¤šç¨®èªè¨€å’Œå·¥å…·ã€‚
    æœ€å¸¸ç”¨çš„æ˜¯ JavaScript/TypeScript ç”Ÿæ…‹ç³»çš„ nostr-tools å‡½å¼åº«ï¼Œ
    å®ƒæä¾›äº†å®Œæ•´çš„å”è­°å¯¦ç¾ã€‚
  </p>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border border-[var(--border-default)] rounded-lg overflow-hidden">
      <thead class="bg-[var(--bg-secondary)]">
        <tr>
          <th class="px-4 py-3 text-left text-[var(--text-primary)]">èªè¨€</th>
          <th class="px-4 py-3 text-left text-[var(--text-primary)]">å‡½å¼åº«</th>
          <th class="px-4 py-3 text-left text-[var(--text-primary)]">èªªæ˜</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-primary)]">JavaScript</td>
          <td class="px-4 py-3 font-mono text-purple-500">nostr-tools</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">æœ€å®Œæ•´çš„ JS å¯¦ç¾</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-primary)]">Python</td>
          <td class="px-4 py-3 font-mono text-purple-500">python-nostr</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">Python å”è­°å¯¦ç¾</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-primary)]">Rust</td>
          <td class="px-4 py-3 font-mono text-purple-500">nostr-sdk</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">é«˜æ•ˆèƒ½ Rust SDK</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-primary)]">Go</td>
          <td class="px-4 py-3 font-mono text-purple-500">go-nostr</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">Go èªè¨€å¯¦ç¾</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-primary)]">Swift</td>
          <td class="px-4 py-3 font-mono text-purple-500">NostrKit</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">iOS/macOS é–‹ç™¼</td>
        </tr>
        <tr class="border-t border-[var(--border-default)]">
          <td class="px-4 py-3 text-[var(--text-primary)]">Kotlin</td>
          <td class="px-4 py-3 font-mono text-purple-500">nostrino</td>
          <td class="px-4 py-3 text-[var(--text-secondary)]">Android é–‹ç™¼</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">é–‹å§‹ä½¿ç”¨ nostr-tools</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">{`# å®‰è£
npm install nostr-tools

# åŸºæœ¬å¼•å…¥
import {
  generateSecretKey,
  getPublicKey,
  finalizeEvent,
  verifyEvent,
  SimplePool
} from 'nostr-tools'`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">å¯†é‘°ç®¡ç†</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">{`import {
  generateSecretKey,
  getPublicKey,
  nip19
} from 'nostr-tools'

// ç”Ÿæˆæ–°å¯†é‘°å°
const sk = generateSecretKey()  // Uint8Array
const pk = getPublicKey(sk)     // hex string

// ç·¨ç¢¼ç‚º bech32 æ ¼å¼
const nsec = nip19.nsecEncode(sk)  // nsec1...
const npub = nip19.npubEncode(pk)  // npub1...

console.log('Public Key:', npub)
console.log('Secret Key:', nsec)  // ä¿å¯†ï¼

// è§£ç¢¼ bech32
const { type, data } = nip19.decode(npub)
// type: 'npub', data: hex pubkey

// ä½¿ç”¨ NIP-07 ç€è¦½å™¨æ“´å±•
if (window.nostr) {
  const pubkey = await window.nostr.getPublicKey()
  // ç°½åæ™‚ä½¿ç”¨ window.nostr.signEvent()
}`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">é€£æ¥ä¸­ç¹¼å™¨</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">{`import { SimplePool } from 'nostr-tools'

// å‰µå»ºé€£æ¥æ± 
const pool = new SimplePool()

// å®šç¾©ä¸­ç¹¼å™¨åˆ—è¡¨
const relays = [
  'wss://relay.damus.io',
  'wss://nos.lol',
  'wss://relay.nostr.band'
]

// ç™¼é€äº‹ä»¶åˆ°æ‰€æœ‰ä¸­ç¹¼å™¨
await pool.publish(relays, signedEvent)

// æŸ¥è©¢äº‹ä»¶
const events = await pool.querySync(relays, {
  kinds: [1],
  authors: [pubkey],
  limit: 20
})

// è¨‚é–±äº‹ä»¶ï¼ˆå³æ™‚ï¼‰
const sub = pool.subscribeMany(
  relays,
  [{ kinds: [1], authors: [pubkey] }],
  {
    onevent(event) {
      console.log('New event:', event)
    },
    oneose() {
      console.log('End of stored events')
    }
  }
)

// é—œé–‰è¨‚é–±
sub.close()`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">å‰µå»ºå’Œç™¼é€äº‹ä»¶</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">{`import { finalizeEvent, verifyEvent } from 'nostr-tools'

// å‰µå»ºçŸ­æ–‡æœ¬äº‹ä»¶ï¼ˆkind:1ï¼‰
const event = finalizeEvent({
  kind: 1,
  created_at: Math.floor(Date.now() / 1000),
  tags: [],
  content: 'Hello Nostr!'
}, sk)

// é©—è­‰äº‹ä»¶
const isValid = verifyEvent(event)
console.log('Valid:', isValid)

// ç™¼å¸ƒ
await pool.publish(relays, event)

// å‰µå»ºå›è¦†
const reply = finalizeEvent({
  kind: 1,
  created_at: Math.floor(Date.now() / 1000),
  tags: [
    ['e', originalEventId, relays[0], 'root'],
    ['e', parentEventId, relays[0], 'reply'],
    ['p', originalAuthorPubkey]
  ],
  content: 'This is a reply!'
}, sk)

// å‰µå»ºåæ‡‰ï¼ˆkind:7ï¼‰
const reaction = finalizeEvent({
  kind: 7,
  created_at: Math.floor(Date.now() / 1000),
  tags: [
    ['e', targetEventId],
    ['p', targetAuthorPubkey]
  ],
  content: '+'  // æˆ– 'â¤ï¸', 'ğŸ”¥' ç­‰
}, sk)

// æ›´æ–°å€‹äººè³‡æ–™ï¼ˆkind:0ï¼‰
const metadata = finalizeEvent({
  kind: 0,
  created_at: Math.floor(Date.now() / 1000),
  tags: [],
  content: JSON.stringify({
    name: 'Alice',
    about: 'Nostr developer',
    picture: 'https://example.com/avatar.jpg',
    nip05: 'alice@example.com',
    lud16: 'alice@walletofsatoshi.com'
  })
}, sk)`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">æŸ¥è©¢å’Œéæ¿¾</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">{`// æŸ¥è©¢ç‰¹å®šç”¨æˆ¶çš„è²¼æ–‡
const posts = await pool.querySync(relays, {
  kinds: [1],
  authors: [pubkey],
  limit: 50
})

// æŸ¥è©¢ç”¨æˆ¶å€‹äººè³‡æ–™
const profiles = await pool.querySync(relays, {
  kinds: [0],
  authors: [pubkey1, pubkey2, pubkey3]
})

// æŸ¥è©¢ç‰¹å®šäº‹ä»¶çš„å›è¦†
const replies = await pool.querySync(relays, {
  kinds: [1],
  '#e': [eventId]
})

// æŸ¥è©¢å¸¶ç‰¹å®šæ¨™ç±¤çš„äº‹ä»¶
const taggedPosts = await pool.querySync(relays, {
  kinds: [1],
  '#t': ['bitcoin', 'nostr']
})

// æ™‚é–“ç¯„åœæŸ¥è©¢
const recentPosts = await pool.querySync(relays, {
  kinds: [1],
  since: Math.floor(Date.now() / 1000) - 3600,  // éå»ä¸€å°æ™‚
  limit: 100
})

// å¤šéæ¿¾å™¨ï¼ˆOR é—œä¿‚ï¼‰
const events = await pool.querySync(relays, [
  { kinds: [1], authors: [pubkey] },  // ç”¨æˆ¶çš„è²¼æ–‡
  { kinds: [7], '#p': [pubkey] }      // å°ç”¨æˆ¶çš„åæ‡‰
])`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">å¯¦æ™‚è¨‚é–±</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">{`// è¨‚é–±å‹•æ…‹æ¶ˆæ¯
const sub = pool.subscribeMany(
  relays,
  [
    { kinds: [1], limit: 50 },  // æœ€è¿‘çš„è²¼æ–‡
    { kinds: [7], '#p': [myPubkey] }  // å°æˆ‘çš„åæ‡‰
  ],
  {
    onevent(event) {
      switch (event.kind) {
        case 1:
          handleNewPost(event)
          break
        case 7:
          handleReaction(event)
          break
      }
    },
    oneose() {
      console.log('Historical events loaded')
      // å¯ä»¥åœ¨é€™è£¡æ›´æ–° UI ç‹€æ…‹
    },
    onclose(reason) {
      console.log('Subscription closed:', reason)
    }
  }
)

// é é¢å¸è¼‰æ™‚é—œé–‰
window.addEventListener('beforeunload', () => {
  sub.close()
})

// å‹•æ…‹æ·»åŠ éæ¿¾å™¨
// å‰µå»ºæ–°è¨‚é–±ï¼ŒèˆŠçš„æœƒè‡ªå‹•æ›¿æ›

// ä½¿ç”¨ REQ è‡ªå‹•é‡é€£
// SimplePool æœƒè‡ªå‹•è™•ç†é€£æ¥æ–·é–‹å’Œé‡é€£`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">NIP-05 é©—è­‰</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">{`import { nip05 } from 'nostr-tools'

// æŸ¥è©¢ NIP-05 è³‡æ–™
const profile = await nip05.queryProfile('alice@example.com')

if (profile) {
  console.log('Public Key:', profile.pubkey)
  console.log('Relays:', profile.relays)
}

// é©—è­‰ç”¨æˆ¶çš„ NIP-05
async function verifyNip05(event) {
  // è§£æå€‹äººè³‡æ–™
  const metadata = JSON.parse(event.content)
  const nip05Addr = metadata.nip05

  if (!nip05Addr) {
    return { verified: false, reason: 'No NIP-05' }
  }

  const profile = await nip05.queryProfile(nip05Addr)

  if (!profile) {
    return { verified: false, reason: 'Query failed' }
  }

  if (profile.pubkey !== event.pubkey) {
    return { verified: false, reason: 'Pubkey mismatch' }
  }

  return { verified: true, relays: profile.relays }
}`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">NIP-07 ç€è¦½å™¨æ“´å±•</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">{`// æª¢æŸ¥æ˜¯å¦æœ‰ NIP-07 æ“´å±•
function hasNostrExtension() {
  return typeof window.nostr !== 'undefined'
}

// ä½¿ç”¨ NIP-07 ç°½å
async function signWithExtension(event) {
  if (!hasNostrExtension()) {
    throw new Error('No Nostr extension found')
  }

  // ç²å–å…¬é‘°
  const pubkey = await window.nostr.getPublicKey()

  // æº–å‚™äº‹ä»¶ï¼ˆä¸åŒ…å« id å’Œ sigï¼‰
  const unsignedEvent = {
    kind: event.kind,
    created_at: event.created_at || Math.floor(Date.now() / 1000),
    tags: event.tags || [],
    content: event.content,
    pubkey: pubkey
  }

  // æ“´å±•æœƒè¨ˆç®— id ä¸¦ç°½å
  const signedEvent = await window.nostr.signEvent(unsignedEvent)

  return signedEvent
}

// åŠ å¯†è¨Šæ¯
async function encryptMessage(recipientPubkey, plaintext) {
  if (!hasNostrExtension()) {
    throw new Error('No Nostr extension found')
  }

  // NIP-04ï¼ˆèˆŠç‰ˆï¼‰
  const ciphertext = await window.nostr.nip04.encrypt(
    recipientPubkey,
    plaintext
  )

  // æˆ– NIP-44ï¼ˆæ–°ç‰ˆï¼Œæ›´å®‰å…¨ï¼‰
  // const ciphertext = await window.nostr.nip44.encrypt(
  //   recipientPubkey,
  //   plaintext
  // )

  return ciphertext
}`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">å»ºæ§‹å®Œæ•´æ‡‰ç”¨</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">{`// ç°¡æ˜“ Nostr å®¢æˆ¶ç«¯æ¶æ§‹

class NostrClient {
  constructor(relays) {
    this.pool = new SimplePool()
    this.relays = relays
    this.subscriptions = new Map()
  }

  // ç™»å…¥ï¼ˆä½¿ç”¨æ“´å±•æˆ–ç§é‘°ï¼‰
  async login(method = 'extension') {
    if (method === 'extension') {
      this.pubkey = await window.nostr.getPublicKey()
      this.signMethod = 'extension'
    } else {
      this.sk = generateSecretKey()
      this.pubkey = getPublicKey(this.sk)
      this.signMethod = 'local'
    }
    return this.pubkey
  }

  // ç°½åäº‹ä»¶
  async signEvent(event) {
    if (this.signMethod === 'extension') {
      return await window.nostr.signEvent(event)
    } else {
      return finalizeEvent(event, this.sk)
    }
  }

  // ç™¼å¸ƒè²¼æ–‡
  async post(content, replyTo = null) {
    const tags = []
    if (replyTo) {
      tags.push(['e', replyTo.id, this.relays[0], 'reply'])
      tags.push(['p', replyTo.pubkey])
    }

    const event = await this.signEvent({
      kind: 1,
      created_at: Math.floor(Date.now() / 1000),
      tags,
      content
    })

    await this.pool.publish(this.relays, event)
    return event
  }

  // ç²å–å‹•æ…‹æ¶ˆæ¯
  async getFeed(limit = 50) {
    // å…ˆç²å–é—œæ³¨åˆ—è¡¨
    const contactEvent = await this.pool.get(this.relays, {
      kinds: [3],
      authors: [this.pubkey]
    })

    const following = contactEvent?.tags
      .filter(t => t[0] === 'p')
      .map(t => t[1]) || []

    // ç²å–é—œæ³¨è€…çš„è²¼æ–‡
    return await this.pool.querySync(this.relays, {
      kinds: [1],
      authors: following,
      limit
    })
  }

  // è¨‚é–±é€šçŸ¥
  subscribeNotifications(callback) {
    const sub = this.pool.subscribeMany(
      this.relays,
      [
        { kinds: [1], '#p': [this.pubkey] },  // æåŠ
        { kinds: [7], '#p': [this.pubkey] },  // åæ‡‰
        { kinds: [9735], '#p': [this.pubkey] }  // Zaps
      ],
      {
        onevent: callback
      }
    )
    this.subscriptions.set('notifications', sub)
    return sub
  }

  // æ¸…ç†
  cleanup() {
    this.subscriptions.forEach(sub => sub.close())
    this.pool.close(this.relays)
  }
}`}</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">æœ€ä½³å¯¦è¸</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-green-500/30 bg-green-500/10">
      <h4 class="font-semibold text-green-700 dark:text-green-400 mb-2">åš</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>â€¢ é©—è­‰æ‰€æœ‰æ”¶åˆ°çš„äº‹ä»¶</li>
        <li>â€¢ ä½¿ç”¨é€£æ¥æ± ç®¡ç†ä¸­ç¹¼å™¨</li>
        <li>â€¢ å¯¦ç¾éŒ¯èª¤è™•ç†å’Œé‡è©¦</li>
        <li>â€¢ å¿«å–å¸¸ç”¨æ•¸æ“š</li>
        <li>â€¢ ä½¿ç”¨ NIP-07 ä¿è­·ç§é‘°</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-red-500/30 bg-red-500/10">
      <h4 class="font-semibold text-red-700 dark:text-red-400 mb-2">ä¸è¦</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>â€¢ åœ¨å®¢æˆ¶ç«¯ç¡¬ç·¨ç¢¼ç§é‘°</li>
        <li>â€¢ ä¿¡ä»»æœªé©—è­‰çš„äº‹ä»¶</li>
        <li>â€¢ å¿½ç•¥ EOSE è¨Šè™Ÿ</li>
        <li>â€¢ å»ºç«‹éå¤šé€£æ¥</li>
        <li>â€¢ å¿½ç•¥äº‹ä»¶å¤§å°é™åˆ¶</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">å»¶ä¼¸é–±è®€</h2>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-purple-500">â€¢</span>
      <span><a href="https://github.com/nbd-wtf/nostr-tools" class="text-purple-500 hover:underline" target="_blank" rel="noopener">nostr-tools GitHub</a>ï¼šå®Œæ•´ API æ–‡æª”</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-purple-500">â€¢</span>
      <span><a href="https://nostr.how" class="text-purple-500 hover:underline" target="_blank" rel="noopener">nostr.how</a>ï¼šNostr å…¥é–€æŒ‡å—</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-purple-500">â€¢</span>
      <span><a href="https://github.com/nostr-protocol/nips" class="text-purple-500 hover:underline" target="_blank" rel="noopener">NIPs</a>ï¼šå®˜æ–¹å”è­°è¦ç¯„</span>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="text-sm text-[var(--text-secondary)]">
      <strong class="text-[var(--text-primary)]">é–‹å§‹å‹•æ‰‹ï¼š</strong>
      å˜—è©¦ç”¨ nostr-tools å»ºæ§‹ä¸€å€‹ç°¡å–®çš„ Nostr é–±è®€å™¨ï¼Œ
      ç„¶å¾Œé€æ­¥æ·»åŠ ç™¼æ–‡ã€åæ‡‰å’Œ Zaps åŠŸèƒ½ï¼
    </p>
  </div>
</ArticleLayout>
