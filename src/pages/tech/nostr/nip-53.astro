---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import { defined } from '@/utils/types';
---

<ArticleLayout
  title="NIP-53: ç›´æ’­æ´»å‹•"
  subtitle="Live Activities - ç›´æ’­ã€æœƒè­°å®¤èˆ‡å³æ™‚äº’å‹•"
  difficulty="advanced"
  readingTime={15}
  tags={['Nostr', 'NIP-53', 'ç›´æ’­', 'live', 'streaming']}
  prevPage={defined({ href: '/tech/nostr/nip-51', label: 'NIP-51 åˆ—è¡¨' })}
  nextPage={defined({ href: '/tech/nostr/nip-56', label: 'NIP-56 èˆ‰å ±' })}
>
  <!-- Breadcrumb -->
  <nav class="flex items-center gap-2 text-sm text-[var(--text-tertiary)] mb-8 flex-wrap">
    <a href="/" class="hover:text-[var(--text-secondary)] transition-colors">é¦–é </a>
    <span>/</span>
    <a href="/tech" class="hover:text-[var(--text-secondary)] transition-colors">æŠ€è¡“</a>
    <span>/</span>
    <a href="/tech/nostr" class="hover:text-[var(--text-secondary)] transition-colors">Nostr</a>
    <span>/</span>
    <span class="text-[var(--text-primary)]">NIP-53</span>
  </nav>

  <!-- Introduction -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">æ¦‚è¿°</h2>
    <p class="text-[var(--text-secondary)] mb-4">
      NIP-53 å®šç¾©äº†ä¸€å¥—ç”¨æ–¼ç›´æ’­æ´»å‹•ã€æœƒè­°å®¤å’Œå³æ™‚äº’å‹•çš„äº‹ä»¶é¡å‹ã€‚å®ƒæ”¯æ´è¦–è¨Šç›´æ’­ã€èªéŸ³æˆ¿é–“ã€
      ç·šä¸Šæœƒè­°ç­‰å ´æ™¯ï¼ŒåŒ…å«åƒèˆ‡è€…ç®¡ç†ã€èŠå¤©è¨Šæ¯ã€ç‹€æ…‹è¿½è¹¤ç­‰å®Œæ•´åŠŸèƒ½ã€‚
    </p>
    <div class="p-4 rounded-lg bg-purple-500/10 border border-purple-500/20">
      <p class="text-[var(--text-secondary)]">
        <strong class="text-purple-400">æ ¸å¿ƒæ¦‚å¿µï¼š</strong>
        NIP-53 ä½¿ç”¨å¤šç¨®äº‹ä»¶é¡å‹å”åŒå·¥ä½œï¼škind 30311 å®šç¾©ç›´æ’­æ´»å‹•ï¼Œkind 1311 ç”¨æ–¼èŠå¤©è¨Šæ¯ï¼Œ
        kind 30312/30313 ç”¨æ–¼æœƒè­°ç©ºé–“ï¼Œkind 10312 è¿½è¹¤ç”¨æˆ¶åœ¨å ´ç‹€æ…‹ã€‚
      </p>
    </div>
  </section>

  <!-- Event Kinds -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">äº‹ä»¶é¡å‹</h2>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse mb-4">
        <thead>
          <tr class="border-b border-[var(--border-default)]">
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">Kind</th>
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">åç¨±</th>
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">é¡å‹</th>
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">èªªæ˜</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">30311</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">Live Event</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">å¯å®šå€</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ç›´æ’­æ´»å‹•ä¸»äº‹ä»¶</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">1311</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">Live Chat</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ä¸€èˆ¬äº‹ä»¶</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ç›´æ’­èŠå¤©è¨Šæ¯</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">30312</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">Meeting Space</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">å¯å®šå€</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">æœƒè­°ç©ºé–“é…ç½®</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">30313</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">Meeting Room</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">å¯å®šå€</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">æœƒè­°æˆ¿é–“</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">10312</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">Room Presence</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">å¯æ›¿æ›</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ç”¨æˆ¶åœ¨å ´ç‹€æ…‹</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Live Event Structure -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">ç›´æ’­æ´»å‹•çµæ§‹ï¼ˆKind 30311ï¼‰</h2>
    <p class="text-[var(--text-secondary)] mb-4">
      ç›´æ’­æ´»å‹•äº‹ä»¶åŒ…å«è±å¯Œçš„å…ƒè³‡æ–™å’Œåƒèˆ‡è€…è³‡è¨Šï¼š
    </p>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse mb-4">
        <thead>
          <tr class="border-b border-[var(--border-default)]">
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">æ¨™ç±¤</th>
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">æ ¼å¼</th>
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">èªªæ˜</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">d</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["d", "&lt;uuid&gt;"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">å”¯ä¸€æ¨™è­˜ç¬¦ï¼ˆå¿…è¦ï¼‰</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">title</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["title", "&lt;name&gt;"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">æ´»å‹•æ¨™é¡Œ</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">summary</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["summary", "&lt;desc&gt;"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">æ´»å‹•æè¿°</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">image</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["image", "&lt;url&gt;"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">é è¦½åœ–ç‰‡</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">streaming</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["streaming", "&lt;url&gt;"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ç›´æ’­ä¸²æµ URL</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">recording</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["recording", "&lt;url&gt;"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">éŒ„å½±å›æ”¾ URL</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">starts</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["starts", "&lt;timestamp&gt;"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">é–‹å§‹æ™‚é–“</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">ends</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["ends", "&lt;timestamp&gt;"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">çµæŸæ™‚é–“</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">status</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["status", "live"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">planned / live / ended</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">p</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["p", "pubkey", "relay", "role", "proof"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">åƒèˆ‡è€…èˆ‡è§’è‰²</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">current_participants</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["current_participants", "100"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ç•¶å‰è§€çœ¾æ•¸</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Status Types -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">æ´»å‹•ç‹€æ…‹</h2>
    <div class="grid md:grid-cols-3 gap-4">
      <div class="p-4 rounded-lg bg-blue-500/10 border border-blue-500/20">
        <h4 class="font-semibold text-blue-400 mb-2 flex items-center gap-2">
          <span class="text-xl">ğŸ“…</span> planned
        </h4>
        <p class="text-sm text-[var(--text-secondary)]">
          å·²æ’ç¨‹ä½†å°šæœªé–‹å§‹çš„æ´»å‹•ã€‚é¡¯ç¤ºé è¨ˆé–‹å§‹æ™‚é–“ï¼Œè®“ç”¨æˆ¶å¯ä»¥é ç´„æé†’ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
        <h4 class="font-semibold text-green-400 mb-2 flex items-center gap-2">
          <span class="text-xl">ğŸ”´</span> live
        </h4>
        <p class="text-sm text-[var(--text-secondary)]">
          æ­£åœ¨é€²è¡Œä¸­çš„ç›´æ’­ã€‚ç”¨æˆ¶å¯ä»¥åŠ å…¥è§€çœ‹å’Œåƒèˆ‡èŠå¤©äº’å‹•ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-gray-500/10 border border-gray-500/20">
        <h4 class="font-semibold text-gray-400 mb-2 flex items-center gap-2">
          <span class="text-xl">â¹ï¸</span> ended
        </h4>
        <p class="text-sm text-[var(--text-secondary)]">
          å·²çµæŸçš„æ´»å‹•ã€‚å¯èƒ½åŒ…å«éŒ„å½±å›æ”¾é€£çµä¾›äº‹å¾Œè§€çœ‹ã€‚
        </p>
      </div>
    </div>
    <div class="mt-4 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
      <p class="text-sm text-[var(--text-secondary)]">
        <strong class="text-yellow-400">æ³¨æ„ï¼š</strong>
        å¦‚æœæ´»å‹•è¶…é 1 å°æ™‚æ²’æœ‰æ›´æ–°ï¼Œå®¢æˆ¶ç«¯å¯ä»¥å°‡å…¶è¦–ç‚ºå·²çµæŸã€‚
      </p>
    </div>
  </section>

  <!-- Participant Roles -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">åƒèˆ‡è€…è§’è‰²</h2>
    <p class="text-[var(--text-secondary)] mb-4">
      åƒèˆ‡è€…æ¨™ç±¤æ ¼å¼ï¼š<code class="px-2 py-1 rounded bg-[var(--inline-code-bg)] text-[var(--inline-code-text)]">["p", "pubkey", "relay", "role", "proof"]</code>
    </p>
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ‘‘ Host</h4>
        <p class="text-sm text-[var(--text-secondary)]">æ´»å‹•ä¸»æŒäººï¼Œæ“æœ‰å®Œæ•´æ§åˆ¶æ¬Š</p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ¤ Speaker</h4>
        <p class="text-sm text-[var(--text-secondary)]">è¬›è€…ï¼Œå¯ä»¥ç™¼è¨€æˆ–åˆ†äº«ç•«é¢</p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ‘¤ Participant</h4>
        <p class="text-sm text-[var(--text-secondary)]">ä¸€èˆ¬åƒèˆ‡è€…ï¼Œå¯è§€çœ‹å’ŒèŠå¤©</p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ›¡ï¸ Moderator</h4>
        <p class="text-sm text-[var(--text-secondary)]">ç®¡ç†å“¡ï¼Œå¯ç®¡ç†èŠå¤©å®¤</p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ  Owner</h4>
        <p class="text-sm text-[var(--text-secondary)]">æ“æœ‰è€…ï¼Œæœƒè­°ç©ºé–“æ‰€æœ‰äºº</p>
      </div>
    </div>
  </section>

  <!-- Examples -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">ä½¿ç”¨ç¯„ä¾‹</h2>

    <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-3">å‰µå»ºç›´æ’­æ´»å‹•</h3>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-6"><code class="text-sm text-gray-300">{`{
  "kind": 30311,
  "tags": [
    ["d", "abc123-live-event"],
    ["title", "Nostr é–‹ç™¼è€…èšæœƒ"],
    ["summary", "è¨è«– Nostr å”è­°çš„æœ€æ–°ç™¼å±•"],
    ["image", "https://example.com/cover.jpg"],
    ["streaming", "https://stream.example.com/live/abc123"],
    ["starts", "1704067200"],
    ["status", "planned"],
    ["p", "<host-pubkey>", "wss://relay.example.com", "Host"],
    ["p", "<speaker-pubkey>", "wss://relay.example.com", "Speaker"]
  ],
  "content": ""
}`}</code></pre>

    <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-3">æ­£åœ¨ç›´æ’­çš„æ´»å‹•</h3>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-6"><code class="text-sm text-gray-300">{`{
  "kind": 30311,
  "tags": [
    ["d", "abc123-live-event"],
    ["title", "Nostr é–‹ç™¼è€…èšæœƒ"],
    ["summary", "è¨è«– Nostr å”è­°çš„æœ€æ–°ç™¼å±•"],
    ["streaming", "https://stream.example.com/live/abc123"],
    ["starts", "1704067200"],
    ["status", "live"],
    ["current_participants", "256"],
    ["p", "<host-pubkey>", "wss://relay.example.com", "Host"],
    ["p", "<speaker1>", "", "Speaker"],
    ["p", "<speaker2>", "", "Speaker", "<proof-signature>"]
  ],
  "content": ""
}`}</code></pre>

    <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-3">ç›´æ’­èŠå¤©è¨Šæ¯</h3>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-6"><code class="text-sm text-gray-300">{`{
  "kind": 1311,
  "tags": [
    ["a", "30311:<host-pubkey>:abc123-live-event", "wss://relay.example.com"]
  ],
  "content": "é€™å€‹åŠŸèƒ½å¤ªæ£’äº†ï¼ğŸ‰"
}`}</code></pre>

    <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-3">å·²çµæŸï¼ˆå«éŒ„å½±ï¼‰</h3>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-6"><code class="text-sm text-gray-300">{`{
  "kind": 30311,
  "tags": [
    ["d", "abc123-live-event"],
    ["title", "Nostr é–‹ç™¼è€…èšæœƒ"],
    ["status", "ended"],
    ["starts", "1704067200"],
    ["ends", "1704074400"],
    ["recording", "https://video.example.com/recordings/abc123.mp4"],
    ["total_participants", "1024"]
  ],
  "content": ""
}`}</code></pre>
  </section>

  <!-- TypeScript Implementation -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">TypeScript å¯¦ä½œ</h2>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-4"><code class="text-sm text-gray-300">{`import { finalizeEvent, generateSecretKey, getPublicKey } from 'nostr-tools'
import { schnorr } from '@noble/curves/secp256k1'
import { sha256 } from '@noble/hashes/sha256'
import { bytesToHex } from '@noble/hashes/utils'

type LiveStatus = 'planned' | 'live' | 'ended'
type ParticipantRole = 'Host' | 'Speaker' | 'Participant' | 'Moderator' | 'Owner'

interface Participant {
  pubkey: string
  relay?: string
  role: ParticipantRole
  proof?: string
}

interface LiveEventOptions {
  id: string
  title: string
  summary?: string
  image?: string
  streamingUrl?: string
  recordingUrl?: string
  starts?: number
  ends?: number
  status: LiveStatus
  participants?: Participant[]
  currentParticipants?: number
  totalParticipants?: number
}

// å‰µå»ºç›´æ’­æ´»å‹•äº‹ä»¶
function createLiveEvent(
  options: LiveEventOptions,
  secretKey: Uint8Array
): object {
  const tags: string[][] = [
    ['d', options.id],
    ['title', options.title],
    ['status', options.status],
  ]

  if (options.summary) {
    tags.push(['summary', options.summary])
  }

  if (options.image) {
    tags.push(['image', options.image])
  }

  if (options.streamingUrl) {
    tags.push(['streaming', options.streamingUrl])
  }

  if (options.recordingUrl) {
    tags.push(['recording', options.recordingUrl])
  }

  if (options.starts) {
    tags.push(['starts', options.starts.toString()])
  }

  if (options.ends) {
    tags.push(['ends', options.ends.toString()])
  }

  if (options.currentParticipants !== undefined) {
    tags.push(['current_participants', options.currentParticipants.toString()])
  }

  if (options.totalParticipants !== undefined) {
    tags.push(['total_participants', options.totalParticipants.toString()])
  }

  // æ·»åŠ åƒèˆ‡è€…
  if (options.participants) {
    for (const p of options.participants) {
      const pTag = ['p', p.pubkey, p.relay || '', p.role]
      if (p.proof) {
        pTag.push(p.proof)
      }
      tags.push(pTag)
    }
  }

  const event = {
    kind: 30311,
    created_at: Math.floor(Date.now() / 1000),
    tags,
    content: '',
  }

  return finalizeEvent(event, secretKey)
}

// ç”Ÿæˆåƒèˆ‡è€…è­‰æ˜ç°½å
function generateParticipantProof(
  hostPubkey: string,
  eventId: string,
  participantSecretKey: Uint8Array
): string {
  const aTag = \`30311:\${hostPubkey}:\${eventId}\`
  const hash = sha256(new TextEncoder().encode(aTag))
  const signature = schnorr.sign(hash, participantSecretKey)
  return bytesToHex(signature)
}

// ç™¼é€ç›´æ’­èŠå¤©è¨Šæ¯
function createLiveChatMessage(
  hostPubkey: string,
  eventId: string,
  message: string,
  relay: string,
  secretKey: Uint8Array
): object {
  const aTag = \`30311:\${hostPubkey}:\${eventId}\`

  const event = {
    kind: 1311,
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['a', aTag, relay],
    ],
    content: message,
  }

  return finalizeEvent(event, secretKey)
}

// æ›´æ–°æ´»å‹•ç‹€æ…‹ç‚ºç›´æ’­ä¸­
function startLiveEvent(
  eventId: string,
  currentOptions: LiveEventOptions,
  secretKey: Uint8Array
): object {
  return createLiveEvent({
    ...currentOptions,
    id: eventId,
    status: 'live',
    starts: Math.floor(Date.now() / 1000),
  }, secretKey)
}

// çµæŸç›´æ’­æ´»å‹•
function endLiveEvent(
  eventId: string,
  currentOptions: LiveEventOptions,
  recordingUrl: string,
  totalParticipants: number,
  secretKey: Uint8Array
): object {
  return createLiveEvent({
    ...currentOptions,
    id: eventId,
    status: 'ended',
    ends: Math.floor(Date.now() / 1000),
    recordingUrl,
    totalParticipants,
  }, secretKey)
}

// ä½¿ç”¨ç¯„ä¾‹
const hostSk = generateSecretKey()
const hostPk = getPublicKey(hostSk)

const speakerSk = generateSecretKey()
const speakerPk = getPublicKey(speakerSk)

const eventId = 'nostr-dev-meetup-2024'

// å‰µå»ºæ’ç¨‹æ´»å‹•
const plannedEvent = createLiveEvent({
  id: eventId,
  title: 'Nostr é–‹ç™¼è€…èšæœƒ',
  summary: 'è¨è«– Nostr å”è­°çš„æœ€æ–°ç™¼å±•å’Œæœªä¾†è¨ˆç•«',
  image: 'https://example.com/cover.jpg',
  streamingUrl: 'https://stream.example.com/live/abc123',
  starts: Math.floor(Date.now() / 1000) + 86400, // æ˜å¤©
  status: 'planned',
  participants: [
    { pubkey: hostPk, role: 'Host' },
    { pubkey: speakerPk, relay: 'wss://relay.example.com', role: 'Speaker' },
  ],
}, hostSk)

// è¬›è€…ç”Ÿæˆåƒèˆ‡è­‰æ˜
const proof = generateParticipantProof(hostPk, eventId, speakerSk)
console.log('Speaker proof:', proof)

// ç™¼é€èŠå¤©è¨Šæ¯
const chatMessage = createLiveChatMessage(
  hostPk,
  eventId,
  'å¤§å®¶å¥½ï¼æœŸå¾…ä»Šå¤©çš„åˆ†äº«ï¼ğŸ‰',
  'wss://relay.example.com',
  speakerSk
)

console.log('Planned event:', plannedEvent)
console.log('Chat message:', chatMessage)`}</code></pre>
  </section>

  <!-- Query Live Events -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">æŸ¥è©¢ç›´æ’­æ´»å‹•</h2>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-4"><code class="text-sm text-gray-300">{`import { SimplePool } from 'nostr-tools'

const pool = new SimplePool()
const relays = ['wss://relay.example.com']

// æŸ¥è©¢æ­£åœ¨ç›´æ’­çš„æ´»å‹•
async function getLiveEvents() {
  const events = await pool.querySync(relays, {
    kinds: [30311],
    '#status': ['live'],
  })
  return events
}

// æŸ¥è©¢å³å°‡é–‹å§‹çš„æ´»å‹•
async function getUpcomingEvents() {
  const now = Math.floor(Date.now() / 1000)
  const events = await pool.querySync(relays, {
    kinds: [30311],
    '#status': ['planned'],
  })

  // éæ¿¾å‡ºæœªä¾†çš„æ´»å‹•
  return events.filter(event => {
    const startsTag = event.tags.find(t => t[0] === 'starts')
    if (!startsTag) return true
    return parseInt(startsTag[1]) > now
  })
}

// æŸ¥è©¢ç‰¹å®šæ´»å‹•çš„èŠå¤©è¨Šæ¯
async function getLiveChatMessages(hostPubkey: string, eventId: string) {
  const aTag = \`30311:\${hostPubkey}:\${eventId}\`
  const messages = await pool.querySync(relays, {
    kinds: [1311],
    '#a': [aTag],
  })
  return messages.sort((a, b) => a.created_at - b.created_at)
}

// è¨‚é–±ç›´æ’­èŠå¤©
function subscribeLiveChat(
  hostPubkey: string,
  eventId: string,
  onMessage: (message: any) => void
) {
  const aTag = \`30311:\${hostPubkey}:\${eventId}\`

  return pool.subscribeMany(
    relays,
    [{
      kinds: [1311],
      '#a': [aTag],
      since: Math.floor(Date.now() / 1000),
    }],
    {
      onevent(event) {
        onMessage(event)
      },
    }
  )
}

// è§£æç›´æ’­æ´»å‹•
function parseLiveEvent(event: any) {
  const getTag = (name: string) =>
    event.tags.find((t: string[]) => t[0] === name)?.[1]

  const participants = event.tags
    .filter((t: string[]) => t[0] === 'p')
    .map((t: string[]) => ({
      pubkey: t[1],
      relay: t[2] || undefined,
      role: t[3] || 'Participant',
      proof: t[4] || undefined,
    }))

  return {
    id: getTag('d'),
    title: getTag('title'),
    summary: getTag('summary'),
    image: getTag('image'),
    streamingUrl: getTag('streaming'),
    recordingUrl: getTag('recording'),
    starts: getTag('starts') ? parseInt(getTag('starts')!) : undefined,
    ends: getTag('ends') ? parseInt(getTag('ends')!) : undefined,
    status: getTag('status') as LiveStatus,
    currentParticipants: getTag('current_participants')
      ? parseInt(getTag('current_participants')!)
      : undefined,
    participants,
    host: event.pubkey,
    createdAt: event.created_at,
  }
}

// ä½¿ç”¨ç¯„ä¾‹
const liveEvents = await getLiveEvents()
console.log('æ­£åœ¨ç›´æ’­:', liveEvents.map(e => parseLiveEvent(e)))

const upcoming = await getUpcomingEvents()
console.log('å³å°‡é–‹å§‹:', upcoming.map(e => parseLiveEvent(e)))`}</code></pre>
  </section>

  <!-- Use Cases -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">æ‡‰ç”¨å ´æ™¯</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ“º è¦–è¨Šç›´æ’­</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          é¡ä¼¼ YouTube Live æˆ– Twitch çš„ç›´æ’­å¹³å°ï¼Œæ”¯æ´å³æ™‚èŠå¤©äº’å‹•ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ™ï¸ èªéŸ³æˆ¿é–“</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          é¡ä¼¼ Twitter Spaces æˆ– Clubhouse çš„èªéŸ³èŠå¤©å®¤ï¼Œå¦‚ Nostr Nestsã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ’¼ ç·šä¸Šæœƒè­°</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          å»ä¸­å¿ƒåŒ–çš„è¦–è¨Šæœƒè­°ï¼Œæ”¯æ´å¤šå€‹æˆ¿é–“å’Œæœƒè­°æ’ç¨‹ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ“ ç·šä¸Šèª²ç¨‹</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          æ•™è‚²ç›´æ’­ï¼Œæ”¯æ´èª²ç¨‹æ’ç¨‹ã€å­¸å“¡äº’å‹•å’ŒéŒ„å½±å›æ”¾ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ® éŠæˆ²ç›´æ’­</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          éŠæˆ²å¯¦æ³ç›´æ’­ï¼Œæ•´åˆæ‰“è³ï¼ˆZapsï¼‰åŠŸèƒ½ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸµ éŸ³æ¨‚è¡¨æ¼”</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          ç¾å ´éŸ³æ¨‚æ¼”å‡ºç›´æ’­ï¼Œè§€çœ¾å¯ä»¥é€é Zaps æ‰“è³è—äººã€‚
        </p>
      </div>
    </div>
  </section>

  <!-- Best Practices -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">æœ€ä½³å¯¦è¸</h2>
    <div class="space-y-4">
      <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
        <h4 class="font-semibold text-green-400 mb-2">âœ“ å®šæœŸæ›´æ–°æ´»å‹•ç‹€æ…‹</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          ç›´æ’­æœŸé–“å®šæœŸæ›´æ–°äº‹ä»¶ï¼ˆå»ºè­°æ¯ 5-10 åˆ†é˜ï¼‰ï¼Œæ›´æ–°è§€çœ¾æ•¸ç­‰è³‡è¨Šï¼Œé¿å…è¢«è¦–ç‚ºå·²çµæŸã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
        <h4 class="font-semibold text-green-400 mb-2">âœ“ ä½¿ç”¨åƒèˆ‡è€…è­‰æ˜</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          è¬›è€…æ‡‰æä¾› proof ç°½åï¼Œè­‰æ˜ä»–å€‘åŒæ„è¢«åˆ—ç‚ºåƒèˆ‡è€…ï¼Œé˜²æ­¢æƒ¡æ„ä¸»æŒäººå†’åã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
        <h4 class="font-semibold text-green-400 mb-2">âœ“ ä¿ç•™éŒ„å½±é€£çµ</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          æ´»å‹•çµæŸå¾Œæ›´æ–°äº‹ä»¶ï¼Œæ·»åŠ  recording æ¨™ç±¤è®“éŒ¯éç›´æ’­çš„ç”¨æˆ¶å¯ä»¥å›çœ‹ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
        <h4 class="font-semibold text-yellow-400 mb-2">âš  é™åˆ¶åƒèˆ‡è€…åˆ—è¡¨å¤§å°</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          å»ºè­°åƒèˆ‡è€…åˆ—è¡¨ä¸è¶…é 1000 äººï¼Œå¤§å‹æ´»å‹•æ‡‰ä½¿ç”¨ current_participants æ•¸å­—è€Œéåˆ—å‡ºæ‰€æœ‰äººã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
        <h4 class="font-semibold text-yellow-400 mb-2">âš  èŠå¤©è¨Šæ¯å¿…é ˆåŒ…å« a æ¨™ç±¤</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          kind 1311 èŠå¤©è¨Šæ¯å¿…é ˆåŒ…å«æŒ‡å‘æ´»å‹•çš„ a æ¨™ç±¤ï¼Œå¦å‰‡ç„¡æ³•æ­£ç¢ºé—œè¯ã€‚
        </p>
      </div>
    </div>
  </section>

  <!-- Related NIPs -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">ç›¸é—œ NIP</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <a
        href="/tech/nostr/nip-57"
        class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] hover:border-purple-500/50 transition-colors"
      >
        <h4 class="font-semibold text-[var(--text-primary)] mb-1">NIP-57 Zaps</h4>
        <p class="text-sm text-[var(--text-secondary)]">ç›´æ’­æ‰“è³åŠŸèƒ½</p>
      </a>
      <a
        href="/tech/nostr/nip-19"
        class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] hover:border-purple-500/50 transition-colors"
      >
        <h4 class="font-semibold text-[var(--text-primary)] mb-1">NIP-19 bech32 ç·¨ç¢¼</h4>
        <p class="text-sm text-[var(--text-secondary)]">naddr ç·¨ç¢¼åˆ†äº«æ´»å‹•é€£çµ</p>
      </a>
      <a
        href="/tech/nostr/nip-30"
        class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] hover:border-purple-500/50 transition-colors"
      >
        <h4 class="font-semibold text-[var(--text-primary)] mb-1">NIP-30 è‡ªè¨‚è¡¨æƒ…</h4>
        <p class="text-sm text-[var(--text-secondary)]">èŠå¤©è¨Šæ¯ä½¿ç”¨è‡ªè¨‚è¡¨æƒ…</p>
      </a>
      <a
        href="/tech/nostr/nip-38"
        class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] hover:border-purple-500/50 transition-colors"
      >
        <h4 class="font-semibold text-[var(--text-primary)] mb-1">NIP-38 ç”¨æˆ¶ç‹€æ…‹</h4>
        <p class="text-sm text-[var(--text-secondary)]">é¡¯ç¤ºç”¨æˆ¶æ­£åœ¨è§€çœ‹çš„ç›´æ’­</p>
      </a>
    </div>
  </section>

  <!-- Summary -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">ç¸½çµ</h2>
    <div class="p-6 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <p class="text-[var(--text-secondary)] mb-4">
        NIP-53 æä¾›äº†ä¸€å¥—å®Œæ•´çš„ç›´æ’­æ´»å‹•è§£æ±ºæ–¹æ¡ˆï¼Œæ”¯æ´è¦–è¨Šç›´æ’­ã€èªéŸ³æˆ¿é–“ã€ç·šä¸Šæœƒè­°ç­‰å¤šç¨®å ´æ™¯ã€‚
        é€éç‹€æ…‹ç®¡ç†ã€åƒèˆ‡è€…è§’è‰²å’Œå³æ™‚èŠå¤©ï¼Œæ‰“é€ å»ä¸­å¿ƒåŒ–çš„äº’å‹•é«”é©—ã€‚
      </p>
      <div class="grid md:grid-cols-4 gap-4 text-center">
        <div class="p-3 rounded-lg bg-[var(--bg-primary)]">
          <div class="text-2xl font-bold text-purple-400">30311</div>
          <div class="text-sm text-[var(--text-secondary)]">ç›´æ’­æ´»å‹•</div>
        </div>
        <div class="p-3 rounded-lg bg-[var(--bg-primary)]">
          <div class="text-2xl font-bold text-blue-400">1311</div>
          <div class="text-sm text-[var(--text-secondary)]">èŠå¤©è¨Šæ¯</div>
        </div>
        <div class="p-3 rounded-lg bg-[var(--bg-primary)]">
          <div class="text-2xl font-bold text-green-400">3 ç¨®</div>
          <div class="text-sm text-[var(--text-secondary)]">æ´»å‹•ç‹€æ…‹</div>
        </div>
        <div class="p-3 rounded-lg bg-[var(--bg-primary)]">
          <div class="text-2xl font-bold text-orange-400">5 ç¨®</div>
          <div class="text-sm text-[var(--text-secondary)]">åƒèˆ‡è€…è§’è‰²</div>
        </div>
      </div>
    </div>
  </section>
</ArticleLayout>
