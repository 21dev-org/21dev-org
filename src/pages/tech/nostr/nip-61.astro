---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-61: Nutzaps"
  description="ä½¿ç”¨ Cashu ecash é€²è¡Œ Zaps æ‰“è³"
  breadcrumbs={[
    { label: 'æŠ€è¡“', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-61' },
  ]}
>
  <h2 id="overview">æ¦‚è¿°</h2>
  <p>
    NIP-61 å®šç¾©äº† Nutzaps - ä½¿ç”¨ Cashu ecash ä»£å¹£é€²è¡Œæ‰“è³çš„æ©Ÿåˆ¶ã€‚ èˆ‡å‚³çµ±çš„é–ƒé›»ç¶²è·¯
    Zapsï¼ˆNIP-57ï¼‰ä¸åŒï¼ŒNutzaps æä¾›æ›´å¼·çš„éš±ç§æ€§ï¼Œ å› ç‚º Cashu
    ä½¿ç”¨ç›²ç°½åæŠ€è¡“ï¼Œé€ å¹£å» ç„¡æ³•è¿½è¹¤ä»£å¹£æµå‘ã€‚
  </p>

  <h2 id="advantages">Nutzaps å„ªå‹¢</h2>
  <ul>
    <li><strong>éš±ç§æ€§</strong>ï¼šç„¡æ³•è¿½è¹¤æ”¯ä»˜ä¾†æº</li>
    <li><strong>ç„¡éœ€ LNURL</strong>ï¼šä¸ä¾è³´é–ƒé›»ç¶²è·¯æœå‹™</li>
    <li><strong>å³æ™‚ç¢ºèª</strong>ï¼šç„¡éœ€ç­‰å¾…é–ƒé›»ç¶²è·¯ç¢ºèª</li>
    <li><strong>ä½æ‰‹çºŒè²»</strong>ï¼šCashu äº¤æ˜“é€šå¸¸å…è²»</li>
  </ul>

  <h2 id="event-kind">äº‹ä»¶é¡å‹</h2>

  <table>
    <thead>
      <tr>
        <th>Kind</th>
        <th>èªªæ˜</th>
        <th>é¡å‹</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>9321</code></td>
        <td>Nutzap äº‹ä»¶</td>
        <td>ä¸€èˆ¬äº‹ä»¶</td>
      </tr>
      <tr>
        <td><code>10019</code></td>
        <td>Nutzap è³‡è¨Š</td>
        <td>å¯æ›¿æ›äº‹ä»¶</td>
      </tr>
    </tbody>
  </table>

  <h2 id="nutzap-info">Nutzap è³‡è¨Š (Kind 10019)</h2>
  <p>ç”¨æˆ¶ç™¼å¸ƒæ­¤äº‹ä»¶ä¾†å®£å‘Šä»–å€‘æ¥å— Nutzaps ä»¥åŠåå¥½çš„é€ å¹£å» ã€‚</p>

  <h3>æ¨™ç±¤</h3>
  <table>
    <thead>
      <tr>
        <th>æ¨™ç±¤</th>
        <th>èªªæ˜</th>
        <th>ç¯„ä¾‹</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>mint</code></td>
        <td>æ¥å—çš„é€ å¹£å»  URL</td>
        <td><code>["mint", "https://mint.example.com", "sat"]</code></td>
      </tr>
      <tr>
        <td><code>relay</code></td>
        <td>æ¥æ”¶ Nutzaps çš„ä¸­ç¹¼å™¨</td>
        <td><code>["relay", "wss://relay.example.com"]</code></td>
      </tr>
      <tr>
        <td><code>pubkey</code></td>
        <td>P2PK é–å®šå…¬é‘°</td>
        <td><code>["pubkey", "hexå…¬é‘°"]</code></td>
      </tr>
    </tbody>
  </table>

  <h3>ç¯„ä¾‹</h3>
  <pre><code class="language-json" is:raw>{
  "kind": 10019,
  "pubkey": "æ¥æ”¶è€…å…¬é‘°",
  "tags": [
    ["mint", "https://mint.minibits.cash", "sat"],
    ["mint", "https://mint.coinos.io", "sat"],
    ["relay", "wss://relay.damus.io"],
    ["relay", "wss://nos.lol"],
    ["pubkey", "ç”¨æ–¼ P2PK é–å®šçš„å…¬é‘°"]
  ],
  "content": "",
  "created_at": 1700000000
}</code></pre>

  <h2 id="nutzap-event">Nutzap äº‹ä»¶ (Kind 9321)</h2>
  <p>å¯¦éš›çš„æ‰“è³äº‹ä»¶ï¼ŒåŒ…å« Cashu ä»£å¹£ã€‚</p>

  <h3>æ¨™ç±¤</h3>
  <table>
    <thead>
      <tr>
        <th>æ¨™ç±¤</th>
        <th>èªªæ˜</th>
        <th>å¿…è¦</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>amount</code></td>
        <td>é‡‘é¡ï¼ˆæœ€å°å–®ä½ï¼‰</td>
        <td>æ˜¯</td>
      </tr>
      <tr>
        <td><code>unit</code></td>
        <td>å–®ä½ï¼ˆsat, msat, usdï¼‰</td>
        <td>æ˜¯</td>
      </tr>
      <tr>
        <td><code>proof</code></td>
        <td>Cashu proof JSON</td>
        <td>æ˜¯</td>
      </tr>
      <tr>
        <td><code>u</code></td>
        <td>é€ å¹£å»  URL</td>
        <td>æ˜¯</td>
      </tr>
      <tr>
        <td><code>e</code></td>
        <td>è¢«æ‰“è³çš„äº‹ä»¶ ID</td>
        <td>å¦</td>
      </tr>
      <tr>
        <td><code>p</code></td>
        <td>è¢«æ‰“è³è€…å…¬é‘°</td>
        <td>æ˜¯</td>
      </tr>
    </tbody>
  </table>

  <h3>ç¯„ä¾‹</h3>
  <pre><code class="language-json" is:raw>{
  "kind": 9321,
  "pubkey": "æ‰“è³è€…å…¬é‘°",
  "tags": [
    ["amount", "100"],
    ["unit", "sat"],
    ["u", "https://mint.minibits.cash"],
    ["proof", "{\"amount\":64,\"id\":\"009a1f293253e41e\",\"secret\":\"...\",\"C\":\"...\"}"],
    ["proof", "{\"amount\":32,\"id\":\"009a1f293253e41e\",\"secret\":\"...\",\"C\":\"...\"}"],
    ["proof", "{\"amount\":4,\"id\":\"009a1f293253e41e\",\"secret\":\"...\",\"C\":\"...\"}"],
    ["e", "è¢«æ‰“è³çš„äº‹ä»¶ID", "wss://relay.example.com"],
    ["p", "è¢«æ‰“è³è€…å…¬é‘°"]
  ],
  "content": "è®šï¼å¾ˆæ£’çš„å…§å®¹ ğŸ‰",
  "created_at": 1700000000
}</code></pre>

  <h2 id="p2pk-locking">P2PK é–å®š</h2>
  <p>ç‚ºäº†ç¢ºä¿åªæœ‰æ¥æ”¶è€…èƒ½å¤ ä½¿ç”¨ä»£å¹£ï¼Œå¯ä»¥ä½¿ç”¨ P2PKï¼ˆPay to Public Keyï¼‰é–å®šï¼š</p>
  <ul>
    <li>æ‰“è³è€…ä½¿ç”¨æ¥æ”¶è€…çš„å…¬é‘°é–å®š Cashu ä»£å¹£</li>
    <li>åªæœ‰æ“æœ‰å°æ‡‰ç§é‘°çš„äººæ‰èƒ½è§£é–ä¸¦ä½¿ç”¨ä»£å¹£</li>
    <li>å³ä½¿ä»£å¹£è¢«æˆªç²ï¼Œä¹Ÿç„¡æ³•è¢«ç›œç”¨</li>
  </ul>

  <h2 id="implementation">TypeScript å¯¦ä½œ</h2>

  <h3>ç™¼å¸ƒ Nutzap è³‡è¨Š</h3>
  <pre><code class="language-typescript" is:raw>import { finalizeEvent } from 'nostr-tools';

interface NutzapConfig {
  mints: { url: string; unit: string }[];
  relays: string[];
  p2pkPubkey?: string;
}

function createNutzapInfo(
  config: NutzapConfig,
  secretKey: Uint8Array
) {
  const tags: string[][] = [];

  config.mints.forEach((mint) => {
    tags.push(['mint', mint.url, mint.unit]);
  });

  config.relays.forEach((relay) => {
    tags.push(['relay', relay]);
  });

  if (config.p2pkPubkey) {
    tags.push(['pubkey', config.p2pkPubkey]);
  }

  return finalizeEvent(
    {
      kind: 10019,
      content: '',
      tags,
      created_at: Math.floor(Date.now() / 1000),
    },
    secretKey
  );
}

// ä½¿ç”¨ç¯„ä¾‹
const nutzapInfo = createNutzapInfo(
  {
    mints: [
      { url: 'https://mint.minibits.cash', unit: 'sat' },
      { url: 'https://mint.coinos.io', unit: 'sat' },
    ],
    relays: ['wss://relay.damus.io', 'wss://nos.lol'],
    p2pkPubkey: 'hexå…¬é‘°',
  },
  secretKey
);</code></pre>

  <h3>ç™¼é€ Nutzap</h3>
  <pre><code class="language-typescript" is:raw>import { CashuMint, CashuWallet, getEncodedToken, Proof } from '@cashu/cashu-ts';

interface NutzapTarget {
  pubkey: string;
  eventId?: string;
  relayHint?: string;
}

async function sendNutzap(
  mintUrl: string,
  proofs: Proof[],
  amount: number,
  target: NutzapTarget,
  message: string,
  secretKey: Uint8Array
) {
  const mint = new CashuMint(mintUrl);
  const wallet = new CashuWallet(mint);

  // é¸æ“‡ä¸¦æ‹†åˆ†ä»£å¹£
  const { send } = await wallet.send(amount, proofs);

  // å»ºç«‹ Nutzap äº‹ä»¶
  const tags: string[][] = [
    ['amount', amount.toString()],
    ['unit', 'sat'],
    ['u', mintUrl],
    ['p', target.pubkey],
  ];

  // æ·»åŠ æ¯å€‹ proof ä½œç‚ºå–®ç¨çš„æ¨™ç±¤
  send.forEach((proof) => {
    tags.push(['proof', JSON.stringify(proof)]);
  });

  if (target.eventId) {
    const eventTag = ['e', target.eventId];
    if (target.relayHint) {
      eventTag.push(target.relayHint);
    }
    tags.push(eventTag);
  }

  return finalizeEvent(
    {
      kind: 9321,
      content: message,
      tags,
      created_at: Math.floor(Date.now() / 1000),
    },
    secretKey
  );
}

// ä½¿ç”¨ç¯„ä¾‹
const nutzap = await sendNutzap(
  'https://mint.minibits.cash',
  myProofs,
  100,
  {
    pubkey: 'è¢«æ‰“è³è€…å…¬é‘°',
    eventId: 'äº‹ä»¶ID',
    relayHint: 'wss://relay.example.com',
  },
  'å¾ˆæ£’çš„å…§å®¹ï¼',
  secretKey
);</code></pre>

  <h3>æ¥æ”¶ Nutzaps</h3>
  <pre><code class="language-typescript" is:raw>import { SimplePool } from 'nostr-tools';

interface ReceivedNutzap {
  id: string;
  from: string;
  amount: number;
  unit: string;
  mint: string;
  proofs: Proof[];
  message: string;
  eventId?: string;
  createdAt: number;
}

async function getReceivedNutzaps(
  pool: SimplePool,
  relays: string[],
  pubkey: string,
  since?: number
): Promise&lt;ReceivedNutzap[]&gt; {
  const filter: any = {
    kinds: [9321],
    '#p': [pubkey],
  };

  if (since) {
    filter.since = since;
  }

  const events = await pool.querySync(relays, filter);

  return events.map((event) => {
    const getTag = (name: string) =>
      event.tags.find((t: string[]) => t[0] === name)?.[1];

    const proofs = event.tags
      .filter((t: string[]) => t[0] === 'proof')
      .map((t: string[]) => JSON.parse(t[1]));

    return {
      id: event.id,
      from: event.pubkey,
      amount: parseInt(getTag('amount') || '0'),
      unit: getTag('unit') || 'sat',
      mint: getTag('u') || '',
      proofs,
      message: event.content,
      eventId: getTag('e'),
      createdAt: event.created_at,
    };
  });
}

// å…Œæ›æ”¶åˆ°çš„ Nutzaps
async function redeemNutzap(
  nutzap: ReceivedNutzap,
  secretKey: Uint8Array
): Promise&lt;Proof[]&gt; {
  const mint = new CashuMint(nutzap.mint);
  const wallet = new CashuWallet(mint);

  // å¦‚æœæ˜¯ P2PK é–å®šçš„ï¼Œéœ€è¦æä¾›ç§é‘°
  const newProofs = await wallet.receive(nutzap.proofs, {
    privkey: bytesToHex(secretKey),
  });

  return newProofs;
}</code></pre>

  <h3>æŸ¥è©¢ç”¨æˆ¶çš„ Nutzap é…ç½®</h3>
  <pre><code class="language-typescript" is:raw>interface UserNutzapConfig {
  mints: { url: string; unit: string }[];
  relays: string[];
  p2pkPubkey?: string;
}

async function getUserNutzapConfig(
  pool: SimplePool,
  relays: string[],
  pubkey: string
): Promise&lt;UserNutzapConfig | null&gt; {
  const events = await pool.querySync(relays, {
    kinds: [10019],
    authors: [pubkey],
  });

  if (events.length === 0) {
    return null;
  }

  // å–æœ€æ–°çš„
  const event = events.sort((a, b) => b.created_at - a.created_at)[0];

  const mints = event.tags
    .filter((t: string[]) => t[0] === 'mint')
    .map((t: string[]) => ({ url: t[1], unit: t[2] || 'sat' }));

  const configRelays = event.tags
    .filter((t: string[]) => t[0] === 'relay')
    .map((t: string[]) => t[1]);

  const pubkeyTag = event.tags.find((t: string[]) => t[0] === 'pubkey');

  return {
    mints,
    relays: configRelays,
    p2pkPubkey: pubkeyTag?.[1],
  };
}

// æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æ”¯æ´ Nutzaps
async function supportsNutzaps(
  pool: SimplePool,
  relays: string[],
  pubkey: string
): Promise&lt;boolean&gt; {
  const config = await getUserNutzapConfig(pool, relays, pubkey);
  return config !== null &amp;&amp; config.mints.length &gt; 0;
}</code></pre>

  <h2 id="comparison">Nutzaps vs å‚³çµ± Zaps</h2>

  <table>
    <thead>
      <tr>
        <th>ç‰¹æ€§</th>
        <th>Zaps (NIP-57)</th>
        <th>Nutzaps (NIP-61)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>æ”¯ä»˜ç¶²è·¯</td>
        <td>é–ƒé›»ç¶²è·¯</td>
        <td>Cashu ecash</td>
      </tr>
      <tr>
        <td>éš±ç§æ€§</td>
        <td>å¯è¿½è¹¤</td>
        <td>ä¸å¯è¿½è¹¤</td>
      </tr>
      <tr>
        <td>è¨­ç½®è¦æ±‚</td>
        <td>LNURL æœå‹™</td>
        <td>åƒ…éœ€ç™¼å¸ƒ kind 10019</td>
      </tr>
      <tr>
        <td>ç¢ºèªæ™‚é–“</td>
        <td>éœ€ç­‰å¾…é–ƒé›»ç¶²è·¯</td>
        <td>å³æ™‚</td>
      </tr>
      <tr>
        <td>è¨—ç®¡é¢¨éšª</td>
        <td>ç„¡ï¼ˆéè¨—ç®¡ï¼‰</td>
        <td>æœ‰ï¼ˆé€ å¹£å» è¨—ç®¡ï¼‰</td>
      </tr>
      <tr>
        <td>äº’æ“ä½œæ€§</td>
        <td>éœ€ LNURL æ”¯æ´</td>
        <td>åªéœ€ Cashu æ”¯æ´</td>
      </tr>
    </tbody>
  </table>

  <h2 id="security">å®‰å…¨è€ƒé‡</h2>
  <ul>
    <li><strong>é€ å¹£å» ä¿¡ä»»</strong>ï¼šCashu æ˜¯è¨—ç®¡å¼çš„ï¼Œé¸æ“‡å¯ä¿¡çš„é€ å¹£å» </li>
    <li><strong>P2PK é–å®š</strong>ï¼šå»ºè­°ä½¿ç”¨ P2PK é˜²æ­¢ä»£å¹£è¢«æˆªç²</li>
    <li><strong>åŠæ™‚å…Œæ›</strong>ï¼šæ”¶åˆ° Nutzap å¾Œæ‡‰åŠæ™‚å…Œæ›ï¼Œé˜²æ­¢é€ å¹£å» å€’é–‰</li>
    <li><strong>å¤šé€ å¹£å» </strong>ï¼šåˆ†æ•£ä½¿ç”¨å¤šå€‹é€ å¹£å» é™ä½é¢¨éšª</li>
  </ul>

  <h2 id="related-nips">ç›¸é—œ NIPs</h2>
  <ul>
    <li><a href="/tech/nostr/nip-57">NIP-57</a>ï¼šZaps - é–ƒé›»ç¶²è·¯æ‰“è³</li>
    <li><a href="/tech/nostr/nip-60">NIP-60</a>ï¼šCashu Wallet - éŒ¢åŒ…ç®¡ç†</li>
    <li><a href="/tech/nostr/nip-44">NIP-44</a>ï¼šåŠ å¯†è¨Šæ¯ v2 - å…§å®¹åŠ å¯†</li>
  </ul>

  <h2 id="references">åƒè€ƒè³‡æº</h2>
  <ul>
    <li>
      <a
        href="https://github.com/nostr-protocol/nips/blob/master/61.md"
        target="_blank"
        rel="noopener noreferrer">NIP-61 è¦ç¯„</a
      >
    </li>
    <li><a href="https://cashu.space/" target="_blank" rel="noopener noreferrer">Cashu å®˜ç¶²</a></li>
    <li>
      <a href="https://github.com/cashubtc/cashu-ts" target="_blank" rel="noopener noreferrer"
        >cashu-ts</a
      >
    </li>
  </ul>
</ArticleLayout>
