---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-70: å—ä¿è­·äº‹ä»¶"
  description="ä½¿ç”¨ - æ¨™ç±¤é˜²æ­¢äº‹ä»¶è¢«ä¸­ç¹¼å™¨å»£æ’­åˆ°å…¶ä»–åœ°æ–¹"
  breadcrumbs={[
    { label: 'æŠ€è¡“', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-70' },
  ]}
>
  <h2 id="overview">æ¦‚è¿°</h2>
  <p>
    NIP-70 å®šç¾©äº† <code>"-"</code> æ¨™ç±¤ï¼Œç”¨æ–¼æ¨™è¨˜äº‹ä»¶ç‚ºã€Œå—ä¿è­·ã€ç‹€æ…‹ã€‚ ç•¶äº‹ä»¶åŒ…å«æ­¤æ¨™ç±¤æ™‚ï¼Œä¸­ç¹¼å™¨æ‡‰è©²æ‹’çµ•å°‡è©²äº‹ä»¶å»£æ’­åˆ°å…¶ä»–ä¸­ç¹¼å™¨ï¼Œ
    ç¢ºä¿äº‹ä»¶åƒ…ä¿ç•™åœ¨ç”¨æˆ¶é¸æ“‡ç™¼å¸ƒçš„ä¸­ç¹¼å™¨ä¸Šã€‚
  </p>

  <h2 id="tag-format">æ¨™ç±¤æ ¼å¼</h2>
  <pre><code class="language-json" is:raw>["-"]</code></pre>

  <p>
    é€™æ˜¯ä¸€å€‹ç°¡å–®çš„å–®å…ƒç´ æ¨™ç±¤ï¼Œä¸éœ€è¦ä»»ä½•é¡å¤–åƒæ•¸ã€‚
    ç•¶ä¸­ç¹¼å™¨çœ‹åˆ°åŒ…å«æ­¤æ¨™ç±¤çš„äº‹ä»¶æ™‚ï¼Œæ‡‰éµå®ˆä»¥ä¸‹è¡Œç‚ºæº–å‰‡ã€‚
  </p>

  <h2 id="relay-behavior">ä¸­ç¹¼å™¨è¡Œç‚º</h2>

  <h3>æ¥æ”¶äº‹ä»¶æ™‚</h3>
  <ul>
    <li>æ¥å—ä¸¦å„²å­˜ä¾†è‡ªåŸå§‹ä½œè€…çš„å—ä¿è­·äº‹ä»¶</li>
    <li><strong>æ‹’çµ•</strong>ä¾†è‡ªå…¶ä»–å®¢æˆ¶ç«¯/ä¸­ç¹¼å™¨çš„è½‰ç™¼</li>
    <li>é©—è­‰äº‹ä»¶ç¢ºå¯¦ä¾†è‡ªåŸå§‹ç™¼å¸ƒè€…</li>
  </ul>

  <h3>å›æ‡‰è¨‚é–±æ™‚</h3>
  <ul>
    <li>æ­£å¸¸å›æ‡‰è¨‚é–±è©²äº‹ä»¶çš„å®¢æˆ¶ç«¯</li>
    <li>ä¸ä¸»å‹•å°‡äº‹ä»¶æ¨é€åˆ°å…¶ä»–ä¸­ç¹¼å™¨</li>
  </ul>

  <h3>éŒ¯èª¤å›æ‡‰</h3>
  <pre><code class="language-json" is:raw>["OK", "&lt;event-id&gt;", false, "blocked: event is protected"]</code></pre>

  <h2 id="use-cases">ä½¿ç”¨å ´æ™¯</h2>

  <h3>ä»˜è²»ä¸­ç¹¼å™¨å…§å®¹</h3>
  <p>ä½œè€…å¸Œæœ›å°‡ç¨å®¶å…§å®¹é™åˆ¶åœ¨ä»˜è²»ä¸­ç¹¼å™¨ï¼Œé˜²æ­¢å…è²»ä¸­ç¹¼å™¨ç²å–ä¸¦é‡æ–°ç™¼å¸ƒã€‚</p>

  <h3>ç§å¯†ç¤¾ç¾¤</h3>
  <p>ç¤¾ç¾¤æˆå“¡åœ¨å°ˆå±¬ä¸­ç¹¼å™¨åˆ†äº«å…§å®¹ï¼Œä¸å¸Œæœ›è¢«å¤–éƒ¨ç´¢å¼•æˆ–å­˜æª”ã€‚</p>

  <h3>è‰ç¨¿èˆ‡æ¸¬è©¦</h3>
  <p>é–‹ç™¼è€…æˆ–ä½œè€…ç™¼å¸ƒè‰ç¨¿å…§å®¹é€²è¡Œæ¸¬è©¦ï¼Œä¸å¸Œæœ›è¢«å…¶ä»–ä¸­ç¹¼å™¨æ°¸ä¹…ä¿å­˜ã€‚</p>

  <h3>åœ°ç†é™åˆ¶</h3>
  <p>æŸäº›å…§å®¹åƒ…é©åˆåœ¨ç‰¹å®šå€åŸŸçš„ä¸­ç¹¼å™¨ç™¼å¸ƒï¼Œä¸å¸Œæœ›å…¨çƒå‚³æ’­ã€‚</p>

  <h2 id="examples">ç¯„ä¾‹</h2>

  <h3>å—ä¿è­·çš„çŸ­æ–‡</h3>
  <pre><code class="language-json" is:raw>{
  "kind": 1,
  "content": "é€™æ˜¯åƒ…é™æ­¤ä¸­ç¹¼å™¨çš„ç¨å®¶å…§å®¹ï¼",
  "tags": [
    ["-"]
  ],
  "created_at": 1234567890,
  "pubkey": "...",
  "id": "...",
  "sig": "..."
}</code></pre>

  <h3>å—ä¿è­·çš„é•·æ–‡</h3>
  <pre><code class="language-json" is:raw>{
  "kind": 30023,
  "content": "# ä»˜è²»æœƒå“¡å°ˆå±¬æ–‡ç« \n\né€™ç¯‡æ–‡ç« åƒ…ä¾›ä»˜è²»ä¸­ç¹¼å™¨æœƒå“¡é–±è®€...",
  "tags": [
    ["d", "exclusive-article-2024"],
    ["title", "æœƒå“¡å°ˆå±¬æ–‡ç« "],
    ["-"]
  ]
}</code></pre>

  <h3>å—ä¿è­·çš„åª’é«”äº‹ä»¶</h3>
  <pre><code class="language-json" is:raw>{
  "kind": 1063,
  "content": "ç¨å®¶å½±ç‰‡å…§å®¹",
  "tags": [
    ["url", "https://exclusive-relay.com/video.mp4"],
    ["m", "video/mp4"],
    ["-"]
  ]
}</code></pre>

  <h2 id="implementation">TypeScript å¯¦ä½œ</h2>

  <h3>å»ºç«‹å—ä¿è­·äº‹ä»¶</h3>
  <pre><code class="language-typescript" is:raw>import { finalizeEvent } from 'nostr-tools';

function createProtectedEvent(
  content: string,
  kind: number = 1,
  additionalTags: string[][] = [],
  secretKey: Uint8Array
) {
  const tags: string[][] = [
    ['-'], // ä¿è­·æ¨™ç±¤
    ...additionalTags,
  ];

  const event = {
    kind,
    content,
    tags,
    created_at: Math.floor(Date.now() / 1000),
  };

  return finalizeEvent(event, secretKey);
}

// ä½¿ç”¨ç¯„ä¾‹ï¼šå»ºç«‹å—ä¿è­·çŸ­æ–‡
const protectedNote = createProtectedEvent(
  'é€™æ˜¯åƒ…é™æ­¤ä¸­ç¹¼å™¨çš„å…§å®¹',
  1,
  [],
  secretKey
);

// ä½¿ç”¨ç¯„ä¾‹ï¼šå»ºç«‹å—ä¿è­·é•·æ–‡
const protectedArticle = createProtectedEvent(
  '# æœƒå“¡å°ˆå±¬\n\nè©³ç´°å…§å®¹...',
  30023,
  [
    ['d', 'members-only-article'],
    ['title', 'æœƒå“¡å°ˆå±¬æ–‡ç« '],
  ],
  secretKey
);</code></pre>

  <h3>æª¢æ¸¬å—ä¿è­·äº‹ä»¶</h3>
  <pre><code class="language-typescript" is:raw>function isProtectedEvent(event: any): boolean {
  return event.tags.some((tag: string[]) => tag[0] === '-' && tag.length === 1);
}

function getProtectionStatus(event: any): {
  isProtected: boolean;
  canRebroadcast: boolean;
} {
  const isProtected = isProtectedEvent(event);

  return {
    isProtected,
    canRebroadcast: !isProtected,
  };
}

// ä½¿ç”¨ç¯„ä¾‹
const status = getProtectionStatus(event);
if (status.isProtected) {
  console.log('æ­¤äº‹ä»¶å—ä¿è­·ï¼Œä¸æ‡‰è½‰ç™¼åˆ°å…¶ä»–ä¸­ç¹¼å™¨');
}</code></pre>

  <h3>ä¸­ç¹¼å™¨ç«¯é©—è­‰</h3>
  <pre><code class="language-typescript" is:raw>interface RelayValidationResult {
  accepted: boolean;
  message?: string;
}

function validateIncomingEvent(
  event: any,
  sourceType: 'client' | 'relay',
  senderPubkey?: string
): RelayValidationResult {
  const isProtected = isProtectedEvent(event);

  // å—ä¿è­·äº‹ä»¶åªæ¥å—ä¾†è‡ªåŸå§‹ä½œè€…çš„ç›´æ¥ç™¼å¸ƒ
  if (isProtected) {
    if (sourceType === 'relay') {
      return {
        accepted: false,
        message: 'blocked: event is protected',
      };
    }

    // å¦‚æœæ˜¯å®¢æˆ¶ç«¯ç™¼é€ï¼Œé©—è­‰æ˜¯å¦ç‚ºä½œè€…æœ¬äºº
    if (senderPubkey && senderPubkey !== event.pubkey) {
      return {
        accepted: false,
        message: 'blocked: protected events can only be published by author',
      };
    }
  }

  return { accepted: true };
}

// ä½¿ç”¨ç¯„ä¾‹
const result = validateIncomingEvent(event, 'relay');
if (!result.accepted) {
  // ç™¼é€ OK å›æ‡‰è¡¨ç¤ºæ‹’çµ•
  sendMessage(['OK', event.id, false, result.message]);
}</code></pre>

  <h3>å®¢æˆ¶ç«¯è™•ç†</h3>
  <pre><code class="language-typescript" is:raw>interface PublishOptions {
  relays: string[];
  protect?: boolean;
}

async function publishEvent(
  content: string,
  kind: number,
  options: PublishOptions,
  secretKey: Uint8Array
) {
  const tags: string[][] = [];

  // å¦‚æœéœ€è¦ä¿è­·ï¼Œæ·»åŠ  - æ¨™ç±¤
  if (options.protect) {
    tags.push(['-']);
  }

  const event = finalizeEvent(
    {
      kind,
      content,
      tags,
      created_at: Math.floor(Date.now() / 1000),
    },
    secretKey
  );

  // ç™¼å¸ƒåˆ°æŒ‡å®šä¸­ç¹¼å™¨
  const results = await Promise.allSettled(
    options.relays.map((relay) => publishToRelay(relay, event))
  );

  return {
    event,
    results: results.map((r, i) => ({
      relay: options.relays[i],
      success: r.status === 'fulfilled' && r.value.success,
      message: r.status === 'fulfilled' ? r.value.message : r.reason,
    })),
  };
}

// ä½¿ç”¨ç¯„ä¾‹ï¼šç™¼å¸ƒå—ä¿è­·äº‹ä»¶åˆ°ä»˜è²»ä¸­ç¹¼å™¨
const result = await publishEvent(
  'æœƒå“¡å°ˆå±¬å…§å®¹',
  1,
  {
    relays: ['wss://paid-relay.example.com'],
    protect: true,
  },
  secretKey
);

console.log(`å·²ç™¼å¸ƒåˆ° ${result.results.filter((r) => r.success).length} å€‹ä¸­ç¹¼å™¨`);</code></pre>

  <h3>UI æŒ‡ç¤ºå™¨</h3>
  <pre><code class="language-typescript" is:raw>// React å…ƒä»¶ç¯„ä¾‹
function ProtectedBadge({ event }: { event: any }) {
  if (!isProtectedEvent(event)) {
    return null;
  }

  return (
    &lt;div className="protected-badge"&gt;
      &lt;span className="icon"&gt;ğŸ”’&lt;/span&gt;
      &lt;span&gt;å—ä¿è­·äº‹ä»¶&lt;/span&gt;
      &lt;span className="tooltip"&gt;
        æ­¤å…§å®¹åƒ…åœ¨ç‰¹å®šä¸­ç¹¼å™¨å¯è¦‹
      &lt;/span&gt;
    &lt;/div&gt;
  );
}

function EventActions({ event }: { event: any }) {
  const isProtected = isProtectedEvent(event);

  return (
    &lt;div className="actions"&gt;
      &lt;button disabled={isProtected}&gt;
        è½‰ç™¼
      &lt;/button&gt;
      {isProtected && (
        &lt;span className="hint"&gt;å—ä¿è­·äº‹ä»¶ç„¡æ³•è½‰ç™¼&lt;/span&gt;
      )}
    &lt;/div&gt;
  );
}</code></pre>

  <h2 id="security-considerations">å®‰å…¨è€ƒé‡</h2>

  <h3>éåŠ å¯†ä¿è­·</h3>
  <p>
    <code>"-"</code> æ¨™ç±¤åƒ…è¡¨é”ä½œè€…æ„åœ–ï¼Œä¸æä¾›åŠ å¯†ä¿è­·ã€‚ ä»»ä½•æ¥æ”¶åˆ°äº‹ä»¶çš„å®¢æˆ¶ç«¯ä»ç„¶å¯ä»¥è®€å–å…§å®¹ã€‚æ­¤æ©Ÿåˆ¶ä¾è³´æ–¼ä¸­ç¹¼å™¨çš„åˆä½œã€‚
  </p>

  <h3>ä¸­ç¹¼å™¨ä¿¡ä»»</h3>
  <ul>
    <li>æƒ¡æ„ä¸­ç¹¼å™¨å¯èƒ½å¿½ç•¥æ­¤æ¨™ç±¤ä¸¦è½‰ç™¼äº‹ä»¶</li>
    <li>é¸æ“‡ä¿¡è­½è‰¯å¥½çš„ä¸­ç¹¼å™¨å¾ˆé‡è¦</li>
    <li>å°æ–¼çœŸæ­£æ•æ„Ÿçš„å…§å®¹ï¼Œæ‡‰ä½¿ç”¨åŠ å¯†ï¼ˆå¦‚ NIP-44ï¼‰</li>
  </ul>

  <h3>å®¢æˆ¶ç«¯è²¬ä»»</h3>
  <ul>
    <li>å®¢æˆ¶ç«¯æ‡‰å°Šé‡æ­¤æ¨™ç±¤ï¼Œä¸ä¸»å‹•è½‰ç™¼å—ä¿è­·äº‹ä»¶</li>
    <li>æ‡‰åœ¨ UI ä¸­æ¸…æ¥šæ¨™ç¤ºå—ä¿è­·ç‹€æ…‹</li>
    <li>ç¦ç”¨æˆ–è­¦å‘Šå¯èƒ½å°è‡´è½‰ç™¼çš„æ“ä½œ</li>
  </ul>

  <h2 id="best-practices">æœ€ä½³å¯¦è¸</h2>
  <ul>
    <li><strong>æ˜ç¢ºæ¨™ç¤º</strong>ï¼šåœ¨ UI ä¸­æ¸…æ¥šé¡¯ç¤ºäº‹ä»¶çš„ä¿è­·ç‹€æ…‹</li>
    <li><strong>é¸æ“‡æ€§ç™¼å¸ƒ</strong>ï¼šåƒ…ç™¼å¸ƒåˆ°ä¿¡ä»»çš„ä¸­ç¹¼å™¨</li>
    <li><strong>çµåˆåŠ å¯†</strong>ï¼šå°æ•æ„Ÿå…§å®¹åŒæ™‚ä½¿ç”¨åŠ å¯†å’Œä¿è­·æ¨™ç±¤</li>
    <li><strong>å‘ŠçŸ¥ç”¨æˆ¶</strong>ï¼šè§£é‡‹ä¿è­·æ©Ÿåˆ¶çš„é™åˆ¶</li>
    <li><strong>é©—è­‰ä¾†æº</strong>ï¼šä¸­ç¹¼å™¨æ‡‰é©—è­‰äº‹ä»¶ç¢ºå¯¦ä¾†è‡ªä½œè€…</li>
  </ul>

  <h2 id="limitations">é™åˆ¶</h2>
  <ul>
    <li>ä¾è³´ä¸­ç¹¼å™¨åˆä½œï¼Œç„¡æ³•å¼·åˆ¶åŸ·è¡Œ</li>
    <li>ä¸é˜²æ­¢å·²æ¥æ”¶å…§å®¹çš„ç”¨æˆ¶æ‰‹å‹•åˆ†äº«</li>
    <li>ä¸æä¾›å…§å®¹åŠ å¯†</li>
    <li>å¯èƒ½å½±éŸ¿å…§å®¹çš„å¯ç™¼ç¾æ€§å’Œå‚³æ’­</li>
  </ul>

  <h2 id="related-nips">ç›¸é—œ NIPs</h2>
  <ul>
    <li><a href="/tech/nostr/nip-01">NIP-01</a>ï¼šåŸºæœ¬å”è­° - äº‹ä»¶æ ¼å¼</li>
    <li><a href="/tech/nostr/nip-42">NIP-42</a>ï¼šä¸­ç¹¼å™¨èªè­‰ - å®¢æˆ¶ç«¯èº«ä»½é©—è­‰</li>
    <li><a href="/tech/nostr/nip-44">NIP-44</a>ï¼šåŠ å¯†è¨Šæ¯ - å…§å®¹åŠ å¯†</li>
    <li><a href="/tech/nostr/nip-65">NIP-65</a>ï¼šä¸­ç¹¼å™¨åˆ—è¡¨ - é¸æ“‡ç™¼å¸ƒç›®æ¨™</li>
  </ul>

  <h2 id="references">åƒè€ƒè³‡æº</h2>
  <ul>
    <li>
      <a
        href="https://github.com/nostr-protocol/nips/blob/master/70.md"
        target="_blank"
        rel="noopener noreferrer">NIP-70 è¦ç¯„</a
      >
    </li>
    <li>
      <a href="https://github.com/nbd-wtf/nostr-tools" target="_blank" rel="noopener noreferrer"
        >nostr-tools</a
      >
    </li>
  </ul>
</ArticleLayout>
