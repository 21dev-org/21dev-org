---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-55: Android Signer Application"
  description="Android 平台的 Nostr 簽名應用程式標準，實現安全的密鑰管理"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-55' },
  ]}
>
  <h2 id="overview">概述</h2>
  <p>
    NIP-55 定義了 Android 平台上 Nostr 簽名應用程式的標準介面。類似於 NIP-07
    在瀏覽器中的作用，NIP-55 允許 Android 應用程式將簽名操作委託給專門的簽名應用，
    實現密鑰的安全隔離和統一管理。
  </p>

  <h2 id="architecture">架構設計</h2>

  <p>NIP-55 使用 Android 的 Intent 和 Content Provider 機制：</p>

  <ul>
    <li><strong>簽名應用（Signer）</strong>：保管私鑰，處理簽名請求</li>
    <li><strong>客戶端應用（Client）</strong>：發送簽名請求，不接觸私鑰</li>
    <li><strong>Intent</strong>：用於應用間通訊</li>
    <li><strong>Content Provider</strong>：用於返回結果</li>
  </ul>

  <h2 id="intent-actions">Intent Actions</h2>

  <h3>簽名應用宣告</h3>
  <pre><code class="language-xml" is:raw>&lt;intent-filter&gt;
  &lt;action android:name="android.intent.action.VIEW" /&gt;
  &lt;category android:name="android.intent.category.DEFAULT" /&gt;
  &lt;category android:name="android.intent.category.BROWSABLE" /&gt;
  &lt;data android:scheme="nostrsigner" /&gt;
&lt;/intent-filter&gt;</code></pre>

  <h3>支援的操作</h3>
  <table>
    <thead>
      <tr>
        <th>操作</th>
        <th>URI Scheme</th>
        <th>說明</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>取得公鑰</td>
        <td><code>nostrsigner:get_public_key</code></td>
        <td>獲取用戶的公鑰</td>
      </tr>
      <tr>
        <td>簽名事件</td>
        <td><code>nostrsigner:sign_event</code></td>
        <td>簽署 Nostr 事件</td>
      </tr>
      <tr>
        <td>加密訊息</td>
        <td><code>nostrsigner:nip04_encrypt</code></td>
        <td>NIP-04 加密</td>
      </tr>
      <tr>
        <td>解密訊息</td>
        <td><code>nostrsigner:nip04_decrypt</code></td>
        <td>NIP-04 解密</td>
      </tr>
      <tr>
        <td>NIP-44 加密</td>
        <td><code>nostrsigner:nip44_encrypt</code></td>
        <td>NIP-44 加密</td>
      </tr>
      <tr>
        <td>NIP-44 解密</td>
        <td><code>nostrsigner:nip44_decrypt</code></td>
        <td>NIP-44 解密</td>
      </tr>
    </tbody>
  </table>

  <h2 id="request-format">請求格式</h2>

  <h3>取得公鑰</h3>
  <pre><code class="language-text" is:raw>nostrsigner:get_public_key?callback=myapp://callback</code></pre>

  <h3>簽名事件</h3>
  <pre><code class="language-text" is:raw>nostrsigner:sign_event?event=&lt;base64-encoded-event&gt;&amp;callback=myapp://callback</code></pre>

  <h3>加密訊息</h3>
  <pre><code class="language-text" is:raw>nostrsigner:nip04_encrypt?pubkey=&lt;recipient-pubkey&gt;&amp;plaintext=&lt;base64-text&gt;&amp;callback=myapp://callback</code></pre>

  <h3>解密訊息</h3>
  <pre><code class="language-text" is:raw>nostrsigner:nip04_decrypt?pubkey=&lt;sender-pubkey&gt;&amp;ciphertext=&lt;encrypted-text&gt;&amp;callback=myapp://callback</code></pre>

  <h2 id="response-format">回應格式</h2>

  <p>簽名應用透過 callback URI 返回結果：</p>

  <h3>成功回應</h3>
  <pre><code class="language-text" is:raw>myapp://callback?result=&lt;base64-encoded-result&gt;</code></pre>

  <h3>錯誤回應</h3>
  <pre><code class="language-text" is:raw>myapp://callback?error=user_rejected</code></pre>

  <h3>常見錯誤碼</h3>
  <table>
    <thead>
      <tr>
        <th>錯誤碼</th>
        <th>說明</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>user_rejected</code></td>
        <td>用戶拒絕請求</td>
      </tr>
      <tr>
        <td><code>invalid_event</code></td>
        <td>事件格式無效</td>
      </tr>
      <tr>
        <td><code>no_key</code></td>
        <td>沒有可用的密鑰</td>
      </tr>
      <tr>
        <td><code>decrypt_failed</code></td>
        <td>解密失敗</td>
      </tr>
    </tbody>
  </table>

  <h2 id="content-provider">Content Provider 方式</h2>

  <p>對於需要同步返回的場景，可使用 Content Provider：</p>

  <h3>URI 格式</h3>
  <pre><code class="language-text" is:raw>content://com.example.signer/sign
content://com.example.signer/get_public_key
content://com.example.signer/nip04_encrypt
content://com.example.signer/nip04_decrypt</code></pre>

  <h2 id="implementation">Android 實作</h2>

  <h3>客戶端：發送簽名請求</h3>
  <pre><code class="language-kotlin" is:raw>import android.content.Intent
import android.net.Uri
import android.util.Base64

class NostrSignerClient(private val activity: Activity) {

    companion object {
        const val REQUEST_SIGN = 1001
        const val REQUEST_GET_PUBKEY = 1002
        const val REQUEST_ENCRYPT = 1003
        const val REQUEST_DECRYPT = 1004
    }

    fun getPublicKey(callback: String) {
        val uri = Uri.parse("nostrsigner:get_public_key")
            .buildUpon()
            .appendQueryParameter("callback", callback)
            .build()

        val intent = Intent(Intent.ACTION_VIEW, uri)
        activity.startActivityForResult(intent, REQUEST_GET_PUBKEY)
    }

    fun signEvent(eventJson: String, callback: String) {
        val encodedEvent = Base64.encodeToString(
            eventJson.toByteArray(),
            Base64.NO_WRAP
        )

        val uri = Uri.parse("nostrsigner:sign_event")
            .buildUpon()
            .appendQueryParameter("event", encodedEvent)
            .appendQueryParameter("callback", callback)
            .build()

        val intent = Intent(Intent.ACTION_VIEW, uri)
        activity.startActivityForResult(intent, REQUEST_SIGN)
    }

    fun encrypt(pubkey: String, plaintext: String, callback: String) {
        val encodedText = Base64.encodeToString(
            plaintext.toByteArray(),
            Base64.NO_WRAP
        )

        val uri = Uri.parse("nostrsigner:nip04_encrypt")
            .buildUpon()
            .appendQueryParameter("pubkey", pubkey)
            .appendQueryParameter("plaintext", encodedText)
            .appendQueryParameter("callback", callback)
            .build()

        val intent = Intent(Intent.ACTION_VIEW, uri)
        activity.startActivityForResult(intent, REQUEST_ENCRYPT)
    }

    fun decrypt(pubkey: String, ciphertext: String, callback: String) {
        val uri = Uri.parse("nostrsigner:nip04_decrypt")
            .buildUpon()
            .appendQueryParameter("pubkey", pubkey)
            .appendQueryParameter("ciphertext", ciphertext)
            .appendQueryParameter("callback", callback)
            .build()

        val intent = Intent(Intent.ACTION_VIEW, uri)
        activity.startActivityForResult(intent, REQUEST_DECRYPT)
    }
}</code></pre>

  <h3>客戶端：處理回應</h3>
  <pre><code class="language-kotlin" is:raw>override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
    super.onActivityResult(requestCode, resultCode, data)

    val uri = data?.data ?: return

    // 檢查錯誤
    val error = uri.getQueryParameter("error")
    if (error != null) {
        handleError(error)
        return
    }

    // 取得結果
    val result = uri.getQueryParameter("result") ?: return
    val decoded = Base64.decode(result, Base64.NO_WRAP)
    val resultString = String(decoded)

    when (requestCode) {
        NostrSignerClient.REQUEST_GET_PUBKEY -> {
            // resultString 是公鑰（hex 格式）
            onPublicKeyReceived(resultString)
        }
        NostrSignerClient.REQUEST_SIGN -> {
            // resultString 是簽名後的事件 JSON
            onEventSigned(resultString)
        }
        NostrSignerClient.REQUEST_ENCRYPT -> {
            // resultString 是加密後的文字
            onEncrypted(resultString)
        }
        NostrSignerClient.REQUEST_DECRYPT -> {
            // resultString 是解密後的明文
            onDecrypted(resultString)
        }
    }
}

private fun handleError(error: String) {
    when (error) {
        "user_rejected" -> showToast("用戶取消了操作")
        "invalid_event" -> showToast("事件格式無效")
        "no_key" -> showToast("沒有可用的密鑰")
        else -> showToast("發生錯誤: $error")
    }
}</code></pre>

  <h3>簽名應用：處理請求</h3>
  <pre><code class="language-kotlin" is:raw>class SignerActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val uri = intent.data ?: return finish()
        val callback = uri.getQueryParameter("callback") ?: return finish()

        when (uri.host) {
            "get_public_key" -> handleGetPublicKey(callback)
            "sign_event" -> handleSignEvent(uri, callback)
            "nip04_encrypt" -> handleEncrypt(uri, callback)
            "nip04_decrypt" -> handleDecrypt(uri, callback)
        }
    }

    private fun handleGetPublicKey(callback: String) {
        // 顯示確認對話框
        showConfirmDialog("允許應用獲取您的公鑰？") { confirmed ->
            if (confirmed) {
                val pubkey = keyManager.getPublicKey()
                returnResult(callback, pubkey)
            } else {
                returnError(callback, "user_rejected")
            }
        }
    }

    private fun handleSignEvent(uri: Uri, callback: String) {
        val encodedEvent = uri.getQueryParameter("event") ?: return
        val eventJson = String(Base64.decode(encodedEvent, Base64.NO_WRAP))
        val event = parseEvent(eventJson)

        // 顯示事件預覽和確認對話框
        showSignConfirmDialog(event) { confirmed ->
            if (confirmed) {
                val signedEvent = keyManager.signEvent(event)
                returnResult(callback, signedEvent.toJson())
            } else {
                returnError(callback, "user_rejected")
            }
        }
    }

    private fun returnResult(callback: String, result: String) {
        val encoded = Base64.encodeToString(result.toByteArray(), Base64.NO_WRAP)
        val uri = Uri.parse(callback)
            .buildUpon()
            .appendQueryParameter("result", encoded)
            .build()

        val intent = Intent(Intent.ACTION_VIEW, uri)
        startActivity(intent)
        finish()
    }

    private fun returnError(callback: String, error: String) {
        val uri = Uri.parse(callback)
            .buildUpon()
            .appendQueryParameter("error", error)
            .build()

        val intent = Intent(Intent.ACTION_VIEW, uri)
        startActivity(intent)
        finish()
    }
}</code></pre>

  <h3>AndroidManifest.xml 配置</h3>
  <pre><code class="language-xml" is:raw>&lt;!-- 簽名應用 --&gt;
&lt;activity
    android:name=".SignerActivity"
    android:exported="true"&gt;
    &lt;intent-filter&gt;
        &lt;action android:name="android.intent.action.VIEW" /&gt;
        &lt;category android:name="android.intent.category.DEFAULT" /&gt;
        &lt;category android:name="android.intent.category.BROWSABLE" /&gt;
        &lt;data android:scheme="nostrsigner" /&gt;
    &lt;/intent-filter&gt;
&lt;/activity&gt;

&lt;!-- 客戶端應用 - 接收回調 --&gt;
&lt;activity
    android:name=".CallbackActivity"
    android:exported="true"&gt;
    &lt;intent-filter&gt;
        &lt;action android:name="android.intent.action.VIEW" /&gt;
        &lt;category android:name="android.intent.category.DEFAULT" /&gt;
        &lt;category android:name="android.intent.category.BROWSABLE" /&gt;
        &lt;data android:scheme="myapp" android:host="callback" /&gt;
    &lt;/intent-filter&gt;
&lt;/activity&gt;</code></pre>

  <h2 id="security">安全考量</h2>

  <h3>密鑰保護</h3>
  <ul>
    <li>私鑰應儲存在 Android Keystore</li>
    <li>使用生物識別保護密鑰存取</li>
    <li>永遠不要將私鑰傳輸給其他應用</li>
  </ul>

  <h3>請求驗證</h3>
  <ul>
    <li>顯示請求來源應用的資訊</li>
    <li>讓用戶確認每個簽名請求</li>
    <li>提供事件內容預覽</li>
  </ul>

  <h3>權限管理</h3>
  <ul>
    <li>可以記住用戶對特定應用的授權</li>
    <li>提供撤銷授權的功能</li>
    <li>定期清理過期授權</li>
  </ul>

  <h2 id="use-cases">使用場景</h2>

  <h3>統一密鑰管理</h3>
  <ul>
    <li>一個簽名應用管理所有 Nostr 密鑰</li>
    <li>多個客戶端應用共享同一身份</li>
    <li>安全備份和恢復</li>
  </ul>

  <h3>增強安全性</h3>
  <ul>
    <li>客戶端應用不接觸私鑰</li>
    <li>減少私鑰洩露風險</li>
    <li>硬體安全模組整合</li>
  </ul>

  <h2 id="compatible-apps">相容應用</h2>

  <h3>簽名應用</h3>
  <ul>
    <li><a href="https://github.com/greenart7c3/Amber" target="_blank" rel="noopener noreferrer">Amber</a></li>
    <li>其他實現 NIP-55 的簽名應用</li>
  </ul>

  <h3>客戶端應用</h3>
  <ul>
    <li>Amethyst</li>
    <li>其他支援 NIP-55 的 Nostr 客戶端</li>
  </ul>

  <h2 id="best-practices">最佳實踐</h2>
  <ul>
    <li><strong>用戶確認</strong>：每次簽名都應要求用戶確認</li>
    <li><strong>清晰預覽</strong>：顯示即將簽名的事件內容</li>
    <li><strong>錯誤處理</strong>：優雅處理各種錯誤情況</li>
    <li><strong>後備方案</strong>：無簽名應用時提供替代方案</li>
    <li><strong>回調安全</strong>：驗證回調 URI 的合法性</li>
  </ul>

  <h2 id="related-nips">相關 NIPs</h2>
  <ul>
    <li><a href="/tech/nostr/nip-01">NIP-01</a>：基本協議 - 事件簽名</li>
    <li><a href="/tech/nostr/nip-04">NIP-04</a>：加密私訊 - 加密格式</li>
    <li><a href="/tech/nostr/nip-07">NIP-07</a>：瀏覽器擴充 - 類似概念</li>
    <li><a href="/tech/nostr/nip-44">NIP-44</a>：加密訊息 v2 - 新加密標準</li>
    <li><a href="/tech/nostr/nip-46">NIP-46</a>：遠端簽名 - Nostr Connect</li>
  </ul>

  <h2 id="references">參考資源</h2>
  <ul>
    <li><a href="https://github.com/nostr-protocol/nips/blob/master/55.md" target="_blank" rel="noopener noreferrer">NIP-55 規範</a></li>
    <li><a href="https://github.com/greenart7c3/Amber" target="_blank" rel="noopener noreferrer">Amber - Android Signer</a></li>
    <li><a href="https://developer.android.com/training/app-links/deep-linking" target="_blank" rel="noopener noreferrer">Android Deep Linking</a></li>
  </ul>
</ArticleLayout>
