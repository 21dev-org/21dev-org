---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import { defined } from '@/utils/types';
---

<ArticleLayout
  title="NIP-75: Zap ç›®æ¨™"
  subtitle="Zap Goals - å»ä¸­å¿ƒåŒ–ç¾¤çœ¾å‹Ÿè³‡èˆ‡æ‰“è³ç›®æ¨™"
  difficulty="intermediate"
  readingTime={10}
  tags={['Nostr', 'NIP-75', 'Zaps', 'å‹Ÿè³‡', 'crowdfunding']}
  prevPage={defined({ href: '/tech/nostr/nip-65', label: 'NIP-65 ä¸­ç¹¼å™¨åˆ—è¡¨' })}
  nextPage={defined({ href: '/tech/nostr/nip-90', label: 'NIP-90 è³‡æ–™è²©è³£æ©Ÿ' })}
>
  <!-- Breadcrumb -->
  <nav class="flex items-center gap-2 text-sm text-[var(--text-tertiary)] mb-8 flex-wrap">
    <a href="/" class="hover:text-[var(--text-secondary)] transition-colors">é¦–é </a>
    <span>/</span>
    <a href="/tech" class="hover:text-[var(--text-secondary)] transition-colors">æŠ€è¡“</a>
    <span>/</span>
    <a href="/tech/nostr" class="hover:text-[var(--text-secondary)] transition-colors">Nostr</a>
    <span>/</span>
    <span class="text-[var(--text-primary)]">NIP-75</span>
  </nav>

  <!-- Introduction -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">æ¦‚è¿°</h2>
    <p class="text-[var(--text-secondary)] mb-4">
      NIP-75 å®šç¾©äº† Zap ç›®æ¨™äº‹ä»¶ï¼Œå…è¨±ç”¨æˆ¶å‰µå»ºå‹Ÿè³‡ç›®æ¨™ä¸¦è¿½è¹¤é€²åº¦ã€‚é€™æ˜¯ä¸€ç¨®å»ä¸­å¿ƒåŒ–çš„ç¾¤çœ¾å‹Ÿè³‡æ©Ÿåˆ¶ï¼Œ
      çµåˆ NIP-57 çš„ Zaps åŠŸèƒ½ï¼Œè®“å‰µä½œè€…ã€å°ˆæ¡ˆæˆ–æ´»å‹•å¯ä»¥è¨­å®šå‹Ÿè³‡ç›®æ¨™ä¸¦æ¥æ”¶é–ƒé›»ç¶²è·¯æ‰“è³ã€‚
    </p>
    <div class="p-4 rounded-lg bg-purple-500/10 border border-purple-500/20">
      <p class="text-[var(--text-secondary)]">
        <strong class="text-purple-400">æ ¸å¿ƒæ¦‚å¿µï¼š</strong>
        Zap ç›®æ¨™ä½¿ç”¨ kind 9041 äº‹ä»¶ï¼Œé€é <code class="px-1 py-0.5 rounded bg-[var(--inline-code-bg)] text-[var(--inline-code-text)]">amount</code> æ¨™ç±¤è¨­å®šç›®æ¨™é‡‘é¡ï¼ˆæ¯«è°ï¼‰ï¼Œ
        ä¸¦å¯è¨­å®šæˆªæ­¢æ™‚é–“å’Œå¤šå€‹å—ç›Šäººã€‚
      </p>
    </div>
  </section>

  <!-- Event Structure -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">äº‹ä»¶çµæ§‹</h2>
    <p class="text-[var(--text-secondary)] mb-4">
      Zap ç›®æ¨™äº‹ä»¶ä½¿ç”¨ kind 9041ï¼š
    </p>
    <div class="overflow-x-auto">
      <table class="w-full border-collapse mb-4">
        <thead>
          <tr class="border-b border-[var(--border-default)]">
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">æ¨™ç±¤</th>
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">å¿…è¦</th>
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">æ ¼å¼</th>
            <th class="text-left py-3 px-4 text-[var(--text-primary)]">èªªæ˜</th>
          </tr>
        </thead>
        <tbody>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">amount</td>
            <td class="py-3 px-4 text-green-400">âœ“</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["amount", "21000000"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ç›®æ¨™é‡‘é¡ï¼ˆæ¯«è° millisatsï¼‰</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">relays</td>
            <td class="py-3 px-4 text-green-400">âœ“</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["relays", "wss://...", "wss://..."]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">è¿½è¹¤ Zaps çš„ä¸­ç¹¼å™¨åˆ—è¡¨</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">closed_at</td>
            <td class="py-3 px-4 text-gray-400">-</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["closed_at", "1704067200"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">æˆªæ­¢æ™‚é–“ï¼ˆUnix æ™‚é–“æˆ³ï¼‰</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">image</td>
            <td class="py-3 px-4 text-gray-400">-</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["image", "https://..."]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ç›®æ¨™åœ–ç‰‡ URL</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">summary</td>
            <td class="py-3 px-4 text-gray-400">-</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["summary", "ç°¡çŸ­æè¿°"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ç°¡çŸ­æ‘˜è¦</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">zap</td>
            <td class="py-3 px-4 text-gray-400">-</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["zap", "pubkey", "relay", "weight"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">å¤šå€‹å—ç›Šäººåˆ†é…</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">r</td>
            <td class="py-3 px-4 text-gray-400">-</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["r", "https://..."]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">ç›¸é—œå¤–éƒ¨é€£çµ</td>
          </tr>
          <tr class="border-b border-[var(--border-default)]">
            <td class="py-3 px-4 font-mono text-purple-400">a</td>
            <td class="py-3 px-4 text-gray-400">-</td>
            <td class="py-3 px-4 font-mono text-sm text-[var(--text-secondary)]">["a", "30023:pubkey:slug"]</td>
            <td class="py-3 px-4 text-[var(--text-secondary)]">é—œè¯çš„å¯å®šå€äº‹ä»¶</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="p-4 rounded-lg bg-blue-500/10 border border-blue-500/20">
      <p class="text-[var(--text-secondary)]">
        <strong class="text-blue-400">é‡‘é¡å–®ä½ï¼š</strong>
        <code class="px-1 py-0.5 rounded bg-[var(--inline-code-bg)] text-[var(--inline-code-text)]">amount</code>
        ä½¿ç”¨æ¯«è°ï¼ˆmillisatoshiï¼‰ä½œç‚ºå–®ä½ã€‚1 sat = 1000 millisatsã€‚ä¾‹å¦‚ 21,000 sats = 21000000 millisatsã€‚
      </p>
    </div>
  </section>

  <!-- Examples -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">ä½¿ç”¨ç¯„ä¾‹</h2>

    <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-3">åŸºæœ¬å‹Ÿè³‡ç›®æ¨™</h3>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-6"><code class="text-sm text-gray-300">{`{
  "kind": 9041,
  "tags": [
    ["amount", "21000000"],
    ["relays", "wss://relay.damus.io", "wss://relay.nostr.band"]
  ],
  "content": "å¹«åŠ©æˆ‘è³¼è²·æ–°çš„éŒ„éŸ³è¨­å‚™ï¼Œæå‡ Podcast å“è³ªï¼"
}`}</code></pre>

    <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-3">å¸¶æˆªæ­¢æ—¥æœŸçš„ç›®æ¨™</h3>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-6"><code class="text-sm text-gray-300">{`{
  "kind": 9041,
  "tags": [
    ["amount", "100000000"],
    ["relays", "wss://relay.example.com"],
    ["closed_at", "1735689600"],
    ["image", "https://example.com/goal-cover.jpg"],
    ["summary", "å¹´åº•å‰å‹Ÿé›† 100,000 sats ç”¨æ–¼é–‹ç™¼æ–°åŠŸèƒ½"]
  ],
  "content": "æˆ‘å€‘è¨ˆåŠƒåœ¨æ˜å¹´æ¨å‡ºå…¨æ–°çš„ Nostr å®¢æˆ¶ç«¯åŠŸèƒ½ï¼Œéœ€è¦æ‚¨çš„æ”¯æŒï¼å‹Ÿé›†çš„è³‡é‡‘å°‡ç”¨æ–¼ï¼š\\n\\n1. ä¼ºæœå™¨æˆæœ¬\\n2. é–‹ç™¼äººå“¡å·¥æ™‚\\n3. è¨­è¨ˆèˆ‡æ¸¬è©¦"
}`}</code></pre>

    <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-3">å¤šå—ç›Šäººç›®æ¨™</h3>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-6"><code class="text-sm text-gray-300">{`{
  "kind": 9041,
  "tags": [
    ["amount", "50000000"],
    ["relays", "wss://relay.example.com"],
    ["zap", "<dev1-pubkey>", "wss://relay.example.com", "2"],
    ["zap", "<dev2-pubkey>", "wss://relay.example.com", "1"],
    ["zap", "<designer-pubkey>", "wss://relay.example.com", "1"]
  ],
  "content": "é–‹æºå°ˆæ¡ˆé–‹ç™¼åŸºé‡‘ - è³‡é‡‘å°‡æŒ‰æ¯”ä¾‹åˆ†é…çµ¦åœ˜éšŠæˆå“¡"
}`}</code></pre>
    <div class="p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20 mb-6">
      <p class="text-sm text-[var(--text-secondary)]">
        <strong class="text-yellow-400">æ¬Šé‡èªªæ˜ï¼š</strong>
        ä¸Šä¾‹ä¸­ dev1 ç²å¾— 2/(2+1+1) = 50%ï¼Œdev2 å’Œ designer å„ç²å¾— 25%ã€‚
      </p>
    </div>

    <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-3">é—œè¯æ–‡ç« çš„ç›®æ¨™</h3>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-6"><code class="text-sm text-gray-300">{`{
  "kind": 9041,
  "tags": [
    ["amount", "10000000"],
    ["relays", "wss://relay.example.com"],
    ["a", "30023:<author-pubkey>:my-article-slug", "wss://relay.example.com"],
    ["r", "https://github.com/myproject"]
  ],
  "content": "å¦‚æœé€™ç¯‡æ–‡ç« å°ä½ æœ‰å¹«åŠ©ï¼Œè«‹è€ƒæ…®æ”¯æŒä½œè€…ç¹¼çºŒå‰µä½œï¼"
}`}</code></pre>
  </section>

  <!-- TypeScript Implementation -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">TypeScript å¯¦ä½œ</h2>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-4"><code class="text-sm text-gray-300">{`import { finalizeEvent, generateSecretKey, getPublicKey } from 'nostr-tools'

interface ZapSplit {
  pubkey: string
  relay?: string
  weight: number
}

interface ZapGoalOptions {
  amountSats: number
  relays: string[]
  content: string
  closedAt?: number
  image?: string
  summary?: string
  zapSplits?: ZapSplit[]
  linkedUrl?: string
  linkedEvent?: { kind: number; pubkey: string; identifier: string }
}

// å‰µå»º Zap ç›®æ¨™äº‹ä»¶
function createZapGoal(
  options: ZapGoalOptions,
  secretKey: Uint8Array
): object {
  // è½‰æ›ç‚ºæ¯«è°
  const amountMillisats = (options.amountSats * 1000).toString()

  const tags: string[][] = [
    ['amount', amountMillisats],
    ['relays', ...options.relays],
  ]

  if (options.closedAt) {
    tags.push(['closed_at', options.closedAt.toString()])
  }

  if (options.image) {
    tags.push(['image', options.image])
  }

  if (options.summary) {
    tags.push(['summary', options.summary])
  }

  // æ·»åŠ å—ç›Šäººåˆ†é…
  if (options.zapSplits) {
    for (const split of options.zapSplits) {
      tags.push(['zap', split.pubkey, split.relay || '', split.weight.toString()])
    }
  }

  // æ·»åŠ ç›¸é—œé€£çµ
  if (options.linkedUrl) {
    tags.push(['r', options.linkedUrl])
  }

  // æ·»åŠ é—œè¯äº‹ä»¶
  if (options.linkedEvent) {
    const { kind, pubkey, identifier } = options.linkedEvent
    tags.push(['a', \`\${kind}:\${pubkey}:\${identifier}\`])
  }

  const event = {
    kind: 9041,
    created_at: Math.floor(Date.now() / 1000),
    tags,
    content: options.content,
  }

  return finalizeEvent(event, secretKey)
}

// è¨ˆç®—ç›®æ¨™é€²åº¦
interface ZapReceipt {
  tags: string[][]
  created_at: number
}

function calculateGoalProgress(
  goal: { tags: string[][]; created_at: number },
  zapReceipts: ZapReceipt[]
): {
  targetSats: number
  raisedSats: number
  percentage: number
  isComplete: boolean
  isClosed: boolean
  contributors: number
} {
  // ç²å–ç›®æ¨™é‡‘é¡
  const amountTag = goal.tags.find(t => t[0] === 'amount')
  const targetMillisats = amountTag ? parseInt(amountTag[1]) : 0
  const targetSats = targetMillisats / 1000

  // ç²å–æˆªæ­¢æ™‚é–“
  const closedAtTag = goal.tags.find(t => t[0] === 'closed_at')
  const closedAt = closedAtTag ? parseInt(closedAtTag[1]) : null
  const now = Math.floor(Date.now() / 1000)
  const isClosed = closedAt ? now > closedAt : false

  // è¨ˆç®—å·²å‹Ÿé›†é‡‘é¡ï¼ˆåªè¨ˆç®—æˆªæ­¢å‰çš„ Zapsï¼‰
  let raisedMillisats = 0
  const validReceipts = zapReceipts.filter(receipt => {
    if (closedAt && receipt.created_at > closedAt) {
      return false
    }
    return true
  })

  for (const receipt of validReceipts) {
    const amountTag = receipt.tags.find(t => t[0] === 'amount')
    if (amountTag) {
      raisedMillisats += parseInt(amountTag[1])
    }
  }

  const raisedSats = raisedMillisats / 1000
  const percentage = targetSats > 0 ? Math.min((raisedSats / targetSats) * 100, 100) : 0

  return {
    targetSats,
    raisedSats,
    percentage,
    isComplete: raisedSats >= targetSats,
    isClosed,
    contributors: validReceipts.length,
  }
}

// æ ¼å¼åŒ–é‡‘é¡é¡¯ç¤º
function formatSats(sats: number): string {
  if (sats >= 100000000) {
    return \`\${(sats / 100000000).toFixed(2)} BTC\`
  } else if (sats >= 1000000) {
    return \`\${(sats / 1000000).toFixed(2)}M sats\`
  } else if (sats >= 1000) {
    return \`\${(sats / 1000).toFixed(1)}K sats\`
  }
  return \`\${sats} sats\`
}

// ä½¿ç”¨ç¯„ä¾‹
const sk = generateSecretKey()
const pk = getPublicKey(sk)

// å‰µå»ºåŸºæœ¬å‹Ÿè³‡ç›®æ¨™
const basicGoal = createZapGoal({
  amountSats: 21000,
  relays: ['wss://relay.damus.io', 'wss://relay.nostr.band'],
  content: 'å¹«åŠ©æˆ‘è³¼è²·æ–°çš„éŒ„éŸ³è¨­å‚™ï¼',
}, sk)

// å‰µå»ºå¸¶æˆªæ­¢æ—¥æœŸçš„ç›®æ¨™
const timedGoal = createZapGoal({
  amountSats: 100000,
  relays: ['wss://relay.example.com'],
  content: 'å¹´åº¦é–‹ç™¼åŸºé‡‘å‹Ÿé›†',
  closedAt: Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60, // 30 å¤©å¾Œ
  image: 'https://example.com/goal.jpg',
  summary: 'ç‚ºé–‹æºå°ˆæ¡ˆç±Œé›†é–‹ç™¼è³‡é‡‘',
}, sk)

// å‰µå»ºå¤šå—ç›Šäººç›®æ¨™
const teamGoal = createZapGoal({
  amountSats: 50000,
  relays: ['wss://relay.example.com'],
  content: 'åœ˜éšŠé–‹ç™¼åŸºé‡‘',
  zapSplits: [
    { pubkey: 'dev1-pubkey', weight: 2 },
    { pubkey: 'dev2-pubkey', weight: 1 },
    { pubkey: 'designer-pubkey', weight: 1 },
  ],
}, sk)

console.log('Basic goal:', basicGoal)
console.log('Timed goal:', timedGoal)
console.log('Team goal:', teamGoal)`}</code></pre>
  </section>

  <!-- Query Goals -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">æŸ¥è©¢èˆ‡è¿½è¹¤é€²åº¦</h2>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-4"><code class="text-sm text-gray-300">{`import { SimplePool } from 'nostr-tools'

const pool = new SimplePool()
const relays = ['wss://relay.example.com']

// æŸ¥è©¢ç”¨æˆ¶çš„æ‰€æœ‰å‹Ÿè³‡ç›®æ¨™
async function getUserGoals(pubkey: string) {
  const goals = await pool.querySync(relays, {
    kinds: [9041],
    authors: [pubkey],
  })
  return goals
}

// æŸ¥è©¢ç›®æ¨™æ”¶åˆ°çš„ Zaps
async function getGoalZaps(goalEvent: any) {
  const goalRelays = goalEvent.tags.find((t: string[]) => t[0] === 'relays')
  const targetRelays = goalRelays ? goalRelays.slice(1) : relays

  // æŸ¥è©¢ Zap receiptsï¼ˆkind 9735ï¼‰æŒ‡å‘æ­¤ç›®æ¨™
  const zaps = await pool.querySync(targetRelays, {
    kinds: [9735],
    '#e': [goalEvent.id],
  })

  return zaps
}

// ç²å–ç›®æ¨™å®Œæ•´è³‡è¨Šèˆ‡é€²åº¦
async function getGoalWithProgress(goalId: string) {
  // ç²å–ç›®æ¨™äº‹ä»¶
  const goals = await pool.querySync(relays, {
    ids: [goalId],
  })

  if (goals.length === 0) return null

  const goal = goals[0]
  const zaps = await getGoalZaps(goal)
  const progress = calculateGoalProgress(goal, zaps)

  return {
    goal: parseGoal(goal),
    progress,
    zaps,
  }
}

// è§£æç›®æ¨™äº‹ä»¶
function parseGoal(event: any) {
  const getTag = (name: string) =>
    event.tags.find((t: string[]) => t[0] === name)?.[1]

  const relaysTags = event.tags.find((t: string[]) => t[0] === 'relays')
  const goalRelays = relaysTags ? relaysTags.slice(1) : []

  const zapSplits = event.tags
    .filter((t: string[]) => t[0] === 'zap')
    .map((t: string[]) => ({
      pubkey: t[1],
      relay: t[2] || undefined,
      weight: parseInt(t[3]) || 1,
    }))

  const amountMillisats = parseInt(getTag('amount') || '0')

  return {
    id: event.id,
    pubkey: event.pubkey,
    amountSats: amountMillisats / 1000,
    relays: goalRelays,
    content: event.content,
    closedAt: getTag('closed_at') ? parseInt(getTag('closed_at')!) : undefined,
    image: getTag('image'),
    summary: getTag('summary'),
    zapSplits,
    createdAt: event.created_at,
  }
}

// è¨‚é–±ç›®æ¨™çš„ Zaps æ›´æ–°
function subscribeGoalZaps(
  goalEvent: any,
  onZap: (zap: any, progress: ReturnType<typeof calculateGoalProgress>) => void
) {
  const goalRelays = goalEvent.tags.find((t: string[]) => t[0] === 'relays')
  const targetRelays = goalRelays ? goalRelays.slice(1) : relays

  let allZaps: any[] = []

  return pool.subscribeMany(
    targetRelays,
    [{
      kinds: [9735],
      '#e': [goalEvent.id],
    }],
    {
      onevent(event) {
        allZaps.push(event)
        const progress = calculateGoalProgress(goalEvent, allZaps)
        onZap(event, progress)
      },
    }
  )
}

// ä½¿ç”¨ç¯„ä¾‹
const goalId = 'abc123...'
const result = await getGoalWithProgress(goalId)

if (result) {
  console.log(\`ç›®æ¨™: \${result.goal.content}\`)
  console.log(\`ç›®æ¨™é‡‘é¡: \${formatSats(result.goal.amountSats)}\`)
  console.log(\`å·²å‹Ÿé›†: \${formatSats(result.progress.raisedSats)}\`)
  console.log(\`é€²åº¦: \${result.progress.percentage.toFixed(1)}%\`)
  console.log(\`è´ŠåŠ©è€…: \${result.progress.contributors} äºº\`)
  console.log(\`å·²å®Œæˆ: \${result.progress.isComplete ? 'æ˜¯' : 'å¦'}\`)
}`}</code></pre>
  </section>

  <!-- React Component -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">React å…ƒä»¶ç¯„ä¾‹</h2>
    <pre class="p-4 rounded-lg bg-[var(--bg-darkest)] overflow-x-auto mb-4"><code class="text-sm text-gray-300">{`import { useState, useEffect } from 'react'

interface GoalProgress {
  targetSats: number
  raisedSats: number
  percentage: number
  isComplete: boolean
  isClosed: boolean
  contributors: number
}

interface ZapGoalCardProps {
  goal: {
    id: string
    content: string
    amountSats: number
    image?: string
    summary?: string
    closedAt?: number
  }
  progress: GoalProgress
  onZap: () => void
}

function ZapGoalCard({ goal, progress, onZap }: ZapGoalCardProps) {
  const daysLeft = goal.closedAt
    ? Math.max(0, Math.ceil((goal.closedAt - Date.now() / 1000) / 86400))
    : null

  return (
    <div className="rounded-xl bg-gray-800 border border-gray-700 overflow-hidden">
      {goal.image && (
        <img
          src={goal.image}
          alt="Goal"
          className="w-full h-48 object-cover"
        />
      )}

      <div className="p-6">
        <h3 className="text-xl font-bold text-white mb-2">
          {goal.summary || 'å‹Ÿè³‡ç›®æ¨™'}
        </h3>

        <p className="text-gray-400 text-sm mb-4">
          {goal.content}
        </p>

        {/* é€²åº¦æ¢ */}
        <div className="mb-4">
          <div className="flex justify-between text-sm mb-2">
            <span className="text-gray-400">
              {formatSats(progress.raisedSats)} å·²å‹Ÿé›†
            </span>
            <span className="text-gray-400">
              ç›®æ¨™ {formatSats(goal.amountSats)}
            </span>
          </div>
          <div className="h-3 bg-gray-700 rounded-full overflow-hidden">
            <div
              className={\`h-full rounded-full transition-all duration-500 \${
                progress.isComplete
                  ? 'bg-green-500'
                  : 'bg-gradient-to-r from-orange-500 to-yellow-500'
              }\`}
              style={{ width: \`\${Math.min(progress.percentage, 100)}%\` }}
            />
          </div>
          <div className="flex justify-between text-sm mt-2">
            <span className="text-purple-400 font-medium">
              {progress.percentage.toFixed(1)}%
            </span>
            <span className="text-gray-500">
              {progress.contributors} ä½è´ŠåŠ©è€…
            </span>
          </div>
        </div>

        {/* ç‹€æ…‹å’Œæˆªæ­¢æ™‚é–“ */}
        <div className="flex items-center justify-between mb-4">
          {progress.isComplete ? (
            <span className="px-3 py-1 bg-green-500/20 text-green-400 text-sm rounded-full">
              âœ“ ç›®æ¨™é”æˆ
            </span>
          ) : progress.isClosed ? (
            <span className="px-3 py-1 bg-red-500/20 text-red-400 text-sm rounded-full">
              å·²æˆªæ­¢
            </span>
          ) : (
            <span className="px-3 py-1 bg-blue-500/20 text-blue-400 text-sm rounded-full">
              å‹Ÿè³‡ä¸­
            </span>
          )}

          {daysLeft !== null && !progress.isClosed && (
            <span className="text-gray-500 text-sm">
              å‰©é¤˜ {daysLeft} å¤©
            </span>
          )}
        </div>

        {/* Zap æŒ‰éˆ• */}
        {!progress.isClosed && (
          <button
            onClick={onZap}
            className="w-full py-3 px-4 bg-gradient-to-r from-orange-500 to-yellow-500
                       hover:from-orange-600 hover:to-yellow-600
                       text-white font-bold rounded-lg transition-all
                       flex items-center justify-center gap-2"
          >
            âš¡ Zap æ”¯æŒ
          </button>
        )}
      </div>
    </div>
  )
}

// é€²åº¦ç’°å½¢åœ–
function GoalProgressRing({ percentage }: { percentage: number }) {
  const radius = 45
  const circumference = 2 * Math.PI * radius
  const offset = circumference - (percentage / 100) * circumference

  return (
    <svg width="120" height="120" className="transform -rotate-90">
      <circle
        cx="60"
        cy="60"
        r={radius}
        stroke="currentColor"
        className="text-gray-700"
        strokeWidth="8"
        fill="none"
      />
      <circle
        cx="60"
        cy="60"
        r={radius}
        stroke="url(#gradient)"
        strokeWidth="8"
        fill="none"
        strokeLinecap="round"
        strokeDasharray={circumference}
        strokeDashoffset={offset}
        className="transition-all duration-500"
      />
      <defs>
        <linearGradient id="gradient">
          <stop offset="0%" stopColor="#f97316" />
          <stop offset="100%" stopColor="#eab308" />
        </linearGradient>
      </defs>
    </svg>
  )
}`}</code></pre>
  </section>

  <!-- Use Cases -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">æ‡‰ç”¨å ´æ™¯</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ¯ å‰µä½œè€…æ”¯æŒ</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          è¨­å‚™å‡ç´šã€å‰µä½œåŸºé‡‘ã€å°ˆæ¡ˆé–‹ç™¼ç­‰å€‹äººå‹Ÿè³‡ç›®æ¨™ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ’» é–‹æºå°ˆæ¡ˆ</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          ç‚ºé–‹æºè»Ÿé«”é–‹ç™¼ç±Œé›†è³‡é‡‘ï¼Œæ”¯æŒå¤šå€‹é–‹ç™¼è€…ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ“º ç›´æ’­æ´»å‹•</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          çµåˆ NIP-53 ç›´æ’­ï¼Œè¨­å®šç›´æ’­æœŸé–“çš„æ‰“è³ç›®æ¨™ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ“ é•·æ–‡å…§å®¹</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          ç‚º NIP-23 é•·æ–‡æ–‡ç« é™„åŠ å‹Ÿè³‡ç›®æ¨™ï¼Œæ”¯æŒä½œè€…å‰µä½œã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ† æˆå°±è§£é–</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          çµåˆ NIP-58 å¾½ç« ï¼Œé”æˆç›®æ¨™å¾Œè‡ªå‹•é ’ç™¼æ„Ÿè¬å¾½ç« ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
        <h4 class="font-semibold text-[var(--text-primary)] mb-2">ğŸ¤ åœ˜éšŠåˆ†æ½¤</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          ä½¿ç”¨ zap æ¨™ç±¤è‡ªå‹•åˆ†é…å‹Ÿå¾—è³‡é‡‘çµ¦å¤šå€‹å—ç›Šäººã€‚
        </p>
      </div>
    </div>
  </section>

  <!-- Best Practices -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">æœ€ä½³å¯¦è¸</h2>
    <div class="space-y-4">
      <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
        <h4 class="font-semibold text-green-400 mb-2">âœ“ è¨­å®šåˆç†çš„ç›®æ¨™é‡‘é¡</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          æ ¹æ“šå¯¦éš›éœ€æ±‚è¨­å®šå¯é”æˆçš„ç›®æ¨™ï¼Œéé«˜çš„ç›®æ¨™å¯èƒ½è®“æ”¯æŒè€…å¤±å»ä¿¡å¿ƒã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
        <h4 class="font-semibold text-green-400 mb-2">âœ“ æä¾›æ¸…æ™°çš„æè¿°</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          åœ¨ content å’Œ summary ä¸­è©³ç´°èªªæ˜è³‡é‡‘ç”¨é€”ï¼Œå¢åŠ é€æ˜åº¦å’Œä¿¡ä»»ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
        <h4 class="font-semibold text-green-400 mb-2">âœ“ ä½¿ç”¨å¤šå€‹ä¸­ç¹¼å™¨</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          åœ¨ relays æ¨™ç±¤ä¸­åŒ…å«å¤šå€‹ä¸­ç¹¼å™¨ï¼Œç¢ºä¿ Zaps ä¸æœƒå› å–®ä¸€ä¸­ç¹¼å™¨æ•…éšœè€Œéºå¤±ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
        <h4 class="font-semibold text-yellow-400 mb-2">âš  å®¢æˆ¶ç«¯å¿…é ˆä½¿ç”¨ç›®æ¨™æŒ‡å®šçš„ä¸­ç¹¼å™¨</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          ç™¼é€ Zap æ™‚ï¼Œå®¢æˆ¶ç«¯æ‡‰ä½¿ç”¨ç›®æ¨™äº‹ä»¶ä¸­ relays æ¨™ç±¤æŒ‡å®šçš„ä¸­ç¹¼å™¨ï¼Œç¢ºä¿èƒ½æ­£ç¢ºè¿½è¹¤ã€‚
        </p>
      </div>
      <div class="p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
        <h4 class="font-semibold text-yellow-400 mb-2">âš  æˆªæ­¢å¾Œçš„ Zaps ä¸è¨ˆå…¥</h4>
        <p class="text-sm text-[var(--text-secondary)]">
          closed_at æ™‚é–“ä¹‹å¾Œæ”¶åˆ°çš„ Zaps ä¸æ‡‰è¨ˆå…¥ç›®æ¨™é€²åº¦ï¼Œä½†ä»æœƒé€é”å—ç›Šäººã€‚
        </p>
      </div>
    </div>
  </section>

  <!-- Related NIPs -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">ç›¸é—œ NIP</h2>
    <div class="grid md:grid-cols-2 gap-4">
      <a
        href="/tech/nostr/nip-57"
        class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] hover:border-purple-500/50 transition-colors"
      >
        <h4 class="font-semibold text-[var(--text-primary)] mb-1">NIP-57 Zaps</h4>
        <p class="text-sm text-[var(--text-secondary)]">é–ƒé›»ç¶²è·¯æ‰“è³åŸºç¤</p>
      </a>
      <a
        href="/tech/nostr/nip-53"
        class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] hover:border-purple-500/50 transition-colors"
      >
        <h4 class="font-semibold text-[var(--text-primary)] mb-1">NIP-53 ç›´æ’­æ´»å‹•</h4>
        <p class="text-sm text-[var(--text-secondary)]">ç›´æ’­å‹Ÿè³‡æ•´åˆ</p>
      </a>
      <a
        href="/tech/nostr/nip-23"
        class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] hover:border-purple-500/50 transition-colors"
      >
        <h4 class="font-semibold text-[var(--text-primary)] mb-1">NIP-23 é•·æ–‡å…§å®¹</h4>
        <p class="text-sm text-[var(--text-secondary)]">æ–‡ç« é™„åŠ å‹Ÿè³‡ç›®æ¨™</p>
      </a>
      <a
        href="/tech/nostr/nip-58"
        class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] hover:border-purple-500/50 transition-colors"
      >
        <h4 class="font-semibold text-[var(--text-primary)] mb-1">NIP-58 å¾½ç« </h4>
        <p class="text-sm text-[var(--text-secondary)]">é”æˆç›®æ¨™é ’ç™¼æ„Ÿè¬å¾½ç« </p>
      </a>
    </div>
  </section>

  <!-- Summary -->
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">ç¸½çµ</h2>
    <div class="p-6 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <p class="text-[var(--text-secondary)] mb-4">
        NIP-75 Zap ç›®æ¨™ç‚º Nostr æä¾›äº†å»ä¸­å¿ƒåŒ–çš„ç¾¤çœ¾å‹Ÿè³‡æ©Ÿåˆ¶ã€‚é€éèˆ‡ NIP-57 Zaps çš„æ•´åˆï¼Œ
        å‰µä½œè€…å¯ä»¥è¨­å®šé€æ˜çš„å‹Ÿè³‡ç›®æ¨™ï¼Œæ”¯æŒè€…å¯ä»¥å³æ™‚è¿½è¹¤é€²åº¦ï¼Œæ‰“é€ é–‹æ”¾ã€ç„¡éœ€è¨±å¯çš„è³‡é‡‘å‹Ÿé›†å¹³å°ã€‚
      </p>
      <div class="grid md:grid-cols-4 gap-4 text-center">
        <div class="p-3 rounded-lg bg-[var(--bg-primary)]">
          <div class="text-2xl font-bold text-purple-400">Kind 9041</div>
          <div class="text-sm text-[var(--text-secondary)]">Zap ç›®æ¨™</div>
        </div>
        <div class="p-3 rounded-lg bg-[var(--bg-primary)]">
          <div class="text-2xl font-bold text-orange-400">æ¯«è°</div>
          <div class="text-sm text-[var(--text-secondary)]">é‡‘é¡å–®ä½</div>
        </div>
        <div class="p-3 rounded-lg bg-[var(--bg-primary)]">
          <div class="text-2xl font-bold text-blue-400">å¤šå—ç›Šäºº</div>
          <div class="text-sm text-[var(--text-secondary)]">zap æ¨™ç±¤åˆ†é…</div>
        </div>
        <div class="p-3 rounded-lg bg-[var(--bg-primary)]">
          <div class="text-2xl font-bold text-green-400">æˆªæ­¢æ™‚é–“</div>
          <div class="text-sm text-[var(--text-secondary)]">closed_at</div>
        </div>
      </div>
    </div>
  </section>
</ArticleLayout>
