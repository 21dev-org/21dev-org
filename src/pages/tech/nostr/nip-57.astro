---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-57 Zaps"
  description="深入了解 Nostr 的 Zaps 功能，透過閃電網路發送比特幣打賞並在 Nostr 上公開記錄。"
  breadcrumbs={[
    { label: '技術', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-57 Zaps' },
  ]}
  difficulty="advanced"
  readingTime="12 分鐘"
  prevPage={{ title: 'NIP-50 搜尋', href: '/tech/nostr/nip-50' }}
  nextPage={{ title: 'NIP-65 中繼器列表', href: '/tech/nostr/nip-65' }}
>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">什麼是 Zaps？</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Zaps 是 Nostr 上的公開閃電網路支付功能。當你「Zap」某人或某篇貼文時，
    會透過閃電網路發送比特幣，並在 Nostr 上產生一個公開的收據（kind 9735 事件），
    讓所有人都能看到這筆打賞。這創造了一個透明的價值交換系統。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>前置要求：</strong>
      Zaps 需要收款方設定支援 NIP-57 的閃電網路地址（Lightning Address），
      以及發送方需要有閃電網路錢包。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">運作流程</h2>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`1. 發送方請求 Zap
   └─> 客戶端從收款方的 kind 0 取得 lud16（Lightning Address）

2. 取得發票
   └─> 向 LNURL 伺服器發送 Zap 請求（含 nostr 參數）
   └─> 伺服器回傳 BOLT11 發票

3. 支付發票
   └─> 發送方用閃電錢包支付

4. 產生 Zap 收據
   └─> LNURL 伺服器收到款項後
   └─> 發布 kind 9735 事件到 Nostr

5. 客戶端顯示
   └─> 訂閱者看到 Zap 收據並顯示`}</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">事件類型</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">Zap 請求（kind 9734）</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    由發送方建立，嵌入在 LNURL 請求中：
  </p>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`{
  "kind": 9734,
  "content": "Great post! ⚡",  // 可選的 Zap 訊息
  "tags": [
    ["p", "<收款方 pubkey>"],
    ["e", "<被 Zap 的事件 id>"],  // 可選
    ["amount", "21000"],          // 金額（毫聰）
    ["relays", "wss://relay1.com", "wss://relay2.com"],
    ["lnurl", "lnurl1..."]        // 原始 LNURL
  ],
  "pubkey": "<發送方 pubkey>",
  "created_at": 1234567890,
  "id": "...",
  "sig": "..."
}`}</code></pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">Zap 收據（kind 9735）</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    由 LNURL 伺服器在收到付款後發布：
  </p>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`{
  "kind": 9735,
  "content": "",
  "tags": [
    ["p", "<收款方 pubkey>"],
    ["P", "<發送方 pubkey>"],     // 大寫 P
    ["e", "<被 Zap 的事件 id>"],  // 可選
    ["bolt11", "lnbc210n1..."],   // BOLT11 發票
    ["description", "{...}"],     // 原始 zap request JSON
    ["preimage", "..."]           // 付款 preimage
  ],
  "pubkey": "<LNURL 伺服器 pubkey>",  // 注意：非發送方
  "created_at": 1234567890,
  "id": "...",
  "sig": "..."
}`}</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">設定接收 Zaps</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">1. 設定 Lightning Address</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`// 在 kind 0 (metadata) 中設定
{
  "kind": 0,
  "content": JSON.stringify({
    "name": "Alice",
    "lud16": "alice@getalby.com",  // Lightning Address
    // 或者使用 LNURL
    "lud06": "lnurl1..."
  }),
  "tags": [],
  ...
}`}</code></pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">2. LNURL 伺服器要求</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    LNURL 伺服器必須支援 NIP-57 才能正確處理 Zaps：
  </p>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`// LNURL-pay 回應必須包含
{
  "callback": "https://...",
  "minSendable": 1000,
  "maxSendable": 100000000,
  "nostrPubkey": "<伺服器用於簽署 zap receipt 的 pubkey>",
  "allowsNostr": true  // 關鍵！表示支援 NIP-57
}`}</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">程式碼範例</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">發送 Zap</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`import { nip57 } from 'nostr-tools'

async function sendZap({
  recipientPubkey,
  eventId,          // 可選：Zap 的事件
  amount,           // 毫聰
  comment,          // Zap 訊息
  relays,
  lightningAddress  // 如 alice@getalby.com
}) {
  // 1. 取得 LNURL 資訊
  const lnurlData = await fetch(
    \`https://\${lightningAddress.split('@')[1]}/.well-known/lnurlp/\${lightningAddress.split('@')[0]}\`
  ).then(r => r.json())

  // 2. 檢查是否支援 Zaps
  if (!lnurlData.allowsNostr) {
    throw new Error('此 Lightning Address 不支援 Zaps')
  }

  // 3. 建立 Zap 請求
  const zapRequest = nip57.makeZapRequest({
    profile: recipientPubkey,
    event: eventId,
    amount: amount,
    comment: comment,
    relays: relays
  })

  // 4. 簽署 Zap 請求
  const signedZapRequest = await window.nostr.signEvent(zapRequest)

  // 5. 請求發票
  const callbackUrl = new URL(lnurlData.callback)
  callbackUrl.searchParams.set('amount', amount.toString())
  callbackUrl.searchParams.set('nostr', JSON.stringify(signedZapRequest))

  const invoiceResponse = await fetch(callbackUrl).then(r => r.json())

  // 6. 支付發票（使用 WebLN 或其他方式）
  if (window.webln) {
    await window.webln.sendPayment(invoiceResponse.pr)
    console.log('Zap 發送成功！')
  } else {
    // 返回發票讓用戶手動支付
    return invoiceResponse.pr
  }
}`}</code></pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">驗證 Zap 收據</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`import { nip57, verifyEvent } from 'nostr-tools'

function validateZapReceipt(zapReceipt, expectedLnurlPubkey) {
  // 1. 驗證簽名
  if (!verifyEvent(zapReceipt)) {
    return { valid: false, error: '簽名無效' }
  }

  // 2. 驗證發布者是 LNURL 伺服器
  if (zapReceipt.pubkey !== expectedLnurlPubkey) {
    return { valid: false, error: 'pubkey 不匹配' }
  }

  // 3. 解析 description（原始 zap request）
  const descriptionTag = zapReceipt.tags.find(t => t[0] === 'description')
  if (!descriptionTag) {
    return { valid: false, error: '缺少 description' }
  }

  const zapRequest = JSON.parse(descriptionTag[1])

  // 4. 驗證 zap request 簽名
  if (!verifyEvent(zapRequest)) {
    return { valid: false, error: 'zap request 簽名無效' }
  }

  // 5. 驗證金額匹配
  const bolt11Tag = zapReceipt.tags.find(t => t[0] === 'bolt11')
  const amountTag = zapRequest.tags.find(t => t[0] === 'amount')
  // 解析 bolt11 並比對金額...

  return {
    valid: true,
    sender: zapRequest.pubkey,
    recipient: zapReceipt.tags.find(t => t[0] === 'p')?.[1],
    amount: amountTag?.[1],
    comment: zapRequest.content
  }
}`}</code></pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">訂閱 Zaps</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`// 訂閱收到的 Zaps
function subscribeToMyZaps(relay, myPubkey) {
  return relay.subscribe([{
    kinds: [9735],
    '#p': [myPubkey],  // 我是收款方
    since: Math.floor(Date.now() / 1000) - 86400  // 過去 24 小時
  }], {
    onevent(event) {
      const descTag = event.tags.find(t => t[0] === 'description')
      const zapRequest = JSON.parse(descTag[1])

      console.log(\`收到 Zap！\`)
      console.log(\`發送者: \${zapRequest.pubkey}\`)
      console.log(\`訊息: \${zapRequest.content}\`)
    }
  })
}

// 訂閱特定貼文的 Zaps
function subscribeToPostZaps(relay, eventId) {
  return relay.subscribe([{
    kinds: [9735],
    '#e': [eventId]
  }], {
    onevent(event) {
      console.log('此貼文收到一個 Zap')
    }
  })
}

// 計算總 Zap 金額
async function getTotalZaps(relay, eventId) {
  const zaps = await new Promise(resolve => {
    const results = []
    const sub = relay.subscribe([{
      kinds: [9735],
      '#e': [eventId]
    }])
    sub.on('event', e => results.push(e))
    sub.on('eose', () => {
      sub.close()
      resolve(results)
    })
  })

  let total = 0
  for (const zap of zaps) {
    const descTag = zap.tags.find(t => t[0] === 'description')
    const zapRequest = JSON.parse(descTag[1])
    const amountTag = zapRequest.tags.find(t => t[0] === 'amount')
    if (amountTag) {
      total += parseInt(amountTag[1])
    }
  }

  return total  // 毫聰
}`}</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">支援 Zaps 的服務</h2>

  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
    {
      [
        { name: 'Alby', type: '瀏覽器錢包', desc: '支援 NIP-57 的 Lightning Address' },
        { name: 'Wallet of Satoshi', type: '行動錢包', desc: '支援 Zaps 的 LN Address' },
        { name: 'ZEBEDEE', type: '遊戲錢包', desc: 'Lightning Address 服務' },
        { name: 'Stacker News', type: '社群', desc: '整合 Nostr Zaps' },
        { name: 'Primal', type: '客戶端', desc: '內建 Zap 功能' },
        { name: 'Damus', type: '客戶端', desc: 'iOS Zaps 支援' },
      ].map((s) => (
        <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
          <h4 class="font-semibold text-[var(--text-primary)] mb-1">{s.name}</h4>
          <p class="text-xs text-[var(--text-tertiary)] mb-1">{s.type}</p>
          <p class="text-sm text-[var(--text-secondary)]">{s.desc}</p>
        </div>
      ))
    }
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">匿名 Zaps</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    發送方可以選擇不公開身份：
  </p>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]"><code>{`// 匿名 Zap：使用一次性密鑰對簽署 zap request
import { generateSecretKey, getPublicKey } from 'nostr-tools'

function createAnonymousZapRequest(params) {
  // 產生一次性密鑰對
  const anonPrivkey = generateSecretKey()
  const anonPubkey = getPublicKey(anonPrivkey)

  const zapRequest = {
    kind: 9734,
    pubkey: anonPubkey,  // 使用一次性公鑰
    content: params.comment || '',
    tags: [
      ['p', params.recipientPubkey],
      ['amount', params.amount.toString()],
      ['relays', ...params.relays],
      ['anon', '']  // 標記為匿名
    ],
    created_at: Math.floor(Date.now() / 1000)
  }

  // 用一次性私鑰簽署
  return signEvent(zapRequest, anonPrivkey)
}

// 檢查 Zap 是否匿名
function isAnonymousZap(zapReceipt) {
  const descTag = zapReceipt.tags.find(t => t[0] === 'description')
  const zapRequest = JSON.parse(descTag[1])
  return zapRequest.tags.some(t => t[0] === 'anon')
}`}</code></pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">金額格式</h2>

  <div class="not-prose mb-8">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">單位</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">換算</th>
          <th class="text-left py-3 px-4 font-semibold text-[var(--text-primary)]" scope="col">NIP-57 中</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">毫聰 (msat)</td>
          <td class="py-3 px-4">1 sat = 1000 msat</td>
          <td class="py-3 px-4 font-mono">amount 標籤使用</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">聰 (sat)</td>
          <td class="py-3 px-4">1 BTC = 100,000,000 sat</td>
          <td class="py-3 px-4">常見顯示單位</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-3 px-4">21 sats</td>
          <td class="py-3 px-4">= 21,000 msat</td>
          <td class="py-3 px-4">常見 Zap 金額</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">常見問題</h2>

  <div class="grid md:grid-cols-2 gap-4 mb-8">
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">為什麼 Zap 沒有顯示？</h4>
      <ul class="space-y-1 text-sm text-[var(--text-secondary)]">
        <li>• LNURL 伺服器可能不支援 NIP-57</li>
        <li>• 收據可能發布到不同的中繼器</li>
        <li>• 等待區塊確認中</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg border border-[var(--border-default)] bg-[var(--surface-elevated)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Zap 可以退款嗎？</h4>
      <ul class="space-y-1 text-sm text-[var(--text-secondary)]">
        <li>• 閃電網路付款不可逆</li>
        <li>• 收款方可以選擇退還</li>
        <li>• 發送前請確認金額</li>
      </ul>
    </div>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <p class="text-sm text-blue-700 dark:text-blue-400">
      <strong>延伸閱讀：</strong>
      Zaps 建立在 LNURL-pay 協議之上。若要深入了解，
      可以參考 <a href="/tech/lightning/" class="underline">閃電網路技術文檔</a>。
    </p>
  </div>
</ArticleLayout>
