---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="NIP-40 éæœŸæ™‚é–“æˆ³"
  description="Nostr äº‹ä»¶éæœŸæ©Ÿåˆ¶ï¼Œç”¨æ–¼è¨­å®šäº‹ä»¶çš„æœ‰æ•ˆæœŸé™ã€‚"
  breadcrumbs={[
    { label: 'æŠ€è¡“', href: '/tech/' },
    { label: 'Nostr', href: '/tech/nostr/' },
    { label: 'NIP-40 éæœŸæ™‚é–“æˆ³' },
  ]}
  difficulty="beginner"
  readingTime="5 åˆ†é˜"
  prevPage={{
    href: '/tech/nostr/nip-25/',
    title: 'NIP-25 åæ‡‰',
  }}
  nextPage={{
    href: '/tech/nostr/nip-42/',
    title: 'NIP-42 ä¸­ç¹¼å™¨èªè­‰',
  }}
>
  <h2 id="overview">æ¦‚è¿°</h2>
  <p>
    NIP-40 å®šç¾©äº†äº‹ä»¶éæœŸæ©Ÿåˆ¶ï¼Œè®“ç™¼å¸ƒè€…å¯ä»¥æŒ‡å®šäº‹ä»¶çš„æœ‰æ•ˆæœŸé™ã€‚
    éæœŸå¾Œï¼Œä¸­ç¹¼å™¨æ‡‰åˆªé™¤è©²äº‹ä»¶ï¼Œå®¢æˆ¶ç«¯ä¹Ÿä¸æ‡‰é¡¯ç¤ºã€‚é€™å°æ–¼è‡¨æ™‚å…¬å‘Šã€
    é™æ™‚å„ªæƒ æˆ–éš±ç§æ•æ„Ÿå…§å®¹éå¸¸æœ‰ç”¨ã€‚
  </p>

  <h2 id="expiration-tag">Expiration æ¨™ç±¤</h2>
  <p>
    ä½¿ç”¨ <code>expiration</code> æ¨™ç±¤æŒ‡å®šäº‹ä»¶çš„éæœŸæ™‚é–“ï¼Œå€¼ç‚º Unix æ™‚é–“æˆ³ï¼ˆç§’ï¼‰ï¼š
  </p>

  <pre><code class="language-json">{`["expiration", "<Unix æ™‚é–“æˆ³>"]`}</code></pre>

  <h3>äº‹ä»¶ç¯„ä¾‹</h3>
  <pre><code class="language-json">{`{
  "id": "...",
  "pubkey": "...",
  "created_at": 1700000000,
  "kind": 1,
  "tags": [
    ["expiration", "1700086400"]
  ],
  "content": "é€™å‰‡è¨Šæ¯å°‡åœ¨ 24 å°æ™‚å¾ŒéæœŸ",
  "sig": "..."
}`}</code></pre>

  <h2 id="implementation">å¯¦ä½œ</h2>

  <h3>å»ºç«‹éæœŸäº‹ä»¶</h3>
  <pre><code class="language-typescript">{`import { finalizeEvent, getPublicKey } from 'nostr-tools';

// å»ºç«‹å¸¶æœ‰éæœŸæ™‚é–“çš„äº‹ä»¶
function createExpiringEvent(
  privateKey: Uint8Array,
  content: string,
  expiresInSeconds: number
) {
  const now = Math.floor(Date.now() / 1000);
  const expiration = now + expiresInSeconds;

  const event = {
    kind: 1,
    created_at: now,
    tags: [
      ['expiration', expiration.toString()],
    ],
    content,
  };

  return finalizeEvent(event, privateKey);
}

// å»ºç«‹ 1 å°æ™‚å¾ŒéæœŸçš„äº‹ä»¶
const hourEvent = createExpiringEvent(
  privateKey,
  'é€™å‰‡è¨Šæ¯ 1 å°æ™‚å¾ŒéæœŸ',
  3600
);

// å»ºç«‹ 24 å°æ™‚å¾ŒéæœŸçš„äº‹ä»¶
const dayEvent = createExpiringEvent(
  privateKey,
  'é€™å‰‡è¨Šæ¯ 24 å°æ™‚å¾ŒéæœŸ',
  86400
);

// å»ºç«‹ç‰¹å®šæ—¥æœŸéæœŸçš„äº‹ä»¶
function createEventExpiringAt(
  privateKey: Uint8Array,
  content: string,
  expirationDate: Date
) {
  const expiration = Math.floor(expirationDate.getTime() / 1000);

  const event = {
    kind: 1,
    created_at: Math.floor(Date.now() / 1000),
    tags: [
      ['expiration', expiration.toString()],
    ],
    content,
  };

  return finalizeEvent(event, privateKey);
}

// å»ºç«‹åœ¨ 2024 å¹´åº•éæœŸçš„äº‹ä»¶
const newYearEvent = createEventExpiringAt(
  privateKey,
  '2024 å¹´ç‰¹åˆ¥å…¬å‘Š',
  new Date('2024-12-31T23:59:59Z')
);`}</code></pre>

  <h3>æª¢æŸ¥äº‹ä»¶æ˜¯å¦éæœŸ</h3>
  <pre><code class="language-typescript">{`// æª¢æŸ¥äº‹ä»¶æ˜¯å¦å·²éæœŸ
function isEventExpired(event: Event): boolean {
  const expirationTag = event.tags.find(t => t[0] === 'expiration');

  if (!expirationTag) {
    return false; // æ²’æœ‰éæœŸæ¨™ç±¤ï¼Œæ°¸ä¸éæœŸ
  }

  const expiration = parseInt(expirationTag[1], 10);
  const now = Math.floor(Date.now() / 1000);

  return now > expiration;
}

// å–å¾—éæœŸæ™‚é–“
function getExpiration(event: Event): Date | null {
  const expirationTag = event.tags.find(t => t[0] === 'expiration');

  if (!expirationTag) {
    return null;
  }

  const expiration = parseInt(expirationTag[1], 10);
  return new Date(expiration * 1000);
}

// å–å¾—å‰©é¤˜æ™‚é–“
function getTimeRemaining(event: Event): number | null {
  const expirationTag = event.tags.find(t => t[0] === 'expiration');

  if (!expirationTag) {
    return null;
  }

  const expiration = parseInt(expirationTag[1], 10);
  const now = Math.floor(Date.now() / 1000);
  const remaining = expiration - now;

  return remaining > 0 ? remaining : 0;
}

// æ ¼å¼åŒ–å‰©é¤˜æ™‚é–“
function formatTimeRemaining(seconds: number): string {
  if (seconds <= 0) return 'å·²éæœŸ';

  const days = Math.floor(seconds / 86400);
  const hours = Math.floor((seconds % 86400) / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);

  if (days > 0) return \`\${days} å¤© \${hours} å°æ™‚\`;
  if (hours > 0) return \`\${hours} å°æ™‚ \${minutes} åˆ†é˜\`;
  return \`\${minutes} åˆ†é˜\`;
}`}</code></pre>

  <h3>éæ¿¾éæœŸäº‹ä»¶</h3>
  <pre><code class="language-typescript">{`import { SimplePool } from 'nostr-tools';

const pool = new SimplePool();
const relays = ['wss://relay.damus.io', 'wss://nos.lol'];

// æŸ¥è©¢äº‹ä»¶ä¸¦éæ¿¾éæœŸçš„
async function getActiveEvents(pubkey: string) {
  const events = await pool.querySync(relays, {
    kinds: [1],
    authors: [pubkey],
    limit: 50,
  });

  // éæ¿¾æ‰å·²éæœŸçš„äº‹ä»¶
  return events.filter(event => !isEventExpired(event));
}

// è¨‚é–±äº‹ä»¶æ™‚è‡ªå‹•éæ¿¾éæœŸ
function subscribeToActiveEvents(
  pubkey: string,
  onEvent: (event: Event) => void
) {
  return pool.subscribeMany(
    relays,
    [{ kinds: [1], authors: [pubkey] }],
    {
      onevent: (event) => {
        if (!isEventExpired(event)) {
          onEvent(event);
        }
      },
    }
  );
}`}</code></pre>

  <h2 id="relay-behavior">ä¸­ç¹¼å™¨è¡Œç‚º</h2>
  <p>ç¬¦åˆ NIP-40 çš„ä¸­ç¹¼å™¨æ‡‰è©²ï¼š</p>

  <ul>
    <li><strong>æ‹’çµ•å·²éæœŸäº‹ä»¶</strong>ï¼šä¸æ¥å— expiration æ™‚é–“å·²éçš„äº‹ä»¶</li>
    <li><strong>å®šæœŸæ¸…ç†</strong>ï¼šåˆªé™¤å·²éæœŸçš„äº‹ä»¶ä»¥ç¯€çœå„²å­˜ç©ºé–“</li>
    <li><strong>ä¸è¿”å›éæœŸäº‹ä»¶</strong>ï¼šæŸ¥è©¢æ™‚ä¸è¿”å›å·²éæœŸçš„äº‹ä»¶</li>
  </ul>

  <div class="p-4 bg-amber-500/10 border border-amber-500/30 rounded-lg my-6">
    <p class="text-amber-700 dark:text-amber-300 font-medium mb-2">æ³¨æ„</p>
    <p class="text-[var(--text-secondary)] text-sm">
      ä¸¦éæ‰€æœ‰ä¸­ç¹¼å™¨éƒ½æ”¯æ´ NIP-40ã€‚æŸäº›ä¸­ç¹¼å™¨å¯èƒ½æœƒå¿½ç•¥éæœŸæ¨™ç±¤ï¼Œç¹¼çºŒå„²å­˜å’Œæä¾›éæœŸäº‹ä»¶ã€‚
      å®¢æˆ¶ç«¯æ‡‰è©²è‡ªè¡Œéæ¿¾éæœŸäº‹ä»¶ï¼Œä¸è¦å®Œå…¨ä¾è³´ä¸­ç¹¼å™¨çš„è¡Œç‚ºã€‚
    </p>
  </div>

  <h2 id="use-cases">æ‡‰ç”¨å ´æ™¯</h2>

  <h3>é™æ™‚å…¬å‘Š</h3>
  <pre><code class="language-typescript">{`// æ´»å‹•å…¬å‘Šï¼Œæ´»å‹•çµæŸå¾ŒéæœŸ
const eventAnnouncement = createEventExpiringAt(
  privateKey,
  'ğŸ‰ ç·šä¸Šèšæœƒä»Šæ™š 8 é»é–‹å§‹ï¼åŠ å…¥é€£çµï¼š...',
  new Date('2024-03-15T22:00:00Z')
);`}</code></pre>

  <h3>é–ƒè³¼å„ªæƒ </h3>
  <pre><code class="language-typescript">{`// é™æ™‚å„ªæƒ ï¼Œ24 å°æ™‚å¾ŒéæœŸ
const flashSale = createExpiringEvent(
  privateKey,
  'âš¡ é™æ™‚å„ªæƒ ï¼ä½¿ç”¨ä»£ç¢¼ NOSTR24 äº« 50% æŠ˜æ‰£',
  86400
);`}</code></pre>

  <h3>è‡¨æ™‚è¨Šæ¯</h3>
  <pre><code class="language-typescript">{`// è‡¨æ™‚ä½ç½®åˆ†äº«ï¼Œ1 å°æ™‚å¾ŒéæœŸ
const locationShare = createExpiringEvent(
  privateKey,
  'ğŸ“ æˆ‘ç¾åœ¨åœ¨å°åŒ— 101ï¼Œæƒ³è¦‹é¢çš„æœ‹å‹ä¾†æ‰¾æˆ‘',
  3600
);`}</code></pre>

  <h3>æŠ•ç¥¨èˆ‡å•å·</h3>
  <pre><code class="language-typescript">{`// æŠ•ç¥¨ï¼Œæˆªæ­¢æ™‚é–“å¾ŒéæœŸ
const poll = {
  kind: 1,
  created_at: Math.floor(Date.now() / 1000),
  tags: [
    ['expiration', (Math.floor(Date.now() / 1000) + 604800).toString()], // 1 é€±
    ['poll_option', '0', 'é¸é … A'],
    ['poll_option', '1', 'é¸é … B'],
  ],
  content: 'ä½ æ¯”è¼ƒå–œæ­¡å“ªå€‹ï¼ŸæŠ•ç¥¨å°‡åœ¨ä¸€é€±å¾Œæˆªæ­¢ã€‚',
};`}</code></pre>

  <h2 id="ui-display">UI é¡¯ç¤ºå»ºè­°</h2>
  <pre><code class="language-typescript">{`// React çµ„ä»¶ç¯„ä¾‹
function ExpiringNote({ event }: { event: Event }) {
  const [remaining, setRemaining] = useState(getTimeRemaining(event));

  useEffect(() => {
    const interval = setInterval(() => {
      const newRemaining = getTimeRemaining(event);
      setRemaining(newRemaining);

      if (newRemaining === 0) {
        clearInterval(interval);
      }
    }, 60000); // æ¯åˆ†é˜æ›´æ–°

    return () => clearInterval(interval);
  }, [event]);

  if (remaining === null) {
    // æ²’æœ‰éæœŸæ™‚é–“
    return <Note event={event} />;
  }

  if (remaining === 0) {
    // å·²éæœŸï¼Œä¸é¡¯ç¤º
    return null;
  }

  return (
    <div className="relative">
      <Note event={event} />
      <div className="absolute top-2 right-2 text-xs text-gray-500">
        â±ï¸ {formatTimeRemaining(remaining)}
      </div>
    </div>
  );
}`}</code></pre>

  <h2 id="considerations">æ³¨æ„äº‹é …</h2>
  <ul>
    <li><strong>ä¸å¯æ’¤éŠ·</strong>ï¼šä¸€æ—¦è¨­å®šéæœŸæ™‚é–“ï¼Œç„¡æ³•å»¶é•·ï¼ˆé™¤éç™¼å¸ƒæ–°äº‹ä»¶ï¼‰</li>
    <li><strong>éå¼·åˆ¶æ€§</strong>ï¼šéæœŸåªæ˜¯å»ºè­°ï¼Œç„¡æ³•ä¿è­‰æ‰€æœ‰å‰¯æœ¬éƒ½è¢«åˆªé™¤</li>
    <li><strong>æ™‚å€å•é¡Œ</strong>ï¼šä½¿ç”¨ Unix æ™‚é–“æˆ³é¿å…æ™‚å€æ··æ·†</li>
    <li><strong>å¿«å–å•é¡Œ</strong>ï¼šå®¢æˆ¶ç«¯å¿«å–å¯èƒ½ä»åŒ…å«éæœŸäº‹ä»¶</li>
  </ul>

  <h2 id="related">ç›¸é—œ NIP</h2>
  <ul>
    <li><a href="/tech/nostr/nip-01/">NIP-01</a> - åŸºæœ¬å”è­°èˆ‡äº‹ä»¶çµæ§‹</li>
    <li><a href="/tech/nostr/nip-09/">NIP-09</a> - äº‹ä»¶åˆªé™¤ï¼ˆä¸»å‹•åˆªé™¤æ©Ÿåˆ¶ï¼‰</li>
  </ul>

  <h2 id="resources">åƒè€ƒè³‡æº</h2>
  <ul>
    <li><a href="https://github.com/nostr-protocol/nips/blob/master/40.md" target="_blank" rel="noopener">NIP-40 è¦ç¯„åŸæ–‡</a></li>
    <li><a href="https://github.com/nbd-wtf/nostr-tools" target="_blank" rel="noopener">nostr-tools å‡½å¼åº«</a></li>
  </ul>
</ArticleLayout>
