---
import PageLayout from '@/layouts/PageLayout.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import TimelineCard from '@/components/ui/TimelineCard.astro';
import HolidayCard from '@/components/ui/HolidayCard.astro';
import Button from '@/components/ui/Button.astro';
import Tag from '@/components/ui/Tag.astro';
import {
  bitcoinMilestones,
  bitcoinHolidays,
  getUpcomingHoliday,
  getTodayInHistory,
  getTodayHoliday,
  getTimelineStats,
  categoryLabels,
  categoryColors,
} from '@/data/bitcoin-timeline';

// æŒ‰å¹´ä»½åˆ†çµ„é‡Œç¨‹ç¢‘
const milestonesByYear = bitcoinMilestones.reduce(
  (acc, m) => {
    const year = m.date.substring(0, 4);
    if (!acc[year]) acc[year] = [];
    acc[year].push(m);
    return acc;
  },
  {} as Record<string, typeof bitcoinMilestones>
);

const years = Object.keys(milestonesByYear).sort((a, b) => b.localeCompare(a));

const upcomingHoliday = getUpcomingHoliday();
const todayInHistory = getTodayInHistory();
const todayHoliday = getTodayHoliday();
const stats = getTimelineStats();

// æŒ‰æ—¥æœŸæ’åºç¯€æ—¥
const sortedHolidays = [...bitcoinHolidays].sort((a, b) => a.date.localeCompare(b.date));

// åˆ†é¡åˆ—è¡¨
const categories = Object.entries(categoryLabels) as [keyof typeof categoryLabels, string][];
---

<PageLayout
  title="æ¯”ç‰¹å¹£å¤§äº‹è¨˜"
  description="æ¯”ç‰¹å¹£æ­·å²ä¸Šçš„é‡è¦äº‹ä»¶èˆ‡ç‰¹æ®Šç¯€æ—¥ï¼Œå¾ 2008 å¹´ç™½çš®æ›¸ç™¼å¸ƒåˆ°ä»Šå¤©ã€‚"
>
  <!-- Hero -->
  <section
    class="py-16 md:py-24 bg-gradient-to-b from-[var(--bg-secondary)] to-[var(--bg-primary)]"
  >
    <div class="container-wide">
      <Breadcrumb items={[{ label: 'æ¯”ç‰¹å¹£å¤§äº‹è¨˜' }]} />
      <div class="max-w-3xl">
        <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)] mb-6">æ¯”ç‰¹å¹£å¤§äº‹è¨˜</h1>
        <p class="text-xl text-[var(--text-secondary)]">
          å¾å‰µä¸–å€å¡Šåˆ° Taproot å‡ç´šï¼Œå›é¡§å¡‘é€ æ¯”ç‰¹å¹£æ­·å²çš„é‡è¦æ™‚åˆ»ï¼Œä»¥åŠç¤¾ç¾¤æ…¶ç¥çš„ç‰¹æ®Šç¯€æ—¥ã€‚
        </p>
      </div>

      <!-- Stats cards -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
        <div class="bg-[var(--surface-elevated)] rounded-xl border border-[var(--border-default)] p-4 text-center">
          <div class="text-3xl font-bold text-bitcoin-500">{stats.totalMilestones}</div>
          <div class="text-sm text-[var(--text-secondary)]">æ­·å²äº‹ä»¶</div>
        </div>
        <div class="bg-[var(--surface-elevated)] rounded-xl border border-[var(--border-default)] p-4 text-center">
          <div class="text-3xl font-bold text-lightning-500">{stats.criticalEvents}</div>
          <div class="text-sm text-[var(--text-secondary)]">é—œéµé‡Œç¨‹ç¢‘</div>
        </div>
        <div class="bg-[var(--surface-elevated)] rounded-xl border border-[var(--border-default)] p-4 text-center">
          <div class="text-3xl font-bold text-nostr-500">{stats.totalHolidays}</div>
          <div class="text-sm text-[var(--text-secondary)]">ç‰¹æ®Šç¯€æ—¥</div>
        </div>
        <div class="bg-[var(--surface-elevated)] rounded-xl border border-[var(--border-default)] p-4 text-center">
          <div class="text-3xl font-bold text-success-500">{stats.yearsCovered}</div>
          <div class="text-sm text-[var(--text-secondary)]">å¹´ä»½è·¨åº¦</div>
        </div>
      </div>

      <!-- Quick nav -->
      <div class="flex flex-wrap gap-3 mt-8">
        <a
          href="#milestones"
          class="px-4 py-2 rounded-full bg-bitcoin-500 text-white text-sm font-medium hover:bg-bitcoin-600 transition-colors"
        >
          æ­·å²å¤§äº‹ä»¶
        </a>
        <a
          href="#holidays"
          class="px-4 py-2 rounded-full bg-[var(--surface-elevated)] border border-[var(--border-default)] text-sm font-medium hover:border-bitcoin-500/50 transition-colors"
        >
          æ¯”ç‰¹å¹£ç¯€æ—¥
        </a>
        {
          todayInHistory.length > 0 && (
            <a
              href="#today"
              class="px-4 py-2 rounded-full bg-lightning-500/10 text-lightning-600 dark:text-lightning-400 border border-lightning-500/30 text-sm font-medium hover:bg-lightning-500/20 transition-colors"
            >
              âš¡ ä»Šæ—¥æ­·å² ({todayInHistory.length})
            </a>
          )
        }
      </div>
    </div>
  </section>

  <!-- Today in History -->
  {
    todayInHistory.length > 0 && (
      <section id="today" class="py-12 bg-lightning-500/5 border-y border-lightning-500/20">
        <div class="container-wide">
          <div class="flex items-center gap-3 mb-6">
            <span class="text-2xl">ğŸ“…</span>
            <div>
              <h2 class="text-xl font-bold text-[var(--text-primary)]">ä»Šæ—¥æ¯”ç‰¹å¹£æ­·å²</h2>
              <p class="text-sm text-[var(--text-secondary)]">
                æ­·å²ä¸Šçš„ä»Šå¤©ï¼Œç™¼ç”Ÿäº†é€™äº›é‡è¦äº‹ä»¶
              </p>
            </div>
          </div>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            {todayInHistory.map((milestone) => (
              <div class="bg-[var(--surface-elevated)] rounded-xl border border-lightning-500/30 p-4">
                <div class="text-sm font-mono text-lightning-500 mb-2">{milestone.date}</div>
                <h3 class="font-semibold text-[var(--text-primary)] mb-1">{milestone.title}</h3>
                {milestone.titleEn && (
                  <p class="text-xs text-[var(--text-tertiary)] mb-2">{milestone.titleEn}</p>
                )}
                <p class="text-sm text-[var(--text-secondary)]">{milestone.description}</p>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- Today's Holiday -->
  {
    todayHoliday && (
      <section class="py-8 bg-bitcoin-500/10 border-b border-bitcoin-500/20">
        <div class="container-wide">
          <div class="flex items-center gap-4">
            <span class="text-4xl">{todayHoliday.icon}</span>
            <div>
              <div class="text-sm text-bitcoin-600 dark:text-bitcoin-400 font-medium mb-1">
                ğŸ‰ ä»Šå¤©æ˜¯æ¯”ç‰¹å¹£ç¯€æ—¥ï¼
              </div>
              <h2 class="text-2xl font-bold text-[var(--text-primary)]">{todayHoliday.name}</h2>
              <p class="text-[var(--text-secondary)]">{todayHoliday.description}</p>
            </div>
          </div>
        </div>
      </section>
    )
  }

  <!-- Milestones section -->
  <section id="milestones" class="py-16 md:py-24">
    <div class="container-wide">
      <h2 class="text-3xl font-bold text-[var(--text-primary)] mb-4">æ­·å²å¤§äº‹ä»¶</h2>
      <p class="text-[var(--text-secondary)] mb-8">
        æ”¶éŒ„ {stats.totalMilestones} å€‹é‡è¦äº‹ä»¶ï¼Œæ©«è·¨ {stats.firstYear} - {stats.lastYear} å¹´
      </p>

      <!-- Search box -->
      <div class="mb-6">
        <div class="relative max-w-md">
          <input
            type="text"
            id="timeline-search"
            placeholder="æœå°‹äº‹ä»¶..."
            class="w-full px-4 py-2 pl-10 rounded-lg bg-[var(--surface-elevated)] border border-[var(--border-default)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:outline-none focus:ring-2 focus:ring-bitcoin-500/50 focus:border-bitcoin-500"
          />
          <svg
            class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-[var(--text-tertiary)]"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
        <p id="search-results" class="text-sm text-[var(--text-tertiary)] mt-2 hidden"></p>
      </div>

      <!-- Category filter -->
      <div class="flex flex-wrap gap-2 mb-4">
        <span class="text-sm text-[var(--text-tertiary)] self-center mr-2">åˆ†é¡:</span>
        <button
          data-category="all"
          class="category-filter px-3 py-1.5 text-sm rounded-full bg-bitcoin-500 text-white transition-colors"
        >
          å…¨éƒ¨
        </button>
        {
          categories.map(([key, label]) => {
            const variant = categoryColors[key];
            return (
              <button
                data-category={key}
                class={`category-filter px-3 py-1.5 text-sm rounded-full bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors`}
              >
                {label}
              </button>
            );
          })
        }
      </div>

      <!-- Significance filter -->
      <div class="flex flex-wrap gap-2 mb-6">
        <span class="text-sm text-[var(--text-tertiary)] self-center mr-2">é‡è¦æ€§:</span>
        <button
          data-significance="all"
          class="significance-filter px-3 py-1.5 text-sm rounded-full bg-lightning-500 text-white transition-colors"
        >
          å…¨éƒ¨
        </button>
        <button
          data-significance="critical"
          class="significance-filter px-3 py-1.5 text-sm rounded-full bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors flex items-center gap-1"
        >
          <span class="w-2 h-2 rounded-full bg-bitcoin-500"></span>
          é—œéµ
        </button>
        <button
          data-significance="major"
          class="significance-filter px-3 py-1.5 text-sm rounded-full bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors flex items-center gap-1"
        >
          <span class="w-2 h-2 rounded-full bg-lightning-500"></span>
          é‡è¦
        </button>
        <button
          data-significance="notable"
          class="significance-filter px-3 py-1.5 text-sm rounded-full bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors flex items-center gap-1"
        >
          <span class="w-2 h-2 rounded-full bg-neutral-400"></span>
          ä¸€èˆ¬
        </button>
      </div>

      <!-- Year filter -->
      <div class="flex flex-wrap gap-2 mb-8">
        {
          years.map((year) => (
            <a
              href={`#year-${year}`}
              class="year-link px-3 py-1 text-sm rounded-full bg-neutral-100 dark:bg-neutral-800 hover:bg-bitcoin-500/10 hover:text-bitcoin-500 transition-colors"
            >
              {year}
            </a>
          ))
        }
      </div>

      <!-- Timeline -->
      <div class="max-w-3xl">
        {
          years.map((year) => (
            <div id={`year-${year}`} class="year-section mb-12 scroll-mt-24" data-year={year}>
              <h3 class="text-2xl font-bold text-bitcoin-500 mb-6 sticky top-20 bg-[var(--bg-primary)] py-2 z-10">
                {year}
                <span class="text-sm font-normal text-[var(--text-tertiary)] ml-2">
                  ({milestonesByYear[year].length} äº‹ä»¶)
                </span>
              </h3>
              {milestonesByYear[year].map((milestone) => (
                <div
                  class="milestone-item"
                  data-category={milestone.category}
                  data-significance={milestone.significance}
                  data-title={milestone.title}
                  data-title-en={milestone.titleEn || ''}
                  data-description={milestone.description}
                >
                  <TimelineCard milestone={milestone} />
                </div>
              ))}
            </div>
          ))
        }
      </div>
    </div>
  </section>

  <!-- Holidays section -->
  <section id="holidays" class="py-16 md:py-24 bg-[var(--bg-secondary)] scroll-mt-24">
    <div class="container-wide">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6 mb-8">
        <div>
          <h2 class="text-3xl font-bold text-[var(--text-primary)] mb-4">æ¯”ç‰¹å¹£ç¯€æ—¥</h2>
          <p class="text-[var(--text-secondary)]">
            ç¤¾ç¾¤æ…¶ç¥çš„ {stats.totalHolidays} å€‹ç‰¹æ®Šæ—¥å­ï¼Œç”¨ä¾†ç´€å¿µæ¯”ç‰¹å¹£æ­·å²ä¸Šçš„é‡è¦æ™‚åˆ»ã€‚
          </p>
        </div>
        {
          upcomingHoliday && (
            <div class="flex items-center gap-2 text-sm text-[var(--text-secondary)]">
              <span class="text-lg">{upcomingHoliday.icon}</span>
              ä¸‹ä¸€å€‹ç¯€æ—¥: <span class="text-bitcoin-500 font-medium">{upcomingHoliday.name}</span>
            </div>
          )
        }
      </div>

      <!-- Calendar view -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          sortedHolidays.map((holiday) => (
            <HolidayCard holiday={holiday} isUpcoming={holiday.id === upcomingHoliday?.id} />
          ))
        }
      </div>
    </div>
  </section>

  <!-- Submit CTA -->
  <section class="py-16 md:py-24">
    <div class="container-wide text-center">
      <h2 class="text-3xl font-bold text-[var(--text-primary)] mb-4">éºæ¼äº†ä»€éº¼é‡è¦äº‹ä»¶ï¼Ÿ</h2>
      <p class="text-lg text-[var(--text-secondary)] mb-8 max-w-2xl mx-auto">
        å¦‚æœä½ ç™¼ç¾æˆ‘å€‘éºæ¼äº†æŸå€‹é‡è¦çš„æ¯”ç‰¹å¹£é‡Œç¨‹ç¢‘æˆ–ç¯€æ—¥ï¼Œæ­¡è¿æäº¤ã€‚
      </p>
      <Button
        href="https://github.com/21dev-org/21dev-org/issues/new"
        variant="primary"
        size="lg"
        external
      >
        æäº¤äº‹ä»¶
      </Button>
    </div>
  </section>
</PageLayout>

<script>
  // State
  let currentCategory = 'all';
  let currentSignificance = 'all';
  let searchQuery = '';

  // Elements
  const categoryButtons = document.querySelectorAll('.category-filter');
  const significanceButtons = document.querySelectorAll('.significance-filter');
  const milestoneItems = document.querySelectorAll('.milestone-item');
  const yearSections = document.querySelectorAll('.year-section');
  const searchInput = document.getElementById('timeline-search') as HTMLInputElement;
  const searchResults = document.getElementById('search-results');

  // Filter function
  function filterMilestones() {
    let visibleCount = 0;

    milestoneItems.forEach((item) => {
      const itemCategory = item.getAttribute('data-category');
      const itemSignificance = item.getAttribute('data-significance');
      const itemTitle = (item.getAttribute('data-title') || '').toLowerCase();
      const itemTitleEn = (item.getAttribute('data-title-en') || '').toLowerCase();
      const itemDescription = (item.getAttribute('data-description') || '').toLowerCase();

      const matchesCategory = currentCategory === 'all' || itemCategory === currentCategory;
      const matchesSignificance =
        currentSignificance === 'all' || itemSignificance === currentSignificance;
      const matchesSearch =
        searchQuery === '' ||
        itemTitle.includes(searchQuery) ||
        itemTitleEn.includes(searchQuery) ||
        itemDescription.includes(searchQuery);

      const isVisible = matchesCategory && matchesSignificance && matchesSearch;
      (item as HTMLElement).style.display = isVisible ? '' : 'none';

      if (isVisible) visibleCount++;
    });

    // Hide year sections with no visible items
    yearSections.forEach((section) => {
      const visibleItems = section.querySelectorAll('.milestone-item');
      let hasVisible = false;
      visibleItems.forEach((item) => {
        if ((item as HTMLElement).style.display !== 'none') {
          hasVisible = true;
        }
      });
      (section as HTMLElement).style.display = hasVisible ? '' : 'none';
    });

    // Update search results text
    if (searchResults) {
      if (searchQuery) {
        searchResults.textContent = `æ‰¾åˆ° ${visibleCount} å€‹ç›¸é—œäº‹ä»¶`;
        searchResults.classList.remove('hidden');
      } else {
        searchResults.classList.add('hidden');
      }
    }
  }

  // Category filter functionality
  categoryButtons.forEach((button) => {
    button.addEventListener('click', () => {
      currentCategory = button.getAttribute('data-category') || 'all';

      // Update button styles
      categoryButtons.forEach((btn) => {
        btn.classList.remove('bg-bitcoin-500', 'text-white');
        btn.classList.add('bg-neutral-100', 'dark:bg-neutral-800');
      });
      button.classList.remove('bg-neutral-100', 'dark:bg-neutral-800');
      button.classList.add('bg-bitcoin-500', 'text-white');

      filterMilestones();
    });
  });

  // Significance filter functionality
  significanceButtons.forEach((button) => {
    button.addEventListener('click', () => {
      currentSignificance = button.getAttribute('data-significance') || 'all';

      // Update button styles
      significanceButtons.forEach((btn) => {
        btn.classList.remove('bg-lightning-500', 'text-white');
        btn.classList.add('bg-neutral-100', 'dark:bg-neutral-800');
      });
      button.classList.remove('bg-neutral-100', 'dark:bg-neutral-800');
      button.classList.add('bg-lightning-500', 'text-white');

      filterMilestones();
    });
  });

  // Search functionality
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      searchQuery = (e.target as HTMLInputElement).value.toLowerCase().trim();
      filterMilestones();
    });
  }

  // Smooth scroll for year links
  const yearLinks = document.querySelectorAll('.year-link');
  yearLinks.forEach((link) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const href = link.getAttribute('href');
      if (href) {
        const target = document.querySelector(href);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth' });
          history.pushState(null, '', href);
        }
      }
    });
  });

  // Keyboard shortcut: / to focus search
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== searchInput) {
      e.preventDefault();
      searchInput?.focus();
    }
  });
</script>
