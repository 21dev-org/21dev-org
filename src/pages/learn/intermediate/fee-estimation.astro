---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
---

<ArticleLayout
  title="手續費估算"
  description="手續費決定交易被確認的速度。學習如何計算和估算合適的手續費。"
  breadcrumbs={[
    { label: '學習', href: '/learn/' },
    { label: '進階知識', href: '/learn/intermediate/' },
    { label: '手續費估算' },
  ]}
  difficulty="intermediate"
  readingTime="15 分鐘"
  prevPage={{ title: '上一篇：時間鎖機制', href: '/learn/intermediate/timelock' }}
  nextPage={{ title: '下一篇：交易加速', href: '/learn/intermediate/rbf-cpfp' }}
>
  <h2 id="fee-basics">手續費基礎</h2>
  <p>
    比特幣交易手續費不是按金額計算，而是按交易的「虛擬位元組」(vBytes) 大小計算。
    礦工優先處理每 vByte 費率較高的交易。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="font-semibold text-[var(--text-primary)] mb-3">手續費公式</p>
    <p class="font-mono text-lg text-bitcoin-500 mb-2">
      手續費 = 交易大小 (vBytes) × 費率 (sat/vB)
    </p>
    <p class="text-sm text-[var(--text-tertiary)]">
      例如：250 vBytes × 10 sat/vB = 2,500 sats
    </p>
  </div>

  <h2 id="vbytes">虛擬位元組 (vBytes)</h2>
  <p>
    SegWit 引入了「權重」概念。witness 數據享有 75% 折扣。
  </p>

  <div class="not-prose mb-6 overflow-x-auto">
    <table class="w-full text-sm" aria-label="SegWit 數據類型權重：基礎數據與 Witness 數據的權重差異">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">數據類型</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">權重</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">說明</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">基礎數據</td>
          <td class="py-2 font-mono">4 WU/byte</td>
          <td class="py-2">版本、輸入、輸出、locktime</td>
        </tr>
        <tr>
          <td class="py-2">Witness 數據</td>
          <td class="py-2 font-mono">1 WU/byte</td>
          <td class="py-2">簽章和公鑰（SegWit）</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm">
    <p class="text-[var(--text-tertiary)] mb-2"># vBytes 計算</p>
    <p class="text-[var(--text-secondary)]">vBytes = weight / 4</p>
    <p class="text-[var(--text-tertiary)] mt-2 mb-2"># 區塊限制</p>
    <p class="text-[var(--text-secondary)]">最大權重 = 4,000,000 WU ≈ 1,000,000 vBytes</p>
  </div>

  <h2 id="transaction-size">交易大小估算</h2>
  <p>
    不同地址類型的交易大小差異很大：
  </p>

  <div class="not-prose mb-6 overflow-x-auto">
    <table class="w-full text-sm" aria-label="不同地址類型的交易輸入大小和相對成本比較">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">輸入類型</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">大小</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">相對成本</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">P2PKH (1...)</td>
          <td class="py-2 font-mono">~148 vB</td>
          <td class="py-2">100%</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">P2SH-P2WPKH (3...)</td>
          <td class="py-2 font-mono">~91 vB</td>
          <td class="py-2">61%</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">P2WPKH (bc1q...)</td>
          <td class="py-2 font-mono">~68 vB</td>
          <td class="py-2">46%</td>
        </tr>
        <tr>
          <td class="py-2">P2TR (bc1p...)</td>
          <td class="py-2 font-mono">~57.5 vB</td>
          <td class="py-2">39%</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-green-500/10 border border-green-500/30">
    <p class="text-sm text-green-700 dark:text-green-400">
      <strong>省錢秘訣：</strong> 使用 Taproot (bc1p) 地址可以節省高達 61% 的手續費！
    </p>
  </div>

  <h2 id="mempool">記憶池 (Mempool)</h2>
  <p>
    未確認的交易在記憶池中等待被打包。礦工從記憶池中選擇費率最高的交易來填滿區塊。
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <p class="font-semibold text-[var(--text-primary)] mb-3">記憶池狀態對費率的影響</p>
    <div class="grid md:grid-cols-3 gap-4 text-sm">
      <div>
        <p class="text-green-500 font-bold">低擁堵</p>
        <p class="text-[var(--text-secondary)]">1-5 sat/vB 即可確認</p>
      </div>
      <div>
        <p class="text-yellow-500 font-bold">中等擁堵</p>
        <p class="text-[var(--text-secondary)]">10-30 sat/vB 建議</p>
      </div>
      <div>
        <p class="text-red-500 font-bold">高擁堵</p>
        <p class="text-[var(--text-secondary)]">50+ sat/vB 可能需要</p>
      </div>
    </div>
  </div>

  <h2 id="estimation-methods">費率估算方法</h2>

  <h3 id="historical-analysis">1. 歷史區塊分析</h3>
  <p>
    分析最近幾個區塊中被確認的交易費率，推斷當前需要的費率。
    Bitcoin Core 使用這種方法提供 <code>estimatesmartfee</code> RPC。
  </p>

  <h3 id="mempool-analysis">2. 記憶池分析</h3>
  <p>
    直接分析當前記憶池中的交易，按費率排序，估算需要多高的費率才能在下一個區塊被確認。
    mempool.space 使用這種方法。
  </p>

  <h3 id="confirmation-target">3. 確認時間目標</h3>
  <p>
    根據希望在多少個區塊內確認，動態調整費率建議：
  </p>
  <ul>
    <li><strong>下一個區塊</strong>：最高費率，緊急交易</li>
    <li><strong>1 小時內</strong>：中等費率（約 6 個區塊）</li>
    <li><strong>1 天內</strong>：低費率，可以等待</li>
    <li><strong>不急</strong>：最低費率，週末或夜間可能確認</li>
  </ul>

  <h2 id="fee-tools">費率查詢工具</h2>
  <ul>
    <li><strong>mempool.space</strong>：最常用，即時記憶池視覺化</li>
    <li><strong>bitcoinfees.net</strong>：簡單的費率建議</li>
    <li><strong>自建節點</strong>：<code>bitcoin-cli estimatesmartfee &lt;blocks&gt;</code></li>
  </ul>

  <h2 id="common-mistakes">常見錯誤</h2>
  <ul>
    <li>設置過低的費率，導致交易長時間不確認</li>
    <li>在高擁堵時段發送大額交易（週末通常較便宜）</li>
    <li>不考慮 UTXO 合併（低費率時段可以整理 UTXO）</li>
    <li>使用舊地址類型，多付不必要的手續費</li>
  </ul>

  <h2 id="saving-tips">省錢策略</h2>
  <ul>
    <li>使用 Native SegWit 或 Taproot 地址</li>
    <li>在低費率時段合併小額 UTXO</li>
    <li>批量處理多筆付款（減少交易數量）</li>
    <li>支援 RBF，可在需要時加速交易</li>
    <li>使用閃電網路處理小額支付</li>
  </ul>

  <div class="not-prose mb-6 p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
    <p class="text-sm text-bitcoin-700 dark:text-bitcoin-400">
      <strong>延伸閱讀：</strong> 了解 <a href="/learn/intermediate/rbf-cpfp" class="underline">RBF 和 CPFP</a> 交易加速技術，
      以及 <a href="/bips/bip-0125" class="underline">BIP-125 RBF</a> 標準。
    </p>
  </div>
</ArticleLayout>
