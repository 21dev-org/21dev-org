---
import PageLayout from '@/layouts/PageLayout.astro';
import Button from '@/components/ui/Button.astro';
---

<PageLayout
  title="MuSig2 多簽聚合詳解"
  description="深入理解 MuSig2 協議如何實現 Schnorr 簽章聚合，提供隱私和效率的多簽方案。"
>
  <article class="py-16 md:py-24">
    <div class="container-wide">
      <div class="max-w-3xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="mb-8" aria-label="麵包屑">
          <ol class="flex items-center gap-2 text-sm text-[var(--text-tertiary)]">
            <li><a href="/" class="hover:text-[var(--text-primary)]">首頁</a></li>
            <li>/</li>
            <li><a href="/learn/" class="hover:text-[var(--text-primary)]">學習</a></li>
            <li>/</li>
            <li><a href="/learn/advanced/" class="hover:text-[var(--text-primary)]">深入技術</a></li>
            <li>/</li>
            <li class="text-[var(--text-primary)]">MuSig2</li>
          </ol>
        </nav>

        <!-- Header -->
        <header class="mb-12">
          <div class="flex items-center gap-3 mb-4">
            <span class="px-3 py-1 rounded-full text-sm font-medium bg-red-500/10 text-red-600 dark:text-red-400">
              深入技術
            </span>
            <span class="text-sm text-[var(--text-tertiary)]">閱讀時間：25 分鐘</span>
          </div>
          <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)] mb-6">
            MuSig2 多簽聚合詳解
          </h1>
          <p class="text-xl text-[var(--text-secondary)]">
            MuSig2 是一個兩輪多簽協議，允許多個參與者共同產生一個與單一簽章無法區分的聚合簽章，
            提供極佳的隱私性和效率。
          </p>
        </header>

        <!-- Content -->
        <div class="prose prose-lg prose-zh dark:prose-invert max-w-none">
          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">為什麼需要 MuSig2？</h2>

          <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-8 mb-3">傳統多簽的問題</h3>
          <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
            傳統的 OP_CHECKMULTISIG 雖然功能強大，但有幾個明顯的缺點：
          </p>

          <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
            <li>• <strong class="text-[var(--text-primary)]">隱私問題</strong>：鏈上暴露所有參與者的公鑰</li>
            <li>• <strong class="text-[var(--text-primary)]">空間浪費</strong>：需要存儲 n 個公鑰和 m 個簽章</li>
            <li>• <strong class="text-[var(--text-primary)]">費用高昂</strong>：更大的交易體積意味著更高的費用</li>
            <li>• <strong class="text-[var(--text-primary)]">可追蹤性</strong>：多簽交易一眼可辨</li>
          </ul>

          <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
            <p class="font-semibold text-[var(--text-primary)] mb-3">2-of-3 多簽比較</p>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-[var(--text-tertiary)] mb-2">傳統 P2SH 多簽</p>
                <ul class="text-[var(--text-secondary)] space-y-1">
                  <li>• 3 個公鑰（99 bytes）</li>
                  <li>• 2 個簽章（~144 bytes）</li>
                  <li>• OP_CHECKMULTISIG</li>
                  <li class="text-red-500">總計 ~250+ bytes</li>
                </ul>
              </div>
              <div>
                <p class="text-[var(--text-tertiary)] mb-2">MuSig2 + Taproot</p>
                <ul class="text-[var(--text-secondary)] space-y-1">
                  <li>• 1 個聚合公鑰（32 bytes）</li>
                  <li>• 1 個聚合簽章（64 bytes）</li>
                  <li>• 看起來像單簽</li>
                  <li class="text-green-500">總計 96 bytes</li>
                </ul>
              </div>
            </div>
          </div>

          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">MuSig 的演進</h2>

          <div class="not-prose mb-6 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-[var(--border-default)]">
                  <th class="text-left py-2 text-[var(--text-primary)]">版本</th>
                  <th class="text-left py-2 text-[var(--text-primary)]">輪數</th>
                  <th class="text-left py-2 text-[var(--text-primary)]">特點</th>
                  <th class="text-left py-2 text-[var(--text-primary)]">狀態</th>
                </tr>
              </thead>
              <tbody class="text-[var(--text-secondary)]">
                <tr class="border-b border-[var(--border-default)]">
                  <td class="py-2">MuSig1</td>
                  <td class="py-2">3 輪</td>
                  <td class="py-2">需要 commitment 輪</td>
                  <td class="py-2 text-yellow-500">已過時</td>
                </tr>
                <tr class="border-b border-[var(--border-default)]">
                  <td class="py-2">MuSig2</td>
                  <td class="py-2 text-green-500">2 輪</td>
                  <td class="py-2">Nonce 可預生成</td>
                  <td class="py-2 text-green-500">BIP-327</td>
                </tr>
                <tr>
                  <td class="py-2">MuSig-DN</td>
                  <td class="py-2 text-green-500">2 輪</td>
                  <td class="py-2">確定性 nonce</td>
                  <td class="py-2 text-blue-500">研究中</td>
                </tr>
              </tbody>
            </table>
          </div>

          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">密鑰聚合</h2>
          <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
            MuSig2 的第一步是將所有參與者的公鑰聚合成單一公鑰。
            但簡單的加法聚合是不安全的。
          </p>

          <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-8 mb-3">惡意密鑰攻擊</h3>
          <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
            假設 Alice 和 Bob 想建立 2-of-2 多簽。如果簡單聚合 P = P_A + P_B，
            Bob 可以選擇 P_B = P_B' - P_A，則聚合公鑰變成 P_B'，Bob 可以單獨花費。
          </p>

          <div class="not-prose mb-8 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
            <p class="text-sm text-red-700 dark:text-red-400">
              <strong>攻擊示例：</strong>
            </p>
            <div class="font-mono text-xs mt-2 text-red-700 dark:text-red-400">
              <p>Alice 公鑰：P_A</p>
              <p>Bob 惡意公鑰：P_B = P_B' - P_A</p>
              <p>聚合公鑰：P = P_A + P_B = P_A + P_B' - P_A = P_B'</p>
              <p class="mt-2">Bob 現在可以用 x_B' 單獨簽署！</p>
            </div>
          </div>

          <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-8 mb-3">KeyAgg 演算法</h3>
          <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
            MuSig2 使用係數來防止惡意密鑰攻擊：
          </p>

          <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm">
            <p class="text-[var(--text-tertiary)] mb-2"># 密鑰聚合 KeyAgg</p>
            <p class="text-[var(--text-secondary)]">L = H("KeyAgg/list", P₁ || P₂ || ... || Pₙ)</p>
            <p class="text-[var(--text-secondary)] mt-2">a_i = H("KeyAgg/coef", L || Pᵢ)</p>
            <p class="text-[var(--text-secondary)] mt-2 text-green-500">P = a₁·P₁ + a₂·P₂ + ... + aₙ·Pₙ</p>
          </div>

          <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
            每個公鑰都乘以一個取決於所有公鑰的係數。攻擊者無法在不知道其他人公鑰的情況下
            選擇一個「抵消」的惡意公鑰，因為係數會隨之改變。
          </p>

          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">簽章協議</h2>

          <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-8 mb-3">協議概覽</h3>
          <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
            <div class="space-y-6 text-sm">
              <!-- Setup -->
              <div class="flex gap-4">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[var(--surface-elevated)] text-[var(--text-primary)] flex items-center justify-center font-bold border border-[var(--border-default)]">0</div>
                <div>
                  <p class="font-semibold text-[var(--text-primary)]">設置（一次性）</p>
                  <p class="text-[var(--text-secondary)]">所有參與者交換公鑰，計算聚合公鑰 P</p>
                  <p class="text-xs text-[var(--text-tertiary)] mt-1">P = KeyAgg(P₁, P₂, ..., Pₙ)</p>
                </div>
              </div>

              <!-- Round 1 -->
              <div class="flex gap-4">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-yellow-500 text-white flex items-center justify-center font-bold">1</div>
                <div>
                  <p class="font-semibold text-[var(--text-primary)]">第一輪：Nonce 交換</p>
                  <p class="text-[var(--text-secondary)]">每個參與者生成兩對 nonce 並分享公開部分</p>
                  <div class="text-xs text-[var(--text-tertiary)] mt-1 font-mono">
                    <p>r_i,1, r_i,2 ← 隨機</p>
                    <p>R_i,1 = r_i,1·G, R_i,2 = r_i,2·G</p>
                    <p>廣播 (R_i,1, R_i,2)</p>
                  </div>
                </div>
              </div>

              <!-- Round 2 -->
              <div class="flex gap-4">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold">2</div>
                <div>
                  <p class="font-semibold text-[var(--text-primary)]">第二輪：部分簽章</p>
                  <p class="text-[var(--text-secondary)]">收到所有 nonce 後，每個參與者計算部分簽章</p>
                  <div class="text-xs text-[var(--text-tertiary)] mt-1 font-mono">
                    <p>b = H(R₁,₁||...||Rₙ,₂||P||m)</p>
                    <p>R = ∑(R_i,1 + b·R_i,2)</p>
                    <p>c = H(R||P||m)</p>
                    <p>s_i = r_i,1 + b·r_i,2 + c·a_i·x_i</p>
                  </div>
                </div>
              </div>

              <!-- Aggregation -->
              <div class="flex gap-4">
                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-bitcoin-500 text-white flex items-center justify-center font-bold">✓</div>
                <div>
                  <p class="font-semibold text-[var(--text-primary)]">聚合</p>
                  <p class="text-[var(--text-secondary)]">聚合所有部分簽章得到最終簽章</p>
                  <p class="text-xs text-[var(--text-tertiary)] mt-1 font-mono">s = s₁ + s₂ + ... + sₙ</p>
                  <p class="text-xs text-green-500 mt-1">最終簽章 σ = (R, s) 是標準 BIP-340 簽章</p>
                </div>
              </div>
            </div>
          </div>

          <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-8 mb-3">為什麼需要兩個 Nonce？</h3>
          <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
            MuSig2 使用兩個 nonce 來防止 Wagner 攻擊。這種攻擊允許惡意參與者
            在並發簽名會話中操控聚合 nonce，進而偽造簽章。
          </p>

          <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
            <p class="font-semibold text-[var(--text-primary)] mb-2">Nonce 組合</p>
            <p class="text-sm text-[var(--text-secondary)] mb-4">
              兩個 nonce 通過取決於消息的係數 b 組合：
            </p>
            <div class="font-mono text-xs text-[var(--text-secondary)]">
              <p>r_eff = r₁ + b·r₂</p>
              <p>R_eff = R₁ + b·R₂</p>
            </div>
            <p class="text-xs text-[var(--text-tertiary)] mt-2">
              由於 b 取決於消息，攻擊者無法預先計算有利的 nonce
            </p>
          </div>

          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">Nonce 預生成</h2>
          <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
            MuSig2 的一大優勢是允許在不知道消息的情況下預生成 nonce。
            這對需要離線參與的場景非常有用。
          </p>

          <div class="not-prose mb-8 p-4 rounded-lg bg-green-500/10 border border-green-500/30">
            <p class="text-sm text-green-700 dark:text-green-400">
              <strong>應用場景：</strong>
              <ul class="mt-2 space-y-1">
                <li>• 硬體錢包可以預生成 nonce，減少互動次數</li>
                <li>• 冷儲存可以批量準備 nonce</li>
                <li>• 閃電網路可以預先準備承諾交易的 nonce</li>
              </ul>
            </p>
          </div>

          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">安全考量</h2>

          <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-8 mb-3">Nonce 絕對不能重用</h3>
          <div class="not-prose mb-8 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
            <p class="text-sm text-red-700 dark:text-red-400">
              <strong>警告：</strong> 在 Schnorr/MuSig 中重用 nonce 會直接洩露私鑰！
            </p>
            <div class="font-mono text-xs mt-3 text-red-700 dark:text-red-400">
              <p># 如果用相同 nonce 簽署 m₁ 和 m₂：</p>
              <p>s₁ = r + c₁·x</p>
              <p>s₂ = r + c₂·x</p>
              <p class="mt-2"># 攻擊者可以計算：</p>
              <p>x = (s₁ - s₂) / (c₁ - c₂)</p>
            </div>
          </div>

          <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-8 mb-3">並發會話風險</h3>
          <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
            同時運行多個簽名會話時需要特別小心。攻擊者可能試圖利用
            不同會話之間的關聯來提取私鑰。BIP-327 建議限制並發會話數量。
          </p>

          <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-8 mb-3">部分簽章驗證</h3>
          <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
            在聚合之前驗證每個部分簽章是重要的。惡意參與者可能提交無效的部分簽章，
            導致最終簽章無效。
          </p>

          <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm">
            <p class="text-[var(--text-tertiary)]"># 驗證部分簽章</p>
            <p class="text-[var(--text-secondary)]">s_i·G == R_i,1 + b·R_i,2 + c·a_i·P_i ?</p>
          </div>

          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">與 FROST 比較</h2>
          <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
            FROST 是另一個多簽方案，支持門限簽章（t-of-n）。
          </p>

          <div class="not-prose mb-6 overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-[var(--border-default)]">
                  <th class="text-left py-2 text-[var(--text-primary)]">特性</th>
                  <th class="text-left py-2 text-[var(--text-primary)]">MuSig2</th>
                  <th class="text-left py-2 text-[var(--text-primary)]">FROST</th>
                </tr>
              </thead>
              <tbody class="text-[var(--text-secondary)]">
                <tr class="border-b border-[var(--border-default)]">
                  <td class="py-2">門限類型</td>
                  <td class="py-2">n-of-n</td>
                  <td class="py-2 text-green-500">t-of-n</td>
                </tr>
                <tr class="border-b border-[var(--border-default)]">
                  <td class="py-2">通訊輪數</td>
                  <td class="py-2">2</td>
                  <td class="py-2">2</td>
                </tr>
                <tr class="border-b border-[var(--border-default)]">
                  <td class="py-2">設置複雜度</td>
                  <td class="py-2 text-green-500">簡單</td>
                  <td class="py-2">需要 DKG</td>
                </tr>
                <tr class="border-b border-[var(--border-default)]">
                  <td class="py-2">容錯</td>
                  <td class="py-2 text-red-500">所有人必須在線</td>
                  <td class="py-2 text-green-500">可容忍缺席</td>
                </tr>
                <tr>
                  <td class="py-2">BIP 狀態</td>
                  <td class="py-2 text-green-500">BIP-327</td>
                  <td class="py-2">尚無 BIP</td>
                </tr>
              </tbody>
            </table>
          </div>

          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">實際應用</h2>

          <ul class="space-y-3 text-[var(--text-secondary)] mb-6">
            <li class="flex items-start gap-2">
              <span class="text-green-500">✓</span>
              <span><strong class="text-[var(--text-primary)]">Taproot 密鑰路徑</strong>：多方共同控制的 Taproot 地址</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500">✓</span>
              <span><strong class="text-[var(--text-primary)]">閃電網路通道</strong>：2-of-2 通道資金控制</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500">✓</span>
              <span><strong class="text-[var(--text-primary)]">企業金庫</strong>：多重簽章保護公司資金</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500">✓</span>
              <span><strong class="text-[var(--text-primary)]">原子交換</strong>：跨鏈交易的簽章協調</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500">✓</span>
              <span><strong class="text-[var(--text-primary)]">聯合託管</strong>：用戶和服務商共同控制</span>
            </li>
          </ul>

          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">實作資源</h2>
          <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
            <li>• <strong>libsecp256k1-zkp</strong>：C 語言參考實作</li>
            <li>• <strong>secp256k1-py</strong>：Python 綁定</li>
            <li>• <strong>bitcoin-core/secp256k1</strong>：正在整合中</li>
          </ul>

          <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-12 mb-4">相關資源</h2>
          <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
            <li>• <a href="/bips/bip-0327" class="text-bitcoin-500 hover:underline">BIP-327</a>：MuSig2 規範</li>
            <li>• <a href="/bips/bip-0340" class="text-bitcoin-500 hover:underline">BIP-340</a>：Schnorr 簽章</li>
            <li>• <a href="/learn/advanced/schnorr-signatures" class="text-bitcoin-500 hover:underline">Schnorr 簽章詳解</a></li>
            <li>• <a href="/learn/advanced/taproot" class="text-bitcoin-500 hover:underline">Taproot 詳解</a></li>
          </ul>

          <div class="mt-8 p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
            <p class="text-sm text-bitcoin-700 dark:text-bitcoin-400">
              <strong>延伸閱讀：</strong> MuSig2 結合 Taproot 可以實現高效、隱私的多簽錢包。
              了解 <a href="/learn/intermediate/multisig" class="underline hover:no-underline">多簽錢包基礎</a>
              可以幫助你更好地理解這些概念。
            </p>
          </div>
        </div>

        <!-- Navigation -->
        <div class="mt-12 pt-8 border-t border-[var(--border-default)] flex justify-between">
          <Button href="/learn/advanced/schnorr-signatures" variant="ghost">
            <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            上一篇：Schnorr 簽章
          </Button>
          <Button href="/learn/advanced/miniscript" variant="primary">
            下一篇：Miniscript
            <svg class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </Button>
        </div>
      </div>
    </div>
  </article>
</PageLayout>
