---
import PageLayout from '@/layouts/PageLayout.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import Tag from '@/components/ui/Tag.astro';
import { getCollection } from 'astro:content';

// 取得所有 FAQ
const faqEntries = await getCollection('faq');

// 分類標籤
const categoryLabels: Record<string, string> = {
  'getting-started': '入門問題',
  wallet: '錢包問題',
  transaction: '交易問題',
  security: '安全問題',
  technical: '技術問題',
  lightning: '閃電網路',
};

// SVG icons for categories (inline)
const categoryIcons: Record<string, string> = {
  'getting-started': `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>`,
  wallet: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>`,
  transaction: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>`,
  security: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>`,
  technical: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`,
  lightning: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>`,
};

// 按分類和排序分組
const faqsByCategory = faqEntries.reduce(
  (acc, entry) => {
    const cat = entry.data.category;
    if (!acc[cat]) acc[cat] = [];
    acc[cat].push(entry);
    return acc;
  },
  {} as Record<string, typeof faqEntries>
);

// 排序每個分類內的問題
Object.keys(faqsByCategory).forEach((cat) => {
  faqsByCategory[cat].sort((a, b) => (a.data.order || 99) - (b.data.order || 99));
});

// 生成 FAQ Schema
const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: await Promise.all(
    faqEntries.map(async (entry) => {
      const { Content } = await entry.render();
      // 簡化版：只取問題，答案在頁面內展示
      return {
        '@type': 'Question',
        name: entry.data.question,
        acceptedAnswer: {
          '@type': 'Answer',
          text: entry.data.question, // 簡化處理
        },
      };
    })
  ),
};

// 分類順序
const categoryOrder = [
  'getting-started',
  'wallet',
  'security',
  'transaction',
  'lightning',
  'technical',
];
const sortedCategories = categoryOrder.filter((cat) => faqsByCategory[cat]?.length > 0);

// 統計資訊
const stats = {
  total: faqEntries.length,
  categories: sortedCategories.length,
};
---

<PageLayout
  title="常見問題 FAQ"
  description="比特幣新手常見問題解答：什麼是比特幣、如何購買、如何安全保管、閃電網路是什麼等。"
>
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />

  <section
    class="py-16 md:py-24 bg-gradient-to-b from-[var(--bg-secondary)] to-[var(--bg-primary)]"
  >
    <div class="container-wide">
      <Breadcrumb items={[{ label: '常見問題' }]} />
      <div class="max-w-3xl">
        <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)] mb-6">常見問題</h1>
        <p class="text-xl text-[var(--text-secondary)] mb-8">
          比特幣新手最常問的問題，從入門到進階一次解答。
        </p>

        <!-- 統計數據 -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
          <div
            class="p-4 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)]"
          >
            <div class="text-3xl font-bold text-bitcoin-500">{stats.total}</div>
            <div class="text-sm text-[var(--text-secondary)]">問題總數</div>
          </div>
          <div
            class="p-4 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)]"
          >
            <div class="text-3xl font-bold text-blue-500">{stats.categories}</div>
            <div class="text-sm text-[var(--text-secondary)]">主題分類</div>
          </div>
          <div
            class="p-4 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)]"
          >
            <div class="text-3xl font-bold text-green-500">
              {faqsByCategory['getting-started']?.length || 0}
            </div>
            <div class="text-sm text-[var(--text-secondary)]">入門問題</div>
          </div>
          <div
            class="p-4 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)]"
          >
            <div class="text-3xl font-bold text-purple-500">
              {faqsByCategory['lightning']?.length || 0}
            </div>
            <div class="text-sm text-[var(--text-secondary)]">閃電網路</div>
          </div>
        </div>
      </div>

      <!-- 搜尋框 -->
      <div class="max-w-lg mt-8">
        <div class="relative">
          <input
            type="text"
            id="faq-search"
            placeholder="搜尋問題..."
            class="w-full px-4 py-3 pl-12 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)] text-[var(--text-primary)] placeholder:text-[var(--text-tertiary)] focus:outline-none focus:ring-2 focus:ring-bitcoin-500/50 focus:border-bitcoin-500"
          />
          <svg
            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--text-tertiary)]"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <span
            id="faq-search-count"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-sm text-[var(--text-tertiary)] hidden"
          >
          </span>
        </div>
      </div>

      <!-- 分類快速跳轉 -->
      <div class="flex flex-wrap gap-3 mt-6">
        <button
          class="category-filter flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-colors bg-bitcoin-500 text-white"
          data-category="all"
        >
          全部
        </button>
        {
          sortedCategories.map((cat) => (
            <button
              class="category-filter flex items-center gap-2 px-4 py-2 rounded-full bg-[var(--surface-elevated)] border border-[var(--border-default)] text-sm font-medium hover:border-bitcoin-500/50 hover:text-bitcoin-500 transition-colors"
              data-category={cat}
            >
              <span class="w-5 h-5" set:html={categoryIcons[cat]} />
              {categoryLabels[cat]}
              <span class="text-[var(--text-tertiary)]">({faqsByCategory[cat].length})</span>
            </button>
          ))
        }
      </div>
    </div>
  </section>

  <!-- FAQ 內容 -->
  <section class="py-16 md:py-24">
    <div class="container-wide">
      <div class="max-w-3xl mx-auto space-y-16">
        {
          sortedCategories.map((cat) => (
            <div id={cat} class="category-section scroll-mt-24" data-category={cat}>
              <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-6 flex items-center gap-3">
                <span class="w-8 h-8 text-bitcoin-500" set:html={categoryIcons[cat]} />
                {categoryLabels[cat]}
              </h2>

              <div class="space-y-4">
                {faqsByCategory[cat].map(async (entry) => {
                  const { Content } = await entry.render();
                  return (
                    <details
                      class="faq-item group rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)] overflow-hidden"
                      data-question={entry.data.question.toLowerCase()}
                      data-short={entry.data.short?.toLowerCase() || ''}
                      data-category={cat}
                    >
                      <summary class="flex items-start justify-between p-4 cursor-pointer hover:bg-bitcoin-500/5 transition-colors">
                        <div class="flex-1 pr-4">
                          <h3 class="font-semibold text-[var(--text-primary)]">
                            {entry.data.question}
                          </h3>
                          {entry.data.short && (
                            <p class="text-sm text-[var(--text-secondary)] mt-1 group-open:hidden">
                              {entry.data.short}
                            </p>
                          )}
                        </div>
                        <svg
                          class="w-5 h-5 text-[var(--text-tertiary)] flex-shrink-0 transition-transform group-open:rotate-180 mt-1"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                      </summary>
                      <div class="px-4 pb-4 prose prose-sm prose-zh dark:prose-invert max-w-none">
                        <Content />
                      </div>
                    </details>
                  );
                })}
              </div>
            </div>
          ))
        }

        <!-- 無搜尋結果 -->
        <div id="no-results" class="hidden text-center py-12">
          <svg
            class="w-16 h-16 mx-auto text-[var(--text-tertiary)] mb-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-2">找不到相關問題</h3>
          <p class="text-[var(--text-secondary)]">
            試試其他關鍵字，或
            <a
              href="https://github.com/21dev-org/21dev-org/issues/new"
              class="text-bitcoin-500 hover:underline"
            >
              提出你的問題
            </a>
          </p>
        </div>
      </div>

      <!-- 還有問題？ -->
      <div
        class="max-w-3xl mx-auto mt-16 p-6 rounded-xl bg-bitcoin-500/5 border border-bitcoin-500/20 text-center"
      >
        <h2 class="text-xl font-bold text-[var(--text-primary)] mb-2">還有其他問題？</h2>
        <p class="text-[var(--text-secondary)] mb-4">
          如果你的問題沒有在這裡找到答案，歡迎透過以下方式聯繫我們。
        </p>
        <div class="flex flex-wrap justify-center gap-3">
          <a
            href="https://github.com/21dev-org/21dev-org/issues/new"
            class="px-4 py-2 rounded-lg bg-bitcoin-500 text-white text-sm font-medium hover:bg-bitcoin-600 transition-colors"
          >
            在 GitHub 提問
          </a>
          <a
            href="https://signal.group/#CjQKIKEW5NtKmgLKX9JOei4GOaTCl1enEIOpFC1R6vjm5_RCEhD3TXZew1_1HSLkD9sh8r5K"
            class="px-4 py-2 rounded-lg bg-[var(--surface-elevated)] border border-[var(--border-default)] text-sm font-medium hover:border-bitcoin-500/50 transition-colors"
          >
            加入 Signal 群組
          </a>
        </div>
      </div>
    </div>
  </section>
</PageLayout>

<script>
  function initFaqSearch() {
    const searchInput = document.getElementById('faq-search') as HTMLInputElement;
    const searchCount = document.getElementById('faq-search-count');
    const faqItems = document.querySelectorAll('.faq-item');
    const categorySections = document.querySelectorAll('.category-section');
    const categoryFilters = document.querySelectorAll('.category-filter');
    const noResults = document.getElementById('no-results');

    let currentCategory = 'all';
    let currentQuery = '';

    function filterItems() {
      let visibleCount = 0;

      faqItems.forEach((item) => {
        const question = item.getAttribute('data-question') || '';
        const short = item.getAttribute('data-short') || '';
        const category = item.getAttribute('data-category') || '';

        const matchesSearch =
          !currentQuery || question.includes(currentQuery) || short.includes(currentQuery);

        const matchesCategory = currentCategory === 'all' || category === currentCategory;

        const isVisible = matchesSearch && matchesCategory;
        (item as HTMLElement).style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
      });

      // Update category sections visibility
      categorySections.forEach((section) => {
        const visibleItems = section.querySelectorAll('.faq-item:not([style*="display: none"])');
        (section as HTMLElement).style.display = visibleItems.length > 0 ? '' : 'none';
      });

      // Show/hide no results message
      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount > 0);
      }

      // Update search count
      if (searchCount) {
        if (currentQuery || currentCategory !== 'all') {
          searchCount.textContent = `${visibleCount} 個結果`;
          searchCount.classList.remove('hidden');
        } else {
          searchCount.classList.add('hidden');
        }
      }
    }

    // Search input handler
    searchInput?.addEventListener('input', (e) => {
      currentQuery = (e.target as HTMLInputElement).value.toLowerCase().trim();
      filterItems();
    });

    // Category filter handlers
    categoryFilters.forEach((btn) => {
      btn.addEventListener('click', () => {
        currentCategory = btn.getAttribute('data-category') || 'all';

        // Update button styles
        categoryFilters.forEach((b) => {
          if (b.getAttribute('data-category') === currentCategory) {
            b.classList.remove(
              'bg-[var(--surface-elevated)]',
              'border',
              'border-[var(--border-default)]'
            );
            b.classList.add('bg-bitcoin-500', 'text-white');
          } else {
            b.classList.add(
              'bg-[var(--surface-elevated)]',
              'border',
              'border-[var(--border-default)]'
            );
            b.classList.remove('bg-bitcoin-500', 'text-white');
          }
        });

        filterItems();
      });
    });
  }

  // Initialize on page load
  initFaqSearch();
  document.addEventListener('astro:after-swap', initFaqSearch);
</script>
