---
import PageLayout from '@/layouts/PageLayout.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import Tag from '@/components/ui/Tag.astro';
import { getCollection } from 'astro:content';

// å–å¾—æ‰€æœ‰ FAQ
const faqEntries = await getCollection('faq');

// åˆ†é¡æ¨™ç±¤
const categoryLabels: Record<string, string> = {
  'getting-started': 'å…¥é–€å•é¡Œ',
  wallet: 'éŒ¢åŒ…å•é¡Œ',
  transaction: 'äº¤æ˜“å•é¡Œ',
  security: 'å®‰å…¨å•é¡Œ',
  technical: 'æŠ€è¡“å•é¡Œ',
  lightning: 'é–ƒé›»ç¶²è·¯',
};

const categoryIcons: Record<string, string> = {
  'getting-started': 'ğŸš€',
  wallet: 'ğŸ‘›',
  transaction: 'ğŸ’¸',
  security: 'ğŸ”’',
  technical: 'âš™ï¸',
  lightning: 'âš¡',
};

// æŒ‰åˆ†é¡å’Œæ’åºåˆ†çµ„
const faqsByCategory = faqEntries.reduce(
  (acc, entry) => {
    const cat = entry.data.category;
    if (!acc[cat]) acc[cat] = [];
    acc[cat].push(entry);
    return acc;
  },
  {} as Record<string, typeof faqEntries>
);

// æ’åºæ¯å€‹åˆ†é¡å…§çš„å•é¡Œ
Object.keys(faqsByCategory).forEach((cat) => {
  faqsByCategory[cat].sort((a, b) => (a.data.order || 99) - (b.data.order || 99));
});

// ç”Ÿæˆ FAQ Schema
const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: await Promise.all(
    faqEntries.map(async (entry) => {
      const { Content } = await entry.render();
      // ç°¡åŒ–ç‰ˆï¼šåªå–å•é¡Œï¼Œç­”æ¡ˆåœ¨é é¢å…§å±•ç¤º
      return {
        '@type': 'Question',
        name: entry.data.question,
        acceptedAnswer: {
          '@type': 'Answer',
          text: entry.data.question, // ç°¡åŒ–è™•ç†
        },
      };
    })
  ),
};

// åˆ†é¡é †åº
const categoryOrder = [
  'getting-started',
  'wallet',
  'security',
  'transaction',
  'lightning',
  'technical',
];
const sortedCategories = categoryOrder.filter((cat) => faqsByCategory[cat]?.length > 0);
---

<PageLayout
  title="å¸¸è¦‹å•é¡Œ FAQ"
  description="æ¯”ç‰¹å¹£æ–°æ‰‹å¸¸è¦‹å•é¡Œè§£ç­”ï¼šä»€éº¼æ˜¯æ¯”ç‰¹å¹£ã€å¦‚ä½•è³¼è²·ã€å¦‚ä½•å®‰å…¨ä¿ç®¡ã€é–ƒé›»ç¶²è·¯æ˜¯ä»€éº¼ç­‰ã€‚"
>
  <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />

  <section
    class="py-16 md:py-24 bg-gradient-to-b from-[var(--bg-secondary)] to-[var(--bg-primary)]"
  >
    <div class="container-wide">
      <Breadcrumb items={[{ label: 'å¸¸è¦‹å•é¡Œ' }]} />
      <div class="max-w-3xl">
        <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)] mb-6">å¸¸è¦‹å•é¡Œ</h1>
        <p class="text-xl text-[var(--text-secondary)]">
          æ¯”ç‰¹å¹£æ–°æ‰‹æœ€å¸¸å•çš„å•é¡Œï¼Œå¾å…¥é–€åˆ°é€²éšä¸€æ¬¡è§£ç­”ã€‚
        </p>
      </div>

      <!-- åˆ†é¡å¿«é€Ÿè·³è½‰ -->
      <div class="flex flex-wrap gap-3 mt-8">
        {
          sortedCategories.map((cat) => (
            <a
              href={`#${cat}`}
              class="px-4 py-2 rounded-full bg-[var(--surface-elevated)] border border-[var(--border-default)] text-sm font-medium hover:border-bitcoin-500/50 hover:text-bitcoin-500 transition-colors"
            >
              {categoryIcons[cat]} {categoryLabels[cat]}
              <span class="ml-1 text-[var(--text-tertiary)]">({faqsByCategory[cat].length})</span>
            </a>
          ))
        }
      </div>
    </div>
  </section>

  <!-- FAQ å…§å®¹ -->
  <section class="py-16 md:py-24">
    <div class="container-wide">
      <div class="max-w-3xl mx-auto space-y-16">
        {
          sortedCategories.map((cat) => (
            <div id={cat} class="scroll-mt-24">
              <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-6 flex items-center gap-2">
                <span class="text-3xl">{categoryIcons[cat]}</span>
                {categoryLabels[cat]}
              </h2>

              <div class="space-y-4">
                {faqsByCategory[cat].map(async (entry) => {
                  const { Content } = await entry.render();
                  return (
                    <details class="group rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)] overflow-hidden">
                      <summary class="flex items-center justify-between p-4 cursor-pointer hover:bg-bitcoin-500/5 transition-colors">
                        <h3 class="font-semibold text-[var(--text-primary)] pr-4">
                          {entry.data.question}
                        </h3>
                        <svg
                          class="w-5 h-5 text-[var(--text-tertiary)] flex-shrink-0 transition-transform group-open:rotate-180"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                      </summary>
                      <div class="px-4 pb-4 prose prose-sm prose-zh dark:prose-invert max-w-none">
                        <Content />
                      </div>
                    </details>
                  );
                })}
              </div>
            </div>
          ))
        }
      </div>

      <!-- é‚„æœ‰å•é¡Œï¼Ÿ -->
      <div
        class="max-w-3xl mx-auto mt-16 p-6 rounded-xl bg-bitcoin-500/5 border border-bitcoin-500/20 text-center"
      >
        <h2 class="text-xl font-bold text-[var(--text-primary)] mb-2">é‚„æœ‰å…¶ä»–å•é¡Œï¼Ÿ</h2>
        <p class="text-[var(--text-secondary)] mb-4">
          å¦‚æœä½ çš„å•é¡Œæ²’æœ‰åœ¨é€™è£¡æ‰¾åˆ°ç­”æ¡ˆï¼Œæ­¡è¿é€éä»¥ä¸‹æ–¹å¼è¯ç¹«æˆ‘å€‘ã€‚
        </p>
        <div class="flex flex-wrap justify-center gap-3">
          <a
            href="https://github.com/21dev-org/21dev-org/issues/new"
            class="px-4 py-2 rounded-lg bg-bitcoin-500 text-white text-sm font-medium hover:bg-bitcoin-600 transition-colors"
          >
            åœ¨ GitHub æå•
          </a>
          <a
            href="https://signal.group/#CjQKIKEW5NtKmgLKX9JOei4GOaTCl1enEIOpFC1R6vjm5_RCEhD3TXZew1_1HSLkD9sh8r5K"
            class="px-4 py-2 rounded-lg bg-[var(--surface-elevated)] border border-[var(--border-default)] text-sm font-medium hover:border-bitcoin-500/50 transition-colors"
          >
            åŠ å…¥ Signal ç¾¤çµ„
          </a>
        </div>
      </div>
    </div>
  </section>
</PageLayout>
