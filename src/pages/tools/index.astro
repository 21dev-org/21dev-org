---
import PageLayout from '@/layouts/PageLayout.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import Tag from '@/components/ui/Tag.astro';

// SVG icons for tools
const toolIcons: Record<string, string> = {
  'unit-converter': `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>`,
  'address-parser': `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>`,
  'tx-decoder': `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`,
  'script-decoder': `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`,
};

const tools = [
  {
    id: 'unit-converter',
    name: 'å–®ä½æ›ç®—å™¨',
    description: 'BTCã€è°ï¼ˆsatsï¼‰ã€mBTC ç­‰å–®ä½äº’ç›¸æ›ç®—',
    status: 'active',
  },
  {
    id: 'address-parser',
    name: 'åœ°å€è§£æå™¨',
    description: 'è§£ææ¯”ç‰¹å¹£åœ°å€é¡å‹ã€ç¶²è·¯å’Œæ ¼å¼',
    status: 'active',
  },
  {
    id: 'tx-decoder',
    name: 'äº¤æ˜“è§£ç¢¼å™¨',
    description: 'è§£æåŸå§‹äº¤æ˜“ hex ä¸¦é¡¯ç¤ºè©³ç´°è³‡è¨Š',
    status: 'coming',
  },
  {
    id: 'script-decoder',
    name: 'Script è§£ç¢¼å™¨',
    description: 'è§£æä¸¦åŸ·è¡Œ Bitcoin Script',
    status: 'coming',
  },
];
---

<PageLayout
  title="ç·šä¸Šå·¥å…·"
  description="æ¯”ç‰¹å¹£å¯¦ç”¨å·¥å…·ï¼šå–®ä½æ›ç®—ã€åœ°å€è§£æã€äº¤æ˜“è§£ç¢¼ç­‰ï¼Œå…¨éƒ¨åœ¨ç€è¦½å™¨æœ¬åœ°åŸ·è¡Œã€‚"
>
  <section
    class="py-16 md:py-24 bg-gradient-to-b from-[var(--bg-secondary)] to-[var(--bg-primary)]"
  >
    <div class="container-wide">
      <Breadcrumb items={[{ label: 'ç·šä¸Šå·¥å…·' }]} />
      <div class="max-w-3xl">
        <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)] mb-6">ç·šä¸Šå·¥å…·</h1>
        <p class="text-xl text-[var(--text-secondary)]">
          å¯¦ç”¨çš„æ¯”ç‰¹å¹£å·¥å…·ï¼Œå…¨éƒ¨åœ¨ç€è¦½å™¨æœ¬åœ°åŸ·è¡Œï¼Œä¸æœƒä¸Šå‚³ä»»ä½•è³‡æ–™ã€‚
        </p>
      </div>

      <!-- å·¥å…·å¡ç‰‡ -->
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-12">
        {
          tools.map((tool) => (
            <a
              href={tool.status === 'active' ? `#${tool.id}` : undefined}
              class:list={[
                'p-4 rounded-xl border transition-all',
                tool.status === 'active'
                  ? 'bg-[var(--surface-elevated)] border-[var(--border-default)] hover:border-bitcoin-500/50 cursor-pointer'
                  : 'bg-neutral-100/50 dark:bg-neutral-800/50 border-dashed border-[var(--border-default)] cursor-not-allowed opacity-60',
              ]}
            >
              <div class="w-8 h-8 mb-2 text-bitcoin-500" set:html={toolIcons[tool.id]} />
              <h3 class="font-semibold text-[var(--text-primary)]">{tool.name}</h3>
              <p class="text-sm text-[var(--text-secondary)] mt-1">{tool.description}</p>
              {tool.status === 'coming' && (
                <Tag size="sm" variant="default" class="mt-2">
                  å³å°‡æ¨å‡º
                </Tag>
              )}
            </a>
          ))
        }
      </div>
    </div>
  </section>

  <!-- å–®ä½æ›ç®—å™¨ -->
  <section id="unit-converter" class="py-16 md:py-24 scroll-mt-24">
    <div class="container-wide">
      <div class="max-w-2xl mx-auto">
        <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-2">ğŸ”„ å–®ä½æ›ç®—å™¨</h2>
        <p class="text-[var(--text-secondary)] mb-8">è¼¸å…¥ä»»æ„å–®ä½ï¼Œå³æ™‚æ›ç®—å…¶ä»–å–®ä½ã€‚</p>

        <div class="space-y-4">
          <!-- BTC -->
          <div class="relative">
            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">BTC</label>
            <input
              type="text"
              id="input-btc"
              placeholder="0"
              class="w-full px-4 py-3 pr-16 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)] text-[var(--text-primary)] font-mono text-lg focus:outline-none focus:ring-2 focus:ring-bitcoin-500/50 focus:border-bitcoin-500"
            />
            <span class="absolute right-4 top-9 text-[var(--text-tertiary)] font-mono">BTC</span>
          </div>

          <!-- sats -->
          <div class="relative">
            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1"
              >è° (Satoshis)</label
            >
            <input
              type="text"
              id="input-sats"
              placeholder="0"
              class="w-full px-4 py-3 pr-16 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)] text-[var(--text-primary)] font-mono text-lg focus:outline-none focus:ring-2 focus:ring-bitcoin-500/50 focus:border-bitcoin-500"
            />
            <span class="absolute right-4 top-9 text-[var(--text-tertiary)] font-mono">sats</span>
          </div>

          <!-- mBTC -->
          <div class="relative">
            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">mBTC</label>
            <input
              type="text"
              id="input-mbtc"
              placeholder="0"
              class="w-full px-4 py-3 pr-16 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)] text-[var(--text-primary)] font-mono text-lg focus:outline-none focus:ring-2 focus:ring-bitcoin-500/50 focus:border-bitcoin-500"
            />
            <span class="absolute right-4 top-9 text-[var(--text-tertiary)] font-mono">mBTC</span>
          </div>

          <!-- Î¼BTC / bits -->
          <div class="relative">
            <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1"
              >Î¼BTC (bits)</label
            >
            <input
              type="text"
              id="input-bits"
              placeholder="0"
              class="w-full px-4 py-3 pr-16 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)] text-[var(--text-primary)] font-mono text-lg focus:outline-none focus:ring-2 focus:ring-bitcoin-500/50 focus:border-bitcoin-500"
            />
            <span class="absolute right-4 top-9 text-[var(--text-tertiary)] font-mono">bits</span>
          </div>
        </div>

        <!-- æ›ç®—åƒè€ƒ -->
        <div
          class="mt-8 p-4 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)]"
        >
          <h3 class="font-semibold text-[var(--text-primary)] mb-2">æ›ç®—åƒè€ƒ</h3>
          <div class="grid grid-cols-2 gap-2 text-sm font-mono">
            <div class="text-[var(--text-secondary)]">1 BTC =</div>
            <div class="text-[var(--text-primary)]">100,000,000 sats</div>
            <div class="text-[var(--text-secondary)]">1 BTC =</div>
            <div class="text-[var(--text-primary)]">1,000 mBTC</div>
            <div class="text-[var(--text-secondary)]">1 BTC =</div>
            <div class="text-[var(--text-primary)]">1,000,000 bits</div>
            <div class="text-[var(--text-secondary)]">1 mBTC =</div>
            <div class="text-[var(--text-primary)]">100,000 sats</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- åœ°å€è§£æå™¨ -->
  <section id="address-parser" class="py-16 md:py-24 bg-[var(--bg-secondary)] scroll-mt-24">
    <div class="container-wide">
      <div class="max-w-2xl mx-auto">
        <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-2">ğŸ” åœ°å€è§£æå™¨</h2>
        <p class="text-[var(--text-secondary)] mb-8">è¼¸å…¥æ¯”ç‰¹å¹£åœ°å€ï¼Œè§£æå…¶é¡å‹å’Œç¶²è·¯ã€‚</p>

        <div>
          <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1"
            >æ¯”ç‰¹å¹£åœ°å€</label
          >
          <input
            type="text"
            id="address-input"
            placeholder="è¼¸å…¥æ¯”ç‰¹å¹£åœ°å€ï¼ˆå¦‚ bc1q... æˆ– 1...ï¼‰"
            class="w-full px-4 py-3 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)] text-[var(--text-primary)] font-mono focus:outline-none focus:ring-2 focus:ring-bitcoin-500/50 focus:border-bitcoin-500"
          />
        </div>

        <!-- è§£æçµæœ -->
        <div
          id="address-result"
          class="mt-6 p-4 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)] hidden"
        >
          <h3 class="font-semibold text-[var(--text-primary)] mb-4">è§£æçµæœ</h3>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-[var(--text-secondary)]">åœ°å€é¡å‹</span>
              <span id="result-type" class="font-mono text-bitcoin-500">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[var(--text-secondary)]">ç¶²è·¯</span>
              <span id="result-network" class="font-mono text-[var(--text-primary)]">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[var(--text-secondary)]">æ ¼å¼</span>
              <span id="result-format" class="font-mono text-[var(--text-primary)]">-</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[var(--text-secondary)]">é•·åº¦</span>
              <span id="result-length" class="font-mono text-[var(--text-primary)]">-</span>
            </div>
          </div>
        </div>

        <div
          id="address-error"
          class="mt-6 p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-red-600 dark:text-red-400 hidden"
        >
          <span id="error-message">ç„¡æ•ˆçš„åœ°å€æ ¼å¼</span>
        </div>

        <!-- åœ°å€é¡å‹èªªæ˜ -->
        <div
          class="mt-8 p-4 rounded-xl bg-[var(--surface-elevated)] border border-[var(--border-default)]"
        >
          <h3 class="font-semibold text-[var(--text-primary)] mb-3">åœ°å€é¡å‹èªªæ˜</h3>
          <div class="space-y-2 text-sm">
            <div class="flex gap-3">
              <code class="text-bitcoin-500">1...</code>
              <span class="text-[var(--text-secondary)]">P2PKH - å‚³çµ±åœ°å€</span>
            </div>
            <div class="flex gap-3">
              <code class="text-bitcoin-500">3...</code>
              <span class="text-[var(--text-secondary)]">P2SH - è…³æœ¬é›œæ¹Šåœ°å€</span>
            </div>
            <div class="flex gap-3">
              <code class="text-bitcoin-500">bc1q...</code>
              <span class="text-[var(--text-secondary)]">P2WPKH/P2WSH - åŸç”Ÿ SegWit</span>
            </div>
            <div class="flex gap-3">
              <code class="text-bitcoin-500">bc1p...</code>
              <span class="text-[var(--text-secondary)]">P2TR - Taproot</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</PageLayout>

<script>
  // å–®ä½æ›ç®—å™¨
  const SATS_PER_BTC = 100_000_000;
  const MBTC_PER_BTC = 1_000;
  const BITS_PER_BTC = 1_000_000;

  const inputBtc = document.getElementById('input-btc') as HTMLInputElement;
  const inputSats = document.getElementById('input-sats') as HTMLInputElement;
  const inputMbtc = document.getElementById('input-mbtc') as HTMLInputElement;
  const inputBits = document.getElementById('input-bits') as HTMLInputElement;

  let isUpdating = false;

  function formatNumber(num: number, decimals: number = 8): string {
    if (num === 0) return '0';
    const formatted = num.toFixed(decimals);
    // ç§»é™¤å°¾éš¨é›¶
    return formatted.replace(/\.?0+$/, '');
  }

  function parseNumber(value: string): number {
    const cleaned = value.replace(/,/g, '');
    const num = parseFloat(cleaned);
    return isNaN(num) ? 0 : num;
  }

  function updateFromBtc(btc: number) {
    if (isUpdating) return;
    isUpdating = true;
    inputSats.value = formatNumber(btc * SATS_PER_BTC, 0);
    inputMbtc.value = formatNumber(btc * MBTC_PER_BTC);
    inputBits.value = formatNumber(btc * BITS_PER_BTC);
    isUpdating = false;
  }

  function updateFromSats(sats: number) {
    if (isUpdating) return;
    isUpdating = true;
    const btc = sats / SATS_PER_BTC;
    inputBtc.value = formatNumber(btc);
    inputMbtc.value = formatNumber(btc * MBTC_PER_BTC);
    inputBits.value = formatNumber(btc * BITS_PER_BTC);
    isUpdating = false;
  }

  function updateFromMbtc(mbtc: number) {
    if (isUpdating) return;
    isUpdating = true;
    const btc = mbtc / MBTC_PER_BTC;
    inputBtc.value = formatNumber(btc);
    inputSats.value = formatNumber(btc * SATS_PER_BTC, 0);
    inputBits.value = formatNumber(btc * BITS_PER_BTC);
    isUpdating = false;
  }

  function updateFromBits(bits: number) {
    if (isUpdating) return;
    isUpdating = true;
    const btc = bits / BITS_PER_BTC;
    inputBtc.value = formatNumber(btc);
    inputSats.value = formatNumber(btc * SATS_PER_BTC, 0);
    inputMbtc.value = formatNumber(btc * MBTC_PER_BTC);
    isUpdating = false;
  }

  inputBtc?.addEventListener('input', (e) => {
    const value = parseNumber((e.target as HTMLInputElement).value);
    updateFromBtc(value);
  });

  inputSats?.addEventListener('input', (e) => {
    const value = parseNumber((e.target as HTMLInputElement).value);
    updateFromSats(value);
  });

  inputMbtc?.addEventListener('input', (e) => {
    const value = parseNumber((e.target as HTMLInputElement).value);
    updateFromMbtc(value);
  });

  inputBits?.addEventListener('input', (e) => {
    const value = parseNumber((e.target as HTMLInputElement).value);
    updateFromBits(value);
  });

  // åœ°å€è§£æå™¨
  const addressInput = document.getElementById('address-input') as HTMLInputElement;
  const addressResult = document.getElementById('address-result') as HTMLElement;
  const addressError = document.getElementById('address-error') as HTMLElement;
  const resultType = document.getElementById('result-type') as HTMLElement;
  const resultNetwork = document.getElementById('result-network') as HTMLElement;
  const resultFormat = document.getElementById('result-format') as HTMLElement;
  const resultLength = document.getElementById('result-length') as HTMLElement;
  const errorMessage = document.getElementById('error-message') as HTMLElement;

  interface AddressInfo {
    type: string;
    network: string;
    format: string;
    length: number;
  }

  function parseAddress(address: string): AddressInfo | null {
    const trimmed = address.trim();
    if (!trimmed) return null;

    // P2PKH (Legacy) - starts with 1
    if (/^1[a-km-zA-HJ-NP-Z1-9]{25,34}$/.test(trimmed)) {
      return {
        type: 'P2PKH (Legacy)',
        network: 'Mainnet',
        format: 'Base58Check',
        length: trimmed.length,
      };
    }

    // P2SH - starts with 3
    if (/^3[a-km-zA-HJ-NP-Z1-9]{25,34}$/.test(trimmed)) {
      return {
        type: 'P2SH (Script Hash)',
        network: 'Mainnet',
        format: 'Base58Check',
        length: trimmed.length,
      };
    }

    // Native SegWit (P2WPKH/P2WSH) - starts with bc1q
    if (/^bc1q[a-z0-9]{38,58}$/i.test(trimmed)) {
      const isP2wpkh = trimmed.length === 42;
      return {
        type: isP2wpkh ? 'P2WPKH (Native SegWit)' : 'P2WSH (Native SegWit)',
        network: 'Mainnet',
        format: 'Bech32',
        length: trimmed.length,
      };
    }

    // Taproot - starts with bc1p
    if (/^bc1p[a-z0-9]{58}$/i.test(trimmed)) {
      return {
        type: 'P2TR (Taproot)',
        network: 'Mainnet',
        format: 'Bech32m',
        length: trimmed.length,
      };
    }

    // Testnet P2PKH - starts with m or n
    if (/^[mn][a-km-zA-HJ-NP-Z1-9]{25,34}$/.test(trimmed)) {
      return {
        type: 'P2PKH (Legacy)',
        network: 'Testnet',
        format: 'Base58Check',
        length: trimmed.length,
      };
    }

    // Testnet P2SH - starts with 2
    if (/^2[a-km-zA-HJ-NP-Z1-9]{25,34}$/.test(trimmed)) {
      return {
        type: 'P2SH (Script Hash)',
        network: 'Testnet',
        format: 'Base58Check',
        length: trimmed.length,
      };
    }

    // Testnet SegWit - starts with tb1
    if (/^tb1[qp][a-z0-9]{38,58}$/i.test(trimmed)) {
      const isTaproot = trimmed[3] === 'p';
      return {
        type: isTaproot ? 'P2TR (Taproot)' : 'P2WPKH/P2WSH (Native SegWit)',
        network: 'Testnet',
        format: isTaproot ? 'Bech32m' : 'Bech32',
        length: trimmed.length,
      };
    }

    return null;
  }

  addressInput?.addEventListener('input', (e) => {
    const address = (e.target as HTMLInputElement).value;

    if (!address.trim()) {
      addressResult.classList.add('hidden');
      addressError.classList.add('hidden');
      return;
    }

    const info = parseAddress(address);

    if (info) {
      resultType.textContent = info.type;
      resultNetwork.textContent = info.network;
      resultFormat.textContent = info.format;
      resultLength.textContent = `${info.length} å­—å…ƒ`;
      addressResult.classList.remove('hidden');
      addressError.classList.add('hidden');
    } else {
      errorMessage.textContent = 'ç„¡æ³•è­˜åˆ¥çš„åœ°å€æ ¼å¼';
      addressError.classList.remove('hidden');
      addressResult.classList.add('hidden');
    }
  });
</script>
