---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-125: 選擇性費用替換 (RBF)"
  description="定義交易如何選擇加入 Replace-By-Fee 機制，允許以更高費用替換未確認交易。"
  breadcrumbs={[{ label: 'BIPs', href: '/bips/' }, { label: 'BIP-125' }]}
  tags={['Standards Track', 'Proposed']}
  author="David A. Harding, Peter Todd"
  date={new Date('2015-12-04')}
  prevPage={{ title: 'BIP-112: CSV', href: '/bips/bip-0112' }}
  nextPage={{ title: 'BIP-141: SegWit', href: '/bips/bip-0141' }}
>
  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">125</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Standards Track</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="warning" size="sm">Proposed</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">部署</span>
        <p class="font-semibold text-[var(--text-primary)]">Bitcoin Core 0.12+</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Replace-By-Fee (RBF) 允許未確認的交易被另一個支付更高費用的交易替換。 BIP-125 定義了「選擇性
    RBF」，只有明確標記的交易才能被替換， 這是通過將輸入的 nSequence 設置為小於 0xFFFFFFFE
    的值來實現的。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">動機</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    在比特幣網路擁塞時，低費用交易可能長時間無法確認。RBF 提供了一種機制，
    允許用戶提高交易費用以加速確認，而不必等待原交易被遺忘。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">選擇加入機制</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">交易被視為可替換的條件：</p>
  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm"
  >
    <p class="text-[var(--text-secondary)]">任一輸入的 nSequence &lt; 0xFFFFFFFE (4294967294)</p>
  </div>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    這意味著只要有一個輸入的序號小於 0xFFFFFFFE，整個交易就標記為可替換。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">替換規則</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">替換交易必須滿足以下條件：</p>
  <ul class="space-y-3 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-green-500">1.</span>
      <span
        ><strong class="text-[var(--text-primary)]">花費相同輸入</strong
        >：至少花費一個與原交易相同的輸入</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">2.</span>
      <span
        ><strong class="text-[var(--text-primary)]">更高費率</strong>：每 vbyte 的費用必須更高</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">3.</span>
      <span
        ><strong class="text-[var(--text-primary)]">更高總費用</strong
        >：總費用必須比原交易加上最低中繼費更高</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">4.</span>
      <span
        ><strong class="text-[var(--text-primary)]">不新增未確認輸入</strong
        >：不能引入新的未確認依賴</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">5.</span>
      <span
        ><strong class="text-[var(--text-primary)]">替換數量限制</strong>：最多替換 100 筆交易</span
      >
    </li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">費用計算範例</h2>
  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <div class="space-y-4 text-sm">
      <div>
        <p class="font-semibold text-[var(--text-primary)]">原交易</p>
        <p class="text-[var(--text-secondary)]">大小：250 vbytes，費用：500 sats</p>
        <p class="text-[var(--text-tertiary)]">費率：2 sat/vbyte</p>
      </div>
      <div>
        <p class="font-semibold text-[var(--text-primary)]">替換交易要求</p>
        <p class="text-[var(--text-secondary)]">費率：必須 &gt; 2 sat/vbyte</p>
        <p class="text-[var(--text-secondary)]">總費用：必須 &gt; 500 + (250 × 1) = 750 sats</p>
        <p class="text-[var(--text-tertiary)]">（假設最低中繼費為 1 sat/vbyte）</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">RBF vs CPFP</h2>
  <div class="not-prose mb-6 overflow-x-auto">
    <table class="w-full text-sm" aria-label="RBF 與 CPFP 費用提升機制比較">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">特性</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">RBF</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">CPFP</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">操作者</td>
          <td class="py-2">發送者</td>
          <td class="py-2">接收者</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">機制</td>
          <td class="py-2">替換交易</td>
          <td class="py-2">新增子交易</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">效率</td>
          <td class="py-2">較高（不增加區塊空間）</td>
          <td class="py-2">較低（需要額外交易）</td>
        </tr>
        <tr>
          <td class="py-2">要求</td>
          <td class="py-2">標記可替換</td>
          <td class="py-2">有可花費的輸出</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Full RBF</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    Bitcoin Core 24.0 引入了 <code class="px-1 bg-neutral-100 dark:bg-neutral-800 rounded"
      >mempoolfullrbf</code
    > 選項， 允許節點接受對任何未確認交易的替換，無論其是否標記為可替換。 這是為了提高網路的經濟效率，但也引發了關於零確認交易安全性的討論。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">錢包支援</h2>
  <ul class="space-y-3 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-green-500">✓</span>
      <span><strong class="text-[var(--text-primary)]">Bitcoin Core</strong>：完整支援</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">✓</span>
      <span><strong class="text-[var(--text-primary)]">Electrum</strong>：完整支援</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">✓</span>
      <span><strong class="text-[var(--text-primary)]">Sparrow</strong>：完整支援</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">✓</span>
      <span><strong class="text-[var(--text-primary)]">BlueWallet</strong>：支援</span>
    </li>
  </ul>

  <div class="not-prose mb-6 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>注意：</strong> RBF 不是共識規則，而是節點的記憶體池策略。 礦工可以選擇不遵循這些規則，但大多數節點和礦工都實現了標準的
      RBF 規則。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關資源</h2>
  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span
        ><a href="/bips/bip-0068" class="text-bitcoin-500 hover:underline">BIP-68</a>：nSequence
        相對時間鎖</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span>Bitcoin Core 費用估算文件</span>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
    <p class="text-sm text-bitcoin-700 dark:text-bitcoin-400">
      <strong>延伸閱讀：</strong> 查看
      <a
        href="https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki"
        target="_blank"
        rel="noopener noreferrer"
        class="underline hover:no-underline"
      >
        GitHub 上的完整 BIP-125 文件
      </a>
    </p>
  </div>
</ArticleLayout>
