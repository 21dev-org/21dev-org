---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-8: Version Bits 改進"
  description="改進的軟分叉部署機制，支持強制啟用選項。"
  breadcrumbs={[
    { label: 'BIPs', href: '/bips/' },
    { label: 'BIP-8' },
  ]}
  tags={['Informational', 'Draft']}
  author="Shaolin Fry, Luke Dashjr"
  date={new Date('2017-02-01')}
  prevPage={{ title: 'BIP-2: BIP 流程', href: '/bips/bip-0002' }}
  nextPage={{ title: 'BIP-9: Version Bits', href: '/bips/bip-0009' }}
>
  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">8</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Informational</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="default" size="sm">Draft</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">使用案例</span>
        <p class="font-semibold text-[var(--text-primary)]">Taproot</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-8 是 BIP-9 的改進版本，增加了在超時後強制啟用（lock-in on timeout）的選項。
    這解決了 BIP-9 中礦工可能無限期阻止升級的問題。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BIP-9 的問題</h2>

  <div class="not-prose mb-8 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">為什麼需要改進？</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-2">
      <li>• BIP-9 給予礦工事實上的否決權</li>
      <li>• 超時後升級自動失敗，必須重新部署</li>
      <li>• 礦工可能出於商業利益而非技術原因阻止升級</li>
      <li>• 這與比特幣「用戶主導」的精神相悖</li>
    </ul>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">BIP-8 的解決方案</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">LOT 參數</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-8 引入了 <code class="px-1 py-0.5 rounded bg-[var(--bg-secondary)]">lockinontimeout</code>（LOT）參數：
  </p>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">LOT = false</h4>
      <p class="text-sm text-[var(--text-secondary)] mb-3">
        與 BIP-9 行為相同。超時後如果未達閾值，升級失敗。
      </p>
      <div class="text-xs px-2 py-1 rounded bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 inline-block">
        礦工主導
      </div>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">LOT = true</h4>
      <p class="text-sm text-[var(--text-secondary)] mb-3">
        超時後自動鎖定（MUST_SIGNAL），強制啟用。礦工必須發送信號否則區塊無效。
      </p>
      <div class="text-xs px-2 py-1 rounded bg-green-500/10 text-green-600 dark:text-green-400 inline-block">
        用戶主導
      </div>
    </div>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">改進的狀態機</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
                    DEFINED
                       │
                       │ start_height 到達
                       ↓
                    STARTED ──────────────────────┐
                       │                          │
          ┌────────────┼────────────┐             │
          │            │            │             │
          │ 達到閾值   │ 超時       │ 超時       │
          │            │ (LOT=true) │ (LOT=false) │
          ↓            ↓            │             ↓
      LOCKED_IN   MUST_SIGNAL       │          FAILED
          │            │            │
          │            │ 下一週期   │
          │            ↓            │
          │       LOCKED_IN ────────┘
          │            │
          └────────────┤
                       │ 下一週期
                       ↓
                    ACTIVE</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">MUST_SIGNAL 狀態</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    當 LOT=true 且超時到達時，進入 MUST_SIGNAL 狀態：
  </p>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>• 所有區塊必須設置對應的信號位元</li>
    <li>• 不設置信號的區塊被視為無效</li>
    <li>• 這確保升級必定啟用</li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">部署參數</h2>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse" aria-label="BIP-8 部署參數與 BIP-9 對比">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">參數</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">說明</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">對比 BIP-9</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">bit</td>
          <td class="p-3">信號位元位置</td>
          <td class="p-3">相同</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">start_height</td>
          <td class="p-3">開始高度（區塊高度而非時間）</td>
          <td class="p-3 text-green-500">改用高度</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">timeout_height</td>
          <td class="p-3">超時高度</td>
          <td class="p-3 text-green-500">改用高度</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">threshold</td>
          <td class="p-3">啟用閾值</td>
          <td class="p-3">相同</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">min_activation_height</td>
          <td class="p-3">最早啟用高度</td>
          <td class="p-3 text-green-500">新增</td>
        </tr>
        <tr>
          <td class="p-3 font-mono">lockinontimeout</td>
          <td class="p-3">超時後是否強制啟用</td>
          <td class="p-3 text-green-500">新增</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">使用高度而非時間</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-8 使用區塊高度而非 MTP（中位時間）的原因：
  </p>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>• <strong>更可預測</strong>：高度是確定的，時間可能因難度調整而變化</li>
    <li>• <strong>避免時間戳攻擊</strong>：礦工可以操縱時間戳來影響啟用</li>
    <li>• <strong>更容易驗證</strong>：輕客戶端可以輕鬆驗證高度</li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Taproot 啟用案例</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Taproot（BIP-341）使用修改版的 BIP-8 進行部署，稱為「Speedy Trial」：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">Taproot 部署參數</h4>
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">bit</span>
        <p class="font-mono text-[var(--text-primary)]">2</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">start_height</span>
        <p class="font-mono text-[var(--text-primary)]">681,408</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">timeout_height</span>
        <p class="font-mono text-[var(--text-primary)]">693,504</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">min_activation_height</span>
        <p class="font-mono text-[var(--text-primary)]">709,632</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">threshold</span>
        <p class="font-mono text-[var(--text-primary)]">90% (1815/2016)</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">結果</span>
        <p class="font-mono text-green-500">鎖定於區塊 687,284</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">LOT 爭議</h2>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">社群辯論</h4>
    <p class="text-sm text-[var(--text-secondary)] mb-3">
      LOT 參數引發了激烈的社群辯論：
    </p>
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <h5 class="font-medium text-[var(--text-primary)] mb-1">LOT=true 支持者</h5>
        <ul class="text-sm text-[var(--text-secondary)] space-y-1">
          <li>• 用戶應該控制協議規則</li>
          <li>• 防止礦工否決權</li>
          <li>• 更快達成共識</li>
        </ul>
      </div>
      <div>
        <h5 class="font-medium text-[var(--text-primary)] mb-1">LOT=false 支持者</h5>
        <ul class="text-sm text-[var(--text-secondary)] space-y-1">
          <li>• 避免鏈分裂風險</li>
          <li>• 給予更多協調時間</li>
          <li>• 更保守的升級方式</li>
        </ul>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">總結</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-8 提供了更靈活的軟分叉部署機制，特別是 LOT=true 選項讓社群可以
    確保升級不被少數礦工阻止。Taproot 的成功啟用證明了這種機制的可行性。
  </p>

  <div class="not-prose mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">延伸閱讀</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-1">
      <li>
        <a href="https://github.com/bitcoin/bips/blob/master/bip-0008.mediawiki" target="_blank" rel="noopener noreferrer" class="text-bitcoin-500 hover:underline">
          BIP-8 完整規格
        </a>
      </li>
      <li>
        <a href="/bips/bip-0341" class="text-bitcoin-500 hover:underline">
          BIP-341: Taproot
        </a>
      </li>
    </ul>
  </div>
</ArticleLayout>
