---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-322: 通用消息簽章"
  description="定義適用於所有 Bitcoin 腳本類型的通用消息簽章格式。"
  breadcrumbs={[
    { label: 'BIPs', href: '/bips/' },
    { label: 'BIP-322' },
  ]}
  tags={['Standards Track', 'Draft']}
  author="Karl-Johan Alm"
  date={new Date('2018-09-10')}
  prevPage={{ title: 'BIP-174: PSBT', href: '/bips/bip-0174' }}
  nextPage={{ title: 'BIP-324: v2 P2P', href: '/bips/bip-0324' }}
>
  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">322</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Standards Track</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="default" size="sm">Draft</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">取代</span>
        <p class="font-semibold text-[var(--text-primary)]">傳統簽章</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-322 定義了一個通用的消息簽章標準，可以用於任何 Bitcoin 腳本類型，
    包括 P2PKH、P2SH、P2WPKH、P2WSH、P2TR 等。它取代了傳統的「Bitcoin Signed Message」格式，
    提供更靈活和強大的簽章能力。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">動機</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">傳統簽章的限制</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    傳統的 Bitcoin 消息簽章（「Bitcoin Signed Message:」前綴）只支援 P2PKH 地址：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">傳統格式的問題</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-2">
      <li>• <strong>僅支援 P2PKH</strong>：無法為 SegWit、多簽或 Taproot 地址簽章</li>
      <li>• <strong>無法證明腳本能力</strong>：只證明擁有私鑰，不證明能花費</li>
      <li>• <strong>格式不一致</strong>：不同錢包實作略有差異</li>
      <li>• <strong>安全疑慮</strong>：可能被用於構建惡意交易</li>
    </ul>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">BIP-322 的優勢</h3>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">通用性</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        支援所有標準和非標準腳本類型，包括多簽、時間鎖和自定義腳本。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">可證明性</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        證明簽章者確實能夠花費該地址的資金，而不僅僅是知道私鑰。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">標準化</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        提供統一的格式，減少錢包間的相容性問題。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">可擴展</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        支援完整簽章和簡單簽章兩種模式，適應不同需求。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">核心概念</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">虛擬交易</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-322 的核心思想是創建一個「虛擬交易」來證明對地址的控制權：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
簽章過程：

1. 構建「to_spend」交易（虛擬 UTXO）
   ┌─────────────────────────────────────────┐
   │ 輸入：特殊的空輸入                      │
   │ 輸出：要證明的地址（scriptPubKey）      │
   │ 輸出金額：0                             │
   └─────────────────────────────────────────┘

2. 構建「to_sign」交易（簽章交易）
   ┌─────────────────────────────────────────┐
   │ 輸入：引用 to_spend 的輸出              │
   │ 輸入簽章：證明控制權的簽章              │
   │ 輸出：OP_RETURN（空）                   │
   └─────────────────────────────────────────┘

3. 簽章結果 = to_sign 交易的見證資料</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">消息哈希</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
消息被包含在 to_spend 交易的 scriptSig 中：

to_spend.vin[0].scriptSig = OP_0 OP_PUSH32 &lt;message_hash&gt;

其中：
message_hash = SHA256(SHA256(
  tag || tag || message
))

tag = "BIP0322-signed-message"

這確保消息無法被重新用於其他目的。</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">簽章類型</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">簡單簽章（Simple）</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    適用於單一簽章者的簡單腳本：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
簡單簽章格式：

• 適用：P2PKH, P2WPKH, P2TR（單一密鑰）
• 格式：Base64 編碼的見證堆疊
• 大小：約 64-73 bytes

範例（P2WPKH）：
witness = [
  &lt;signature&gt;,   // 64-72 bytes
  &lt;pubkey&gt;       // 33 bytes
]

簽章 = Base64(serialize(witness))</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">完整簽章（Full）</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    適用於複雜腳本，如多簽：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
完整簽章格式：

• 適用：P2SH, P2WSH, 多簽, 自定義腳本
• 格式：完整的 to_sign 交易
• 包含：所有輸入的簽章和見證資料

範例（2-of-3 多簽）：
witness = [
  OP_0,              // 多簽 bug
  &lt;sig1&gt;,            // 第一個簽章
  &lt;sig2&gt;,            // 第二個簽章
  &lt;redeem_script&gt;    // 贖回腳本
]

簽章 = Base64(serialize(to_sign_tx))</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">各地址類型支援</h2>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left p-3 text-[var(--text-primary)]">地址類型</th>
          <th class="text-left p-3 text-[var(--text-primary)]">傳統簽章</th>
          <th class="text-left p-3 text-[var(--text-primary)]">BIP-322</th>
          <th class="text-left p-3 text-[var(--text-primary)]">簽章模式</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">P2PKH (1...)</td>
          <td class="p-3 text-green-500">支援</td>
          <td class="p-3 text-green-500">支援</td>
          <td class="p-3">Simple</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">P2SH (3...)</td>
          <td class="p-3 text-red-500">不支援</td>
          <td class="p-3 text-green-500">支援</td>
          <td class="p-3">Full</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">P2WPKH (bc1q...)</td>
          <td class="p-3 text-red-500">不支援</td>
          <td class="p-3 text-green-500">支援</td>
          <td class="p-3">Simple</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">P2WSH (bc1q...)</td>
          <td class="p-3 text-red-500">不支援</td>
          <td class="p-3 text-green-500">支援</td>
          <td class="p-3">Full</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">P2TR (bc1p...)</td>
          <td class="p-3 text-red-500">不支援</td>
          <td class="p-3 text-green-500">支援</td>
          <td class="p-3">Simple/Full</td>
        </tr>
        <tr>
          <td class="p-3 font-mono">多簽</td>
          <td class="p-3 text-red-500">不支援</td>
          <td class="p-3 text-green-500">支援</td>
          <td class="p-3">Full</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">驗證流程</h2>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
驗證 BIP-322 簽章：

1. 解析輸入
   address = "bc1q..."
   message = "I own this address"
   signature = "Base64..."

2. 重建 to_spend 交易
   to_spend = create_to_spend(address, message)

3. 重建 to_sign 交易
   to_sign = create_to_sign(to_spend, signature)

4. 驗證交易
   • 檢查 to_sign 是否正確花費 to_spend
   • 驗證簽章是否有效
   • 驗證腳本是否滿足

5. 結果
   valid = script_verify(to_spend, to_sign)</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Taproot 簽章</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-322 對 Taproot 地址有特殊支援：
  </p>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Key Path 簽章</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        使用內部密鑰直接簽章，產生 Simple 格式的簽章。
        見證只包含 64 bytes 的 Schnorr 簽章。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Script Path 簽章</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        使用腳本路徑簽章，產生 Full 格式的簽章。
        包含腳本、控制塊和相關簽章。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">應用場景</h2>

  <div class="not-prose mb-8 space-y-4">
    <div class="p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">身份驗證</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        證明你控制某個 Bitcoin 地址，用於登入、身份驗證或所有權證明。
        例如：在論壇或社交媒體證明你是某個地址的擁有者。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">法律文件</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        簽署合約或協議，提供不可否認的加密證據。
        結合時間戳服務可以證明簽章時間。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">多簽協調</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        在多簽設置中，各方可以簽署消息來協調決策，
        而不需要實際創建鏈上交易。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-purple-500/10 border border-purple-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">儲備證明</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        交易所或託管商可以證明他們控制聲稱的地址，
        提供更可靠的 Proof of Reserves。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">安全考量</h2>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">注意事項</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-2">
      <li>
        <strong>重放攻擊</strong>：簽章可以被重複使用。如果需要防止重放，
        應在消息中包含時間戳或 nonce。
      </li>
      <li>
        <strong>消息解讀</strong>：確保用戶清楚知道他們簽署的內容。
        惡意應用可能誘導用戶簽署誤導性消息。
      </li>
      <li>
        <strong>腳本複雜度</strong>：複雜腳本的簽章可能揭露腳本結構，
        影響隱私。
      </li>
    </ul>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實作狀態</h2>

  <div class="not-prose mb-8 space-y-3">
    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
      <span class="font-medium text-[var(--text-primary)]">Bitcoin Core</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— signmessage / verifymessage RPC（部分支援）</span>
    </div>
    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
      <span class="font-medium text-[var(--text-primary)]">Sparrow Wallet</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 完整 BIP-322 支援</span>
    </div>
    <div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
      <span class="font-medium text-[var(--text-primary)]">其他錢包</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 逐漸增加支援中</span>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">總結</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-322 通過使用虛擬交易的概念，提供了一個適用於所有 Bitcoin 腳本類型的通用消息簽章標準。
    它解決了傳統簽章格式的限制，特別是對 SegWit 和 Taproot 地址的支援，
    為身份驗證、合約簽署和儲備證明等應用場景提供了強大的工具。
  </p>

  <div class="not-prose mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">延伸閱讀</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-1">
      <li>
        <a href="https://github.com/bitcoin/bips/blob/master/bip-0322.mediawiki" target="_blank" rel="noopener noreferrer" class="text-bitcoin-500 hover:underline">
          BIP-322 完整規格
        </a>
      </li>
      <li>
        <a href="https://sparrowwallet.com/" target="_blank" rel="noopener noreferrer" class="text-bitcoin-500 hover:underline">
          Sparrow Wallet（支援 BIP-322）
        </a>
      </li>
    </ul>
  </div>
</ArticleLayout>
