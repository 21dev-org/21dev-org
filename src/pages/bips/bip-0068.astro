---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-68: 相對時間鎖 (nSequence)"
  description="重新定義 nSequence 欄位以支援相對時間鎖，是閃電網路的關鍵基礎設施。"
  breadcrumbs={[
    { label: 'BIPs', href: '/bips/' },
    { label: 'BIP-68' },
  ]}
  tags={['Standards Track', 'Final']}
  author="Mark Friedenbach, BtcDrak, Nicolas Dorier, kinoshitajona"
  date={new Date('2015-05-28')}
  prevPage={{ title: 'BIP-66: Strict DER', href: '/bips/bip-0066' }}
  nextPage={{ title: 'BIP-84: Native SegWit', href: '/bips/bip-0084' }}
>
  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">68</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Standards Track</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="success" size="sm">Final</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">啟用日期</span>
        <p class="font-semibold text-[var(--text-primary)]">2016-07</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-68 重新定義了交易輸入中 nSequence 欄位的語意，使其能夠表示相對時間鎖。
    相對時間鎖允許輸出在被確認後的一定時間或區塊數之後才能被花費，
    這與 CLTV 的「絕對時間鎖」形成互補。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">動機</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    相對時間鎖是建構高級智能合約的關鍵功能，特別是對於：
  </p>
  <ul class="space-y-3 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span><strong class="text-[var(--text-primary)]">閃電網路</strong>：撤銷機制需要相對時間鎖</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span><strong class="text-[var(--text-primary)]">雙向支付通道</strong>：確保舊狀態可被懲罰</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span><strong class="text-[var(--text-primary)]">繼承合約</strong>：資金在一段不活動期後轉移</span>
    </li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">nSequence 位元結構</h2>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <pre class="text-[var(--text-secondary)]">
位元 31:    停用標誌 (1 = 停用相對鎖定)
位元 22:    類型標誌 (0 = 區塊, 1 = 時間)
位元 0-15:  值 (區塊數或 512 秒單位)
    </pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">解碼規則</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <div class="grid md:grid-cols-2 gap-4 text-sm">
      <div>
        <p class="font-semibold text-[var(--text-primary)] mb-2">區塊高度模式</p>
        <p class="text-[var(--text-secondary)]">位元 22 = 0</p>
        <p class="text-[var(--text-tertiary)]">值 = 區塊數量</p>
        <p class="text-[var(--text-tertiary)]">範圍：1 ~ 65535 區塊</p>
      </div>
      <div>
        <p class="font-semibold text-[var(--text-primary)] mb-2">時間模式</p>
        <p class="text-[var(--text-secondary)]">位元 22 = 1</p>
        <p class="text-[var(--text-tertiary)]">值 × 512 秒</p>
        <p class="text-[var(--text-tertiary)]">範圍：~8.5 分鐘 ~ ~1 年</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">範例</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">鎖定 144 區塊（約 1 天）</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <p class="text-[var(--text-secondary)]">nSequence = 0x00000090 (144 in hex)</p>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">鎖定 1 天（時間模式）</h3>
  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto">
    <p class="text-[var(--text-secondary)]">nSequence = 0x004000A8</p>
    <p class="text-[var(--text-tertiary)]"># 位元 22 = 1, 值 = 168 (168 × 512 秒 ≈ 24 小時)</p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">CLTV vs CSV</h2>
  <div class="not-prose mb-6 overflow-x-auto">
    <table class="w-full text-sm" aria-label="CLTV 與 CSV 時間鎖比較">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">特性</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">CLTV (BIP-65)</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">CSV (BIP-68/112)</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">時間類型</td>
          <td class="py-2">絕對時間</td>
          <td class="py-2">相對時間</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">參考點</td>
          <td class="py-2">固定區塊/時間</td>
          <td class="py-2">輸入確認時間</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">用途</td>
          <td class="py-2">到期日合約</td>
          <td class="py-2">等待期合約</td>
        </tr>
        <tr>
          <td class="py-2">閃電網路</td>
          <td class="py-2">HTLC 超時</td>
          <td class="py-2">撤銷機制</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">閃電網路應用</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    在閃電網路中，相對時間鎖用於懲罰機制：
  </p>
  <ol class="space-y-3 text-[var(--text-secondary)] mb-6 list-decimal list-inside">
    <li>Alice 廣播舊的通道狀態</li>
    <li>Bob 有一個相對時間鎖窗口期（例如 144 區塊）來檢測</li>
    <li>在窗口期內，Bob 可以使用撤銷密鑰拿走所有資金</li>
    <li>這確保了通道參與者不會作弊</li>
  </ol>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關 BIP</h2>
  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span><a href="/bips/bip-0065" class="text-bitcoin-500 hover:underline">BIP-65</a>：OP_CHECKLOCKTIMEVERIFY</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span><a href="/bips/bip-0112" class="text-bitcoin-500 hover:underline">BIP-112</a>：OP_CHECKSEQUENCEVERIFY</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span>BIP-113：Median Time Past</span>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
    <p class="text-sm text-bitcoin-700 dark:text-bitcoin-400">
      <strong>延伸閱讀：</strong> 查看
      <a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki" target="_blank" rel="noopener noreferrer" class="underline hover:no-underline">
        GitHub 上的完整 BIP-68 文件
      </a>
    </p>
  </div>
</ArticleLayout>
