---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-112: OP_CHECKSEQUENCEVERIFY (CSV)"
  description="在腳本中驗證相對時間鎖，是閃電網路撤銷機制的核心組件。"
  breadcrumbs={[{ label: 'BIPs', href: '/bips/' }, { label: 'BIP-112' }]}
  tags={['Standards Track', 'Final']}
  author="BtcDrak, Mark Friedenbach, Eric Lombrozo"
  date={new Date('2015-08-10')}
  prevPage={{ title: 'BIP-84: 原生 SegWit', href: '/bips/bip-0084' }}
  nextPage={{ title: 'BIP-125: RBF', href: '/bips/bip-0125' }}
>
  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">112</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Standards Track</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="success" size="sm">Final</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">啟用日期</span>
        <p class="font-semibold text-[var(--text-primary)]">2016-07</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    OP_CHECKSEQUENCEVERIFY (CSV) 是一個操作碼，允許腳本驗證輸入的 nSequence 值符合相對時間鎖要求。
    它與 BIP-68 配合使用，使相對時間鎖成為花費條件的強制部分。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">與 BIP-68 的關係</h2>
  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <div class="grid md:grid-cols-2 gap-4 text-sm">
      <div>
        <p class="font-semibold text-[var(--text-primary)] mb-2">BIP-68</p>
        <p class="text-[var(--text-secondary)]">定義 nSequence 的語意</p>
        <p class="text-[var(--text-tertiary)]">共識層面的相對鎖定</p>
      </div>
      <div>
        <p class="font-semibold text-[var(--text-primary)] mb-2">BIP-112</p>
        <p class="text-[var(--text-secondary)]">腳本層面的驗證</p>
        <p class="text-[var(--text-tertiary)]">使時間鎖成為花費條件</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">運作方式</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">執行邏輯</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    CSV 重新定義了之前未使用的 OP_NOP3 操作碼：
  </p>
  <ol class="space-y-3 text-[var(--text-secondary)] mb-6 list-decimal list-inside">
    <li>從堆疊讀取一個值（不彈出）</li>
    <li>檢查該值的停用位元（位元 31）</li>
    <li>如果未停用，與輸入的 nSequence 比較</li>
    <li>驗證類型（區塊/時間）必須匹配</li>
    <li>驗證 nSequence 值 ≥ 腳本中的值</li>
  </ol>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">腳本範例</h3>
  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <p class="text-[var(--text-tertiary)] mb-2"># 資金必須等待 144 區塊後才能被 Alice 花費</p>
    <p class="text-[var(--text-secondary)]">&lt;144&gt; OP_CHECKSEQUENCEVERIFY OP_DROP</p>
    <p class="text-[var(--text-secondary)]">&lt;Alice's pubkey&gt; OP_CHECKSIG</p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">閃電網路撤銷機制</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">閃電網路使用 CSV 來實現懲罰機制：</p>
  <div
    class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm overflow-x-auto"
  >
    <p class="text-[var(--text-tertiary)] mb-2"># 典型的閃電網路承諾交易輸出腳本</p>
    <p class="text-[var(--text-secondary)]">OP_IF</p>
    <p class="text-[var(--text-secondary)]"># 撤銷路徑 - Bob 可以立即用撤銷密鑰花費</p>
    <p class="text-[var(--text-secondary)]">&lt;revocation_pubkey&gt;</p>
    <p class="text-[var(--text-secondary)]">OP_ELSE</p>
    <p class="text-[var(--text-secondary)]"># 正常路徑 - Alice 等待後可以花費</p>
    <p class="text-[var(--text-secondary)]">&lt;144&gt; OP_CHECKSEQUENCEVERIFY OP_DROP</p>
    <p class="text-[var(--text-secondary)]">&lt;alice_delayed_pubkey&gt;</p>
    <p class="text-[var(--text-secondary)]">OP_ENDIF</p>
    <p class="text-[var(--text-secondary)]">OP_CHECKSIG</p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">驗證規則</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">CSV 驗證失敗的情況：</p>
  <ul class="space-y-3 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-red-500">✗</span>
      <span>堆疊為空</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-red-500">✗</span>
      <span>堆疊頂部值為負數</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-red-500">✗</span>
      <span>類型標誌不匹配（一個是區塊，另一個是時間）</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-red-500">✗</span>
      <span>nSequence 值小於腳本要求</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-red-500">✗</span>
      <span>nSequence 的停用位元被設置但腳本值未設置</span>
    </li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">CLTV vs CSV 對比</h2>
  <div class="not-prose mb-6 overflow-x-auto">
    <table class="w-full text-sm" aria-label="CLTV 與 CSV 操作碼比較">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">特性</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">CLTV (OP_CLTV)</th>
          <th scope="col" class="text-left py-2 text-[var(--text-primary)]">CSV (OP_CSV)</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">BIP</td>
          <td class="py-2">BIP-65</td>
          <td class="py-2">BIP-112</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">驗證對象</td>
          <td class="py-2">nLockTime</td>
          <td class="py-2">nSequence</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">時間類型</td>
          <td class="py-2">絕對時間</td>
          <td class="py-2">相對時間</td>
        </tr>
        <tr>
          <td class="py-2">應用</td>
          <td class="py-2">到期日、HTLC</td>
          <td class="py-2">懲罰機制、等待期</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關 BIP</h2>
  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span
        ><a href="/bips/bip-0065" class="text-bitcoin-500 hover:underline">BIP-65</a
        >：OP_CHECKLOCKTIMEVERIFY</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span
        ><a href="/bips/bip-0068" class="text-bitcoin-500 hover:underline">BIP-68</a>：nSequence
        相對時間鎖</span
      >
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span>BIP-113：Median Time Past</span>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
    <p class="text-sm text-bitcoin-700 dark:text-bitcoin-400">
      <strong>延伸閱讀：</strong> 查看
      <a
        href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki"
        target="_blank"
        rel="noopener noreferrer"
        class="underline hover:no-underline"
      >
        GitHub 上的完整 BIP-112 文件
      </a>
    </p>
  </div>
</ArticleLayout>
