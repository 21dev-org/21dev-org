---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-324: v2 P2P 傳輸協議"
  description="為比特幣節點間通訊提供加密和認證，增強網路隱私性。"
  breadcrumbs={[
    { label: 'BIPs', href: '/bips/' },
    { label: 'BIP-324' },
  ]}
  tags={['Standards Track', 'Final']}
  author="Dhruv Mehta, Tim Ruffing, Jonas Schnelli, Pieter Wuille"
  date={new Date('2023-01-01')}
  prevPage={{ title: 'BIP-322: 通用消息簽章', href: '/bips/bip-0322' }}
  nextPage={{ title: 'BIP-327: MuSig2', href: '/bips/bip-0327' }}
>
  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">324</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Standards Track</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="success" size="sm">Final</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">啟用</span>
        <p class="font-semibold text-[var(--text-primary)]">Bitcoin Core 26.0</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-324 定義了比特幣節點之間的新版本 P2P 傳輸協議（v2）。
    與原始的明文協議相比，v2 提供了機會性加密（opportunistic encryption），
    使網路流量更難被監控和干擾。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">為什麼需要加密？</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">v1 協議的問題</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    原始的比特幣 P2P 協議是完全明文的。ISP、政府或其他網路觀察者可以：
  </p>
  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>• 識別比特幣節點流量</li>
    <li>• 追蹤交易傳播路徑</li>
    <li>• 進行流量分析攻擊</li>
    <li>• 選擇性阻斷或延遲連接</li>
  </ul>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <p class="text-sm text-yellow-700 dark:text-yellow-400">
      <strong>注意：</strong> 加密並不能保證完全隱私。它只是增加了攻擊成本。
      流量分析和時序攻擊仍然可能洩露一些資訊。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">技術概述</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">加密方案</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-324 使用以下加密原語：
  </p>

  <div class="not-prose mb-6 overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-2 text-[var(--text-primary)]">組件</th>
          <th class="text-left py-2 text-[var(--text-primary)]">算法</th>
          <th class="text-left py-2 text-[var(--text-primary)]">用途</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">密鑰交換</td>
          <td class="py-2 font-mono">secp256k1 ECDH</td>
          <td class="py-2">建立共享密鑰</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">密鑰派生</td>
          <td class="py-2 font-mono">HKDF-SHA256</td>
          <td class="py-2">從共享密鑰派生會話密鑰</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">對稱加密</td>
          <td class="py-2 font-mono">ChaCha20-Poly1305</td>
          <td class="py-2">加密和認證消息</td>
        </tr>
        <tr>
          <td class="py-2">封包格式</td>
          <td class="py-2 font-mono">Length + AEAD</td>
          <td class="py-2">可變長度加密封包</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">握手流程</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    v2 連接建立流程：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <ol class="space-y-3 text-sm text-[var(--text-secondary)]">
      <li>1. 發起者生成臨時 secp256k1 密鑰對</li>
      <li>2. 發起者發送 64 字節公鑰（EllSwift 編碼）</li>
      <li>3. 響應者生成自己的臨時密鑰對並回覆公鑰</li>
      <li>4. 雙方使用 ECDH 計算共享密鑰</li>
      <li>5. 使用 HKDF 派生加密密鑰</li>
      <li>6. 後續通訊使用 ChaCha20-Poly1305 加密</li>
    </ol>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">EllSwift 編碼</h3>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-324 使用 EllSwift 編碼傳輸公鑰。這種編碼產生看起來像隨機數據的 64 字節輸出，
    使協議更難被識別。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">封包格式</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    v2 使用新的高效封包格式：
  </p>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-xs overflow-x-auto">
    <pre class="text-[var(--text-secondary)]" set:html={`
v1 封包格式（舊）：
┌─────────────┬─────────────┬──────────┬─────────┬─────────┐
│ magic (4B)  │ command(12B)│ size (4B)│ check(4B)│ payload │
└─────────────┴─────────────┴──────────┴─────────┴─────────┘
總 overhead: 24 字節

v2 封包格式（新）：
┌───────────────┬────────────────────────────────────────┐
│ length (3B)   │ encrypted(1B command + payload + 16B tag) │
└───────────────┴────────────────────────────────────────┘
總 overhead: 4-20 字節（取決於命令長度）`}>
    </pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">安全特性</h2>

  <ul class="space-y-3 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-green-500">✓</span>
      <span><strong class="text-[var(--text-primary)]">機會性加密</strong>：自動加密，無需配置</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">✓</span>
      <span><strong class="text-[var(--text-primary)]">前向保密</strong>：每次連接使用臨時密鑰</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">✓</span>
      <span><strong class="text-[var(--text-primary)]">消息認證</strong>：防止篡改</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">✓</span>
      <span><strong class="text-[var(--text-primary)]">流量混淆</strong>：難以識別比特幣流量</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-green-500">✓</span>
      <span><strong class="text-[var(--text-primary)]">可選認證</strong>：支援節點身份驗證</span>
    </li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">v1 vs v2 比較</h2>

  <div class="not-prose mb-6 overflow-x-auto">
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left py-2 text-[var(--text-primary)]">特性</th>
          <th class="text-left py-2 text-[var(--text-primary)]">v1 (舊)</th>
          <th class="text-left py-2 text-[var(--text-primary)]">v2 (新)</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">加密</td>
          <td class="py-2 text-red-500">無</td>
          <td class="py-2 text-green-500">ChaCha20-Poly1305</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">認證</td>
          <td class="py-2 text-red-500">無</td>
          <td class="py-2 text-green-500">AEAD + 可選節點認證</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">流量識別</td>
          <td class="py-2 text-red-500">容易</td>
          <td class="py-2 text-green-500">困難</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="py-2">封包 overhead</td>
          <td class="py-2">24 字節</td>
          <td class="py-2 text-green-500">4-20 字節</td>
        </tr>
        <tr>
          <td class="py-2">向後相容</td>
          <td class="py-2">-</td>
          <td class="py-2 text-green-500">自動降級到 v1</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">使用方式</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    在 Bitcoin Core 26.0+ 中，v2 傳輸預設啟用。可以通過以下方式控制：
  </p>

  <div class="not-prose mb-6 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)] font-mono text-sm">
    <p class="text-[var(--text-tertiary)]"># bitcoin.conf</p>
    <p class="text-[var(--text-secondary)]">v2transport=1        # 啟用 v2 (預設)</p>
    <p class="text-[var(--text-secondary)]">v2transport=0        # 禁用 v2</p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">限制</h2>
  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>• 不防止中間人攻擊（除非使用可選的節點認證）</li>
    <li>• 流量大小和時序仍可被分析</li>
    <li>• 需要雙方都支援 v2 才能加密</li>
    <li>• 初始連接建立時有少量延遲</li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">相關 BIP</h2>
  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span>BIP-151：原始的 P2P 加密提案（已被 BIP-324 取代）</span>
    </li>
    <li class="flex items-start gap-2">
      <span class="text-bitcoin-500">•</span>
      <span><a href="/bips/bip-0340" class="text-bitcoin-500 hover:underline">BIP-340</a>：Schnorr 簽章（使用相同的 secp256k1 曲線）</span>
    </li>
  </ul>

  <div class="mt-8 p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
    <p class="text-sm text-bitcoin-700 dark:text-bitcoin-400">
      <strong>延伸閱讀：</strong> 查看
      <a href="https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki" target="_blank" rel="noopener noreferrer" class="underline hover:no-underline">
        GitHub 上的完整 BIP-324 文件
      </a>
    </p>
  </div>
</ArticleLayout>
