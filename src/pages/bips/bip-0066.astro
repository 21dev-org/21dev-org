---
import BipLayout from '@/layouts/BipLayout.astro';
---

<BipLayout number={66} prevBip={65} nextBip={68}>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-66 引入了一個新的共識規則，要求所有 ECDSA 簽章必須嚴格遵守 DER（Distinguished Encoding
    Rules）編碼格式。 這修復了 OpenSSL 實現中的潛在安全漏洞，並確保所有節點對簽章驗證有一致的行為。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">背景</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">OpenSSL 的問題</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    早期比特幣使用 OpenSSL 庫來驗證 ECDSA 簽章。OpenSSL 對 DER 編碼的解析較為寬鬆，
    接受多種非標準格式：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">風險</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-2">
      <li>• 不同版本的 OpenSSL 可能對同一簽章有不同判斷</li>
      <li>• 可能導致網路分裂（consensus failure）</li>
      <li>• 攻擊者可利用此不一致性製造混亂</li>
    </ul>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">DER 編碼規則</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">簽章結構</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
ECDSA 簽章 DER 格式：
┌──────────────────────────────────────────────────────┐
│ 0x30 [total-len] 0x02 [r-len] [r] 0x02 [s-len] [s]   │
└──────────────────────────────────────────────────────┘

各欄位說明：
• 0x30     : SEQUENCE 標記
• total-len: 後續所有資料的長度
• 0x02     : INTEGER 標記（r 值）
• r-len    : r 值的長度
• r        : r 值（big-endian，無前導零，除非需要避免負數）
• 0x02     : INTEGER 標記（s 值）
• s-len    : s 值的長度
• s        : s 值（同上規則）</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">嚴格規則</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-66 要求簽章必須滿足以下所有條件：
  </p>

  <div class="not-prose mb-8 space-y-3">
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-medium text-[var(--text-primary)]">1. 正確的標記</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2"
        >— 必須以 0x30 開頭，r 和 s 必須以 0x02 開頭</span
      >
    </div>
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-medium text-[var(--text-primary)]">2. 正確的長度</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2"
        >— 長度欄位必須準確反映實際資料長度</span
      >
    </div>
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-medium text-[var(--text-primary)]">3. 最小編碼</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2"
        >— r 和 s 不能有多餘的前導零（除非最高位是 1）</span
      >
    </div>
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-medium text-[var(--text-primary)]">4. 正數表示</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2"
        >— 如果 r 或 s 的最高位是 1，必須加 0x00 前綴避免被解讀為負數</span
      >
    </div>
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-medium text-[var(--text-primary)]">5. 非零值</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— r 和 s 不能是零</span>
    </div>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">合法簽章範例</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
合法簽章（71 bytes）：
30 44                          // SEQUENCE, 長度 68
   02 20                       // INTEGER, 長度 32
      7a8e...（32 bytes r）
   02 20                       // INTEGER, 長度 32
      3b1c...（32 bytes s）
01                             // SIGHASH_ALL

不合法範例：
• 30 45 02 21 00 7a8e... — r 有不必要的 0x00 前綴
• 30 43 02 1f 7a8e...    — r 少了一個位元組（無效長度）
• 30 44 02 20 00 00...   — r 以多個 0x00 開頭</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">部署方式</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-66 使用區塊版本號進行軟分叉部署：
  </p>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse" aria-label="BIP-66 軟分叉部署參數">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">參數</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">值</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3">區塊版本</td>
          <td class="p-3 font-mono">3（或更高）</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3">啟用閾值</td>
          <td class="p-3">最近 1000 區塊中 750 個是 v3+</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3">啟用區塊</td>
          <td class="p-3 font-mono">363,725（2015-07-04）</td>
        </tr>
        <tr>
          <td class="p-3">強制區塊</td>
          <td class="p-3 font-mono">363,724 後的所有區塊</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">影響</h2>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-green-600 dark:text-green-400 mb-2">好處</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 消除 OpenSSL 相關的共識風險</li>
        <li>• 所有節點行為一致</li>
        <li>• 為移除 OpenSSL 依賴鋪路</li>
        <li>• 減少交易延展性</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
      <h4 class="font-semibold text-yellow-600 dark:text-yellow-400 mb-2">注意事項</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 舊版錢包可能生成非嚴格簽章</li>
        <li>• 需要更新簽章生成代碼</li>
        <li>• 不影響已確認的歷史交易</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">後續發展</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-66 是減少比特幣對 OpenSSL 依賴的重要一步。後續發展包括：
  </p>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>• <strong>libsecp256k1</strong>：Bitcoin Core 現在使用自己的 ECDSA 庫</li>
    <li>• <strong>BIP-146</strong>：進一步限制簽章格式（低 S 值）</li>
    <li>• <strong>Schnorr 簽章</strong>：BIP-340 引入更簡潔的簽章格式</li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">總結</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-66 是一個重要的安全性改進，確保所有節點對簽章驗證有相同的行為。
    雖然對終端使用者透明，但它消除了一類潛在的共識失敗風險， 是比特幣協議穩健性的重要保障。
  </p>

  <div
    class="not-prose mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">延伸閱讀</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-1">
      <li>
        <a
          href="https://github.com/bitcoin-core/secp256k1"
          target="_blank"
          rel="noopener noreferrer"
          class="text-bitcoin-700 hover:underline"
        >
          libsecp256k1
        </a>
      </li>
    </ul>
  </div>
</BipLayout>
