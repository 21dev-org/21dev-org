---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-381: 非 SegWit 輸出描述符"
  description="定義 pk()、pkh() 和 sh() 描述符函數，用於傳統比特幣腳本類型。"
  breadcrumbs={[{ label: 'BIPs', href: '/bips/' }, { label: 'BIP-381' }]}
  tags={['Informational', 'Final']}
  author="Pieter Wuille, Andrew Chow"
  date={new Date('2021-06-27')}
  prevPage={{ title: 'BIP-380: 描述符基礎', href: '/bips/bip-0380' }}
  nextPage={{ title: 'BIP-382: SegWit 描述符', href: '/bips/bip-0382' }}
>
  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">381</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Informational</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="success" size="sm">Final</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">依賴</span>
        <p class="font-semibold text-[var(--text-primary)]">BIP-380</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-381 定義了三個描述符函數，用於表達非 SegWit 的傳統腳本類型：
    <code class="px-1 py-0.5 rounded bg-[var(--bg-secondary)]">pk()</code>（Pay-to-PubKey）、
    <code class="px-1 py-0.5 rounded bg-[var(--bg-secondary)]">pkh()</code>（Pay-to-PubKey-Hash）和
    <code class="px-1 py-0.5 rounded bg-[var(--bg-secondary)]">sh()</code>（Pay-to-Script-Hash）。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">pk() — Pay-to-PubKey</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">格式</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
語法：pk(KEY)

輸出腳本：
&lt;pubkey&gt; OP_CHECKSIG

範例：
pk(0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798)

生成的腳本：
21 0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798 AC
│  └─────────────────── 33 bytes 公鑰 ───────────────────┘    │
└─ OP_PUSHBYTES_33                                            └─ OP_CHECKSIG</pre>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">歷史背景</h4>
    <p class="text-sm text-[var(--text-secondary)]">
      P2PK 是比特幣最早的腳本類型，用於 Satoshi 挖的前幾個區塊。
      它直接在腳本中包含完整公鑰，沒有對應的地址格式。 現在已經很少使用，因為 P2PKH
      更節省空間且有地址格式。
    </p>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">特性</h3>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-red-500/10 border border-red-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">缺點</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 沒有標準地址格式</li>
        <li>• 公鑰直接暴露（量子風險）</li>
        <li>• 輸出較大（33-65 bytes）</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">優點</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 花費時腳本較小（只需簽章）</li>
        <li>• 歷史相容性</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">
    pkh() — Pay-to-PubKey-Hash
  </h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">格式</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
語法：pkh(KEY)

輸出腳本：
OP_DUP OP_HASH160 &lt;20-byte-hash&gt; OP_EQUALVERIFY OP_CHECKSIG

範例：
pkh([d34db33f/44'/0'/0']xpub6ERApfZ.../0/*)

生成的腳本（對於第一個地址）：
76 A9 14 &lt;20-byte-hash&gt; 88 AC
│   │  │                 │   └─ OP_CHECKSIG
│   │  │                 └─ OP_EQUALVERIFY
│   │  └─ OP_PUSHBYTES_20
│   └─ OP_HASH160
└─ OP_DUP

對應地址：1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2（Base58Check）</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">地址格式</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
P2PKH 地址編碼：

1. 計算公鑰哈希
   hash = RIPEMD160(SHA256(pubkey))

2. 添加版本前綴
   主網：0x00
   測試網：0x6f

3. Base58Check 編碼
   address = Base58Check(0x00 || hash)

結果：
主網地址以 "1" 開頭
測試網地址以 "m" 或 "n" 開頭</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">使用範例</h3>

  <div class="not-prose mb-8 space-y-4">
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">BIP-44 相容錢包</h4>
      <pre
        class="text-xs font-mono overflow-x-auto">
pkh([d34db33f/44'/0'/0']xpub6ERApfZwUNrhL.../0/*)#checksum

派生路徑：m/44'/0'/0'/0/*
• 44' = BIP-44 用途
• 0' = 比特幣
• 0' = 第一帳戶
• 0 = 接收鏈
• * = 地址索引</pre>
    </div>
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">單一地址</h4>
      <pre
        class="text-xs font-mono overflow-x-auto">
pkh(02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5)#checksum

固定公鑰，只生成一個地址</pre>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">sh() — Pay-to-Script-Hash</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">格式</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
語法：sh(SCRIPT)

輸出腳本：
OP_HASH160 &lt;20-byte-script-hash&gt; OP_EQUAL

範例：
sh(multi(2, KEY1, KEY2, KEY3))

生成的腳本：
A9 14 &lt;20-byte-hash&gt; 87
│   │                 └─ OP_EQUAL
│   └─ OP_PUSHBYTES_20
└─ OP_HASH160

對應地址：3J98t1WpEZ73CNmQviecrnyiWrnqRhWNLy（以 "3" 開頭）</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">可包裝的腳本</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">sh() 可以包裝多種內部腳本：</p>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse" aria-label="sh() 可包裝的腳本類型">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">描述符</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">說明</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">常見用途</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono text-xs">sh(multi(...))</td>
          <td class="p-3">P2SH 多簽</td>
          <td class="p-3">傳統多簽錢包</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono text-xs">sh(wpkh(KEY))</td>
          <td class="p-3">P2SH-P2WPKH</td>
          <td class="p-3">相容性 SegWit</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono text-xs">sh(wsh(...))</td>
          <td class="p-3">P2SH-P2WSH</td>
          <td class="p-3">相容性 SegWit 多簽</td>
        </tr>
        <tr>
          <td class="p-3 font-mono text-xs">sh(sortedmulti(...))</td>
          <td class="p-3">排序多簽</td>
          <td class="p-3">確定性多簽</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">P2SH-P2WPKH 範例</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
相容性 SegWit 地址（BIP-49）：

sh(wpkh([d34db33f/49'/0'/0']xpub6CUGRUo.../0/*))#checksum

結構：
┌─────────────────────────────────────────────┐
│ P2SH 輸出腳本                               │
│   OP_HASH160 &lt;script-hash&gt; OP_EQUAL        │
├─────────────────────────────────────────────┤
│ 贖回腳本（redeemScript）                    │
│   OP_0 &lt;20-byte-pubkey-hash&gt;               │
│   （這是 P2WPKH 見證程序）                  │
├─────────────────────────────────────────────┤
│ 見證資料                                    │
│   [signature, pubkey]                       │
└─────────────────────────────────────────────┘

地址格式：以 "3" 開頭（主網）</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">腳本大小限制</h2>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">P2SH 限制</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-2">
      <li>
        <strong>贖回腳本大小</strong>：最大 520 bytes（推送到堆疊的限制）
      </li>
      <li>
        <strong>多簽限制</strong>：最多約 15 個公鑰（15-of-15）
      </li>
      <li>
        <strong>標準化限制</strong>：某些腳本可能被認為是非標準的，不會被節點轉發
      </li>
    </ul>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Bitcoin Core 範例</h2>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
# 獲取描述符資訊
$ bitcoin-cli getdescriptorinfo "pkh(02c6047f...)"
&#123;
  "descriptor": "pkh(02c6047f...)#checksum",
  "checksum": "8fhd9pwu",
  "isrange": false,
  "issolvable": true,
  "hasprivatekeys": false
&#125;

# 從描述符派生地址
$ bitcoin-cli deriveaddresses "pkh([d34db33f/44'/0'/0']xpub.../0/*)#checksum" "[0,4]"
[
  "1BvBMSEYst...",
  "1HB5XMLmzF...",
  "1LqBGSKuXa...",
  "14u2pAKbZx...",
  "1M8L5JSN3L..."
]

# 導入描述符錢包
$ bitcoin-cli importdescriptors '[&#123;
  "desc": "pkh([d34db33f/44h/0h/0h]xpub.../0/*)#checksum",
  "timestamp": "now",
  "range": [0, 999],
  "watchonly": true
&#125;]'</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">總結</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-381 定義了傳統比特幣腳本的描述符函數。雖然這些腳本類型相對較舊， 但對於歷史錢包恢復和相容性
    SegWit 地址仍然重要。 理解這些基礎類型有助於理解更複雜的 SegWit 和 Taproot 描述符。
  </p>

  <div
    class="not-prose mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">延伸閱讀</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-1">
      <li>
        <a
          href="https://github.com/bitcoin/bips/blob/master/bip-0381.mediawiki"
          target="_blank"
          rel="noopener noreferrer"
          class="text-bitcoin-500 hover:underline"
        >
          BIP-381 完整規格
        </a>
      </li>
      <li>
        <a href="/bips/bip-0380" class="text-bitcoin-500 hover:underline">
          BIP-380: 描述符基礎框架
        </a>
      </li>
      <li>
        <a href="/bips/bip-0382" class="text-bitcoin-500 hover:underline">
          BIP-382: SegWit 描述符
        </a>
      </li>
    </ul>
  </div>
</ArticleLayout>
