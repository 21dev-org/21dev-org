---
import BipLayout from '@/layouts/BipLayout.astro';
---

<BipLayout number={11} prevBip={9} nextBip={13}>
  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-11 定義了 M-of-N 多重簽名交易的標準腳本格式。這種交易需要 N 個公鑰中的 M 個
    對應私鑰簽名才能花費，為資金管理提供了更高的安全性和靈活性。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">動機</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    多重簽名交易解決了單一密鑰控制的多個問題：
  </p>

  <div class="not-prose mb-8 space-y-4">
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">安全性提升</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        單一密鑰遺失或被盜不會導致資金損失。例如 2-of-3 設置中，
        即使一個密鑰被攻擊者獲取，資金仍然安全。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">備份冗餘</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        2-of-3 設置允許遺失一個備份而不影響資金存取。 這對於長期儲存非常重要。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">共同控制</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        多方必須同意才能移動資金，適用於公司財務、託管服務等場景。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">技術規範</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">裸多簽腳本</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-11 定義的「裸」多簽腳本直接放在 scriptPubKey 中：
  </p>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">scriptPubKey 格式</h4>
    <pre
      class="text-sm overflow-x-auto font-mono bg-[var(--bg-primary)] p-3 rounded">
OP_M &lt;pubkey1&gt; &lt;pubkey2&gt; ... &lt;pubkeyN&gt; OP_N OP_CHECKMULTISIG</pre>
    <p class="text-xs text-[var(--text-tertiary)] mt-2">M 和 N 是 OP_1 到 OP_16 之間的操作碼</p>
  </div>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">scriptSig 格式（花費時）</h4>
    <pre
      class="text-sm overflow-x-auto font-mono bg-[var(--bg-primary)] p-3 rounded">
OP_0 &lt;sig1&gt; &lt;sig2&gt; ... &lt;sigM&gt;</pre>
    <p class="text-xs text-[var(--text-tertiary)] mt-2">
      OP_0 是由於 OP_CHECKMULTISIG 的一個 bug，會消耗一個額外的堆疊元素
    </p>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">範例：2-of-3 多簽</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
scriptPubKey:
OP_2
&lt;pubkey_A&gt;
&lt;pubkey_B&gt;
&lt;pubkey_C&gt;
OP_3
OP_CHECKMULTISIG

scriptSig（使用 A 和 B 簽名）:
OP_0
&lt;signature_A&gt;
&lt;signature_B&gt;

驗證過程：
1. 推入 OP_0（dummy）
2. 推入 sig_A 和 sig_B
3. 推入 OP_2（需要 2 個簽名）
4. 推入三個公鑰
5. 推入 OP_3（共 3 個公鑰）
6. OP_CHECKMULTISIG 驗證</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">限制</h2>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse" aria-label="M-of-N 多重簽名交易限制">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">限制</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">值</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">說明</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3">最大公鑰數</td>
          <td class="p-3 font-mono">3</td>
          <td class="p-3">標準交易限制，非共識規則</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3">共識最大值</td>
          <td class="p-3 font-mono">20</td>
          <td class="p-3">OP_CHECKMULTISIG 的硬限制</td>
        </tr>
        <tr>
          <td class="p-3">腳本大小</td>
          <td class="p-3 font-mono">520 bytes</td>
          <td class="p-3">標準交易的最大腳本大小</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">與 P2SH 的關係</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">BIP-11 定義的裸多簽有幾個缺點：</p>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>• <strong>地址長</strong>：所有公鑰都在輸出中，無法用傳統地址表示</li>
    <li>• <strong>費用高</strong>：輸出較大，發送方支付更多費用</li>
    <li>• <strong>隱私差</strong>：多簽結構在鏈上公開可見</li>
  </ul>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-16（P2SH）解決了這些問題，允許將多簽腳本哈希為簡短地址。 現代多簽通常使用 P2SH 或 P2WSH
    而非裸多簽。
  </p>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">裸多簽（BIP-11）</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        公鑰直接放在輸出中，無法使用地址，較少使用。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">P2SH 多簽（推薦）</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        多簽腳本哈希為 3 開頭的地址，更短、更便宜、更私密。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">常見配置</h2>

  <div class="not-prose mb-8 space-y-3">
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-mono font-medium text-[var(--text-primary)]">2-of-3</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2"
        >— 最常見，適合個人安全儲存和小型團隊</span
      >
    </div>
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-mono font-medium text-[var(--text-primary)]">3-of-5</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 適合企業和機構，提供更多冗餘</span>
    </div>
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-mono font-medium text-[var(--text-primary)]">2-of-2</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 用於託管和原子交換</span>
    </div>
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-mono font-medium text-[var(--text-primary)]">1-of-N</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 任一密鑰可花費，用於備份場景</span>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">總結</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-11 建立了多重簽名交易的基礎標準。雖然現代應用更多使用 P2SH 或 P2WSH 包裝的多簽， 但 BIP-11
    定義的 OP_CHECKMULTISIG 操作碼仍然是所有多簽實現的核心。
  </p>
</BipLayout>
