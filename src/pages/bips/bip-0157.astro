---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-157: 輕客戶端區塊過濾器"
  description="定義輕客戶端向全節點請求和驗證區塊過濾器的 P2P 協議。"
  breadcrumbs={[
    { label: 'BIPs', href: '/bips/' },
    { label: 'BIP-157' },
  ]}
  tags={['Standards Track', 'Draft']}
  author="Olaoluwa Osuntokun, Alex Akselrod, Jim Posen"
  date={new Date('2017-05-24')}
  prevPage={{ title: 'BIP-152: Compact Block', href: '/bips/bip-0152' }}
  nextPage={{ title: 'BIP-158: 緊湊過濾器', href: '/bips/bip-0158' }}
>
  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">157</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Standards Track</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="default" size="sm">Draft</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">依賴</span>
        <p class="font-semibold text-[var(--text-primary)]">BIP-158</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-157 定義了輕客戶端（如手機錢包）向全節點請求區塊過濾器的 P2P 協議訊息。
    搭配 BIP-158 定義的過濾器格式，這套方案提供了比 BIP-37 更隱私的輕客戶端同步方式。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">動機</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">BIP-37 的問題</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-37 定義的 Bloom Filter 方式有嚴重的隱私問題：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">隱私洩露</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-2">
      <li>• 客戶端將 Bloom Filter 發送給伺服器，暴露感興趣的地址</li>
      <li>• 伺服器可以通過多次請求推斷出所有地址</li>
      <li>• 假陽性率不足以提供有意義的隱私保護</li>
      <li>• 研究表明可以以 70% 的準確率連結地址</li>
    </ul>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">Neutrino 方案</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-157/158 採用相反的方式：伺服器產生過濾器，客戶端在本地檢查。
  </p>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-red-500/10 border border-red-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">BIP-37（Bloom Filter）</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        客戶端告訴伺服器「我關心這些地址」，
        伺服器過濾後返回相關交易。
      </p>
      <p class="text-xs text-red-500 mt-2">隱私差</p>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">BIP-157（Client Filters）</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        伺服器提供區塊過濾器，
        客戶端本地檢查是否有相關交易。
      </p>
      <p class="text-xs text-green-500 mt-2">隱私好</p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">P2P 訊息</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">服務位元</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
NODE_COMPACT_FILTERS = (1 &lt;&lt; 6) = 0x40

支援此服務的節點可以：
• 提供區塊過濾器
• 響應過濾器頭和過濾器請求</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">訊息類型</h3>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left p-3 text-[var(--text-primary)]">訊息</th>
          <th class="text-left p-3 text-[var(--text-primary)]">方向</th>
          <th class="text-left p-3 text-[var(--text-primary)]">用途</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">getcfcheckpt</td>
          <td class="p-3">客戶端 → 伺服器</td>
          <td class="p-3">請求過濾器頭檢查點</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">cfcheckpt</td>
          <td class="p-3">伺服器 → 客戶端</td>
          <td class="p-3">過濾器頭檢查點列表</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">getcfheaders</td>
          <td class="p-3">客戶端 → 伺服器</td>
          <td class="p-3">請求過濾器頭</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">cfheaders</td>
          <td class="p-3">伺服器 → 客戶端</td>
          <td class="p-3">過濾器頭資料</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">getcfilters</td>
          <td class="p-3">客戶端 → 伺服器</td>
          <td class="p-3">請求實際過濾器</td>
        </tr>
        <tr>
          <td class="p-3 font-mono">cfilter</td>
          <td class="p-3">伺服器 → 客戶端</td>
          <td class="p-3">過濾器資料</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">同步流程</h2>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
1. 獲取檢查點（每 1000 區塊）
   客戶端 ──getcfcheckpt──→ 伺服器
   客戶端 ←──cfcheckpt───── 伺服器

2. 比較多個節點的檢查點，確保一致

3. 獲取過濾器頭
   客戶端 ──getcfheaders──→ 伺服器
   客戶端 ←──cfheaders───── 伺服器

4. 驗證過濾器頭鏈
   • 每個頭 = SHA256(filter_hash || prev_header)
   • 形成可驗證的鏈

5. 獲取需要的過濾器
   客戶端 ──getcfilters──→ 伺服器
   客戶端 ←──cfilter────── 伺服器

6. 本地匹配檢查
   • 對每個相關區塊，在本地檢查過濾器
   • 如果匹配，請求完整區塊</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">過濾器頭</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    過濾器頭形成一條鏈，允許客戶端驗證過濾器的完整性：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
filter_header[n] = SHA256(filter_hash[n] || filter_header[n-1])

其中：
• filter_hash = SHA256(filter_data)
• filter_header[0] = SHA256(filter_hash[0] || 0x00...00)

這確保：
• 客戶端可以驗證過濾器未被篡改
• 可以從多個節點獲取並比較
• 惡意節點無法提供錯誤過濾器而不被發現</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">隱私保護</h2>

  <div class="not-prose mb-8 space-y-4">
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">伺服器不知道</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 客戶端關心哪些地址</li>
        <li>• 客戶端的錢包餘額</li>
        <li>• 哪些交易與客戶端相關</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">仍可觀察到</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 客戶端請求了哪些區塊（如果有匹配）</li>
        <li>• 可以使用 Tor 或多節點輪詢緩解</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實作</h2>

  <div class="not-prose mb-8 space-y-3">
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-medium text-[var(--text-primary)]">btcd</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— Go 語言的全節點實作，原生支援</span>
    </div>
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-medium text-[var(--text-primary)]">Bitcoin Core</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 支援生成過濾器（需要 -blockfilterindex）</span>
    </div>
    <div class="p-3 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <span class="font-medium text-[var(--text-primary)]">Neutrino</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— lnd 使用的輕客戶端庫</span>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">總結</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-157 定義了一套隱私優先的輕客戶端協議。通過讓伺服器提供過濾器而不是
    客戶端暴露查詢條件，大幅改善了輕客戶端的隱私性。這對於手機錢包和
    其他資源受限的環境特別重要。
  </p>

  <div class="not-prose mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">延伸閱讀</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-1">
      <li>
        <a href="https://github.com/bitcoin/bips/blob/master/bip-0157.mediawiki" target="_blank" rel="noopener noreferrer" class="text-bitcoin-500 hover:underline">
          BIP-157 完整規格
        </a>
      </li>
      <li>
        <a href="/bips/bip-0158" class="text-bitcoin-500 hover:underline">
          BIP-158: 緊湊區塊過濾器
        </a>
      </li>
    </ul>
  </div>
</ArticleLayout>
