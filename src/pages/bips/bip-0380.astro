---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-380: Output Script Descriptors 基礎"
  description="定義輸出腳本描述符的通用語法和語義，作為整個描述符系列的基礎規範。"
  breadcrumbs={[{ label: 'BIPs', href: '/bips/' }, { label: 'BIP-380' }]}
  tags={['Informational', 'Final']}
  author="Pieter Wuille, Andrew Chow"
  date={new Date('2021-06-27')}
  prevPage={{ title: 'BIP-370: PSBT v2', href: '/bips/bip-0370' }}
  nextPage={{ title: 'BIP-381: 非 SegWit 描述符', href: '/bips/bip-0381' }}
>
  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">380</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Informational</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="success" size="sm">Final</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">系列</span>
        <p class="font-semibold text-[var(--text-primary)]">BIP-380~386</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-380 定義了 Output Script Descriptors（輸出腳本描述符）的基礎框架。
    描述符是一種用於完整描述如何從密鑰材料派生輸出腳本的語言，
    解決了僅靠助記詞無法完整恢復錢包的問題。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">動機</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">助記詞的不足</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-39 助記詞只編碼了熵（種子），但錢包恢復還需要知道：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">缺失的資訊</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-2">
      <li>• <strong>腳本類型</strong>：P2PKH? P2SH-P2WPKH? P2WPKH? P2TR?</li>
      <li>• <strong>派生路徑</strong>：BIP-44? BIP-84? BIP-86? 自定義路徑?</li>
      <li>• <strong>多簽配置</strong>：幾個密鑰？閾值是多少？密鑰順序？</li>
      <li>• <strong>時間鎖</strong>：是否有額外的鎖定條件？</li>
    </ul>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">實際問題</h4>
    <p class="text-sm text-[var(--text-secondary)]">
      用戶 Alice 在錢包 A 創建了 2-of-3 多簽錢包。當她嘗試在錢包 B 恢復時，
      即使輸入了所有三個助記詞，錢包 B 也無法重建相同的地址，
      因為它不知道這是多簽、閾值是多少、以及密鑰的正確順序。
    </p>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">描述符解決方案</h3>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">完整性</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        描述符包含重建錢包所需的所有資訊：腳本類型、派生路徑、密鑰、條件等。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">可移植性</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        標準化格式使不同錢包軟體可以正確解析和使用相同的描述符。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">可擴展性</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        可以表達任意複雜的腳本，包括多簽、時間鎖、Taproot 等。
      </p>
    </div>
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">可驗證性</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        內建校驗和確保描述符在傳輸過程中沒有被修改或損壞。
      </p>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">基本語法</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">描述符結構</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
描述符基本結構：

SCRIPT_EXPRESSION#CHECKSUM

組成部分：
┌─────────────────────────────────────────────────────────────┐
│ 腳本表達式（SCRIPT_EXPRESSION）                              │
│   定義輸出腳本的結構和使用的密鑰                             │
├─────────────────────────────────────────────────────────────┤
│ #                                                           │
│   分隔符                                                     │
├─────────────────────────────────────────────────────────────┤
│ 校驗和（CHECKSUM）                                          │
│   8 字符的錯誤檢測碼                                         │
└─────────────────────────────────────────────────────────────┘

範例：
wpkh([d34db33f/84'/0'/0']xpub6ERApfZ.../0/*)#checksum</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">腳本表達式</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    腳本表達式是一個函數調用，描述如何構建輸出腳本：
  </p>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
腳本表達式語法：

FUNCTION(ARGUMENTS)

其中 ARGUMENTS 可以是：
• 密鑰表達式（KEY）
• 其他腳本表達式（嵌套）
• 其他參數（如數字、哈希等）

範例：
sh(wpkh(KEY))      // P2SH 包裝 P2WPKH
wsh(multi(2,K1,K2,K3))  // P2WSH 包裝 2-of-3 多簽</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">密鑰表達式</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">密鑰類型</h3>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse" aria-label="描述符密鑰類型說明">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">類型</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">格式</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">說明</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3">公鑰（hex）</td>
          <td class="p-3 font-mono text-xs">02abc123...</td>
          <td class="p-3">33 或 65 bytes 的壓縮/非壓縮公鑰</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3">WIF 私鑰</td>
          <td class="p-3 font-mono text-xs">L1a2b3c4...</td>
          <td class="p-3">Base58Check 編碼的私鑰</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3">xpub</td>
          <td class="p-3 font-mono text-xs">xpub6ABC...</td>
          <td class="p-3">BIP-32 擴展公鑰</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3">xprv</td>
          <td class="p-3 font-mono text-xs">xprv9ABC...</td>
          <td class="p-3">BIP-32 擴展私鑰</td>
        </tr>
        <tr>
          <td class="p-3">x-only 公鑰</td>
          <td class="p-3 font-mono text-xs">abc123...（32 bytes）</td>
          <td class="p-3">Taproot 使用的 32 bytes 公鑰</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">來源資訊</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    密鑰可以包含來源資訊，描述其派生路徑：
  </p>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
來源資訊格式：

[FINGERPRINT/PATH]KEY

組成部分：
• FINGERPRINT: 主密鑰的 4 bytes 指紋（hex）
• PATH: BIP-32 派生路徑
• KEY: 該路徑對應的密鑰

範例：
[d34db33f/84'/0'/0']xpub6ERApfZ...

解讀：
• d34db33f = 主密鑰指紋
• 84' = BIP-84 用途（原生 SegWit）
• 0' = 比特幣主網
• 0' = 第一個帳戶
• xpub6ERApfZ... = 該路徑的擴展公鑰</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">派生路徑</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
從擴展密鑰派生子密鑰：

xpub.../0/*    // 從 xpub 派生接收地址
xpub.../1/*    // 從 xpub 派生找零地址

路徑元素：
• 數字：普通派生（如 0, 1, 2）
• 數字'：硬化派生（如 0', 44'）， 只能用於私鑰
• *：萬用符，表示一系列索引
• &lt;M;N;O&gt;：多路徑，表示多個可能的索引

範例：
xpub.../0/*         // 索引 0, 1, 2, 3, ...
xpub.../&lt;0;1&gt;/*     // 接收(0)和找零(1)都包含</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">校驗和</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    描述符使用與 Bech32 類似的校驗和算法：
  </p>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
校驗和特性：

長度：8 字符
字符集：qpzry9x8gf2tvdw0s3jn54khce6mua7l（Bech32）

錯誤檢測能力：
• 最多 4 個字符錯誤
• 任何單個字符替換
• 任意兩個字符交換

計算方式：
1. 將描述符（不含 #）轉換為 5-bit 組
2. 應用多項式校驗
3. 輸出 8 個 5-bit 值
4. 轉換為 Bech32 字符

範例：
wpkh(02abc...)#abcd1234
            ^^^^^^^^
            校驗和</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">描述符系列</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-380 是基礎規範，具體的腳本類型由後續 BIP 定義：
  </p>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse" aria-label="描述符系列 BIP 概覽">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">BIP</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">內容</th>
          <th scope="col" class="text-left p-3 text-[var(--text-primary)]">描述符函數</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">BIP-380</td>
          <td class="p-3">基礎框架</td>
          <td class="p-3">語法、密鑰表達式、校驗和</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">BIP-381</td>
          <td class="p-3">非 SegWit 描述符</td>
          <td class="p-3 font-mono">pk(), pkh(), sh()</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">BIP-382</td>
          <td class="p-3">SegWit 描述符</td>
          <td class="p-3 font-mono">wpkh(), wsh()</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">BIP-383</td>
          <td class="p-3">多簽描述符</td>
          <td class="p-3 font-mono">multi(), sortedmulti()</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">BIP-384</td>
          <td class="p-3">組合描述符</td>
          <td class="p-3 font-mono">combo()</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">BIP-385</td>
          <td class="p-3">原始描述符</td>
          <td class="p-3 font-mono">raw(), addr()</td>
        </tr>
        <tr>
          <td class="p-3 font-mono">BIP-386</td>
          <td class="p-3">Taproot 描述符</td>
          <td class="p-3 font-mono">tr()</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實際範例</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">單簽錢包</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
P2WPKH（Native SegWit，bc1q... 地址）：

wpkh([d34db33f/84'/0'/0']xpub6ERApfZwUNrhL.../0/*)#checksum

解讀：
• wpkh() = P2WPKH 腳本類型
• [d34db33f/84'/0'/0'] = 來源資訊
• xpub6ERApfZ... = 帳戶級別的擴展公鑰
• /0/* = 接收地址鏈，索引從 0 開始
• #checksum = 校驗和</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">多簽錢包</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
2-of-3 多簽（P2WSH）：

wsh(sortedmulti(2,
  [aabbccdd/48'/0'/0'/2']xpub1.../0/*,
  [11223344/48'/0'/0'/2']xpub2.../0/*,
  [55667788/48'/0'/0'/2']xpub3.../0/*
))#checksum

解讀：
• wsh() = P2WSH 包裝
• sortedmulti() = 排序的多簽（密鑰按字典序排列）
• 2 = 閾值（需要 2 個簽章）
• 3 個 xpub = 3 個參與者的公鑰</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">Taproot 錢包</h3>

  <div
    class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <pre
      class="text-sm overflow-x-auto font-mono">
簡單 Taproot（bc1p... 地址）：

tr([d34db33f/86'/0'/0']xpub6ERApfZ.../0/*)#checksum

帶腳本樹的 Taproot：

tr(KEY_INTERNAL,&#123;
  pk(KEY_A),
  &#123;pk(KEY_B),pk(KEY_C)&#125;
&#125;)#checksum

     [Internal Key]
           │
      ┌────┴────┐
    pk(A)   ┌───┴───┐
          pk(B)  pk(C)</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">工具支援</h2>

  <div class="not-prose mb-8 space-y-3">
    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
      <span class="font-medium text-[var(--text-primary)]">Bitcoin Core</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2"
        >— getdescriptorinfo, deriveaddresses, importdescriptors</span
      >
    </div>
    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
      <span class="font-medium text-[var(--text-primary)]">Sparrow Wallet</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 完整描述符支援，導入/導出</span>
    </div>
    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
      <span class="font-medium text-[var(--text-primary)]">Specter Desktop</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 多簽描述符管理</span>
    </div>
    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
      <span class="font-medium text-[var(--text-primary)]">HWI</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 硬體錢包描述符介面</span>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">總結</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-380 建立了 Output Script Descriptors 的基礎框架，定義了語法結構、密鑰表達式和校驗和算法。
    這個標準使錢包備份和恢復變得完整和可靠，特別是對於複雜的多簽和 Taproot 設置。 後續的 BIP-381 到
    BIP-386 則定義了具體的腳本類型函數。
  </p>

  <div
    class="not-prose mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]"
  >
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">延伸閱讀</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-1">
      <li>
        <a
          href="https://github.com/bitcoin/bips/blob/master/bip-0380.mediawiki"
          target="_blank"
          rel="noopener noreferrer"
          class="text-bitcoin-500 hover:underline"
        >
          BIP-380 完整規格
        </a>
      </li>
      <li>
        <a href="/learn/advanced/output-descriptors" class="text-bitcoin-500 hover:underline">
          Output Descriptors 學習指南
        </a>
      </li>
      <li>
        <a href="/bips/bip-0381" class="text-bitcoin-500 hover:underline">
          BIP-381: 非 SegWit 描述符
        </a>
      </li>
    </ul>
  </div>
</ArticleLayout>
