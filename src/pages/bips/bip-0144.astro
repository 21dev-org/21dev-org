---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-144: SegWit 序列化"
  description="定義隔離見證交易的網路傳輸和序列化格式。"
  breadcrumbs={[
    { label: 'BIPs', href: '/bips/' },
    { label: 'BIP-144' },
  ]}
  tags={['Standards Track', 'Final']}
  author="Eric Lombrozo, Pieter Wuille"
  date={new Date('2016-01-08')}
  prevPage={{ title: 'BIP-143: SegWit 簽章', href: '/bips/bip-0143' }}
  nextPage={{ title: 'BIP-152: Compact Block', href: '/bips/bip-0152' }}
>
  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">144</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Standards Track</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="success" size="sm">Final</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">依賴</span>
        <p class="font-semibold text-[var(--text-primary)]">BIP-141</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-144 定義了隔離見證（SegWit）交易在 P2P 網路中的序列化格式。
    它引入了新的交易格式，將見證資料（簽章等）從交易主體中分離，
    同時保持與舊節點的向後相容性。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">動機</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-141 定義了 SegWit 的共識規則，但沒有說明如何在網路中傳輸交易。
    BIP-144 解決了以下問題：
  </p>

  <ul class="space-y-2 text-[var(--text-secondary)] mb-6">
    <li>• 如何編碼包含見證資料的交易</li>
    <li>• 如何讓舊節點仍能轉發（但不驗證）SegWit 交易</li>
    <li>• 如何讓新節點識別 SegWit 交易</li>
  </ul>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">交易序列化格式</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">傳統格式</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
傳統交易格式（非 SegWit）：
┌──────────────────────────────────────┐
│ version      │ 4 bytes              │
│ tx_in_count  │ varint               │
│ tx_in[]      │ 輸入列表             │
│ tx_out_count │ varint               │
│ tx_out[]     │ 輸出列表             │
│ lock_time    │ 4 bytes              │
└──────────────────────────────────────┘</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">SegWit 格式</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
SegWit 交易格式：
┌──────────────────────────────────────┐
│ version      │ 4 bytes              │
│ marker       │ 0x00（1 byte）       │ ← 新增
│ flag         │ 0x01（1 byte）       │ ← 新增
│ tx_in_count  │ varint               │
│ tx_in[]      │ 輸入列表             │
│ tx_out_count │ varint               │
│ tx_out[]     │ 輸出列表             │
│ witness[]    │ 見證資料列表         │ ← 新增
│ lock_time    │ 4 bytes              │
└──────────────────────────────────────┘</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">Marker 和 Flag</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">為什麼用 0x00 作為 marker？</h4>
    <p class="text-sm text-[var(--text-secondary)]">
      傳統交易中，version 後面緊接著 tx_in_count（輸入數量）。
      由於交易必須至少有一個輸入，tx_in_count 不可能是 0x00。
      因此 0x00 可以明確標識這是 SegWit 交易。
    </p>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">見證資料結構</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
witness[] 結構：
每個輸入對應一個 witness：

witness_i = [
  witness_count,      // 見證項目數量（varint）
  witness_item_1,     // 第一個見證項目
  witness_item_2,     // 第二個見證項目
  ...
]

witness_item = [
  length,             // 項目長度（varint）
  data                // 項目資料（如簽章、公鑰）
]

範例（P2WPKH）：
witness = [
  02,                 // 2 個項目
  47, &lt;signature&gt;,    // 71 bytes 簽章
  21, &lt;pubkey&gt;        // 33 bytes 壓縮公鑰
]</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">網路協議</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">服務位元</h3>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    節點通過 <code class="px-1 py-0.5 rounded bg-[var(--bg-secondary)]">NODE_WITNESS</code> 服務位元宣告支援 SegWit：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
NODE_WITNESS = (1 &lt;&lt; 3) = 0x08

version 訊息中設置此位元表示：
• 節點理解 SegWit 交易格式
• 節點可以提供見證資料
• 節點驗證見證資料</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">Inventory 訊息</h3>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left p-3 text-[var(--text-primary)]">類型</th>
          <th class="text-left p-3 text-[var(--text-primary)]">值</th>
          <th class="text-left p-3 text-[var(--text-primary)]">說明</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">MSG_TX</td>
          <td class="p-3">1</td>
          <td class="p-3">傳統交易格式（無見證）</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">MSG_WITNESS_TX</td>
          <td class="p-3">0x40000001</td>
          <td class="p-3">SegWit 交易格式（含見證）</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">MSG_BLOCK</td>
          <td class="p-3">2</td>
          <td class="p-3">傳統區塊格式</td>
        </tr>
        <tr>
          <td class="p-3 font-mono">MSG_WITNESS_BLOCK</td>
          <td class="p-3">0x40000002</td>
          <td class="p-3">SegWit 區塊格式（含見證）</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">交易 ID</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">txid vs wtxid</h3>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">txid（傳統 ID）</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        不包含見證資料的序列化交易的雙重 SHA256 哈希。
        用於 UTXO 引用和交易鏈接。
      </p>
      <pre class="text-xs font-mono mt-2 bg-[var(--bg-primary)] p-2 rounded">
txid = SHA256(SHA256(
  version || inputs || outputs || locktime
))</pre>
    </div>
    <div class="p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">wtxid（見證 ID）</h4>
      <p class="text-sm text-[var(--text-secondary)]">
        包含見證資料的完整序列化交易的雙重 SHA256 哈希。
        用於區塊的 witness commitment。
      </p>
      <pre class="text-xs font-mono mt-2 bg-[var(--bg-primary)] p-2 rounded">
wtxid = SHA256(SHA256(
  version || marker || flag ||
  inputs || outputs || witness || locktime
))</pre>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">向後相容性</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-144 設計確保舊節點可以：
  </p>

  <div class="not-prose mb-8 space-y-3">
    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
      <span class="font-medium text-[var(--text-primary)]">接收精簡格式</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 舊節點請求 MSG_TX 獲得無見證的交易</span>
    </div>
    <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
      <span class="font-medium text-[var(--text-primary)]">轉發交易</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 舊節點可以轉發它不完全理解的 SegWit 交易</span>
    </div>
    <div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
      <span class="font-medium text-[var(--text-primary)]">不驗證見證</span>
      <span class="text-sm text-[var(--text-secondary)] ml-2">— 舊節點將 SegWit 輸出視為「anyone-can-spend」</span>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">範例</h2>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <h4 class="font-semibold text-[var(--text-primary)] mb-3">P2WPKH 交易序列化</h4>
    <pre class="text-sm overflow-x-auto font-mono">
01000000              // version (1)
00                    // marker
01                    // flag
01                    // 1 個輸入
  [prevout txid]      // 32 bytes
  [prevout index]     // 4 bytes
  00                  // 空 scriptSig（P2WPKH）
  ffffffff            // sequence
01                    // 1 個輸出
  [value]             // 8 bytes
  [scriptPubKey]      // 輸出腳本
02                    // 見證：2 個項目
  47 [signature]      // 簽章
  21 [pubkey]         // 公鑰
00000000              // locktime</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">總結</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-144 定義了 SegWit 交易在網路中的傳輸格式，巧妙地利用 marker 和 flag 欄位
    區分新舊格式，同時保持向後相容性。這種設計讓 SegWit 能夠作為軟分叉部署，
    不需要所有節點同時升級。
  </p>

  <div class="not-prose mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">延伸閱讀</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-1">
      <li>
        <a href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki" target="_blank" rel="noopener noreferrer" class="text-bitcoin-500 hover:underline">
          BIP-144 完整規格
        </a>
      </li>
      <li>
        <a href="/bips/bip-0141" class="text-bitcoin-500 hover:underline">
          BIP-141: SegWit（共識層）
        </a>
      </li>
      <li>
        <a href="/bips/bip-0143" class="text-bitcoin-500 hover:underline">
          BIP-143: SegWit 簽章驗證
        </a>
      </li>
    </ul>
  </div>
</ArticleLayout>
