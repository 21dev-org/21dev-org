---
import ArticleLayout from '@/layouts/ArticleLayout.astro';
import Tag from '@/components/ui/Tag.astro';
---

<ArticleLayout
  title="BIP-386: Taproot 輸出描述符"
  description="定義 tr() 描述符函數，用於表示 Taproot (SegWit v1) 輸出。"
  breadcrumbs={[
    { label: 'BIPs', href: '/bips/' },
    { label: 'BIP-386' },
  ]}
  tags={['Informational', 'Final']}
  author="Pieter Wuille, Andrew Chow"
  date={new Date('2021-06-27')}
  prevPage={{ title: 'BIP-385: 原始描述符', href: '/bips/bip-0385' }}
>
  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-[var(--text-tertiary)]">BIP 編號</span>
        <p class="font-semibold text-[var(--text-primary)]">386</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">類型</span>
        <p class="font-semibold text-[var(--text-primary)]">Informational</p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">狀態</span>
        <p><Tag variant="success" size="sm">Final</Tag></p>
      </div>
      <div>
        <span class="text-[var(--text-tertiary)]">依賴</span>
        <p class="font-semibold text-[var(--text-primary)]">BIP-340, 341, 380</p>
      </div>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">摘要</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-6">
    BIP-386 定義了 <code class="px-1 py-0.5 rounded bg-[var(--bg-secondary)]">tr()</code> 描述符函數，
    用於表示 Taproot（SegWit v1）輸出。它支援 key path spending 和帶有腳本樹的 script path spending，
    生成 bc1p 開頭的 Bech32m 地址。
  </p>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">基本格式</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">簡單 Key Path</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
語法：tr(KEY)

只有內部密鑰，沒有腳本樹：

tr([d34db33f/86'/0'/0']xpub6ERApfZ.../0/*)

輸出腳本：
OP_1 &lt;32-byte-tweaked-pubkey&gt;

其中：
• OP_1 = 見證版本 1
• tweaked_pubkey = taproot_tweak(internal_pubkey, merkle_root=None)

地址：bc1p...（Bech32m 編碼）</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">帶腳本樹</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
語法：tr(KEY, TREE)

TREE 可以是：
• 單個腳本：tr(KEY, SCRIPT)
• 腳本對：tr(KEY, &#123;SCRIPT_A, SCRIPT_B&#125;)
• 嵌套樹：tr(KEY, &#123;SCRIPT_A, &#123;SCRIPT_B, SCRIPT_C&#125;&#125;)

範例：
tr(KEY_INTERNAL, &#123;
  pk(KEY_A),
  &#123;pk(KEY_B), pk(KEY_C)&#125;
&#125;)

Merkle 樹結構：
        [root]
       /      \
   pk(A)    [branch]
            /      \
        pk(B)    pk(C)</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">x-only 公鑰</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    Taproot 使用 32 bytes 的 x-only 公鑰（省略 y 座標的符號位）：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
標準公鑰（33 bytes）：
02 c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
│  └─────────────────────── x 座標（32 bytes）───────────────────────┘
└─ 前綴（02 或 03 表示 y 座標的奇偶）

x-only 公鑰（32 bytes）：
c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5
└─────────────────────── 只有 x 座標 ───────────────────────┘

在 tr() 中，密鑰會自動轉換為 x-only 格式</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">腳本類型</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">Tapscript 函數</h3>

  <div class="not-prose mb-8 overflow-x-auto">
    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="border-b border-[var(--border-default)]">
          <th class="text-left p-3 text-[var(--text-primary)]">描述符</th>
          <th class="text-left p-3 text-[var(--text-primary)]">腳本</th>
          <th class="text-left p-3 text-[var(--text-primary)]">說明</th>
        </tr>
      </thead>
      <tbody class="text-[var(--text-secondary)]">
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">pk(KEY)</td>
          <td class="p-3 font-mono text-xs">&lt;xonly_key&gt; OP_CHECKSIG</td>
          <td class="p-3">單一密鑰簽章</td>
        </tr>
        <tr class="border-b border-[var(--border-default)]">
          <td class="p-3 font-mono">multi_a(k, K...)</td>
          <td class="p-3 font-mono text-xs">&lt;K1&gt; CHECKSIG ... CHECKSIGADD ... k NUMEQUAL</td>
          <td class="p-3">k-of-n 多簽</td>
        </tr>
        <tr>
          <td class="p-3 font-mono">sortedmulti_a(k, K...)</td>
          <td class="p-3 font-mono text-xs">（同上，密鑰排序）</td>
          <td class="p-3">排序多簽</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="not-prose mb-8 p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">注意：multi_a vs multi</h4>
    <p class="text-sm text-[var(--text-secondary)]">
      Tapscript 使用 <code>multi_a()</code> 而非 <code>multi()</code>。
      這是因為 Tapscript 使用 OP_CHECKSIGADD 替代 OP_CHECKMULTISIG，
      提供更好的批量驗證和更小的見證大小。
    </p>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">實際範例</h2>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">BIP-86 錢包</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
標準 Taproot 單簽錢包：

tr([d34db33f/86'/0'/0']xpub6ERApfZ.../0/*)#checksum

派生路徑：m/86'/0'/0'/0/*
• 86' = BIP-86 用途（Taproot）
• 0' = 比特幣主網
• 0' = 第一帳戶
• 0 = 接收鏈
• * = 地址索引

生成地址：bc1p...</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">2-of-3 Taproot 多簽</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
使用腳本路徑的 2-of-3：

tr(KEY_INTERNAL, sortedmulti_a(2,
  [fp1/86'/0'/0']xpub1.../0/*,
  [fp2/86'/0'/0']xpub2.../0/*,
  [fp3/86'/0'/0']xpub3.../0/*
))

花費方式：
• Key path: 用 KEY_INTERNAL 簽章（如果它是某個多簽的聚合密鑰）
• Script path: 提供 2 個簽章 + Merkle proof</pre>
  </div>

  <h3 class="text-xl font-semibold text-[var(--text-primary)] mt-6 mb-3">複雜腳本樹</h3>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
混合花費條件：

tr(KEY_INTERNAL, &#123;
  pk(KEY_HOT),                    // 熱錢包快速花費
  &#123;
    pk(KEY_COLD),                 // 冷錢包備份
    multi_a(2, KEY_A, KEY_B, KEY_C)  // 3 人中 2 人的恢復
  &#125;
&#125;)

樹結構：
         [root]
        /      \
    pk(HOT)   [branch]
              /      \
        pk(COLD)   multi_a(2,A,B,C)

Merkle 深度影響見證大小：
• pk(HOT): 1 個哈希的 proof
• pk(COLD): 2 個哈希的 proof
• multi_a: 2 個哈希的 proof</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Key Path vs Script Path</h2>

  <div class="not-prose mb-8 grid md:grid-cols-2 gap-4">
    <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Key Path</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 只需 64 bytes Schnorr 簽章</li>
        <li>• 最小的見證大小</li>
        <li>• 最低的費用</li>
        <li>• 看起來像普通單簽</li>
        <li>• 最佳隱私</li>
      </ul>
    </div>
    <div class="p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
      <h4 class="font-semibold text-[var(--text-primary)] mb-2">Script Path</h4>
      <ul class="text-sm text-[var(--text-secondary)] space-y-1">
        <li>• 需要揭露腳本</li>
        <li>• 需要 Merkle proof</li>
        <li>• 見證較大</li>
        <li>• 揭露使用的條件</li>
        <li>• 支援任意條件</li>
      </ul>
    </div>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">MuSig2 整合</h2>

  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    對於多簽場景，可以結合 MuSig2 獲得最佳效率：
  </p>

  <div class="not-prose mb-8 p-4 rounded-lg bg-bitcoin-500/10 border border-bitcoin-500/30">
    <pre class="text-sm overflow-x-auto font-mono">
使用 MuSig2 聚合密鑰作為內部密鑰：

tr(MUSIG_AGGREGATE_KEY)

其中 MUSIG_AGGREGATE_KEY 是多個參與者公鑰的聚合。

優點：
• 看起來像單簽交易
• 最小的見證大小（64 bytes）
• 最佳隱私
• 參與者數量不可見

缺點：
• 需要交互式簽章協議
• 所有參與者必須在線</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">Bitcoin Core 範例</h2>

  <div class="not-prose mb-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <pre class="text-sm overflow-x-auto font-mono">
# 創建 Taproot 描述符錢包
$ bitcoin-cli createwallet "taproot_wallet" false false "" false true true

# 導入 tr() 描述符
$ bitcoin-cli -rpcwallet=taproot_wallet importdescriptors '[
  &#123;
    "desc": "tr([d34db33f/86h/0h/0h]xpub.../0/*)#checksum",
    "timestamp": "now",
    "range": [0, 999],
    "internal": false
  &#125;,
  &#123;
    "desc": "tr([d34db33f/86h/0h/0h]xpub.../1/*)#checksum",
    "timestamp": "now",
    "range": [0, 999],
    "internal": true
  &#125;
]'

# 獲取 Taproot 地址
$ bitcoin-cli -rpcwallet=taproot_wallet getnewaddress "" "bech32m"
bc1p0xlxvlhemja6c4dqv22uapctqupfhlxm9h8z3k2e72q4k9hcz7vqzk5jj0</pre>
  </div>

  <h2 class="text-2xl font-bold text-[var(--text-primary)] mt-8 mb-4">總結</h2>
  <p class="text-[var(--text-secondary)] leading-relaxed mb-4">
    BIP-386 定義的 tr() 函數是 Taproot 時代描述符的核心。
    它支援從簡單的單簽到複雜的腳本樹，並生成 bc1p 開頭的 Bech32m 地址。
    結合 MuSig2，Taproot 多簽可以達到與單簽相同的鏈上足跡，提供最佳的隱私和效率。
  </p>

  <div class="not-prose mt-8 p-4 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border-default)]">
    <h4 class="font-semibold text-[var(--text-primary)] mb-2">延伸閱讀</h4>
    <ul class="text-sm text-[var(--text-secondary)] space-y-1">
      <li>
        <a href="https://github.com/bitcoin/bips/blob/master/bip-0386.mediawiki" target="_blank" rel="noopener noreferrer" class="text-bitcoin-500 hover:underline">
          BIP-386 完整規格
        </a>
      </li>
      <li>
        <a href="/bips/bip-0341" class="text-bitcoin-500 hover:underline">
          BIP-341: Taproot 花費規則
        </a>
      </li>
      <li>
        <a href="/learn/advanced/taproot" class="text-bitcoin-500 hover:underline">
          Taproot 升級詳解
        </a>
      </li>
      <li>
        <a href="/bips/bip-0327" class="text-bitcoin-500 hover:underline">
          BIP-327: MuSig2
        </a>
      </li>
    </ul>
  </div>
</ArticleLayout>
